---
title: "state_data_testing"
author: "Denver Link"
date: "2023-09-15"
output: html_document
editor_options: 
  chunk_output_type: console
---

#Library
```{r}
library(tidyverse)
library(knitr)
library(data.table)
library(sharpshootR)
library(stringr)
library(sf)
library(arrow)
library(readr)
library(stringr)
library(janitor)
library(tidyr)
library(lubridate)
library(ggplot2)
options(scipen = 999)
```

#Data
```{r}
#Michigan
mi_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "mi_file_arrow"))

#Wisconsin
wi_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "wi_file_arrow"))

#Minnesota
mn_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "mn_file_arrow"))

#Iowa
ia_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "ia_file_arrow"))
```

#Column Tidy
```{r}
#####################Michigan#################################

#changing species names to standard format                       
mi_data <- mi_data %>% 
  #agency species code updated with common name
  mutate(species.1 = case_when(species.abbrev == "taxon_BCR" ~ "black_crappie",
                             species.abbrev == "taxon_BLG" ~ "bluegill",
                             species.abbrev == "taxon_CIS" ~ "cisco",
                             species.abbrev == "taxon_LMB" ~ "largemouth_bass",
                             species.abbrev == "taxon_NOP" ~ "northern_pike",
                             species.abbrev == "taxon_SMB" ~ "smallmouth_bass",
                             species.abbrev == "taxon_WAE" ~ "walleye",
                             species.abbrev == "taxon_YEP" ~ "yellow_perch",
                             TRUE ~ species.abbrev)) %>% 
  #Gear type code updated with spelled-out common name
  mutate(sampling_method = case_when(sampling_method_abbrev == "BOOMSHK" ~ "boomshocking",
                                            sampling_method_abbrev == "GLGNET" ~ "great_lakes_gill_net",
                                            sampling_method_abbrev == "IGNET" ~ "inland_gill_net",
                                            sampling_method_abbrev == "LMFYKE" ~ "large_mesh_fyke_net",
                                            sampling_method_abbrev == "SEINE" ~ "seine",
                                            sampling_method_abbrev == "SMFYKE" ~ "small_mesh_fyke_net",
                                            sampling_method_abbrev == "TRAPNET" ~ "trap_net")) %>% 
  #unit length 
  mutate(length_unit.1 = case_when(length_unit.1 == "col_name_Inch_group" ~ "inch_group",
                                   TRUE ~ length_unit.1)) %>% 
  #effort unit 
  mutate(effort_units.1 = case_when(effort_units.1 == "HAULS" ~ "hauls",
                                    effort_units.1 == "MINUT" ~ "minute",
                                    effort_units.1 == "LIFTS" ~ "lifts")) %>%
  #selects for columns to be used during analysis - limits memory usage and allows creates more clarity
  #effort files for survey type, lat/long, and target species contained more data than the merged catch files
  select(state, county, lake_id, lake_name.1, date.1, year, survey_type.1_effort, survey_id, lat_unspec_effort, lon_unspec_effort, sampling_method, sampling_method_abbrev, target_species_effort, species.1, species.abbrev, length.1, length_unit.1, total_effort_1.1_effort, effort_units.1)

###################Minnesota##########################################
mn_data %>% 
  #This chunk cleans codes and names within the species column
  mutate(species.new = case_when(species.1 == "LMB" ~ "largemouth_bass",
                                 species.1 == "SMB" ~ "smallmouth_bass",
                                 species.1 == "WAE" ~ "walleye", 
                                 species.1 == "WTS" ~ "white_sucker",
                                 species.1 == "BLC" ~ "black_crappie",
                                 species.1 == "YEP" ~ "yellow_perch",
                                 species.1 == "BLG" ~ "bluegill",
                                 species.1 == "NOP" ~ "northern_pike",
                                 species.1 == "PMK" ~ "pumpkinseed", 
                                 species.1 == "RKB" ~ "rock_bass",
                                 species.1 == "BKF" ~ "banded_killifish",
                                 species.1 == "IOD" ~ "iowa_darter",
                                 species.1 == "BCS" ~ "blackchin_shiner",
                                 species.1 == "BLB" ~ "black_bullhead",
                                 species.1 == "JND" ~ "johnny_darter",
                                 species.1 == "GOS" ~ "golden_shiner",
                                 species.1 == "YEB" ~ "yellow_bullhead",
                                 species.1 == "BRB" ~ "brown_bullhead",
                                 species.1 == "CNM" ~ "central_mudminnow",
                                 species.1 == "NRD" ~ "northern_redbelly_dace",
                                 species.1 == "CSH" ~ "chinook_salmon",
                                 species.1 == "MTS" ~ "mottled_sculpin",
                                 species.1 == "TPM" ~ "tadpole_madtom",
                                 species.1 == "SHR" ~ "shorthead_redhorse",
                                 species.1 == "HSF" ~ "hybrid_sunfish",
                                 species.1 == "BOF" ~ "bowfin",
                                 species.1 == "WDS" ~ "weed_shiner",
                                 species.1 == "BNM" ~ "bluntnose_minnow",
                                 species.1 == "BND" ~ "blacknose_dace",
                                 species.1 == "OTM" ~ "minnows",
                                 species.1 == "FHM" ~ "fathead_minnow",
                                 species.1 == "FND" ~ "finescale_dace",
                                 species.1 == "SDM" ~ "slender_madtom",
                                 species.1 == "SPO" ~ "spottail_shiner",
                                 species.1 == "BNS" ~ "blacknose_shiner",
                                 species.1 == "BKT" ~ "brook_trout",
                                 species.1 == "SPT" ~ "splake",
                                 species.1 == "RBT" ~ "rainbow_trout",
                                 species.1 == "BNT" ~ "brown_trout",
                                 species.1 == "BUB" ~ "burbot",
                                 species.1 == "BIB" ~ "bigmouth_buffalo",
                                 species.1 == "BLH" ~ "bullheads",
                                 species.1 == "TLC" ~ "cisco",
                                 species.1 == "CCF" ~ "channel_catfish",
                                 species.1 == "BSD" ~ "blackside_darter",
                                 species.1 == "BKS" ~ "brook_silverside",
                                 species.1 == "LED" ~ "least_darter",
                                 species.1 == "LGP" ~ "logperch",
                                 species.1 == "SLR" ~ "silver_redhorse",
                                 species.1 == "HHC" ~ "hornyhead_chub",
                                 species.1 == "MUE" ~ "muskellunge",
                                 species.1 == "TRP" ~ "trout_perch",
                                 species.1 == "RHS" ~ "redhorse",
                                 species.1 == "CAP" ~ "common_carp",
                                 species.1 == "MMS" ~ "mimic_shiner",
                                 species.1 == "EMS" ~ "emerald_shiner",
                                 species.1 == "SUN" ~ "sunfish",
                                 species.1 == "CRC" ~ "creek_chub",
                                 species.1 == "GSF" ~ "green_sunfish",
                                 species.1 == "SFS" ~ "spotfin_shiner",
                                 species.1 == "SHI" ~ "shiners",
                                 species.1 == "BST" ~ "brook_stickleback",
                                 species.1 == "CSR" ~ "central_stoneroller",
                                 species.1 == "SDS" ~ "sand_shiner",
                                 species.1 == "GRR" ~ "greater_redhorse",
                                 species.1 == "PGS" ~ "pugnose_shiner",
                                 species.1 == "SMS" ~ "slimy_sculpin",
                                 species.1 == "LND" ~ "longnose_dace",
                                 species.1 == "FRD" ~ "freshwater_drum",
                                 species.1 == "WHC" ~ "white_crappie",
                                 species.1 == "DAR" ~ "darters",
                                 species.1 == "SAR" ~ "sauger",
                                 species.1 == "FCF" ~ "flathead_catfish",
                                 species.1 == "BMS" ~ "bigmouth_shiner",
                                 species.1 == "LKS" ~ "lake_sturgeon",
                                 species.1 == "LKW" ~ "lake_whitefish",
                                 species.1 == "BRM" ~ "brassy_minnow",
                                 species.1 == "SLM" ~ "mississippi_silvery_minnow",
                                 species.1 == "GLR" ~ "golden_redhorse",
                                 species.1 == "OTS" ~ "suckers",
                                 species.1 == "NST" ~ "ninespine_stickleback",
                                 species.1 == "GOE" ~ "goldeye",
                                 species.1 == "QBS" ~ "quillback",
                                 species.1 == "RVS" ~ "river_shiner",
                                 species.1 == "LES" ~ "longear_sunfish",
                                 species.1 == "CHL" ~ "chestnut_lamprey",
                                 species.1 == "RRH" ~ "river_redhorse",
                                 species.1 == "WHB" ~ "white_bass",
                                 species.1 == "OSS" ~ "orangespotted_sunfish",
                                 species.1 == "STC" ~ "stonecat",
                                 species.1 == "SNG" ~ "shortnose_gar",
                                 species.1 == "RFS" ~ "rosyface_shiner",
                                 species.1 == "CMS" ~ "carmine_shiner",
                                 species.1 == "SAB" ~ "smallmouth_buffalo",
                                 species.1 == "GIS" ~ "gizzard_shad",
                                 species.1 == "LNG" ~ "longnose_gar",
                                 species.1 == "RCS" ~ "river_carpsucker",
                                 species.1 == "SLS" ~ "shovelnose_sturgeon",
                                 species.1 == "LAT" ~ "lake_trout",
                                 species.1 == "TME" ~ "tiger_muskellunge",
                                 species.1 == "PRD" ~ "pearl_dace",
                                 species.1 == "PLS" ~ "pallid_shiner",
                                 species.1 == "RBS" ~ "rainbow_smelt",
                                 species.1 == "RBD" ~ "rainbow_darter",
                                 species.1 == "LNS" ~ "longnose_sucker",
                                 species.1 == "SJC" ~ "shortjaw_cisco",
                                 species.1 == "DWS" ~ "deepwater_sculpin",
                                 species.1 == "SHS" ~ "spoonhead_sculpin",
                                 species.1 == "BDD" ~ "banded_darter",
                                 species.1 == "MOE" ~ "mooneye",
                                 species.1 == "BLS" ~ "blue_sucker",
                                 species.1 == "SLC" ~ "silver_chub",
                                 species.1 == "HFS" ~ "highfin_carpsucker",
                                 species.1 == "MCP" ~ "mirror_carp",
                                 species.1 == "WAS" ~ "walleye/sauger",
                                 species.1 == "AME" ~ "american_eel",
                                 species.1 == "GOF" ~ "goldfish",
                                 species.1 == "SPS" ~ "spotted_sucker",
                                 species.1 == "PAH" ~ "paddlefish",
                                 species.1 == "RVD" ~ "river_darter",
                                 species.1 == "NHS" ~ "northern_hog_sucker",
                                 species.1 == "BHM" ~ "bullhead_minnow",
                                 species.1 == "WSD" ~ "western_sand_darter",
                                 species.1 == "MDD" ~ "mud_darter",
                                 species.1 == "SIL" ~ "silver_lamprey",
                                 species.1 == "SKJ" ~ "skipjack_herring",
                                 species.1 == "PGM" ~ "pugnose_minnow",
                                 species.1 == "BKB" ~ "black_buffalo",
                                 species.1 == "FTD" ~ "fantail_darter",
                                 species.1 == "YLB" ~ "yellow_bass",
                                 species.1 == "PRP" ~ "pirate_perch",
                                 species.1 == "LKC" ~ "lake_chub",
                                 species.1 == "RIR" ~ "river_ruffe",
                                 species.1 == "WHP" ~ "white_perch",
                                 species.1 == "ALW" ~ "alewife",
                                 species.1 == "SEL" ~ "sea_lamprey",
                                 species.1 == "BHC" ~ "bighead_carp",
                                 species.1 == "GLD" ~ "gilt_darter",
                                 species.1 == "CRD" ~ "crystal_darter",
                                 species.1 == "SMT" ~ "speckled_madtom",
                                 species.1 == "RDS" ~ "red_shiner",
                                 species.1 == "WAM" ~ "warmouth",
                                 #above are fish codes converted, below are name corrections
                                 species.1 == "tullibee (cisco)" ~ "cisco",
                                 species.1 == "trout-perch" ~ "trout_perch",
                                 species.1 == "bowfin (dogfish)" ~ "bowfin",
                                 #listing unknown taxa
                                 species.1 == "unknown fish one" ~ "taxa_unknown",
                                 species.1 == "LXB" ~ "taxa_unknown",
                                 species.1 == "UK2" ~ "taxa_unknown",
                                 species.1 == "UK1" ~ "taxa_unknown",
                                 species.1 == "SIP" ~ "taxa_unknown",
                                 species.1 == "SHD" ~ "taxa_unknown",
                                 species.1 == "SCU" ~ "taxa_unknown",
                                 species.1 == "no particular species" ~ "taxa_unknown",
                                 species.1 == "HCR" ~ "taxa_unknown",
                                 species.1 == "CRP" ~ "taxa_unknown",
                                 species.1 == "CPS" ~ "taxa_unknown",
                                 species.1 == "CIS" ~ "taxa_unknown",
                                 is.na(species.1) ~ "taxa_unknown",
                                 TRUE ~ species.1)) %>%
  #adds _ instead of spaces within species name
  mutate(species.new = str_replace_all(species.new, " ", "_")) %>% 
  #makes sure everything is lower case in the species column
  mutate(species.new = tolower(species.new)) %>% 
  #makes sure all observations have Minnesota in the state column
  mutate(state = "Minnesota") %>% 
  #formats the length unit for clarity
  mutate(length_unit.1 = case_when(length_unit.1 == "col_name_LEN_MM" ~ "mm",
                                   TRUE ~ length_unit.1)) %>% 
  #formats the weight unit for clarity
  mutate(weight_unit.1 = case_when(weight_unit.1 == "col_name_WT_G 25943716" ~ "g",
                                   TRUE ~ weight_unit.1)) %>% 
  select(state, county_indivfish, lake_id, lake_name.1, date_clean, survey_type.1, survey_id_effort, sampling_method, target_species, species.1, species.new, length.1, length_unit.1, weight.1, weight_unit.1, total_effort_1.1)

##########################Wisconsin####################################
wi_data %>% 
  select(state, county, lake_id, lake_name.1, date.1, year, survey_type.1_effort, survey_type.2_effort, survey_id, sampling_method, target_species_effort, species.1, species.abbrev, length.1, length_unit.1, weight.1, weight_unit.1, effort, total.effort.1, total.effort.2, effort_units, total.effort.1.units, total.effort.2.units)

########################Illinois#####################################
il_data %>% 
  mutate(species.1 = str_to_lower(species.1),
         species.1 = str_replace_all(species.1, " ", "_")) %>% 
  mutate(weight_unit.1 = case_when(weight_unit.1 == "col_name_Wt(g)" ~ "g",
                                   TRUE ~ NA))
```

#Michigan - exploration
```{r}
#testing year with species
mi_data %>% 
  group_by(species.1, year) %>% 
  count() %>% 
  ggplot() +
  geom_smooth(aes(year, n)) +
  facet_wrap(~species.1)

#NA values in date column
mi_data %>% 
  filter(is.na(date.1)) %>% 
  group_by(survey_id) %>% 
  summarise(n = n())

#gear type
mi_data %>% 
  group_by(sampling_method_abbrev) %>% 
  count()
  
#looking at length in the data
mi_data %>% 
  ggplot() +
  geom_violin(aes(year, length.1)) +
  facet_wrap(~species.1, scales = "free")
mi_data %>% 
  group_by(length_unit.1) %>% 
  count()
mi_data %>% 
  group_by(length_unit.1, species.1) %>% 
  summarise(n = n(), max = max(length.1), min = min(length.1))
mi_data %>% 
  filter(is.na(length_unit.1)) %>% 
  group_by(species.1) %>% 
  summarise(mean = mean(length.1))

mi_data[ , .N , .(na_unit = is.na(length_unit.1), na_length = is.na(length.1)) ]
#length and unit length work together with NAs

  
#target species
mi_data %>% 
  group_by(target_species_effort) %>% 
  count()
mi_data %>% 
  filter(is.na(target_species_effort)) %>% 
  count(sampling_method_abbrev)

#Effort
mi_data %>% 
  group_by(effort_units.1, sampling_method_abbrev) %>% 
  count()
mi_data %>% 
  group_by(effort_units.1) %>% 
  filter(!is.na(total_effort_1.1_effort)) %>% 
  summarise(mean = mean(total_effort_1.1_effort), max = max(total_effort_1.1_effort), min = min(total_effort_1.1_effort))
mi_data %>% 
  ggplot() +
  geom_boxplot(aes(sampling_method_abbrev, total_effort_1.1_effort)) +
  facet_wrap(~effort_units.1,  scales = "free")
mi_data %>% 
  filter(is.na(total_effort_1.1_effort)) %>% 
  group_by(survey_id) %>% 
  count()

mi_data %>% 
  ggplot() +
  geom_boxplot(aes(sampling_method_abbrev, total_effort_1.1_mergedcatch)) +
  facet_wrap(~effort_units.1,  scales = "free")

#lat/long
mi_data %>%
  mutate(same_latitudes = ifelse(lat_unspec_mergedcatch == lat_unspec_effort, "Same", "Different")) %>% 
  group_by(same_latitudes) %>% 
  count()

na.effort <- mi_data %>% 
  filter(is.na(lat_unspec_effort)) %>% 
  group_by(survey_id) %>% 
  count() #only one survey 4042

na.merge <- mi_data %>% 
  filter(is.na(lat_unspec_mergedcatch)) %>% 
  group_by(survey_id) %>% 
  count() #115 surveys

mi_data[ , .N , .(na_lat_mc = is.na(lat_unspec_mergedcatch), na_lat_eff = is.na(lat_unspec_effort)) ]

mi_data %>% 
  filter(!is.na(lat_unspec_mergedcatch)) %>% 
  filter(!is.na(lat_unspec_effort)) %>% 
  mutate(same_latitudes = ifelse(lat_unspec_mergedcatch == lat_unspec_effort, "Same", "Different")) %>% 
  group_by(same_latitudes) %>% 
  count()

#survey type
mi_data %>% 
  mutate(same_type = ifelse(survey_type.1_effort == survey_type.1_mergedcatch, "Same", "Different")) %>% 
  group_by(same_type) %>% 
  count()

mi_data[ , .N , .(na_type_mc = is.na(survey_type.1_mergedcatch), na_type_eff = is.na(survey_type.1_effort)) ]

#target catch
mi_data[ , .N , .(na_tg_mc = is.na(target_species_mergedcatch), na_tg_eff = is.na(target_species_effort)) ]
```

#Wisconsin - exploration
```{r}
#print all column names
wi_data %>%
  names() %>%
  sort()


#species column
#cols containing "species" (skipping pipe to names includes a format report from arrow)
wi_data %>% 
  select(contains("species"))
  # %>%
  # names()
#view unique names of species:
wi_data %>% 
  select(species.1) %>% 
  unique() %>%
  arrange(species.1) %>%
  collect() %>%
  print(n = nrow(.))

wi_data %>% 
  group_by(species.1) %>% 
  summarise( n = n()) %>% 
  arrange( n) %>% 
  collect() %>% 
  print(n = nrow(.))

wi_data %>% 
  filter(is.na(species.1)) %>%
  select(survey_id, sampling_method, site_id.1, site_id.2, site_id.3, site_id.4, date.1) %>% 
  collect() %>% 
  {species_NA_surveys <<- . }


wi_data %>% 
  inner_join(species_NA_surveys) %>% 
  compute()


#location columns
#lake_id & lake_name
wi_data %>%
  select(contains("lake"))%>%
  unique()%>%
  collect()

#all lake loc data:
#here I review glimpse(wi_data) and call only the location-ey fields
wi_data %>% 
  select(lake_id, lake_name.1, state, county, location_notes.1, location_notes.2, location_notes.3, site_id.1, site_id.2, site_id.3, site_id.4 )%>%
  unique() %>%
  compute()

# I suspect the site IDs are winnebago specific
wi_data %>% 
  filter( !is.na(site_id.1)) %>% 
  select(lake_name.1) %>% 
  unique() %>% 
  collect()
# it is. drop that from the location data, above

#here I review glimpse(wi_data) and call only the location-ey fields
wi_data %>% 
  select(lake_id, lake_name.1, state, county, location_notes.1, location_notes.2, location_notes.3 )%>%
  unique() %>%
  compute()

#now check these fields one at a time (lake_name and id are done)
wi_data %>% 
  select(state) %>% 
  unique() %>%
  collect()
#view unique names of counties:
wi_data %>% 
  group_by(county) %>% 
  summarize( n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

# NA counties are a diverse set of waterbodies:
wi_data %>% 
  filter( !is.na(county)) %>% 
  select(lake_name.1) %>% 
  unique() %>% 
  collect() %>% 
  print( n = 100)

#lat/long
wi_data %>%
  select(contains("lat"))
#only lat and long columns are start and end?

wi_data %>% 
  mutate(same_loc = ifelse(lat_start == lat_end, "Same", "Different")) %>% 
  group_by(same_loc) %>% 
  count() %>% 
  collect()

660944/16534323 #prop that have lat/log


wi_data %>% 
  filter(is.na(lat_start)) %>% 
  group_by(lat_start) %>% 
  summarise(n = n()) %>% 
  collect()
#15567010 nas

wi_data %>% 
  filter(is.na(lat_end)) %>% 
  group_by(lat_end) %>% 
  summarise(n = n()) %>% 
  collect()
#15861264 - end has more obs but still a lot missing

#now review the date columns
#fields with "date"
wi_data %>%
  select(contains("date"))
#date.1 is the only useful column here:

#any NAs in date? NO!
wi_data %>%
  filter(is.na(date.1))%>%
  compute()

wi_data %>%
  select(date.1)%>%
  compute() 

wi_data %>%
  select(date.1)%>%
  collect() %>% 
  summary() 

# seems unlikely that there are fish data from 1899...
wi_data %>%
  filter(date.1 < "1940-1-1")%>%
  select(date.1) %>% 
  collect()

wi_data %>% 
  filter(lake_id == 99999) %>% 
  select(lake_name.1) %>% 
  unique() %>% 
  collect()
#definitely odd, but I don't know that we have any way of determining the true date in these. Let's flag those dates as questionable

wi_data %>%
  # filter(date.1 < "1940-1-1") %>% 
  mutate(FLAGGED_date_questionable = date.1 < "1930-1-1") %>% 
  select(FLAGGED_date_questionable ) %>% 
  compute()
#in order to amend the parquet file, I'd need to load it into R, add that column then re-write to disk. 


#gear
wi_data %>% 
  select(sampling_method) %>% 
  unique() %>% 
  compute() %>% 
  collect() %>% 
  print(n = nrow(.))

wi_data %>% 
  group_by(sampling_method) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  arrange(n) %>% 
  print( n = nrow(.))  
#gear looks good 


#target species
wi_data %>% 
  group_by(target_species_indivfish) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  arrange(n) %>% 
  print(n = nrow(.))

wi_data %>% 
  group_by(target_species_effort) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  arrange(n) %>% 
  print(n = nrow(.))
#counts are different for fish and effort

wi_data %>% 
  mutate(same_target = ifelse(target_species_effort == target_species_indivfish, "Same", "Different")) %>% 
  group_by(same_target) %>% 
  count() %>% 
  collect()
#no conflicting rows between effort and fish, but data might be missing from one or the other

wi_data %>% 
  filter(is.na(target_species_effort) & !is.na(target_species_indivfish)) %>% 
  count(species.1) %>% 
  collect()
#only one case where effort is na but fish is not

wi_data %>% 
  filter(!is.na(target_species_effort) & is.na(target_species_indivfish)) %>% 
  count(species.1) %>% 
  collect()
#33657 cases where fish is na but effort is not - ironically the species is also na 

wi_data %>% 
  filter(is.na(target_species_effort) & is.na(target_species_indivfish)) %>% 
  summarise(n = n()) %>% 
  collect()
#this tells us that the effort column should be used for the targeted data - there is only one case where indivfish has data and effort doesn't. All other cases are na for both


#length
wi_data %>% 
  group_by(species.1) %>% 
  summarise(mean = mean(length.1, na.rm = T), min = min(length.1, na.rm = T), max = max(length.1, na.rm = T)) %>% 
  collect() %>% 
  print(n = nrow(.))

#big walleye and pike?
wi_data %>% 
  filter(length.1 > 75) %>% 
  group_by(length_unit.1, species.1) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#how many fish do we suspect are in the wrong unit
#I used a cut off of 50 as we would likely not see many 75 inch fish 
#this doesn't seem to be a big issue

wi_data %>% 
  group_by(length_unit.1) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  arrange(n) %>% 
  print(n = nrow(.))
#units are in inches, 4153536 obs that are na for length unit

#Are the cases of na length unit when length is na?
wi_data %>% 
  filter(is.na(length.1) & is.na(length_unit.1)) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#3928844 are missing both length and length unit

#cases where there are lengths without any length units
wi_data %>% 
  filter(!is.na(length.1) & is.na(length_unit.1)) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#224692 have a length but are missing the unit
#these two cases above make up all cases for when length is na

#weight
wi_data %>%
  select(contains("weight"))

wi_data %>% 
  group_by(species.1) %>% 
  summarise(mean = mean(weight.1, na.rm = T), min = min(weight.1, na.rm = T), max = max(weight.1, na.rm = T)) %>% 
  collect() %>% 
  filter(!is.na(mean)) %>% 
  print(n = nrow(.))
#we have weights for 15 species, weights of 0? Appears like there is a spread in units

wi_data %>% 
  group_by(weight_unit.1) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#units say lbs or NA

#are there any unlikely lbs weights with that unit?
wi_data %>% 
  filter(weight.1 > 50) %>% 
  group_by(weight_unit.1, species.1) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#there are seemingly a lot of perch over 50 pounds... I'm taking those lake numbers and going fishing

#are the yellow perch from the same survey?
wi_data %>% 
  filter(species.1 == "yellow_perch") %>% 
  filter(weight.1 > 50) %>%
  group_by(weight_unit.1, survey_id) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#the unlikely weights for yellow perch come from two survey ids

#Are the cases of na weight unit when length is na?
wi_data %>% 
  filter(is.na(weight.1) & is.na(weight_unit.1)) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#4153536 are missing both weight and weight unit - making up all of the na values for weight unit

#cases where there are weights without any weight units
wi_data %>% 
  filter(!is.na(weight.1) & is.na(weight_unit.1)) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#no fish have a weight but are missing the unit

#age years
wi_data %>%
  select(contains("age"))
#doesn't look like there is any age year data

#effort 
wi_data %>%
  select(contains("effort"))

wi_data %>% 
  group_by(effort) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

#effort is currently in a string?
wi_data %>% 
  group_by(effort) %>% 
  summarise(mean = mean(effort, na.rm = T), min = min(effort, na.rm = T), max = max(effort, na.rm = T)) %>% 
  collect() %>% 
  print(n = nrow(.))

#total effort 1 - string?
wi_data %>% 
  group_by(total.effort.1) %>% 
  summarise(mean = mean(effort, na.rm = T), min = min(effort, na.rm = T), max = max(effort, na.rm = T)) %>% 
  collect() %>% 
  print(n = nrow(.))

#total effort 2 - string?
wi_data %>% 
  group_by(effort_units) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

#total effort 1 units
wi_data %>% 
  group_by(total.effort.1.units) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

#total effort 2 units
wi_data %>% 
  group_by(total.effort.2.units) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

#survey type
wi_data %>% 
  group_by(survey_type.1_effort) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

wi_data %>% 
  group_by(survey_type.2_effort) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

#sex column
wi_data %>% 
  group_by(sex) %>% 
  summarise(n = n()) %>% 
  collect()

##########################ready for combination#############################
wi_data %>% 
  select(state, county, lake_id, lake_name.1, date.1, year, survey_type.1_effort, survey_type.2_effort, survey_id, sampling_method, sampling_method_abbrev, target_species_effort, species.1, species.abbrev, length.1, length_unit.1, weight.1, weight_unit.1)
#things to check on:
##what type of effort should be kept - effort? effort.1, effort.2?
##lat/long - mostly nas
##survey_type kept for effort?
##other columsn to keep? sex, yoy, sample_id.1

```

#Minnesota - exploration
```{r}


#Overall cleaning code for Minnesota starts here, below this chuck explores within each column
mn_data %>% 
  #This chunk cleans codes and names within the species column
  mutate(species.new = case_when(species.1 == "LMB" ~ "largemouth_bass",
                                 species.1 == "SMB" ~ "smallmouth_bass",
                                 species.1 == "WAE" ~ "walleye", 
                                 species.1 == "WTS" ~ "white_sucker",
                                 species.1 == "BLC" ~ "black_crappie",
                                 species.1 == "YEP" ~ "yellow_perch",
                                 species.1 == "BLG" ~ "bluegill",
                                 species.1 == "NOP" ~ "northern_pike",
                                 species.1 == "PMK" ~ "pumpkinseed", 
                                 species.1 == "RKB" ~ "rock_bass",
                                 species.1 == "BKF" ~ "banded_killifish",
                                 species.1 == "IOD" ~ "iowa_darter",
                                 species.1 == "BCS" ~ "blackchin_shiner",
                                 species.1 == "BLB" ~ "black_bullhead",
                                 species.1 == "JND" ~ "johnny_darter",
                                 species.1 == "GOS" ~ "golden_shiner",
                                 species.1 == "YEB" ~ "yellow_bullhead",
                                 species.1 == "BRB" ~ "brown_bullhead",
                                 species.1 == "CNM" ~ "central_mudminnow",
                                 species.1 == "NRD" ~ "northern_redbelly_dace",
                                 species.1 == "CSH" ~ "chinook_salmon",
                                 species.1 == "MTS" ~ "mottled_sculpin",
                                 species.1 == "TPM" ~ "tadpole_madtom",
                                 species.1 == "SHR" ~ "shorthead_redhorse",
                                 species.1 == "HSF" ~ "hybrid_sunfish",
                                 species.1 == "BOF" ~ "bowfin",
                                 species.1 == "WDS" ~ "weed_shiner",
                                 species.1 == "BNM" ~ "bluntnose_minnow",
                                 species.1 == "BND" ~ "blacknose_dace",
                                 species.1 == "OTM" ~ "minnows",
                                 species.1 == "FHM" ~ "fathead_minnow",
                                 species.1 == "FND" ~ "finescale_dace",
                                 species.1 == "SDM" ~ "slender_madtom",
                                 species.1 == "SPO" ~ "spottail_shiner",
                                 species.1 == "BNS" ~ "blacknose_shiner",
                                 species.1 == "BKT" ~ "brook_trout",
                                 species.1 == "SPT" ~ "splake",
                                 species.1 == "RBT" ~ "rainbow_trout",
                                 species.1 == "BNT" ~ "brown_trout",
                                 species.1 == "BUB" ~ "burbot",
                                 species.1 == "BIB" ~ "bigmouth_buffalo",
                                 species.1 == "BLH" ~ "bullheads",
                                 species.1 == "TLC" ~ "cisco",
                                 species.1 == "CCF" ~ "channel_catfish",
                                 species.1 == "BSD" ~ "blackside_darter",
                                 species.1 == "BKS" ~ "brook_silverside",
                                 species.1 == "LED" ~ "least_darter",
                                 species.1 == "LGP" ~ "logperch",
                                 species.1 == "SLR" ~ "silver_redhorse",
                                 species.1 == "HHC" ~ "hornyhead_chub",
                                 species.1 == "MUE" ~ "muskellunge",
                                 species.1 == "TRP" ~ "trout_perch",
                                 species.1 == "RHS" ~ "redhorse",
                                 species.1 == "CAP" ~ "common_carp",
                                 species.1 == "MMS" ~ "mimic_shiner",
                                 species.1 == "EMS" ~ "emerald_shiner",
                                 species.1 == "SUN" ~ "sunfish",
                                 species.1 == "CRC" ~ "creek_chub",
                                 species.1 == "GSF" ~ "green_sunfish",
                                 species.1 == "SFS" ~ "spotfin_shiner",
                                 species.1 == "SHI" ~ "shiners",
                                 species.1 == "BST" ~ "brook_stickleback",
                                 species.1 == "CSR" ~ "central_stoneroller",
                                 species.1 == "SDS" ~ "sand_shiner",
                                 species.1 == "GRR" ~ "greater_redhorse",
                                 species.1 == "PGS" ~ "pugnose_shiner",
                                 species.1 == "SMS" ~ "slimy_sculpin",
                                 species.1 == "LND" ~ "longnose_dace",
                                 species.1 == "FRD" ~ "freshwater_drum",
                                 species.1 == "WHC" ~ "white_crappie",
                                 species.1 == "DAR" ~ "darters",
                                 species.1 == "SAR" ~ "sauger",
                                 species.1 == "FCF" ~ "flathead_catfish",
                                 species.1 == "BMS" ~ "bigmouth_shiner",
                                 species.1 == "LKS" ~ "lake_sturgeon",
                                 species.1 == "LKW" ~ "lake_whitefish",
                                 species.1 == "BRM" ~ "brassy_minnow",
                                 species.1 == "SLM" ~ "mississippi_silvery_minnow",
                                 species.1 == "GLR" ~ "golden_redhorse",
                                 species.1 == "OTS" ~ "suckers",
                                 species.1 == "NST" ~ "ninespine_stickleback",
                                 species.1 == "GOE" ~ "goldeye",
                                 species.1 == "QBS" ~ "quillback",
                                 species.1 == "RVS" ~ "river_shiner",
                                 species.1 == "LES" ~ "longear_sunfish",
                                 species.1 == "CHL" ~ "chestnut_lamprey",
                                 species.1 == "RRH" ~ "river_redhorse",
                                 species.1 == "WHB" ~ "white_bass",
                                 species.1 == "OSS" ~ "orangespotted_sunfish",
                                 species.1 == "STC" ~ "stonecat",
                                 species.1 == "SNG" ~ "shortnose_gar",
                                 species.1 == "RFS" ~ "rosyface_shiner",
                                 species.1 == "CMS" ~ "carmine_shiner",
                                 species.1 == "SAB" ~ "smallmouth_buffalo",
                                 species.1 == "GIS" ~ "gizzard_shad",
                                 species.1 == "LNG" ~ "longnose_gar",
                                 species.1 == "RCS" ~ "river_carpsucker",
                                 species.1 == "SLS" ~ "shovelnose_sturgeon",
                                 species.1 == "LAT" ~ "lake_trout",
                                 species.1 == "TME" ~ "tiger_muskellunge",
                                 species.1 == "PRD" ~ "pearl_dace",
                                 species.1 == "PLS" ~ "pallid_shiner",
                                 species.1 == "RBS" ~ "rainbow_smelt",
                                 species.1 == "RBD" ~ "rainbow_darter",
                                 species.1 == "LNS" ~ "longnose_sucker",
                                 species.1 == "SJC" ~ "shortjaw_cisco",
                                 species.1 == "DWS" ~ "deepwater_sculpin",
                                 species.1 == "SHS" ~ "spoonhead_sculpin",
                                 species.1 == "BDD" ~ "banded_darter",
                                 species.1 == "MOE" ~ "mooneye",
                                 species.1 == "BLS" ~ "blue_sucker",
                                 species.1 == "SLC" ~ "silver_chub",
                                 species.1 == "HFS" ~ "highfin_carpsucker",
                                 species.1 == "MCP" ~ "mirror_carp",
                                 species.1 == "WAS" ~ "walleye/sauger",
                                 species.1 == "AME" ~ "american_eel",
                                 species.1 == "GOF" ~ "goldfish",
                                 species.1 == "SPS" ~ "spotted_sucker",
                                 species.1 == "PAH" ~ "paddlefish",
                                 species.1 == "RVD" ~ "river_darter",
                                 species.1 == "NHS" ~ "northern_hog_sucker",
                                 species.1 == "BHM" ~ "bullhead_minnow",
                                 species.1 == "WSD" ~ "western_sand_darter",
                                 species.1 == "MDD" ~ "mud_darter",
                                 species.1 == "SIL" ~ "silver_lamprey",
                                 species.1 == "SKJ" ~ "skipjack_herring",
                                 species.1 == "PGM" ~ "pugnose_minnow",
                                 species.1 == "BKB" ~ "black_buffalo",
                                 species.1 == "FTD" ~ "fantail_darter",
                                 species.1 == "YLB" ~ "yellow_bass",
                                 species.1 == "PRP" ~ "pirate_perch",
                                 species.1 == "LKC" ~ "lake_chub",
                                 species.1 == "RIR" ~ "river_ruffe",
                                 species.1 == "WHP" ~ "white_perch",
                                 species.1 == "ALW" ~ "alewife",
                                 species.1 == "SEL" ~ "sea_lamprey",
                                 species.1 == "BHC" ~ "bighead_carp",
                                 species.1 == "GLD" ~ "gilt_darter",
                                 species.1 == "CRD" ~ "crystal_darter",
                                 species.1 == "SMT" ~ "speckled_madtom",
                                 species.1 == "RDS" ~ "red_shiner",
                                 species.1 == "WAM" ~ "warmouth",
                                 #above are fish codes converted, below are name corrections
                                 species.1 == "tullibee (cisco)" ~ "cisco",
                                 species.1 == "trout-perch" ~ "trout_perch",
                                 species.1 == "bowfin (dogfish)" ~ "bowfin",
                                 #listing unknown taxa
                                 species.1 == "unknown fish one" ~ "taxa_unknown",
                                 species.1 == "LXB" ~ "taxa_unknown",
                                 species.1 == "UK2" ~ "taxa_unknown",
                                 species.1 == "UK1" ~ "taxa_unknown",
                                 species.1 == "SIP" ~ "taxa_unknown",
                                 species.1 == "SHD" ~ "taxa_unknown",
                                 species.1 == "SCU" ~ "taxa_unknown",
                                 species.1 == "no particular species" ~ "taxa_unknown",
                                 species.1 == "HCR" ~ "taxa_unknown",
                                 species.1 == "CRP" ~ "taxa_unknown",
                                 species.1 == "CPS" ~ "taxa_unknown",
                                 species.1 == "CIS" ~ "taxa_unknown",
                                 is.na(species.1) ~ "taxa_unknown",
                                 TRUE ~ species.1)) %>%
  #adds _ instead of spaces within species name
  mutate(species.new = str_replace_all(species.new, " ", "_")) %>% 
  #makes sure everything is lower case in the species column
  mutate(species.new = tolower(species.new)) %>% 
  #makes sure all observations have Minnesota in the state column
  mutate(state = "Minnesota") %>% 
  #formats the length unit for clarity
  mutate(length_unit.1 = case_when(length_unit.1 == "col_name_LEN_MM" ~ "mm",
                                   TRUE ~ length_unit.1)) %>% 
  #formats the weight unit for clarity
  mutate(weight_unit.1 = case_when(weight_unit.1 == "col_name_WT_G 25943716" ~ "g",
                                   TRUE ~ weight_unit.1)) 
  

#species
mn_data %>%
  select(contains("species"))

mn_data %>% 
  group_by(species.1) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

mn_data %>% 
  mutate(species.new = case_when(species.1 == "LMB" ~ "largemouth_bass",
                                 species.1 == "SMB" ~ "smallmouth_bass",
                                 species.1 == "WAE" ~ "walleye", 
                                 species.1 == "WTS" ~ "white_sucker",
                                 species.1 == "BLC" ~ "black_crappie",
                                 species.1 == "YEP" ~ "yellow_perch",
                                 species.1 == "BLG" ~ "bluegill",
                                 species.1 == "NOP" ~ "northern_pike",
                                 species.1 == "PMK" ~ "pumpkinseed", 
                                 species.1 == "RKB" ~ "rock_bass",
                                 species.1 == "BKF" ~ "banded_killifish",
                                 species.1 == "IOD" ~ "iowa_darter",
                                 species.1 == "BCS" ~ "blackchin_shiner",
                                 species.1 == "BLB" ~ "black_bullhead",
                                 species.1 == "JND" ~ "johnny_darter",
                                 species.1 == "GOS" ~ "golden_shiner",
                                 species.1 == "YEB" ~ "yellow_bullhead",
                                 species.1 == "BRB" ~ "brown_bullhead",
                                 species.1 == "CNM" ~ "central_mudminnow",
                                 species.1 == "NRD" ~ "northern_redbelly_dace",
                                 species.1 == "CSH" ~ "chinook_salmon",
                                 species.1 == "MTS" ~ "mottled_sculpin",
                                 species.1 == "TPM" ~ "tadpole_madtom",
                                 species.1 == "SHR" ~ "shorthead_redhorse",
                                 species.1 == "HSF" ~ "hybrid_sunfish",
                                 species.1 == "BOF" ~ "bowfin",
                                 species.1 == "WDS" ~ "weed_shiner",
                                 species.1 == "BNM" ~ "bluntnose_minnow",
                                 species.1 == "BND" ~ "blacknose_dace",
                                 species.1 == "OTM" ~ "minnows",
                                 species.1 == "FHM" ~ "fathead_minnow",
                                 species.1 == "FND" ~ "finescale_dace",
                                 species.1 == "SDM" ~ "slender_madtom",
                                 species.1 == "SPO" ~ "spottail_shiner",
                                 species.1 == "BNS" ~ "blacknose_shiner",
                                 species.1 == "BKT" ~ "brook_trout",
                                 species.1 == "SPT" ~ "splake",
                                 species.1 == "RBT" ~ "rainbow_trout",
                                 species.1 == "BNT" ~ "brown_trout",
                                 species.1 == "BUB" ~ "burbot",
                                 species.1 == "BIB" ~ "bigmouth_buffalo",
                                 species.1 == "BLH" ~ "bullheads",
                                 species.1 == "TLC" ~ "cisco",
                                 species.1 == "CCF" ~ "channel_catfish",
                                 species.1 == "BSD" ~ "blackside_darter",
                                 species.1 == "BKS" ~ "brook_silverside",
                                 species.1 == "LED" ~ "least_darter",
                                 species.1 == "LGP" ~ "logperch",
                                 species.1 == "SLR" ~ "silver_redhorse",
                                 species.1 == "HHC" ~ "hornyhead_chub",
                                 species.1 == "MUE" ~ "muskellunge",
                                 species.1 == "TRP" ~ "trout_perch",
                                 species.1 == "RHS" ~ "redhorse",
                                 species.1 == "CAP" ~ "common_carp",
                                 species.1 == "MMS" ~ "mimic_shiner",
                                 species.1 == "EMS" ~ "emerald_shiner",
                                 species.1 == "SUN" ~ "sunfish",
                                 species.1 == "CRC" ~ "creek_chub",
                                 species.1 == "GSF" ~ "green_sunfish",
                                 species.1 == "SFS" ~ "spotfin_shiner",
                                 species.1 == "SHI" ~ "shiners",
                                 species.1 == "BST" ~ "brook_stickleback",
                                 species.1 == "CSR" ~ "central_stoneroller",
                                 species.1 == "SDS" ~ "sand_shiner",
                                 species.1 == "GRR" ~ "greater_redhorse",
                                 species.1 == "PGS" ~ "pugnose_shiner",
                                 species.1 == "SMS" ~ "slimy_sculpin",
                                 species.1 == "LND" ~ "longnose_dace",
                                 species.1 == "FRD" ~ "freshwater_drum",
                                 species.1 == "WHC" ~ "white_crappie",
                                 species.1 == "DAR" ~ "darters",
                                 species.1 == "SAR" ~ "sauger",
                                 species.1 == "FCF" ~ "flathead_catfish",
                                 species.1 == "BMS" ~ "bigmouth_shiner",
                                 species.1 == "LKS" ~ "lake_sturgeon",
                                 species.1 == "LKW" ~ "lake_whitefish",
                                 species.1 == "BRM" ~ "brassy_minnow",
                                 species.1 == "SLM" ~ "mississippi_silvery_minnow",
                                 species.1 == "GLR" ~ "golden_redhorse",
                                 species.1 == "OTS" ~ "suckers",
                                 species.1 == "NST" ~ "ninespine_stickleback",
                                 species.1 == "GOE" ~ "goldeye",
                                 species.1 == "QBS" ~ "quillback",
                                 species.1 == "RVS" ~ "river_shiner",
                                 species.1 == "LES" ~ "longear_sunfish",
                                 species.1 == "CHL" ~ "chestnut_lamprey",
                                 species.1 == "RRH" ~ "river_redhorse",
                                 species.1 == "WHB" ~ "white_bass",
                                 species.1 == "OSS" ~ "orangespotted_sunfish",
                                 species.1 == "STC" ~ "stonecat",
                                 species.1 == "SNG" ~ "shortnose_gar",
                                 species.1 == "RFS" ~ "rosyface_shiner",
                                 species.1 == "CMS" ~ "carmine_shiner",
                                 species.1 == "SAB" ~ "smallmouth_buffalo",
                                 species.1 == "GIS" ~ "gizzard_shad",
                                 species.1 == "LNG" ~ "longnose_gar",
                                 species.1 == "RCS" ~ "river_carpsucker",
                                 species.1 == "SLS" ~ "shovelnose_sturgeon",
                                 species.1 == "LAT" ~ "lake_trout",
                                 species.1 == "TME" ~ "tiger_muskellunge",
                                 species.1 == "PRD" ~ "pearl_dace",
                                 species.1 == "PLS" ~ "pallid_shiner",
                                 species.1 == "RBS" ~ "rainbow_smelt",
                                 species.1 == "RBD" ~ "rainbow_darter",
                                 species.1 == "LNS" ~ "longnose_sucker",
                                 species.1 == "SJC" ~ "shortjaw_cisco",
                                 species.1 == "DWS" ~ "deepwater_sculpin",
                                 species.1 == "SHS" ~ "spoonhead_sculpin",
                                 species.1 == "BDD" ~ "banded_darter",
                                 species.1 == "MOE" ~ "mooneye",
                                 species.1 == "BLS" ~ "blue_sucker",
                                 species.1 == "SLC" ~ "silver_chub",
                                 species.1 == "HFS" ~ "highfin_carpsucker",
                                 species.1 == "MCP" ~ "mirror_carp",
                                 species.1 == "WAS" ~ "walleye/sauger",
                                 species.1 == "AME" ~ "american_eel",
                                 species.1 == "GOF" ~ "goldfish",
                                 species.1 == "SPS" ~ "spotted_sucker",
                                 species.1 == "PAH" ~ "paddlefish",
                                 species.1 == "RVD" ~ "river_darter",
                                 species.1 == "NHS" ~ "northern_hog_sucker",
                                 species.1 == "BHM" ~ "bullhead_minnow",
                                 species.1 == "WSD" ~ "western_sand_darter",
                                 species.1 == "MDD" ~ "mud_darter",
                                 species.1 == "SIL" ~ "silver_lamprey",
                                 species.1 == "SKJ" ~ "skipjack_herring",
                                 species.1 == "PGM" ~ "pugnose_minnow",
                                 species.1 == "BKB" ~ "black_buffalo",
                                 species.1 == "FTD" ~ "fantail_darter",
                                 species.1 == "YLB" ~ "yellow_bass",
                                 species.1 == "PRP" ~ "pirate_perch",
                                 species.1 == "LKC" ~ "lake_chub",
                                 species.1 == "RIR" ~ "river_ruffe",
                                 species.1 == "WHP" ~ "white_perch",
                                 species.1 == "ALW" ~ "alewife",
                                 species.1 == "SEL" ~ "sea_lamprey",
                                 species.1 == "BHC" ~ "bighead_carp",
                                 species.1 == "GLD" ~ "gilt_darter",
                                 species.1 == "CRD" ~ "crystal_darter",
                                 species.1 == "SMT" ~ "speckled_madtom",
                                 species.1 == "RDS" ~ "red_shiner",
                                 species.1 == "WAM" ~ "warmouth",
                                 #above are fish codes converted, below are name corrections
                                 species.1 == "tullibee (cisco)" ~ "cisco",
                                 species.1 == "trout-perch" ~ "trout_perch",
                                 species.1 == "bowfin (dogfish)" ~ "bowfin",
                                 #listing unknown taxa
                                 species.1 == "unknown fish one" ~ "taxa_unknown",
                                 species.1 == "LXB" ~ "taxa_unknown",
                                 species.1 == "UK2" ~ "taxa_unknown",
                                 species.1 == "UK1" ~ "taxa_unknown",
                                 species.1 == "SIP" ~ "taxa_unknown",
                                 species.1 == "SHD" ~ "taxa_unknown",
                                 species.1 == "SCU" ~ "taxa_unknown",
                                 species.1 == "no particular species" ~ "taxa_unknown",
                                 species.1 == "HCR" ~ "taxa_unknown",
                                 species.1 == "CRP" ~ "taxa_unknown",
                                 species.1 == "CPS" ~ "taxa_unknown",
                                 species.1 == "CIS" ~ "taxa_unknown",
                                 is.na(species.1) ~ "taxa_unknown",
                                 TRUE ~ species.1)) %>%
  mutate(species.new = str_replace_all(species.new, " ", "_")) %>% 
  mutate(species.new = tolower(species.new)) %>% 
  group_by(species.new) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  arrange(desc(species.new)) %>% 
  print(n = nrow(.))

#state
mn_data %>%
  select(contains("state"))

mn_data %>% 
  group_by(state) %>% 
  summarise(n = n()) %>% 
  collect()

mn_data %>% 
  mutate(state = "Minnesota") %>% 
  group_by(state) %>% 
  summarise(n = n()) %>% 
  collect()

#county - based on info below for county in indivfish
mn_data %>%
  select(contains("county"))

mn_data %>% 
  mutate(same_county = ifelse(county_effort == county_indivfish, "Same", "Different")) %>% 
  group_by(same_county) %>% 
  count() %>% 
  collect()
#no conflicting rows between effort and fish, but data might be missing from one or the other

mn_data %>% 
  filter(is.na(county_effort) & !is.na(county_indivfish)) %>% 
  count() %>% 
  collect()
#76246 - obs when effort is na but fish is not

mn_data %>% 
  filter(!is.na(county_effort) & is.na(county_indivfish)) %>% 
  count() %>% 
  collect()
#1904 - obs when county effort is not na but fish is
#fish has more coverage than county



#lake_ID
mn_data %>% 
  group_by(lake_id) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  mutate(check = ifelse(grepl("^\\d{7,8}$", lake_id), "good", "bad")) %>% 
  group_by(check) %>% 
  summarise(n = n())
#all lake ids are in the same format and look good

#how many lakes? - 4148
mn_data %>% 
  summarise(unique = n_distinct(lake_id)) %>%  
  collect()

#lake_name
mn_data %>% 
  group_by(lake_name.1) %>% 
  summarise(n = n()) %>% 
  collect()

mn_data %>% 
  summarise(unique = n_distinct(lake_name.1)) %>%  
  collect()
#2436 unique lake names 

mn_data %>% 
  select(lake_name.1) %>% 
  unique() %>% 
  collect() %>% 
  print( n = 100)

#lat/long
mn_data %>% 
  select(contains("lat"))
mn_data %>% 
  select(contains("long"))
#no lat or long column?

#date
mn_data %>%
  select(contains("date"))

#any NAs in date? 
mn_data %>%
  filter(is.na(date_clean))%>%
  summarise(n = n()) %>% 
  collect()

mn_data %>%
  select(date_clean)%>%
  collect() %>% 
  summary() 
#NAs and seems legit

#gear 
mn_data %>% 
  group_by(sampling_method) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#over 7 million NAs? 

mn_data %>% 
  filter(is.na(sampling_method)) %>% 
  group_by(lake_id) %>% 
  summarise(n = n()) %>% 
  collect()

#targeted species - needs cleaning, has species codes
mn_data %>% 
  group_by(target_species) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

#how many targeted vs non-targeted?
mn_data %>% 
  mutate(target.survey = case_when(target_species == "" ~ "untargeted",
                                   TRUE ~ "targeted")) %>% 
  group_by(target.survey) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#roughly 30% are targeted

#length and weight ranges
mn_data %>% 
  mutate(species.new = case_when(species.1 == "LMB" ~ "largemouth_bass",
                                 species.1 == "SMB" ~ "smallmouth_bass",
                                 species.1 == "WAE" ~ "walleye", 
                                 species.1 == "WTS" ~ "white_sucker",
                                 species.1 == "BLC" ~ "black_crappie",
                                 species.1 == "YEP" ~ "yellow_perch",
                                 species.1 == "BLG" ~ "bluegill",
                                 species.1 == "NOP" ~ "northern_pike",
                                 species.1 == "PMK" ~ "pumpkinseed", 
                                 species.1 == "RKB" ~ "rock_bass",
                                 species.1 == "BKF" ~ "banded_killifish",
                                 species.1 == "IOD" ~ "iowa_darter",
                                 species.1 == "BCS" ~ "blackchin_shiner",
                                 species.1 == "BLB" ~ "black_bullhead",
                                 species.1 == "JND" ~ "johnny_darter",
                                 species.1 == "GOS" ~ "golden_shiner",
                                 species.1 == "YEB" ~ "yellow_bullhead",
                                 species.1 == "BRB" ~ "brown_bullhead",
                                 species.1 == "CNM" ~ "central_mudminnow",
                                 species.1 == "NRD" ~ "northern_redbelly_dace",
                                 species.1 == "CSH" ~ "chinook_salmon",
                                 species.1 == "MTS" ~ "mottled_sculpin",
                                 species.1 == "TPM" ~ "tadpole_madtom",
                                 species.1 == "SHR" ~ "shorthead_redhorse",
                                 species.1 == "HSF" ~ "hybrid_sunfish",
                                 species.1 == "BOF" ~ "bowfin",
                                 species.1 == "WDS" ~ "weed_shiner",
                                 species.1 == "BNM" ~ "bluntnose_minnow",
                                 species.1 == "BND" ~ "blacknose_dace",
                                 species.1 == "OTM" ~ "minnows",
                                 species.1 == "FHM" ~ "fathead_minnow",
                                 species.1 == "FND" ~ "finescale_dace",
                                 species.1 == "SDM" ~ "slender_madtom",
                                 species.1 == "SPO" ~ "spottail_shiner",
                                 species.1 == "BNS" ~ "blacknose_shiner",
                                 species.1 == "BKT" ~ "brook_trout",
                                 species.1 == "SPT" ~ "splake",
                                 species.1 == "RBT" ~ "rainbow_trout",
                                 species.1 == "BNT" ~ "brown_trout",
                                 species.1 == "BUB" ~ "burbot",
                                 species.1 == "BIB" ~ "bigmouth_buffalo",
                                 species.1 == "BLH" ~ "bullheads",
                                 species.1 == "TLC" ~ "cisco",
                                 species.1 == "CCF" ~ "channel_catfish",
                                 species.1 == "BSD" ~ "blackside_darter",
                                 species.1 == "BKS" ~ "brook_silverside",
                                 species.1 == "LED" ~ "least_darter",
                                 species.1 == "LGP" ~ "logperch",
                                 species.1 == "SLR" ~ "silver_redhorse",
                                 species.1 == "HHC" ~ "hornyhead_chub",
                                 species.1 == "MUE" ~ "muskellunge",
                                 species.1 == "TRP" ~ "trout_perch",
                                 species.1 == "RHS" ~ "redhorse",
                                 species.1 == "CAP" ~ "common_carp",
                                 species.1 == "MMS" ~ "mimic_shiner",
                                 species.1 == "EMS" ~ "emerald_shiner",
                                 species.1 == "SUN" ~ "sunfish",
                                 species.1 == "CRC" ~ "creek_chub",
                                 species.1 == "GSF" ~ "green_sunfish",
                                 species.1 == "SFS" ~ "spotfin_shiner",
                                 species.1 == "SHI" ~ "shiners",
                                 species.1 == "BST" ~ "brook_stickleback",
                                 species.1 == "CSR" ~ "central_stoneroller",
                                 species.1 == "SDS" ~ "sand_shiner",
                                 species.1 == "GRR" ~ "greater_redhorse",
                                 species.1 == "PGS" ~ "pugnose_shiner",
                                 species.1 == "SMS" ~ "slimy_sculpin",
                                 species.1 == "LND" ~ "longnose_dace",
                                 species.1 == "FRD" ~ "freshwater_drum",
                                 species.1 == "WHC" ~ "white_crappie",
                                 species.1 == "DAR" ~ "darters",
                                 species.1 == "SAR" ~ "sauger",
                                 species.1 == "FCF" ~ "flathead_catfish",
                                 species.1 == "BMS" ~ "bigmouth_shiner",
                                 species.1 == "LKS" ~ "lake_sturgeon",
                                 species.1 == "LKW" ~ "lake_whitefish",
                                 species.1 == "BRM" ~ "brassy_minnow",
                                 species.1 == "SLM" ~ "mississippi_silvery_minnow",
                                 species.1 == "GLR" ~ "golden_redhorse",
                                 species.1 == "OTS" ~ "suckers",
                                 species.1 == "NST" ~ "ninespine_stickleback",
                                 species.1 == "GOE" ~ "goldeye",
                                 species.1 == "QBS" ~ "quillback",
                                 species.1 == "RVS" ~ "river_shiner",
                                 species.1 == "LES" ~ "longear_sunfish",
                                 species.1 == "CHL" ~ "chestnut_lamprey",
                                 species.1 == "RRH" ~ "river_redhorse",
                                 species.1 == "WHB" ~ "white_bass",
                                 species.1 == "OSS" ~ "orangespotted_sunfish",
                                 species.1 == "STC" ~ "stonecat",
                                 species.1 == "SNG" ~ "shortnose_gar",
                                 species.1 == "RFS" ~ "rosyface_shiner",
                                 species.1 == "CMS" ~ "carmine_shiner",
                                 species.1 == "SAB" ~ "smallmouth_buffalo",
                                 species.1 == "GIS" ~ "gizzard_shad",
                                 species.1 == "LNG" ~ "longnose_gar",
                                 species.1 == "RCS" ~ "river_carpsucker",
                                 species.1 == "SLS" ~ "shovelnose_sturgeon",
                                 species.1 == "LAT" ~ "lake_trout",
                                 species.1 == "TME" ~ "tiger_muskellunge",
                                 species.1 == "PRD" ~ "pearl_dace",
                                 species.1 == "PLS" ~ "pallid_shiner",
                                 species.1 == "RBS" ~ "rainbow_smelt",
                                 species.1 == "RBD" ~ "rainbow_darter",
                                 species.1 == "LNS" ~ "longnose_sucker",
                                 species.1 == "SJC" ~ "shortjaw_cisco",
                                 species.1 == "DWS" ~ "deepwater_sculpin",
                                 species.1 == "SHS" ~ "spoonhead_sculpin",
                                 species.1 == "BDD" ~ "banded_darter",
                                 species.1 == "MOE" ~ "mooneye",
                                 species.1 == "BLS" ~ "blue_sucker",
                                 species.1 == "SLC" ~ "silver_chub",
                                 species.1 == "HFS" ~ "highfin_carpsucker",
                                 species.1 == "MCP" ~ "mirror_carp",
                                 species.1 == "WAS" ~ "walleye/sauger",
                                 species.1 == "AME" ~ "american_eel",
                                 species.1 == "GOF" ~ "goldfish",
                                 species.1 == "SPS" ~ "spotted_sucker",
                                 species.1 == "PAH" ~ "paddlefish",
                                 species.1 == "RVD" ~ "river_darter",
                                 species.1 == "NHS" ~ "northern_hog_sucker",
                                 species.1 == "BHM" ~ "bullhead_minnow",
                                 species.1 == "WSD" ~ "western_sand_darter",
                                 species.1 == "MDD" ~ "mud_darter",
                                 species.1 == "SIL" ~ "silver_lamprey",
                                 species.1 == "SKJ" ~ "skipjack_herring",
                                 species.1 == "PGM" ~ "pugnose_minnow",
                                 species.1 == "BKB" ~ "black_buffalo",
                                 species.1 == "FTD" ~ "fantail_darter",
                                 species.1 == "YLB" ~ "yellow_bass",
                                 species.1 == "PRP" ~ "pirate_perch",
                                 species.1 == "LKC" ~ "lake_chub",
                                 species.1 == "RIR" ~ "river_ruffe",
                                 species.1 == "WHP" ~ "white_perch",
                                 species.1 == "ALW" ~ "alewife",
                                 species.1 == "SEL" ~ "sea_lamprey",
                                 species.1 == "BHC" ~ "bighead_carp",
                                 species.1 == "GLD" ~ "gilt_darter",
                                 species.1 == "CRD" ~ "crystal_darter",
                                 species.1 == "SMT" ~ "speckled_madtom",
                                 species.1 == "RDS" ~ "red_shiner",
                                 species.1 == "WAM" ~ "warmouth",
                                 species.1 == "tullibee (cisco)" ~ "cisco",
                                 species.1 == "trout-perch" ~ "trout_perch",
                                 species.1 == "bowfin (dogfish)" ~ "bowfin",
                                 TRUE ~ species.1)) %>%
  mutate(species.new = str_replace_all(species.new, " ", "_")) %>% 
  mutate(species.new = tolower(species.new)) %>% 
  group_by(species.new) %>% 
  summarise(mean.length = mean(length.1, na.rm = T), min.length = min(length.1, na.rm = T), max.length = max(length.1, na.rm = T), mean.weight = mean(weight.1, na.rm = T), min.weight = min(weight.1, na.rm = T), max.weight = max(weight.1, na.rm = T)) %>% 
  collect() %>% 
  print(n = nrow(.))

#length unit
mn_data %>% 
  group_by(length_unit.1) %>% 
  summarise(n = n()) %>% 
  collect()

#Are the cases of na length unit when length is na?
mn_data %>% 
  filter(is.na(length.1) & is.na(length_unit.1)) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#7867520 are missing both length and length unit

#cases where there are lengths without any length units
mn_data %>% 
  filter(!is.na(length.1) & is.na(length_unit.1)) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

#weight units
mn_data %>% 
  group_by(weight_unit.1) %>% 
  summarise(n = n()) %>% 
  collect()

#weight nas
mn_data %>% 
  filter(is.na(weight.1) & is.na(weight_unit.1)) %>% 
  summarise(n = n()) %>% 
  collect()

#cases where there are weights without any length units
mn_data %>% 
  filter(!is.na(weight.1) & is.na(weight_unit.1)) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
####there are no cases of a weight missing a unit

#age yrs
mn_data %>% 
  select(contains("age"))
#column for age

#how many nas?
mn_data %>% 
  filter(!is.na(age)) %>% 
  summarise(n = n()) %>% 
  collect()
#1273674 cases with ages

#age by species?
mn_data %>% 
  mutate(species.new = case_when(species.1 == "LMB" ~ "largemouth_bass",
                                 species.1 == "SMB" ~ "smallmouth_bass",
                                 species.1 == "WAE" ~ "walleye", 
                                 species.1 == "WTS" ~ "white_sucker",
                                 species.1 == "BLC" ~ "black_crappie",
                                 species.1 == "YEP" ~ "yellow_perch",
                                 species.1 == "BLG" ~ "bluegill",
                                 species.1 == "NOP" ~ "northern_pike",
                                 species.1 == "PMK" ~ "pumpkinseed", 
                                 species.1 == "RKB" ~ "rock_bass",
                                 species.1 == "BKF" ~ "banded_killifish",
                                 species.1 == "IOD" ~ "iowa_darter",
                                 species.1 == "BCS" ~ "blackchin_shiner",
                                 species.1 == "BLB" ~ "black_bullhead",
                                 species.1 == "JND" ~ "johnny_darter",
                                 species.1 == "GOS" ~ "golden_shiner",
                                 species.1 == "YEB" ~ "yellow_bullhead",
                                 species.1 == "BRB" ~ "brown_bullhead",
                                 species.1 == "CNM" ~ "central_mudminnow",
                                 species.1 == "NRD" ~ "northern_redbelly_dace",
                                 species.1 == "CSH" ~ "chinook_salmon",
                                 species.1 == "MTS" ~ "mottled_sculpin",
                                 species.1 == "TPM" ~ "tadpole_madtom",
                                 species.1 == "SHR" ~ "shorthead_redhorse",
                                 species.1 == "HSF" ~ "hybrid_sunfish",
                                 species.1 == "BOF" ~ "bowfin",
                                 species.1 == "WDS" ~ "weed_shiner",
                                 species.1 == "BNM" ~ "bluntnose_minnow",
                                 species.1 == "BND" ~ "blacknose_dace",
                                 species.1 == "OTM" ~ "minnows",
                                 species.1 == "FHM" ~ "fathead_minnow",
                                 species.1 == "FND" ~ "finescale_dace",
                                 species.1 == "SDM" ~ "slender_madtom",
                                 species.1 == "SPO" ~ "spottail_shiner",
                                 species.1 == "BNS" ~ "blacknose_shiner",
                                 species.1 == "BKT" ~ "brook_trout",
                                 species.1 == "SPT" ~ "splake",
                                 species.1 == "RBT" ~ "rainbow_trout",
                                 species.1 == "BNT" ~ "brown_trout",
                                 species.1 == "BUB" ~ "burbot",
                                 species.1 == "BIB" ~ "bigmouth_buffalo",
                                 species.1 == "BLH" ~ "bullheads",
                                 species.1 == "TLC" ~ "cisco",
                                 species.1 == "CCF" ~ "channel_catfish",
                                 species.1 == "BSD" ~ "blackside_darter",
                                 species.1 == "BKS" ~ "brook_silverside",
                                 species.1 == "LED" ~ "least_darter",
                                 species.1 == "LGP" ~ "logperch",
                                 species.1 == "SLR" ~ "silver_redhorse",
                                 species.1 == "HHC" ~ "hornyhead_chub",
                                 species.1 == "MUE" ~ "muskellunge",
                                 species.1 == "TRP" ~ "trout_perch",
                                 species.1 == "RHS" ~ "redhorse",
                                 species.1 == "CAP" ~ "common_carp",
                                 species.1 == "MMS" ~ "mimic_shiner",
                                 species.1 == "EMS" ~ "emerald_shiner",
                                 species.1 == "SUN" ~ "sunfish",
                                 species.1 == "CRC" ~ "creek_chub",
                                 species.1 == "GSF" ~ "green_sunfish",
                                 species.1 == "SFS" ~ "spotfin_shiner",
                                 species.1 == "SHI" ~ "shiners",
                                 species.1 == "BST" ~ "brook_stickleback",
                                 species.1 == "CSR" ~ "central_stoneroller",
                                 species.1 == "SDS" ~ "sand_shiner",
                                 species.1 == "GRR" ~ "greater_redhorse",
                                 species.1 == "PGS" ~ "pugnose_shiner",
                                 species.1 == "SMS" ~ "slimy_sculpin",
                                 species.1 == "LND" ~ "longnose_dace",
                                 species.1 == "FRD" ~ "freshwater_drum",
                                 species.1 == "WHC" ~ "white_crappie",
                                 species.1 == "DAR" ~ "darters",
                                 species.1 == "SAR" ~ "sauger",
                                 species.1 == "FCF" ~ "flathead_catfish",
                                 species.1 == "BMS" ~ "bigmouth_shiner",
                                 species.1 == "LKS" ~ "lake_sturgeon",
                                 species.1 == "LKW" ~ "lake_whitefish",
                                 species.1 == "BRM" ~ "brassy_minnow",
                                 species.1 == "SLM" ~ "mississippi_silvery_minnow",
                                 species.1 == "GLR" ~ "golden_redhorse",
                                 species.1 == "OTS" ~ "suckers",
                                 species.1 == "NST" ~ "ninespine_stickleback",
                                 species.1 == "GOE" ~ "goldeye",
                                 species.1 == "QBS" ~ "quillback",
                                 species.1 == "RVS" ~ "river_shiner",
                                 species.1 == "LES" ~ "longear_sunfish",
                                 species.1 == "CHL" ~ "chestnut_lamprey",
                                 species.1 == "RRH" ~ "river_redhorse",
                                 species.1 == "WHB" ~ "white_bass",
                                 species.1 == "OSS" ~ "orangespotted_sunfish",
                                 species.1 == "STC" ~ "stonecat",
                                 species.1 == "SNG" ~ "shortnose_gar",
                                 species.1 == "RFS" ~ "rosyface_shiner",
                                 species.1 == "CMS" ~ "carmine_shiner",
                                 species.1 == "SAB" ~ "smallmouth_buffalo",
                                 species.1 == "GIS" ~ "gizzard_shad",
                                 species.1 == "LNG" ~ "longnose_gar",
                                 species.1 == "RCS" ~ "river_carpsucker",
                                 species.1 == "SLS" ~ "shovelnose_sturgeon",
                                 species.1 == "LAT" ~ "lake_trout",
                                 species.1 == "TME" ~ "tiger_muskellunge",
                                 species.1 == "PRD" ~ "pearl_dace",
                                 species.1 == "PLS" ~ "pallid_shiner",
                                 species.1 == "RBS" ~ "rainbow_smelt",
                                 species.1 == "RBD" ~ "rainbow_darter",
                                 species.1 == "LNS" ~ "longnose_sucker",
                                 species.1 == "SJC" ~ "shortjaw_cisco",
                                 species.1 == "DWS" ~ "deepwater_sculpin",
                                 species.1 == "SHS" ~ "spoonhead_sculpin",
                                 species.1 == "BDD" ~ "banded_darter",
                                 species.1 == "MOE" ~ "mooneye",
                                 species.1 == "BLS" ~ "blue_sucker",
                                 species.1 == "SLC" ~ "silver_chub",
                                 species.1 == "HFS" ~ "highfin_carpsucker",
                                 species.1 == "MCP" ~ "mirror_carp",
                                 species.1 == "WAS" ~ "walleye/sauger",
                                 species.1 == "AME" ~ "american_eel",
                                 species.1 == "GOF" ~ "goldfish",
                                 species.1 == "SPS" ~ "spotted_sucker",
                                 species.1 == "PAH" ~ "paddlefish",
                                 species.1 == "RVD" ~ "river_darter",
                                 species.1 == "NHS" ~ "northern_hog_sucker",
                                 species.1 == "BHM" ~ "bullhead_minnow",
                                 species.1 == "WSD" ~ "western_sand_darter",
                                 species.1 == "MDD" ~ "mud_darter",
                                 species.1 == "SIL" ~ "silver_lamprey",
                                 species.1 == "SKJ" ~ "skipjack_herring",
                                 species.1 == "PGM" ~ "pugnose_minnow",
                                 species.1 == "BKB" ~ "black_buffalo",
                                 species.1 == "FTD" ~ "fantail_darter",
                                 species.1 == "YLB" ~ "yellow_bass",
                                 species.1 == "PRP" ~ "pirate_perch",
                                 species.1 == "LKC" ~ "lake_chub",
                                 species.1 == "RIR" ~ "river_ruffe",
                                 species.1 == "WHP" ~ "white_perch",
                                 species.1 == "ALW" ~ "alewife",
                                 species.1 == "SEL" ~ "sea_lamprey",
                                 species.1 == "BHC" ~ "bighead_carp",
                                 species.1 == "GLD" ~ "gilt_darter",
                                 species.1 == "CRD" ~ "crystal_darter",
                                 species.1 == "SMT" ~ "speckled_madtom",
                                 species.1 == "RDS" ~ "red_shiner",
                                 species.1 == "WAM" ~ "warmouth",
                                 species.1 == "tullibee (cisco)" ~ "cisco",
                                 species.1 == "trout-perch" ~ "trout_perch",
                                 species.1 == "bowfin (dogfish)" ~ "bowfin",
                                 TRUE ~ species.1)) %>%
  mutate(species.new = str_replace_all(species.new, " ", "_")) %>% 
  mutate(species.new = tolower(species.new)) %>% 
  filter(!is.na(age)) %>% 
  group_by(species.new) %>%
  summarise(median = median(age), min = min (age), max = max(age), n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#ages 382 and 116 for walleye and northern pike seem unreasonable

#effort
mn_data %>% 
  select(contains("effort"))
#total_effort_1.1

mn_data %>% 
  filter(!is.na(total_effort_1.1)) %>% 
  summarise(mean = mean(total_effort_1.1), min =min(total_effort_1.1), max = max(total_effort_1.1)) %>% 
  collect()
#no effort units, we have a negative effort? 

#survey id
mn_data %>% 
  group_by(survey_id) %>% 
  summarise(n = n()) %>% 
  collect()
```

#JDM Team
```{r}
#######################Michigan#####################################
#sampling method
#what sampling methods do we have and how many?
mi_data %>% 
  group_by(sampling_method) %>% 
  summarise(n = n()) %>% 
  print(n = nrow(.))

mi_data %>% 
  count(is.na(length.1))

#survey type 
mi_data %>% 
  group_by(survey_type.1_effort) %>% 
  summarise(n = n()) %>% 
  print(n = nrow(.))

#how many surveys have na survey types?
#just one - 4042
mi_data %>% 
  filter(is.na(survey_type.1_effort)) %>% 
  group_by(survey_id) %>% 
  summarise(n = n()) %>% 
  print(n = nrow(.))
mi_data %>% 
  filter(is.na(survey_type.1_effort)) %>% 
  group_by(sampling_method, species.1) %>% 
  summarise(mean = mean(length.1), min = min (length.1), max = max(length.1), n = n()) %>% 
  print(n = nrow(.))

#visualizing sampling methods by sampling gear and species 
#can we lump all fyke net/trap nets together, same thing for gill nets?

#all inclusive
mi_data %>% 
  mutate(sampling_method_agg = case_when(sampling_method %in% c("large_mesh_fyke_net", "small_mesh_fyke_net", "trap_net") ~ "fyke_net",
                                         sampling_method %in% c("great_lakes_gill_net", "inland_gill_net") ~ "gill_net",
                                         sampling_method == "boomshocking" ~ "boat_electrofishing",
                                         sampling_method == "seine" ~ "seine")) %>% 
  ggplot() +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(species.1~sampling_method_agg, scales = "free")

#only fyke net
mi_data %>% 
  mutate(sampling_method_agg = case_when(sampling_method %in% c("large_mesh_fyke_net", "small_mesh_fyke_net", "trap_net") ~ "fyke_net",
                                         sampling_method %in% c("great_lakes_gill_net", "inland_gill_net") ~ "gill_net",
                                         sampling_method == "boomshocking" ~ "boat_electrofishing",
                                         sampling_method == "seine" ~ "seine")) %>% 
  filter(sampling_method_agg == "fyke_net") %>% 
  filter(species.1 != "taxon_NA") %>%
  ggplot() +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15))
#small mesh fyke sets look fairly different for largemouth bass and yellow perch

#remove small mesh fyke
mi_data %>% 
  mutate(sampling_method_agg = case_when(sampling_method %in% c("large_mesh_fyke_net", "small_mesh_fyke_net", "trap_net") ~ "fyke_net",
                                         sampling_method %in% c("great_lakes_gill_net", "inland_gill_net") ~ "gill_net",
                                         sampling_method == "boomshocking" ~ "boat_electrofishing",
                                         sampling_method == "seine" ~ "seine")) %>% 
  filter(sampling_method_agg == "fyke_net") %>% 
  filter(species.1 != "taxon_NA") %>%
  filter(sampling_method != "small_mesh_fyke_net") %>% 
  mutate(species.1 = case_when(species.1 == "blue_gill" ~ "bluegill",
                               TRUE ~ species.1)) %>% 
  ggplot() +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15)) +
  ggtitle("Michigan Fyke/Trap Nets")
ggsave("MI_Fyke.png", width = 7, height = 5)


#only gill net
mi_data %>% 
  mutate(sampling_method_agg = case_when(sampling_method %in% c("large_mesh_fyke_net", "small_mesh_fyke_net", "trap_net") ~ "fyke_net",
                                         sampling_method %in% c("great_lakes_gill_net", "inland_gill_net") ~ "gill_net",
                                         sampling_method == "boomshocking" ~ "boat_electrofishing",
                                         sampling_method == "seine" ~ "seine")) %>% 
  filter(sampling_method_agg == "gill_net") %>% 
  filter(species.1 != "taxon_NA") %>% 
  ggplot() +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15))
#great lake gill nets only caught cisco, smallmouth bass, northern pike, and yellow perch
#size recruited to the net looks different for northern pike and smallmouth bass

#removing great lakes gill net
mi_data %>% 
  mutate(sampling_method_agg = case_when(sampling_method %in% c("large_mesh_fyke_net", "small_mesh_fyke_net", "trap_net") ~ "fyke_net",
                                         sampling_method %in% c("great_lakes_gill_net", "inland_gill_net") ~ "gill_net",
                                         sampling_method == "boomshocking" ~ "boat_electrofishing",
                                         sampling_method == "seine" ~ "seine")) %>% 
  filter(sampling_method_agg == "gill_net") %>% 
  filter(species.1 != "taxon_NA") %>% 
  filter(sampling_method != "great_lakes_gill_net") %>% 
  ggplot() +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15))

#Quartiles fish length  by species and state
mi_data %>%
  filter(!is.na(length.1)) %>% 
  group_by(species.1, sampling_method) %>%
  summarise(q1 = quantile(length.1, probs = 0.20),
    median = quantile(length.1, probs = 0.50),
    q3 = quantile(length.1, probs = 0.80)) %>% 
  print(n = nrow(.))

####################Wisconsin##############################
#sampling method
#what sampling methods do we have and how many?
wi_data %>% 
  group_by(sampling_method) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  arrange(n) %>% 
  print( n = nrow(.)) 

#hoop nets?
wi_data %>% 
  filter(sampling_method == "hoop_net") %>% 
  group_by(lake_name.1) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

wi_data %>% 
  filter(sampling_method == "hoop_trap") %>% 
  group_by(lake_name.1) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

wi_data %>% 
  filter(sampling_method == "hoop_net") %>% 
  summarise(n = n()) %>% 
  collect() 


#visualizing sampling methods by sampling gear and species 
#can we lump all fyke net/trap nets together, same thing for gill nets?

#all inclusive
glimpse(wi_data)

#survey type
wi_data %>% 
  group_by(survey_type.2_indivfish) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  arrange(desc(n)) %>%
  print(n = nrow(.))

#selecting for representative survey types
#original survey types
wi_data %>% 
  group_by(survey_type.1_indivfish) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  arrange(desc(n)) %>% 
  print(n = nrow(.))

#selecting for representative survey types
wi_data %>% 
  filter(is.na(survey_type.1_indivfish) |
        !(survey_type.1_indivfish == "special_study" |
         survey_type.1_indivfish == "fisheries_assessments_rivers" |
         survey_type.1_indivfish == "fisheries_assessments_stream_smallmouth_bass" |
         survey_type.1_indivfish == "winterkill_investigation" |
         survey_type.1_indivfish == "non_dnr_cooperator_study"|
         survey_type.1_indivfish =="fisheries_assessments_trout_rotation"|
         survey_type.1_indivfish == "fisheries_assessments_trout_trend"|
         survey_type.1_indivfish == "habitat_improvement_evaluation"|
         survey_type.1_indivfish =="research_project"|
         survey_type.1_indivfish == "fish_kill_investigation"|
         survey_type.1_indivfish == "epa_national_stream_river_assessment"|
         survey_type.1_indivfish =="fisheries_assessments_trout_potential"|
         survey_type.1_indivfish =="severely_impacted"|
         survey_type.1_indivfish =="fish_passage_study"|
         survey_type.1_indivfish == "use_designation"|
         survey_type.1_indivfish == "creel,_access_point"|
         survey_type.1_indivfish == "treaty_fisheries_assessment"|
         str_detect(survey_type.1_indivfish, "watershed"))) %>% 
  group_by(survey_type.1_indivfish) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  arrange(desc(n)) %>%
  print(n = nrow(.))

#are these survey types capturing all populations?
wi_data %>% 
  filter(is.na(survey_type.1_indivfish) |
        !(survey_type.1_indivfish == "special_study" |
         survey_type.1_indivfish == "fisheries_assessments_rivers" |
         survey_type.1_indivfish == "fisheries_assessments_stream_smallmouth_bass" |
         survey_type.1_indivfish == "winterkill_investigation" |
         survey_type.1_indivfish == "non_dnr_cooperator_study"|
         survey_type.1_indivfish =="fisheries_assessments_trout_rotation"|
         survey_type.1_indivfish == "fisheries_assessments_trout_trend"|
         survey_type.1_indivfish == "habitat_improvement_evaluation"|
         survey_type.1_indivfish == "fish_kill_investigation"|
         survey_type.1_indivfish == "epa_national_stream_river_assessment"|
         survey_type.1_indivfish =="fisheries_assessments_trout_potential"|
         survey_type.1_indivfish =="research_project"|
         survey_type.1_indivfish =="severely_impacted"|
         survey_type.1_indivfish =="fish_passage_study"|
         survey_type.1_indivfish == "use_designation"|
         survey_type.1_indivfish == "creel,_access_point"|
         survey_type.1_indivfish == "treaty_fisheries_assessment"|
         str_detect(survey_type.1_indivfish, "watershed"))) %>% 
  select(length.1, species.1, survey_type.1_indivfish) %>% 
  collect() %>% 
  filter(length.1 < 100) %>% 
  ggplot() +
  geom_density(aes(length.1, fill = species.1, alpha = .5)) +
  facet_wrap(~survey_type.1_indivfish, scales = "free") +
  theme(legend.position = "none")

#table for selected survey types
wi_data %>% 
  filter(is.na(survey_type.1_indivfish) |
        !(survey_type.1_indivfish == "special_study" |
         survey_type.1_indivfish == "fisheries_assessments_rivers" |
         survey_type.1_indivfish == "fisheries_assessments_stream_smallmouth_bass" |
         survey_type.1_indivfish == "winterkill_investigation" |
         survey_type.1_indivfish == "non_dnr_cooperator_study"|
         survey_type.1_indivfish =="fisheries_assessments_trout_rotation"|
         survey_type.1_indivfish == "fisheries_assessments_trout_trend"|
         survey_type.1_indivfish == "habitat_improvement_evaluation"|
         survey_type.1_indivfish == "fish_kill_investigation"|
         survey_type.1_indivfish == "epa_national_stream_river_assessment"|
         survey_type.1_indivfish =="fisheries_assessments_trout_potential"|
         survey_type.1_indivfish =="research_project"|
         survey_type.1_indivfish =="severely_impacted"|
         survey_type.1_indivfish =="fish_passage_study"|
         survey_type.1_indivfish == "use_designation"|
         survey_type.1_indivfish == "creel,_access_point"|
         survey_type.1_indivfish == "treaty_fisheries_assessment"|
         str_detect(survey_type.1_indivfish, "watershed"))) %>% 
  group_by(survey_type.1_indivfish, species.1) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  arrange(survey_type.1_indivfish, desc(n)) %>% 
  print(n = nrow(.))

#table of excluded survey types
wi_data %>% 
  filter(survey_type.1_indivfish == "special_study" |
         survey_type.1_indivfish == "fisheries_assessments_rivers" |
         survey_type.1_indivfish == "fisheries_assessments_stream_smallmouth_bass" |
         survey_type.1_indivfish == "winterkill_investigation" |
         survey_type.1_indivfish == "non_dnr_cooperator_study"|
         survey_type.1_indivfish =="fisheries_assessments_trout_rotation"|
         survey_type.1_indivfish == "fisheries_assessments_trout_trend"|
         survey_type.1_indivfish == "habitat_improvement_evaluation"|
         survey_type.1_indivfish == "fish_kill_investigation"|
         survey_type.1_indivfish == "epa_national_stream_river_assessment"|
         survey_type.1_indivfish =="fisheries_assessments_trout_potential"|
         survey_type.1_indivfish =="research_project"|
         survey_type.1_indivfish =="severely_impacted"|
         survey_type.1_indivfish =="fish_passage_study"|
         survey_type.1_indivfish == "use_designation"|
         survey_type.1_indivfish == "creel,_access_point"|
         survey_type.1_indivfish == "treaty_fisheries_assessment"|
         str_detect(survey_type.1_indivfish, "watershed")) %>% 
  group_by(survey_type.1_indivfish, species.1) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  arrange(survey_type.1_indivfish, desc(n)) %>% 
  print(n = nrow(.))

#what about the other survey types?
wi_data %>% 
  group_by(survey_type.1_effort) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.)) 

wi_data %>% 
  group_by(survey_type.2_effort) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#effort column does not look very helpful?

wi_data %>% 
  group_by(survey_type.2_indivfish) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.)) 

wi_data %>% 
  filter(is.na(survey_type.1_indivfish) & !is.na(survey_type.2_indivfish)) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))
#there are no cases where survey type 2 would provide more information than 1

#how are cisco being captured?
wi_data %>% 
  filter(species.1 == "cisco/lake_herring") %>% 
  group_by(sampling_method) %>% 
  summarise(n = n()) %>% 
  collect() %>% 
  print(n = nrow(.))

gear.plot.wi <- wi_data %>% 
  mutate(sampling_method_agg = case_when(sampling_method %in% c("fyke_net", 
                                                                "mini_fyke_net",
                                                                "mini_fyke_net_with_turtle_exclusion", 
                                                                "mini_fyke_net_without_turtle_exclusion",
                                                                "mini_fyke_net_with_unknown_turtle_exclusion",
                                                                "trap_net",
                                                                "hoop_net", 
                                                                "hoop_trap") ~ "fyke_net",
                                         sampling_method %in% c("bottom_gill_net", 
                                                                "gillnet", 
                                                                "vertical_gill_net",
                                                                "floating_gill_net",
                                                                "trammel_net") ~ "gill_net",
                                         sampling_method %in% c("boom_shocker", 
                                                                "mini_boom_shocker",
                                                                "mini-boom_shocker",
                                                                "boom_shocker_or_mini-boom_shocker",
                                                                "dc_boom_shocker") ~ "boat_electrofishing",
                                         sampling_method %in% c("stream_shocker", 
                                                                "backpack_shocker") ~ "backpack_electrofishing",
                                         sampling_method %in% c("seine", 
                                                                "small-mesh_seine", 
                                                                "elec_seine") ~ "seine",
                                         sampling_method %in% c("trawl",
                                                                "bottom_trawl", 
                                                                "surface_trawl",
                                                                "mid-water_trawl") ~ "trawl",
                                         sampling_method == "poison" ~ "poison",
                                         sampling_method == "spearing" ~ "spear")) %>% 
  select(state, species.1, sampling_method, sampling_method_agg, length.1, date.1, survey_id, survey_type.1_indivfish) %>% 
  filter(!is.na(length.1)) %>% 
  filter(species.1 %in% c("walleye", 
                          "northern_pike",
                          "largemouth_bass", 
                          "smallmouth_bass", 
                          "yellow_perch", 
                          "black_crappie", 
                          "bluegill", 
                          "cisco/lake_herring")) %>% 
  collect()

#survey type


#all together
ggplot(gear.plot.wi) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(species.1~sampling_method_agg, scales = "free")

#fyke net only 
ggplot(gear.plot.wi %>% 
         filter(sampling_method_agg == "fyke_net") %>% 
         filter((length.1 < 15 & species.1 == "black_crappie") | 
                (length.1 < 12 & species.1 == "bluegill") |
                (length.1 < 30 & species.1 == "largemouth_bass") |
                (length.1 < 50 & species.1 == "northern_pike") |
                (length.1 < 25 & species.1 == "smallmouth_bass") |
                (length.1 < 35 & species.1 == "walleye") |
                (length.1 < 17 & species.1 == "yellow_perch"))) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15))

#remove minis (they do not capture adult fish)
#remove hoop trap (not many observations and appear to be different for smallmouth)
ggplot(gear.plot.wi %>% 
         filter(sampling_method_agg == "fyke_net") %>% 
         filter(!(sampling_method %in% c("mini_fyke_net", 
                                         "mini_fyke_net_with_turtle_exclusion",
                                         "mini_fyke_net_without_turtle_exclusion",
                                         "mini_fyke_net_with_unknown_turtle_exclusion",
                                         "hoop_trap",
                                         "hoop_net"))) %>% 
         filter((length.1 < 15 & species.1 == "black_crappie") | 
                (length.1 < 12 & species.1 == "bluegill") |
                (length.1 < 30 & species.1 == "largemouth_bass") |
                (length.1 < 50 & species.1 == "northern_pike") |
                (length.1 < 25 & species.1 == "smallmouth_bass") |
                (length.1 < 35 & species.1 == "walleye") |
                (length.1 < 17 & species.1 == "yellow_perch"))) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15)) +
  ggtitle("Wisconsin Fyke/Trap")
ggsave("WI_Fyke.png", width = 7, height = 5)


#gill net only
ggplot(gear.plot %>% 
         filter(sampling_method_agg == "gill_net") %>% 
         filter((length.1 < 15 & species.1 == "black_crappie") | 
                (length.1 < 12 & species.1 == "bluegill") |
                (length.1 < 40 & species.1 == "largemouth_bass") |
                (length.1 < 60 & species.1 == "northern_pike") |
                (length.1 < 40 & species.1 == "smallmouth_bass") |
                (length.1 < 35 & species.1 == "walleye") |
                (length.1 < 17 & species.1 == "yellow_perch") |
                (length.1 < 20 & species.1 == "cisco/lake_herring"))) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15))

gear.plot %>% 
  filter(sampling_method_agg == "gill_net") %>% 
  group_by(sampling_method, species.1) %>% 
  summarise(n = n()) %>% 
  print(n = nrow(.))
#the only species with sizable obs from gill nets in wisconsin are cisco, walleye, northern pike, and yellow perch

#electrofishing
ggplot(gear.plot %>% 
         filter(sampling_method_agg == "boat_electrofishing") %>% 
         filter((length.1 < 25 & species.1 == "black_crappie") | 
                (length.1 < 15 & species.1 == "bluegill") |
                (length.1 < 30 & species.1 == "largemouth_bass") |
                (length.1 < 50 & species.1 == "northern_pike") |
                (length.1 < 40 & species.1 == "smallmouth_bass") |
                (length.1 < 35 & species.1 == "walleye") |
                (length.1 < 20 & species.1 == "yellow_perch"))) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15))

#trawl only
ggplot(gear.plot %>% 
         filter(sampling_method_agg == "trawl")) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(species.1~sampling_method_agg, scales = "free")

#seine
ggplot(gear.plot %>% 
         filter(sampling_method_agg == "seine")) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(species.1~sampling_method_agg, scales = "free")

#timing of gear types throughout the year
gear.plot <- gear.plot %>% 
  mutate(julian_day = format(date.1, "%j")) %>% 
  mutate(julian_day = as.numeric(julian_day)) # have to make it numeric

gear.plot %>% 
  filter(sampling_method_agg %in% c("gill_net", "fyke_net")) %>% 
  ggplot() +
  geom_density(aes(julian_day, fill = sampling_method_agg), alpha = 0.5) +
  theme_classic() +
  theme(legend.position = c(0.1, 0.6))

#######################Minnesota##############################################
gear.plot.mn <- mn_data %>% 
  mutate(sampling_method_agg = case_when(sampling_method %in% c("Standard 3/4-in mesh, double frame trap net sets", 
                                                                "1/4-in trap nets",
                                                                "Special sampling with trap nets", 
                                                                "Large-frame (5 x 6 ft) trap nets",
                                                                "3/8-in trap nets",
                                                                "3/4 inch single-frame trap net", 
                                                                "Trap Net - Mini Fyke",
                                                                "1-in trap nets",
                                                                "Double-pot 3/4-in-mesh double frame trap nets") ~ "fyke_net",
                                         sampling_method %in% c("Standard gill net sets", 
                                                                "Special sampling with gill nets", 
                                                                "Gill net fine mesh",
                                                                "Small mesh gill nets, 3/8 and 1/2-in mesh, 200 x 6 ft",
                                                                "Standard gill nets, set deep in stratified assessment",
                                                                "Standard Vertical Gillnet",
                                                                "Standard gill nets, set shallow in stratified assessment",
                                                                "FCIN gill nets",
                                                                "Monofilament gill nets, short-term sets",
                                                                "Multifilament GN; 300 x 6; three 100 panels 1.5-2.0-2.5",
                                                                "Standard gill nets, suspended sets",
                                                                "Trammel Net; 100 X 6 multifilament",
                                                                "Standard North American gill net") ~ "gill_net",
                                         sampling_method %in% c("Fall electrofishing for walleye", 
                                                                "Standard electrofishing",
                                                                "Special sampling, electrofishing") ~ "boat_electrofishing",
                                         sampling_method %in% c("Electrofishing, Backpack") ~ "backpack_electrofishing",
                                         sampling_method %in% c("Standard shoreline seining", 
                                                                "Seining, 50 foot 1/8 in Beach Seine for IBI", 
                                                                "Seining, 15 foot 1/8 in Beach Seine for IBI",
                                                                "Special sampling, seining") ~ "seine",
                                         sampling_method %in% c("Standard trawling",
                                                                "Special sampling, trawling") ~ "trawl")) %>% 
  select(state, species.1, sampling_method, sampling_method_agg, length.1, date_clean, survey_id_effort, survey_type.1) %>%
  filter(species.1 %in% c("WAE", 
                          "walleye", 
                          "LMB", 
                          "largemouth bass", 
                          "SMB", 
                          "smallmouth bass", 
                          "YEP", 
                          "yellow perch", 
                          "NOP", 
                          "northern pike", 
                          "BLG", 
                          "bluegill", 
                          "BLC", 
                          "black crappie", 
                          "TLC", 
                          "tullibee (cisco)")) %>% 
  filter(!is.na(length.1)) %>% 
  collect() %>% 
    mutate(species.1 = case_when(species.1 %in% c("WAE", "walleye") ~ "walleye",
                               species.1 %in% c("LMB", "largemouth bass") ~ "largemouth_bass",
                               species.1 %in% c("SMB", "smallmouth bass") ~ "smallmouth_bass",
                               species.1 %in% c("YEP", "yellow perch") ~ "yellow_perch",
                               species.1 %in% c("NOP", "northern pike") ~ "northern_pike",
                               species.1 %in% c("BLG", "bluegill") ~ "bluegill",
                               species.1 %in% c("BLC", "black crappie") ~ "black_crappie",
                               species.1 %in% c("TLC", "tullibee (cisco)") ~ "cisco")) %>% 
  rename(date.1 = date_clean)

#quick fix for MN species 
gear.plot %>% 
  group_by(species.1) %>% 
  summarise(n = n()) %>% 
  print(n = nrow(.))

#mn sampling methods
gear.plot.mn %>% 
  group_by(sampling_method) %>% 
  summarise(n = n()) %>% 
  print(n = nrow(.))

#fyke net only 
ggplot(gear.plot.mn %>% 
         filter(sampling_method_agg == "fyke_net") %>% 
         filter(!(species.1 == "black_crappie" & length.1>500))) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15))

#removing fyke net methods that are not consistent 
ggplot(gear.plot.mn %>% 
         filter(sampling_method_agg == "fyke_net") %>% 
         filter(!(sampling_method %in% c("Trap Net - Mini Fyke",
                                         "3/8-in trap nets",
                                         "1/4-in trap nets",
                                         "Double-pot 3/4-in-mesh double frame trap nets"))) %>% 
         filter(!(species.1 == "black_crappie" & length.1>500))) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15),
        legend.text = element_text(size = 8),    # Adjust the size of legend labels
  legend.title = element_text(size = 10),  # Adjust the size of legend title
  legend.key.size = unit(0.5, "lines")) +
  ggtitle("Minnesota Fyke/Trap")
ggsave("MN_Fyke.png", width = 7, height = 5)


#gill net only
ggplot(gear.plot.mn %>% 
         filter(sampling_method_agg == "gill_net")) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15))

#removing gear nets that are not consistent 
ggplot(gear.plot.mn %>% 
         filter(sampling_method_agg == "gill_net") %>% 
         filter(!(sampling_method %in% c("Small mesh gill nets, 3/8 and 1/2-in mesh, 200 x 6 ft",
                                         "FCIN gill nets",
                                         "Multifilament GN; 300 x 6; three 100 panels 1.5-2.0-2.5",
                                         "Monofilament gill nets, short-term sets",
                                         "Gill net fine mesh")))) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15),
        legend.text = element_text(size = 8),    # Adjust the size of legend labels
  legend.title = element_text(size = 10),  # Adjust the size of legend title
  legend.key.size = unit(0.5, "lines")) +
  ggtitle("Minnesota Gill Net")
ggsave("MN_Gillnet.png", width = 7, height = 5)

#trawl
ggplot(gear.plot %>% 
         filter(sampling_method_agg == "trawl")) +
  geom_density(aes(length.1, fill = sampling_method), adjust = 3, alpha = .5) +
  facet_wrap(~species.1, scales = "free") +
  theme_classic() +
  theme(legend.position = c(.8, .15))

#types of surveys
mn_data %>% 
  group_by(survey_type.1) %>% 
  summarise(n = n()) %>% 
  collect()

####################across states###############################
#I did a quick cleaning within states for methods, but species specific might be needed within Minnesota and Wisconsin
#cleaning Wisconsin
gear.plot.wi <- gear.plot.wi %>% 
         filter(sampling_method_agg == "fyke_net") %>% #no gill nets in WI
         filter(!(sampling_method %in% c("mini_fyke_net", #excluding methods not representative of adult pop.
                                         "mini_fyke_net_with_turtle_exclusion",
                                         "mini_fyke_net_without_turtle_exclusion",
                                         "mini_fyke_net_with_unknown_turtle_exclusion",
                                         "hoop_trap",
                                         "hoop_net"))) %>% 
  mutate(species.1 = case_when(species.1 == "cisco/lake_herring" ~ "cisco", #making Cisco name consistent 
                               TRUE ~ species.1)) %>% 
  filter(is.na(survey_type.1_indivfish) | #excluding survey types that do not sample abundance evenly 
        !(survey_type.1_indivfish == "special_study" |
         survey_type.1_indivfish == "fisheries_assessments_rivers" |
         survey_type.1_indivfish == "fisheries_assessments_stream_smallmouth_bass" |
         survey_type.1_indivfish == "winterkill_investigation" |
         survey_type.1_indivfish == "non_dnr_cooperator_study"|
         survey_type.1_indivfish =="fisheries_assessments_trout_rotation"|
         survey_type.1_indivfish == "fisheries_assessments_trout_trend"|
         survey_type.1_indivfish == "habitat_improvement_evaluation"|
         survey_type.1_indivfish =="research_project"|
         survey_type.1_indivfish == "fish_kill_investigation"|
         survey_type.1_indivfish == "epa_national_stream_river_assessment"|
         survey_type.1_indivfish =="fisheries_assessments_trout_potential"|
         survey_type.1_indivfish =="severely_impacted"|
         survey_type.1_indivfish =="fish_passage_study"|
         survey_type.1_indivfish == "use_designation"|
         survey_type.1_indivfish == "creel,_access_point"|
         survey_type.1_indivfish == "treaty_fisheries_assessment"|
         str_detect(survey_type.1_indivfish, "watershed"))) %>% 
  rename(survey_type = survey_type.1_indivfish)

#cleaning mi
gear.plot.mi <- mi_data %>% 
  mutate(sampling_method_agg = case_when(sampling_method %in% c("large_mesh_fyke_net", "small_mesh_fyke_net", "trap_net") ~ "fyke_net",
                                         sampling_method %in% c("great_lakes_gill_net", "inland_gill_net") ~ "gill_net",
                                         sampling_method == "boomshocking" ~ "boat_electrofishing",
                                         sampling_method == "seine" ~ "seine")) %>% #aggregating common sampling methods
  filter(sampling_method_agg %in% c("fyke_net", "gill_net")) %>% #selecting fyke/trap nets and gill nets for abundance 
  filter(species.1 != "taxon_NA") %>% #removing samples that do not have taxa
  filter(!(sampling_method %in% c("small_mesh_fyke_net", 
                                  "great_lakes_gill_net"))) %>% #removing gear types not representative of adult populations 
  filter(!is.na(survey_type.1_effort)) %>% #excluding na survey types 
  select(state, species.1, sampling_method, sampling_method_agg, length.1, date.1, survey_id, survey_type.1_effort) %>% 
  mutate(date.1 = as.Date(date.1)) %>% 
  mutate(length.1 = as.integer(length.1)) %>% 
  mutate(species.1 = case_when(species.1 == "blue_gill" ~ "bluegill",
                               TRUE ~ species.1)) %>% 
  rename(survey_type = survey_type.1_effort) %>% 
  mutate(state = "Michigan") %>% 
  collect()

#cleaning mn
gear.plot.mn <- gear.plot.mn %>% 
         filter(sampling_method_agg %in% c("fyke_net", "gill_net")) %>% 
         filter(!(sampling_method %in% c("Trap Net - Mini Fyke", #removing gear types not representative of adult pop. or has specific timing of year
                                         "3/8-in trap nets",
                                         "1/4-in trap nets",
                                         "Double-pot 3/4-in-mesh double frame trap nets",
                                         "Small mesh gill nets, 3/8 and 1/2-in mesh, 200 x 6 ft",
                                         "FCIN gill nets",
                                         "Multifilament GN; 300 x 6; three 100 panels 1.5-2.0-2.5",
                                         "Monofilament gill nets, short-term sets",
                                         "Gill net fine mesh",
                                         "Special sampling with gill nets",
                                         "Special sampling with trap nets", 
                                         "Standard gill nets, set deep in stratified assessment",
                                         "Standard gill nets, set shallow in stratified assessment",
                                         "Standard gill nets, suspended sets",
                                         "Standard Vertical Gillnet",
                                         "1-in trap nets", #mostly used in the spring 
                                         "3/4 inch single-frame trap net",
                                         "Large-frame (5 x 6 ft) trap nets"))) %>% 
  filter(!(survey_type.1 %in% c("Winter Kill Assessment", 
                                "External Management Survey", 
                                "Subsurvey",
                                "Natural Reproduction Check", 
                                "Targeted Survey", 
                                "Dissolved Oxygen Check"))) %>% #removing surveys not representative of abundance 
  mutate(state = "Minnesota") %>% 
  rename(survey_id = survey_id_effort) %>% 
  rename(survey_type = survey_type.1)

gear.plot <- rbind(gear.plot.mn, gear.plot.wi, gear.plot.mi)
gear.plot <- gear.plot %>% 
  mutate(julian_day = format(date.1, "%j")) %>% 
  mutate(julian_day = as.numeric(julian_day))

#survey level
gear.plot.survey <- gear.plot %>% 
  group_by(state, survey_id, sampling_method_agg) %>% 
  summarise(julian_day = unique(julian_day)) 

gear.plot.survey %>% 
  group_by(state) %>% 
  summarise(n = n())

#fyke net
gear.plot.survey %>%
  filter(sampling_method_agg == "fyke_net") %>% 
  ggplot() +
  geom_density(aes(julian_day, fill = state), alpha = 0.5) +
  theme_classic() +
  theme(legend.position = c(0.9, 0.3)) +
  ggtitle("State Timing Fyke")
ggsave("State_Timing_Fyke.png", width = 7, height = 5)

#gill net
gear.plot.survey %>%
  filter(sampling_method_agg == "gill_net") %>% 
  ggplot() +
  geom_density(aes(julian_day, fill = state), alpha = 0.5) +
  theme_classic() +
  theme(legend.position = c(0.9, 0.28)) +
  ggtitle("State Timing Gill Net")
ggsave("State_Timing_Gillnet.png", width = 7, height = 5)

#within states timing of sampling
#overall
gear.plot %>% 
  group_by(state, survey_id, sampling_method, sampling_method_agg) %>% 
  summarise(julian_day = unique(julian_day)) %>% 
  ggplot() +
  geom_density(aes(julian_day, fill = sampling_method), alpha = 0.5) +
  facet_grid(state~sampling_method_agg, scales = "free") +
  theme_classic() 

#state by state
gear.plot %>% 
  filter(state == "Michigan") %>% 
  group_by(state, survey_id, sampling_method, sampling_method_agg) %>% 
  summarise(julian_day = unique(julian_day)) %>% 
  ggplot() +
  geom_density(aes(julian_day, fill = sampling_method), alpha = 0.5) +
  theme_classic()+
  theme(legend.position = c(0.8, 0.28)) 
ggsave("MI_sample_timing.png", width = 7, height = 5)

gear.plot %>% 
  filter(state == "Wisconsin") %>% 
  group_by(state, survey_id, sampling_method, sampling_method_agg) %>% 
  summarise(julian_day = unique(julian_day)) %>% 
  ggplot() +
  geom_density(aes(julian_day, fill = sampling_method), alpha = 0.5) +
  theme_classic() +
  theme(legend.position = c(0.8, 0.28)) 
ggsave("WI_sample_timing.png", width = 7, height = 5)

gear.plot %>% 
  filter(state == "Minnesota") %>% 
  group_by(state, survey_id, sampling_method, sampling_method_agg) %>% 
  summarise(julian_day = unique(julian_day)) %>% 
  ggplot() +
  geom_density(aes(julian_day, fill = sampling_method), alpha = 0.5) +
  theme_classic() +
  theme(legend.position = c(0.25, 0.9),
        legend.key.size = unit(.2, "cm"),
        legend.text = element_text(size = 5)) 
#after looking at this chart, non-standard trap nets were removed due to difference in deployment times
ggsave("MN_sample_timing.png", width = 7, height = 5)

#species time of year
gear.plot %>% 
  group_by(state, survey_id, species.1) %>% 
  summarise(julian_day = unique(julian_day), catch = n()) %>% 
  ggplot() +
  geom_density(aes(julian_day, fill = species.1), alpha = 0.5) +
  theme_classic() +
  theme(legend.position = c(0.2, 0.85)) +
  facet_wrap(~state, scales = "free")
```

#Minimum effort exploration
```{r}
#################################################Minnesota#####################################################
effort.mn <- mn_data %>% 
  mutate(sampling_method_agg = case_when(sampling_method %in% c("Standard 3/4-in mesh, double frame trap net sets", 
                                                                "1/4-in trap nets",
                                                                "Special sampling with trap nets", 
                                                                "Large-frame (5 x 6 ft) trap nets",
                                                                "3/8-in trap nets",
                                                                "3/4 inch single-frame trap net", 
                                                                "Trap Net - Mini Fyke",
                                                                "1-in trap nets",
                                                                "Double-pot 3/4-in-mesh double frame trap nets") ~ "fyke_net",
                                         sampling_method %in% c("Standard gill net sets", 
                                                                "Special sampling with gill nets", 
                                                                "Gill net fine mesh",
                                                                "Small mesh gill nets, 3/8 and 1/2-in mesh, 200 x 6 ft",
                                                                "Standard gill nets, set deep in stratified assessment",
                                                                "Standard Vertical Gillnet",
                                                                "Standard gill nets, set shallow in stratified assessment",
                                                                "FCIN gill nets",
                                                                "Monofilament gill nets, short-term sets",
                                                                "Multifilament GN; 300 x 6; three 100 panels 1.5-2.0-2.5",
                                                                "Standard gill nets, suspended sets",
                                                                "Trammel Net; 100 X 6 multifilament",
                                                                "Standard North American gill net") ~ "gill_net",
                                         sampling_method %in% c("Fall electrofishing for walleye", 
                                                                "Standard electrofishing",
                                                                "Special sampling, electrofishing") ~ "boat_electrofishing",
                                         sampling_method %in% c("Electrofishing, Backpack") ~ "backpack_electrofishing",
                                         sampling_method %in% c("Standard shoreline seining", 
                                                                "Seining, 50 foot 1/8 in Beach Seine for IBI", 
                                                                "Seining, 15 foot 1/8 in Beach Seine for IBI",
                                                                "Special sampling, seining") ~ "seine",
                                         sampling_method %in% c("Standard trawling",
                                                                "Special sampling, trawling") ~ "trawl")) %>% 
  select(state, lake_id, species.1, sampling_method, sampling_method_agg, length.1, date_clean, survey_id_effort, survey_type.1, total_effort_1.1) %>%
  filter(species.1 %in% c("WAE", 
                          "walleye", 
                          "LMB", 
                          "largemouth bass", 
                          "SMB", 
                          "smallmouth bass", 
                          "YEP", 
                          "yellow perch", 
                          "NOP", 
                          "northern pike", 
                          "BLG", 
                          "bluegill", 
                          "BLC", 
                          "black crappie", 
                          "TLC", 
                          "tullibee (cisco)")) %>% 
    filter(!is.na(length.1)) %>% 
    mutate(species.1 = case_when(species.1 %in% c("WAE", "walleye") ~ "walleye",
                               species.1 %in% c("LMB", "largemouth bass") ~ "largemouth_bass",
                               species.1 %in% c("SMB", "smallmouth bass") ~ "smallmouth_bass",
                               species.1 %in% c("YEP", "yellow perch") ~ "yellow_perch",
                               species.1 %in% c("NOP", "northern pike") ~ "northern_pike",
                               species.1 %in% c("BLG", "bluegill") ~ "bluegill",
                               species.1 %in% c("BLC", "black crappie") ~ "black_crappie",
                               species.1 %in% c("TLC", "tullibee (cisco)") ~ "cisco")) %>% 
  rename(date.1 = date_clean) %>% 
  #this is where the break was
  filter(sampling_method_agg %in% c("fyke_net", "gill_net")) %>% 
         filter(!(sampling_method %in% c("Trap Net - Mini Fyke", #removing gear types not representative of adult pop. or has specific timing of year
                                         "3/8-in trap nets",
                                         "1/4-in trap nets",
                                         "Double-pot 3/4-in-mesh double frame trap nets",
                                         "Small mesh gill nets, 3/8 and 1/2-in mesh, 200 x 6 ft",
                                         "FCIN gill nets",
                                         "Multifilament GN; 300 x 6; three 100 panels 1.5-2.0-2.5",
                                         "Monofilament gill nets, short-term sets",
                                         "Gill net fine mesh",
                                         "Special sampling with gill nets",
                                         "Special sampling with trap nets", 
                                         "Standard gill nets, set deep in stratified assessment",
                                         "Standard gill nets, set shallow in stratified assessment",
                                         "Standard gill nets, suspended sets",
                                         "Standard Vertical Gillnet",
                                         "1-in trap nets", #mostly used in the spring 
                                         "3/4 inch single-frame trap net",
                                         "Large-frame (5 x 6 ft) trap nets"))) %>% 
  filter(!(survey_type.1 %in% c("Winter Kill Assessment", 
                                "External Management Survey", 
                                "Subsurvey",
                                "Natural Reproduction Check", 
                                "Targeted Survey", 
                                "Dissolved Oxygen Check"))) %>% #removing surveys not representative of abundance 
  mutate(state = "Minnesota") %>% 
  rename(survey_id = survey_id_effort) %>% 
  rename(survey_type = survey_type.1) %>% 
  collect()

effort.mn %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(total_effort_1.1), median = median(total_effort_1.1), max(total_effort_1.1), n = n())

effort.mn %>% 
  group_by(survey_id, sampling_method) %>% 
  summarise(effort = unique(total_effort_1.1)) %>% 
  filter(!(effort >25)) %>% 
  ggplot()+
  geom_density(aes(effort, fill = sampling_method), alpha = .5) +
  theme_classic() +
  theme(legend.position = c(.7,.7))

#large amounts of effort?
effort.mn %>% 
  group_by(lake_id, survey_id, sampling_method) %>% 
  summarise(effort = unique(total_effort_1.1)) %>% 
  filter(effort >100)

#what does catch and cupe look like in MN?
gillnet.effort <- effort.mn %>% 
  filter(sampling_method_agg == "gill_net") %>% 
  group_by(survey_id, species.1) %>% 
  summarise(lake_id = unique(lake_id), sampling_method = unique(sampling_method), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort)

#are there multiple surveys within the same year?
gillnet.effort %>%
  mutate(year = year(date.1)) %>% 
  group_by(lake_id, year) %>% 
  summarise(n = n_distinct(survey_id)) %>% 
  filter(n >1) %>% 
  print(n = nrow(.))

#Leech?
gillnet.effort %>% 
  filter(lake_id == "11020300") %>% 
  mutate(year = year(date.1)) %>% 
  ggplot() +
  geom_point(aes(year, cpue)) +
  facet_wrap(~species.1, scales = "free")


fyke.effort <- effort.mn %>% 
  filter(sampling_method_agg == "fyke_net") %>% 
  group_by(survey_id, species.1) %>% 
  summarise(lake_id = unique(lake_id), sampling_method = unique(sampling_method), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort)

#gillnet exploration
#catch vs effort
gillnet.effort %>% 
  filter(effort < 75) %>%
  ggplot() +
  geom_point(aes(effort, n)) +
  geom_smooth(aes(effort, n)) +
  facet_wrap(~species.1, scales = "free") 

#cpue vs effort
gillnet.effort %>% 
  filter(effort < 75) %>%
  ggplot() +
  geom_point(aes(effort, cpue)) +
  geom_smooth(aes(effort, cpue)) +
  facet_wrap(~species.1, scales = "free")

#fyke exploration
#catch vs effort
fyke.effort %>% 
  filter(effort < 75) %>%
  ggplot() +
  geom_point(aes(effort, n)) +
  geom_smooth(aes(effort, n)) +
  facet_wrap(~species.1, scales = "free")

#cpue vs effort
fyke.effort %>% 
  filter(effort < 75) %>%
  ggplot() +
  geom_point(aes(effort, cpue)) +
  geom_smooth(aes(effort, cpue)) +
  facet_wrap(~species.1, scales = "free")

#####both together - cpue
effort.mn %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(effort < 25) %>%
  ggplot() +
  geom_smooth(aes(effort, cpue, color = sampling_method_agg)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))

effort.mn %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(effort < 25) %>%
  ggplot() +
  geom_jitter(aes(effort, cpue, color = sampling_method_agg), alpha = .3) +
  geom_smooth(aes(effort, cpue, color = sampling_method_agg)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))

#####both together - catch
effort.mn %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(effort < 25) %>%
  ggplot() +
  geom_smooth(aes(effort, n, color = sampling_method_agg)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))

effort.mn %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(effort < 25) %>%
  ggplot() +
  geom_jitter(aes(effort, n, color = sampling_method_agg), alpha = .3) +
  geom_smooth(aes(effort, n, color = sampling_method_agg)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))

#how many surveys with effort less than 5?
effort.mn %>% 
  group_by(survey_id, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(effort < 5) %>% 
  summarise(n = n())

####with lake area
area <- read_csv("Data_and_Scripts/Data/input/mn_lake_list.csv") %>% 
  select(DOW, LAKE_AREA_DOW_ACRES) %>% 
  mutate(DOW = as.integer(DOW))
glimpse(area)
glimpse(effort.mn)
effort.mn <- left_join(effort.mn, area, by = c("lake_id" = "DOW")) 
  
effort.mn <- effort.mn %>%
  mutate(LAKE_AREA_DOW_ACRES = as.numeric(case_when(
        lake_id == "56038800" ~ "1288",
        lake_id == "55006400" ~ "20",
        lake_id == "76014601" ~ "467",
        lake_id == "76014602" ~ "218",
        TRUE ~ as.character(LAKE_AREA_DOW_ACRES))))
effort.mn %>% 
  filter(is.na(LAKE_AREA_DOW_ACRES)) %>% 
  group_by(lake_id) %>% 
  summarise(n = n())
#no cases of na area

#creating lake area bins for gill nets and fyke
effort.area.gill <- effort.mn %>% 
  filter(sampling_method_agg == "gill_net") %>% 
  mutate(area.group = case_when(LAKE_AREA_DOW_ACRES < 100 ~ "<100",
                                LAKE_AREA_DOW_ACRES >= 100 & LAKE_AREA_DOW_ACRES <= 300 ~ "100-300",
                                LAKE_AREA_DOW_ACRES >= 301 & LAKE_AREA_DOW_ACRES <= 600 ~ "301-600",
                                LAKE_AREA_DOW_ACRES >= 601 & LAKE_AREA_DOW_ACRES <= 1500 ~ "601-1500",
                                LAKE_AREA_DOW_ACRES >= 1501 ~ "1501+",
                                TRUE ~ "NA")) %>% 
  mutate(area.group = factor(area.group, levels = c("<100", "100-300", "301-600", "601-1500", "1501+")))

effort.area.fyke <- effort.mn %>% 
  filter(sampling_method_agg == "fyke_net") %>% 
  mutate(area.group = case_when(LAKE_AREA_DOW_ACRES < 600 ~ "<600",
                                LAKE_AREA_DOW_ACRES >= 601 & LAKE_AREA_DOW_ACRES <= 1500 ~ "601-1500",
                                LAKE_AREA_DOW_ACRES >= 1501 ~ "1501+",
                                TRUE ~ "NA")) %>% 
  mutate(area.group = factor(area.group, levels = c("<600", "601-1500", "1501+")))
  
#looking at counts by grouping
effort.area.gill %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  group_by(area.group) %>% 
  summarise(n = n(), min = min(effort), average = median(effort), max = max(effort))

#figures for bin groupings (can change between cpue and count)
effort.area.gill %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(effort < 25) %>%
  ggplot() +
  geom_smooth(aes(effort, cpue, color = area.group)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))

effort.area.gill %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(effort < 25) %>%
  ggplot() +
  geom_jitter(aes(effort, cpue, color = area.group), alpha = .2) +
  geom_smooth(aes(effort, cpue, color = area.group)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))

########fyke summary
effort.area.fyke %>% 
  group_by(area.group) %>% 
  summarise(n = n(), min = min(total_effort_1.1), average = median(total_effort_1.1), max = max(total_effort_1.1))

#figures for bin groupings (can change between cpue and count)
effort.area.gill %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(effort < 25) %>%
  ggplot() +
  geom_smooth(aes(effort, cpue, color = area.group)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))

effort.area.gill %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(effort < 25) %>%
  ggplot() +
  geom_jitter(aes(effort, cpue, color = area.group), alpha = .2) +
  geom_smooth(aes(effort, cpue, color = area.group)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))

effort.area.fyke %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(effort < 25) %>%
  ggplot() +
  geom_smooth(aes(effort, cpue, color = area.group)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))

effort.area.fyke %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(effort < 25) %>%
  ggplot() +
  geom_jitter(aes(effort, cpue, color = area.group), alpha = .2) +
  geom_smooth(aes(effort, cpue, color = area.group)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))

##########how many low effort surveys are in each group for gill nets?##############
effort.area.gill %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  filter(effort < 25) %>%
  mutate(cpue = n/effort) %>% 
  ggplot() +
  geom_histogram(aes(effort, fill = area.group), binwidth = 1) +
  facet_wrap(~area.group, scales = "free") +
  theme(legend.position = c(.8,.2))

#how many surveys of effort 1, 2, or 3, 4, 5 in each area grouping?
effort.area.gill %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  filter(effort < 6) %>% 
  group_by(area.group, effort) %>% 
  summarise(n = n()) %>% 
  print(n = nrow(.))

#max, min, and median effort values
effort.area.gill %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  group_by(area.group) %>% 
  summarise(min = min(effort), median = median(effort), max = max(effort), n = n())

#how many unique lakes?
effort.area.gill %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  group_by(lake_id) %>% 
  summarise(n = n_distinct(lake_id))

#filtering out minimum effort for gill nets
effort.area.gill %>% 
   group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>%
  filter(!(area.group == "<100" & effort < 2) & 
         !(area.group == "100-300" & effort < 3) &
         !(area.group == "301-600" & effort < 3) &
         !(area.group == "601-1500" & effort < 3) &
         !(area.group == "1501+" & effort < 5)) %>% 
  group_by(area.group) %>% 
  summarise(min = min(effort), median = median(effort), max = max(effort), n = n())

#how many unique lakes?
effort.area.gill %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  filter(!(area.group == "<100" & effort < 2) & 
         !(area.group == "100-300" & effort < 3) &
         !(area.group == "301-600" & effort < 3) &
         !(area.group == "601-1500" & effort < 3) &
         !(area.group == "1501+" & effort < 5)) %>% 
  group_by(lake_id) %>% 
  summarise(n = n_distinct(lake_id))

effort.area.gill %>% 
  filter(!(species.1 %in% c("smallmouth_bass", "cisco"))) %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>%
  filter(!(area.group == "<100" & effort < 2) & 
         !(area.group == "100-300" & effort < 3) &
         !(area.group == "301-600" & effort < 3) &
         !(area.group == "601-1500" & effort < 3) &
         !(area.group == "1501+" & effort < 5)) %>% 
  mutate(cpue = n/effort) %>% 
  ggplot() +
  geom_smooth(aes(effort, cpue, color = area.group)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.55,.27))

##########how many low effort surveys are in each group for fyke nets?##############
effort.area.fyke %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  filter(effort < 25) %>%
  mutate(cpue = n/effort) %>% 
  ggplot() +
  geom_histogram(aes(effort, fill = area.group), binwidth = 1) +
  facet_wrap(~area.group, scales = "free")

#how many surveys of effort 1, 2, or 3, 4, 5 in each area grouping?
effort.area.fyke %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  filter(effort < 6) %>% 
  group_by(area.group, effort) %>% 
  summarise(n = n()) %>% 
  print(n = nrow(.))

#max, min, and median effort values
effort.area.fyke %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  group_by(area.group) %>% 
  summarise(min = min(effort), median = median(effort), max = max(effort), n = n())

#filtering out minimum effort for gill nets
effort.area.fyke %>% 
   group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>%
  filter(!(area.group == "<600" & effort < 5) & 
         !(area.group == "601-1500" & effort < 5) &
         !(area.group == "1501+" & effort < 5)) %>% 
  group_by(area.group) %>% 
  summarise(min = min(effort), median = median(effort), max = max(effort), n = n())

effort.area.fyke %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>%
  filter(!(area.group == "<600" & effort < 5) & 
         !(area.group == "601-1500" & effort < 5) &
         !(area.group == "1501+" & effort < 5)) %>% 
  mutate(cpue = n/effort) %>% 
  ggplot() +
  geom_smooth(aes(effort, cpue, color = area.group)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))

#######binning effort boxplot#######################
#zoomed in
effort.area.gill %>% 
   group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>%
  filter(effort < 10) %>% 
  mutate(effort = factor(effort, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"))) %>%
  ggplot() +
  geom_violin(aes(x = effort, y = log(cpue), color = species.1)) +
  facet_wrap(~species.1, scales = "free")

effort.area.fyke %>% 
   group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>%
  filter(effort < 10) %>% 
  mutate(effort = factor(effort, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"))) %>%
  ggplot() +
  geom_boxplot(aes(x = effort, y = log(cpue), color = species.1)) +
  facet_wrap(~species.1, scales = "free")

effort.area.gill %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), area.group = unique(area.group), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>%
  mutate(effort.bin = case_when(effort > 0 & effort < 3 ~ "1-2",
                                 effort >= 3 & effort < 5 ~ "3-4",
                                 effort >= 5 & effort < 7 ~ "5-6",
                                 effort >= 7 & effort < 11 ~ "7-10",
                                 effort >= 10 & effort < 21 ~ "10-20",
                                TRUE ~ "21+")) %>% 
  mutate(effort.bin = factor(effort.bin, levels = c("1-2", "3-4", "5-6", "7-10", "10-20", "21+"))) %>%
  ggplot() +
  geom_boxplot(aes(x = effort.bin, y = log(cpue), color = species.1)) +
  geom_jitter(aes(x = effort.bin, y = log(cpue), color = species.1), alpha = .1) +
  facet_wrap(~species.1, scales = "free")

#CPUE species with time
effort.mn <- effort.mn %>% 
  mutate(julian_day = format(date.1, "%j")) %>% 
  mutate(julian_day = as.numeric(julian_day))

effort.mn %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  mutate(area.group = case_when(sampling_method_agg == "gill_net" & LAKE_AREA_DOW_ACRES < 100 ~ "<100",
                                sampling_method_agg == "gill_net" & LAKE_AREA_DOW_ACRES >= 100 & LAKE_AREA_DOW_ACRES <= 300 ~ "100-300",
                                sampling_method_agg == "gill_net" & LAKE_AREA_DOW_ACRES >= 301 & LAKE_AREA_DOW_ACRES <= 600 ~ "301-600",
                                sampling_method_agg == "gill_net"& LAKE_AREA_DOW_ACRES >= 601 & LAKE_AREA_DOW_ACRES <= 1500 ~ "601-1500",
                                sampling_method_agg == "gill_net"& LAKE_AREA_DOW_ACRES >= 1501 ~ "1501+",
                                sampling_method_agg == "fyke_net" & LAKE_AREA_DOW_ACRES < 600 ~ "<600",
                                sampling_method_agg == "fyke_net" & LAKE_AREA_DOW_ACRES >= 601 & LAKE_AREA_DOW_ACRES <= 1500 ~ "601-1500",
                                sampling_method_agg == "fyke_net" & LAKE_AREA_DOW_ACRES >= 1501 ~ "1501+",
                                TRUE ~ "NA")) %>%
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), julian_day = unique(julian_day), effort = unique(total_effort_1.1), area.group = unique(area.group), n = n()) %>% 
  filter(!(sampling_method_agg == "gill_net" & area.group == "<100" & effort < 2) & 
         !(sampling_method_agg == "gill_net" & area.group == "100-300" & effort < 3) &
         !(sampling_method_agg == "gill_net" & area.group == "301-600" & effort < 3) &
         !(sampling_method_agg == "gill_net" & area.group == "601-1500" & effort < 3) &
         !(sampling_method_agg == "gill_net" & area.group == "1501+" & effort < 5) &
         !(sampling_method_agg == "fyke_net" & area.group == "<600" & effort < 5) & 
         !(sampling_method_agg == "fyke_net" & area.group == "601-1500" & effort < 5) &
         !(sampling_method_agg == "fyke_net" & area.group == "1501+" & effort < 5)) %>% 
  mutate(cpue = n/effort) %>% 
  ggplot() +
  geom_smooth(aes(x = julian_day, y = cpue, color = species.1)) +
  facet_wrap(~sampling_method_agg, scales = "free")

effort.mn %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  mutate(area.group = case_when(sampling_method_agg == "gill_net" & LAKE_AREA_DOW_ACRES < 100 ~ "<100",
                                sampling_method_agg == "gill_net" & LAKE_AREA_DOW_ACRES >= 100 & LAKE_AREA_DOW_ACRES <= 300 ~ "100-300",
                                sampling_method_agg == "gill_net" & LAKE_AREA_DOW_ACRES >= 301 & LAKE_AREA_DOW_ACRES <= 600 ~ "301-600",
                                sampling_method_agg == "gill_net"& LAKE_AREA_DOW_ACRES >= 601 & LAKE_AREA_DOW_ACRES <= 1500 ~ "601-1500",
                                sampling_method_agg == "gill_net"& LAKE_AREA_DOW_ACRES >= 1501 ~ "1501+",
                                sampling_method_agg == "fyke_net" & LAKE_AREA_DOW_ACRES < 600 ~ "<600",
                                sampling_method_agg == "fyke_net" & LAKE_AREA_DOW_ACRES >= 601 & LAKE_AREA_DOW_ACRES <= 1500 ~ "601-1500",
                                sampling_method_agg == "fyke_net" & LAKE_AREA_DOW_ACRES >= 1501 ~ "1501+",
                                TRUE ~ "NA")) %>%
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), julian_day = unique(julian_day), effort = unique(total_effort_1.1), area.group = unique(area.group), n = n()) %>% 
  filter(!(sampling_method_agg == "gill_net" & area.group == "<100" & effort < 2) & 
         !(sampling_method_agg == "gill_net" & area.group == "100-300" & effort < 3) &
         !(sampling_method_agg == "gill_net" & area.group == "301-600" & effort < 3) &
         !(sampling_method_agg == "gill_net" & area.group == "601-1500" & effort < 3) &
         !(sampling_method_agg == "gill_net" & area.group == "1501+" & effort < 5) &
         !(sampling_method_agg == "fyke_net" & area.group == "<600" & effort < 5) & 
         !(sampling_method_agg == "fyke_net" & area.group == "601-1500" & effort < 5) &
         !(sampling_method_agg == "fyke_net" & area.group == "1501+" & effort < 5)) %>% 
  mutate(cpue = n/effort) %>%  
  ggplot() +
  geom_smooth(aes(x = julian_day, y = cpue, color = species.1)) +
  geom_jitter(aes(x = julian_day, y = cpue, color = species.1)) +
  facet_wrap(species.1~sampling_method_agg, scales = "free")

#nop
effort.mn %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), julian_day = unique(julian_day), effort = unique(total_effort_1.1), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  filter(species.1 == "northern_pike" & cpue >200)

########################################Wisconsin##########################################
effort.wi <- wi_data %>% 
  mutate(sampling_method_agg = case_when(sampling_method %in% c("fyke_net", 
                                                                "mini_fyke_net",
                                                                "mini_fyke_net_with_turtle_exclusion", 
                                                                "mini_fyke_net_without_turtle_exclusion",
                                                                "mini_fyke_net_with_unknown_turtle_exclusion",
                                                                "trap_net",
                                                                "hoop_net", 
                                                                "hoop_trap") ~ "fyke_net",
                                         sampling_method %in% c("bottom_gill_net", 
                                                                "gillnet", 
                                                                "vertical_gill_net",
                                                                "floating_gill_net",
                                                                "trammel_net") ~ "gill_net",
                                         sampling_method %in% c("boom_shocker", 
                                                                "mini_boom_shocker",
                                                                "mini-boom_shocker",
                                                                "boom_shocker_or_mini-boom_shocker",
                                                                "dc_boom_shocker") ~ "boat_electrofishing",
                                         sampling_method %in% c("stream_shocker", 
                                                                "backpack_shocker") ~ "backpack_electrofishing",
                                         sampling_method %in% c("seine", 
                                                                "small-mesh_seine", 
                                                                "elec_seine") ~ "seine",
                                         sampling_method %in% c("trawl",
                                                                "bottom_trawl", 
                                                                "surface_trawl",
                                                                "mid-water_trawl") ~ "trawl",
                                         sampling_method == "poison" ~ "poison",
                                         sampling_method == "spearing" ~ "spear")) %>% 
  select(state, lake_id, species.1, sampling_method, sampling_method_agg, length.1, date.1, survey_id, survey_type.1_indivfish, effort, effort_units, total.effort.1, total.effort.1.units, total.effort.2, total.effort.2.units) %>% 
  filter(!is.na(length.1)) %>% 
  filter(species.1 %in% c("walleye", 
                          "northern_pike",
                          "largemouth_bass", 
                          "smallmouth_bass", 
                          "yellow_perch", 
                          "black_crappie", 
                          "bluegill", 
                          "cisco/lake_herring")) %>% 
  #this is where the break was
  filter(sampling_method_agg == "fyke_net") %>% #no gill nets in WI
         filter(!(sampling_method %in% c("mini_fyke_net", #excluding methods not representative of adult pop.
                                         "mini_fyke_net_with_turtle_exclusion",
                                         "mini_fyke_net_without_turtle_exclusion",
                                         "mini_fyke_net_with_unknown_turtle_exclusion",
                                         "hoop_trap",
                                         "hoop_net",
                                         "trap_net"))) %>% 
  mutate(species.1 = case_when(species.1 == "cisco/lake_herring" ~ "cisco", #making Cisco name consistent 
                               TRUE ~ species.1)) %>% 
  filter(is.na(survey_type.1_indivfish) | #excluding survey types that do not sample abundance evenly 
        !(survey_type.1_indivfish == "special_study" |
         survey_type.1_indivfish == "fisheries_assessments_rivers" |
         survey_type.1_indivfish == "fisheries_assessments_stream_smallmouth_bass" |
         survey_type.1_indivfish == "winterkill_investigation" |
         survey_type.1_indivfish == "non_dnr_cooperator_study"|
         survey_type.1_indivfish =="fisheries_assessments_trout_rotation"|
         survey_type.1_indivfish == "fisheries_assessments_trout_trend"|
         survey_type.1_indivfish == "habitat_improvement_evaluation"|
         survey_type.1_indivfish =="research_project"|
         survey_type.1_indivfish == "fish_kill_investigation"|
         survey_type.1_indivfish == "epa_national_stream_river_assessment"|
         survey_type.1_indivfish =="fisheries_assessments_trout_potential"|
         survey_type.1_indivfish =="severely_impacted"|
         survey_type.1_indivfish =="fish_passage_study"|
         survey_type.1_indivfish == "use_designation"|
         survey_type.1_indivfish == "creel,_access_point"|
         survey_type.1_indivfish == "treaty_fisheries_assessment"|
         str_detect(survey_type.1_indivfish, "watershed"))) %>% 
  rename(survey_type = survey_type.1_indivfish) %>%
  collect()

#Wisconsin has three effort columns, but only two are useful
#number of nets is the second effort which is more consist by state
glimpse(effort.wi)

#which effort to use?
effort.wi %>% 
  mutate(total.effort.1 = as.numeric(total.effort.1)) %>%
  filter(is.na(total.effort.1)) %>% 
  count()

effort.wi %>% 
  mutate(total.effort.2 = as.numeric(total.effort.2)) %>%
  filter(is.na(total.effort.2)) %>% 
  count()
#less NAs in the effort 2 - also is more consistent across states (number of nets)

effort.wi %>% 
  group_by(survey_id, species.1, sampling_method_agg) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), effort = unique(total.effort.2), n = n())  %>% #add in day? multiple days for one survey but same catch?
  print(n = 25)
  mutate(total.effort.2 = as.numeric(total.effort.2)) %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(total.effort.2, na.rm = T), median = median(total.effort.2, na.rm = T), max = max(total.effort.2, na.rm = T), n = n()) 
  
#looking a particular survey to get a feel for the structure
survey <- effort.wi %>% 
  filter(survey_id == 281)

survey %>% 
  group_by(survey_id, species.1, sampling_method_agg) %>% 
  summarise(lake_id = unique(lake_id), n = n()) 

survey %>% 
  group_by(survey_id, species.1, sampling_method_agg) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), effort = unique(total.effort.2), n = n()) %>% 
  print(n = nrow(.))

survey %>% 
  group_by(survey_id, species.1, sampling_method_agg) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), date = unique(date.1), n = n()) %>% 
  print(n = nrow(.))
#there are more unique dates than there are unique efforts - which efforts are combined? 
#survey spans for what is seemingly the whole month of april 

effort.wi %>% 
  mutate(total.effort.2 = as.numeric(total.effort.2)) %>%
  filter(total.effort.2 > 500) %>% 
  count()
#there is a ton of effort in Wisconsin that seems to have a lot of effort

#how many less than 5? less than 1?
effort.wi %>% 
  mutate(total.effort.2 = as.numeric(total.effort.2)) %>%
  filter(total.effort.2 > 5) %>% 
  count()
effort.wi %>% 
  mutate(total.effort.2 = as.numeric(total.effort.2)) %>%
  filter(total.effort.2 > 5) %>% 
  count()

effort.wi %>% 
  mutate(total.effort.2 = as.numeric(total.effort.2)) %>% 
  group_by(survey_id, sampling_method) %>% 
  summarise(effort = unique(total.effort.2)) %>% 
  filter(effort < 30) %>% 
  ggplot() +
  geom_histogram(aes(effort, fill = sampling_method), alpha = 0.5, binwidth = 1) +
  theme_classic() +
  theme(legend.position = c(.7,.7))

#################################Michigan###################################
effort.mi <- mi_data %>% 
  mutate(sampling_method_agg = case_when(sampling_method %in% c("large_mesh_fyke_net", "small_mesh_fyke_net", "trap_net") ~ "fyke_net",
                                         sampling_method %in% c("great_lakes_gill_net", "inland_gill_net") ~ "gill_net",
                                         sampling_method == "boomshocking" ~ "boat_electrofishing",
                                         sampling_method == "seine" ~ "seine")) %>% #aggregating common sampling methods
  filter(sampling_method_agg %in% c("fyke_net", "gill_net")) %>% #selecting fyke/trap nets and gill nets for abundance 
  filter(species.1 != "taxon_NA") %>% #removing samples that do not have taxa
  filter(!(sampling_method %in% c("small_mesh_fyke_net", 
                                  "great_lakes_gill_net"))) %>% #removing gear types not representative of adult populations 
  filter(!is.na(survey_type.1_effort)) %>% #excluding na survey types 
  select(state, lake_id, species.1, sampling_method, sampling_method_agg, length.1, date.1, survey_id, survey_type.1_effort, total_effort_1.1_effort, effort_units.1) %>% 
  mutate(date.1 = as.Date(date.1)) %>% 
  mutate(length.1 = as.integer(length.1)) %>% 
  mutate(species.1 = case_when(species.1 == "blue_gill" ~ "bluegill",
                               TRUE ~ species.1)) %>% 
  rename(survey_type = survey_type.1_effort) %>% 
  collect()

effort.mi %>% 
  group_by(survey_id, sampling_method) %>% 
  summarise(effort = unique(total_effort_1.1_effort)) %>% 
  ggplot() +
  geom_histogram(aes(effort, fill = sampling_method), alpha = 0.5, binwidth = 1) +
  facet_wrap(~sampling_method) +
  theme_classic() +
  theme(legend.position = c(.7,.7))

#what does catch and cupe look like in MI with a small amount of effort?
gillnet.effort <- effort.mi %>% 
  filter(sampling_method_agg == "gill_net") %>% 
  group_by(survey_id, species.1) %>% 
  summarise(sampling_method = unique(sampling_method), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), effort = unique(total_effort_1.1_effort), n = n()) %>% 
  mutate(cpue = n/effort)

fyke.effort <- effort.mi %>% 
  filter(sampling_method_agg == "fyke_net") %>% 
  group_by(survey_id, species.1) %>% 
  summarise(sampling_method = unique(sampling_method), sampling_method_agg = unique(sampling_method_agg), date.1 = unique(date.1), effort = unique(total_effort_1.1_effort), n = n()) %>% 
  mutate(cpue = n/effort)

#gill net exploration
gillnet.effort %>% 
  mutate(effort.size = case_when(effort >= 4 ~ "4+",
                                 effort < 4 ~ "<4")) %>% 
  group_by(effort.size) %>% 
  count()
#having a 4 effort minimum removes roughly 25% of gill net surveys

gillnet.effort %>%
  filter(effort >= 4) %>% 
  ggplot() +
  geom_smooth(aes(effort, cpue, color = species.1)) +
  facet_wrap(~species.1) +
  theme(legend.position = c(.8,.2))

gillnet.effort %>% 
  mutate(effort.size = case_when(effort >= 4 ~ "4+",
                                 effort < 4 ~ "<4")) %>% 
  ggplot() +
  geom_boxplot(aes(x = effort.size, y = log(cpue)))

gillnet.effort %>%
  filter(effort >= 4) %>% 
  ggplot() +
  geom_smooth(aes(effort, cpue, color = species.1)) +
  geom_jitter(aes(effort, cpue, color = species.1)) +
  theme(legend.position = c(.8,.85))

#fyke exploration - not great at catching anything other than crappie and bluegill
fyke.effort %>% 
  mutate(effort.size = case_when(effort >= 4 ~ "4+",
                                 effort < 4 ~ "<4")) %>% 
  group_by(effort.size) %>% 
  count()

fyke.effort %>% 
  mutate(effort.size = case_when(effort >= 4 ~ "4+",
                                 effort < 4 ~ "<4")) %>% 
  ggplot() +
  geom_boxplot(aes(x = effort.size, y = log(cpue)))

fyke.effort %>% 
  mutate(effort.size = case_when(effort >= 7 ~ "7+",
                                 effort < 7 ~ "<7")) %>% 
  group_by(effort.size) %>% 
  count()


fyke.effort %>% 
  filter(effort >= 4) %>% 
  ggplot() +
  geom_smooth(aes(effort, cpue, color = species.1)) +
  facet_wrap(~species.1, scales = "free") +
  theme(legend.position = c(.8,.2))
#having a 4 net minimum for fyke removes roughly 10% of surveys
#jumps to 40% with 7


#a minimum of 4 nets was chosen for Michigan surveys but might need to be species specific 


#time of year with cpue
effort.mi <- effort.mi %>% 
  mutate(julian_day = format(date.1, "%j")) %>% 
  mutate(julian_day = as.numeric(julian_day))

effort.mi %>% 
  group_by(survey_id, species.1, sampling_method) %>% 
  summarise(lake_id = unique(lake_id), sampling_method_agg = unique(sampling_method_agg), julian_day = unique(julian_day), effort = unique(total_effort_1.1_effort), n = n()) %>% 
  mutate(cpue = n/effort) %>% 
  ggplot() +
  geom_smooth(aes(x = julian_day, y = cpue, color = species.1)) +
  geom_jitter(aes(x = julian_day, y = cpue, color = species.1)) +
  facet_wrap(species.1~sampling_method_agg, scales = "free")
```

#Final Filtering
```{r}
##############################Minnesota######################################
#adding in area to mn data set
area <- read_csv("Data_and_Scripts/Data/input/mn_lake_list.csv") %>% 
  select(DOW, LAKE_AREA_DOW_ACRES) %>% 
  mutate(DOW = as.integer(DOW))
glimpse(area)
glimpse(effort.mn)
effort.mn <- left_join(effort.mn, area, by = c("lake_id" = "DOW")) 
effort.mn <- effort.mn %>%
  mutate(LAKE_AREA_DOW_ACRES = as.numeric(case_when(
        lake_id == "56038800" ~ "1288",
        lake_id == "55006400" ~ "20",
        lake_id == "76014601" ~ "467",
        lake_id == "76014602" ~ "218",
        TRUE ~ as.character(LAKE_AREA_DOW_ACRES))))

mn <- mn_data %>% 
  #selecting for species of interest 
  filter(species.1 %in% c("black_crappie", 
                          "bluegill", 
                          "largemouth_bass", 
                          "northern_pike",
                          "smallmouth_bass", 
                          "walleye",
                          "yellow_perch", 
                          "cisco")) %>% 
  #aggregating similar gear types
  mutate(sampling_method_agg = case_when(sampling_method %in% c("Standard 3/4-in mesh, double frame trap net sets", 
                                                                "1/4-in trap nets",
                                                                "Special sampling with trap nets", 
                                                                "Large-frame (5 x 6 ft) trap nets",
                                                                "3/8-in trap nets",
                                                                "3/4 inch single-frame trap net", 
                                                                "Trap Net - Mini Fyke",
                                                                "1-in trap nets",
                                                                "Double-pot 3/4-in-mesh double frame trap nets") ~ "fyke_net",
                                         sampling_method %in% c("Standard gill net sets", 
                                                                "Special sampling with gill nets", 
                                                                "Gill net fine mesh",
                                                                "Small mesh gill nets, 3/8 and 1/2-in mesh, 200 x 6 ft",
                                                                "Standard gill nets, set deep in stratified assessment",
                                                                "Standard Vertical Gillnet",
                                                                "Standard gill nets, set shallow in stratified assessment",
                                                                "FCIN gill nets",
                                                                "Monofilament gill nets, short-term sets",
                                                                "Multifilament GN; 300 x 6; three 100 panels 1.5-2.0-2.5",
                                                                "Standard gill nets, suspended sets",
                                                                "Trammel Net; 100 X 6 multifilament",
                                                                "Standard North American gill net") ~ "gill_net",
                                         sampling_method %in% c("Fall electrofishing for walleye", 
                                                                "Standard electrofishing",
                                                                "Special sampling, electrofishing") ~ "boat_electrofishing",
                                         sampling_method %in% c("Electrofishing, Backpack") ~ "backpack_electrofishing",
                                         sampling_method %in% c("Standard shoreline seining", 
                                                                "Seining, 50 foot 1/8 in Beach Seine for IBI", 
                                                                "Seining, 15 foot 1/8 in Beach Seine for IBI",
                                                                "Special sampling, seining") ~ "seine",
                                         sampling_method %in% c("Standard trawling",
                                                                "Special sampling, trawling") ~ "trawl")) %>% 
  #only including fyke and gill net sampling gears
  filter(sampling_method_agg %in% c("fyke_net", "gill_net")) %>% 
  #removing gear types not representative of adult populations or has specific timing of year
  filter(!(sampling_method %in% c("Trap Net - Mini Fyke", 
                                         "3/8-in trap nets",
                                         "1/4-in trap nets",
                                         "Double-pot 3/4-in-mesh double frame trap nets",
                                         "Small mesh gill nets, 3/8 and 1/2-in mesh, 200 x 6 ft",
                                         "FCIN gill nets",
                                         "Multifilament GN; 300 x 6; three 100 panels 1.5-2.0-2.5",
                                         "Monofilament gill nets, short-term sets",
                                         "Gill net fine mesh",
                                         "Special sampling with gill nets",
                                         "Special sampling with trap nets", 
                                         "Standard gill nets, set deep in stratified assessment",
                                         "Standard gill nets, set shallow in stratified assessment",
                                         "Standard gill nets, suspended sets",
                                         "Standard Vertical Gillnet",
                                         "1-in trap nets", #mostly used in the spring 
                                         "3/4 inch single-frame trap net",
                                         "Large-frame (5 x 6 ft) trap nets"))) %>% 
  #removing surveys that are not representative of abundance
  filter(!(survey_type.1 %in% c("Winter Kill Assessment", 
                                "External Management Survey", 
                                "Subsurvey",
                                "Natural Reproduction Check", 
                                "Targeted Survey", 
                                "Dissolved Oxygen Check"))) %>% 
  #creating area groupings based on the recommended effort for lake area in MN
  #groupings are based on gear type and lake size in acres 
  mutate(area.group = case_when(sampling_method_agg == "gill_net" & LAKE_AREA_DOW_ACRES < 100 ~ "<100",
                                sampling_method_agg == "gill_net" & LAKE_AREA_DOW_ACRES >= 100 & LAKE_AREA_DOW_ACRES <= 300 ~ "100-300",
                                sampling_method_agg == "gill_net" & LAKE_AREA_DOW_ACRES >= 301 & LAKE_AREA_DOW_ACRES <= 600 ~ "301-600",
                                sampling_method_agg == "gill_net"& LAKE_AREA_DOW_ACRES >= 601 & LAKE_AREA_DOW_ACRES <= 1500 ~ "601-1500",
                                sampling_method_agg == "gill_net"& LAKE_AREA_DOW_ACRES >= 1501 ~ "1501+",
                                sampling_method_agg == "fyke_net" & LAKE_AREA_DOW_ACRES < 600 ~ "<600",
                                sampling_method_agg == "fyke_net" & LAKE_AREA_DOW_ACRES >= 601 & LAKE_AREA_DOW_ACRES <= 1500 ~ "601-1500",
                                sampling_method_agg == "fyke_net" & LAKE_AREA_DOW_ACRES >= 1501 ~ "1501+",
                                TRUE ~ "NA")) %>% 
  #exclude surveys with a minimum effort that is not a consistence measure of CPUE
  #filters are specific to lake area and gear type
  filter(!(sampling_method_agg == "gill_net" & area.group == "<100" & effort < 2) & 
         !(sampling_method_agg == "gill_net" & area.group == "100-300" & effort < 3) &
         !(sampling_method_agg == "gill_net" & area.group == "301-600" & effort < 3) &
         !(sampling_method_agg == "gill_net" & area.group == "601-1500" & effort < 3) &
         !(sampling_method_agg == "gill_net" & area.group == "1501+" & effort < 5) &
         !(sampling_method_agg == "fyke_net" & area.group == "<600" & effort < 5) & 
         !(sampling_method_agg == "fyke_net" & area.group == "601-1500" & effort < 5) &
         !(sampling_method_agg == "fyke_net" & area.group == "1501+" & effort < 5))


####################################Wisconsin###################################
wi <- wi_data %>% 
  #selecting for species of interest 
   filter(species.1 %in% c("walleye", 
                          "northern_pike",
                          "largemouth_bass", 
                          "smallmouth_bass", 
                          "yellow_perch", 
                          "black_crappie", 
                          "bluegill", 
                          "cisco/lake_herring")) %>% 
  #making Cisco name consistent 
  mutate(species.1 = case_when(species.1 == "cisco/lake_herring" ~ "cisco", 
                               TRUE ~ species.1))
  #aggregating similar gear types
  mutate(sampling_method_agg = case_when(sampling_method %in% c("fyke_net", 
                                                                "mini_fyke_net",
                                                                "mini_fyke_net_with_turtle_exclusion", 
                                                                "mini_fyke_net_without_turtle_exclusion",
                                                                "mini_fyke_net_with_unknown_turtle_exclusion",
                                                                "trap_net",
                                                                "hoop_net", 
                                                                "hoop_trap") ~ "fyke_net",
                                         sampling_method %in% c("bottom_gill_net", 
                                                                "gillnet", 
                                                                "vertical_gill_net",
                                                                "floating_gill_net",
                                                                "trammel_net") ~ "gill_net",
                                         sampling_method %in% c("boom_shocker", 
                                                                "mini_boom_shocker",
                                                                "mini-boom_shocker",
                                                                "boom_shocker_or_mini-boom_shocker",
                                                                "dc_boom_shocker") ~ "boat_electrofishing",
                                         sampling_method %in% c("stream_shocker", 
                                                                "backpack_shocker") ~ "backpack_electrofishing",
                                         sampling_method %in% c("seine", 
                                                                "small-mesh_seine", 
                                                                "elec_seine") ~ "seine",
                                         sampling_method %in% c("trawl",
                                                                "bottom_trawl", 
                                                                "surface_trawl",
                                                                "mid-water_trawl") ~ "trawl",
                                         sampling_method == "poison" ~ "poison",
                                         sampling_method == "spearing" ~ "spear")) %>% 
  #only using fyke nets in  Wisconsin 
  filter(sampling_method_agg == "fyke_net") %>% 
  #removing gear types not representative of adult populations or has specific timing of year
  filter(!(sampling_method %in% c("mini_fyke_net",
                                         "mini_fyke_net_with_turtle_exclusion",
                                         "mini_fyke_net_without_turtle_exclusion",
                                         "mini_fyke_net_with_unknown_turtle_exclusion",
                                         "hoop_trap",
                                         "hoop_net",
                                         "trap_net"))) %>% 
  #removing surveys that are not representative of abundance
  filter(is.na(survey_type.1_indivfish) |  
        !(survey_type.1_indivfish == "special_study" |
         survey_type.1_indivfish == "fisheries_assessments_rivers" |
         survey_type.1_indivfish == "fisheries_assessments_stream_smallmouth_bass" |
         survey_type.1_indivfish == "winterkill_investigation" |
         survey_type.1_indivfish == "non_dnr_cooperator_study"|
         survey_type.1_indivfish =="fisheries_assessments_trout_rotation"|
         survey_type.1_indivfish == "fisheries_assessments_trout_trend"|
         survey_type.1_indivfish == "habitat_improvement_evaluation"|
         survey_type.1_indivfish =="research_project"|
         survey_type.1_indivfish == "fish_kill_investigation"|
         survey_type.1_indivfish == "epa_national_stream_river_assessment"|
         survey_type.1_indivfish =="fisheries_assessments_trout_potential"|
         survey_type.1_indivfish =="severely_impacted"|
         survey_type.1_indivfish =="fish_passage_study"|
         survey_type.1_indivfish == "use_designation"|
         survey_type.1_indivfish == "creel,_access_point"|
         survey_type.1_indivfish == "treaty_fisheries_assessment"|
         str_detect(survey_type.1_indivfish, "watershed")))

#trial run of species specific filtering################
#smallmouth and largemouth bass? - document only says shocking
  filter(species.1 == "walleye" &
         month %in% c(3, 4, 5) &
         water.temp > 40 &
         water.temp < 50)
  filter(species.1 == "northern_pike" &
         month %in% c(3, 4, 5) &
         water.temp > 40 &
         water.temp < 50)
  filter(species.1 == "bluegill" &
         month %in% c(6, 7, 8) &
         water.temp > 65 &
         water.temp < 80)
  filter(species.1 == "cisco" &
         sampling_method == "vertical_gill_netting" &
         month %in% c(3, 4, 5) &
         water.temp > 40 &
         water.temp < 50)
  filter(species.1 == "black_crappie" &
         month %in% c(3, 4, 5) &
         water.temp > 40 &
         water.temp < 70)
  filter(species.1 == "yellow_perch" &
         month %in% c(3, 4, 5) &
         water.temp > 40 &
         water.temp < 70) #two temperatures included in the document?

###############################Michigan########################################
mi <- mi_data %>% 
    #selecting for species of interest
    filter(species.1 %in% c("black_crappie", 
                          "bluegill", 
                          "largemouth_bass", 
                          "northern_pike",
                          "smallmouth_bass", 
                          "walleye",
                          "yellow_perch", 
                          "cisco")) %>% 
    #aggregating similar gear types
    mutate(sampling_method_agg = case_when(sampling_method %in% c("large_mesh_fyke_net", 
                                                                  "small_mesh_fyke_net", 
                                                                  "trap_net") ~ "fyke_net",
                                         sampling_method %in% c("great_lakes_gill_net",
                                                                "inland_gill_net") ~ "gill_net",
                                         sampling_method == "boomshocking" ~ "boat_electrofishing",
                                         sampling_method == "seine" ~ "seine")) %>%
  #only including fyke and gill net sampling gears
  filter(sampling_method_agg %in% c("fyke_net", "gill_net")) %>% 
  #removing gear types not representative of adult populations or has specific timing of year  
  filter(!(sampling_method %in% c("small_mesh_fyke_net", 
                                  "great_lakes_gill_net"))) %>% 
  #filtering for effort that is above 4 for both gear types
  filter(effort > 4) %>% 
  #excluding na survey types (removing survey 4042)
  filter(!is.na(survey_type.1_effort))

#################Iowa####################################
  
  
#################Indiana##################################
  
  
#################Illinois#################################


################South Dakota#############################
  

##################combining states#########################
midwest_data <- rbind(mn, wi, mi)
```

#filter table in code
```{r}
#this will give me a list of sampling methods to include on the other page (might need to run other filters before this)
mn_data %>% 
  filter(species.1 %in% c("black_crappie", 
                          "bluegill", 
                          "largemouth_bass", 
                          "northern_pike",
                          "smallmouth_bass", 
                          "walleye",
                          "yellow_perch", 
                          "cisco")) %>% 
   mutate(sampling_method_agg = case_when(sampling_method %in% c("Standard 3/4-in mesh, double frame trap net sets", 
                                                                "1/4-in trap nets",
                                                                "Special sampling with trap nets", 
                                                                "Large-frame (5 x 6 ft) trap nets",
                                                                "3/8-in trap nets",
                                                                "3/4 inch single-frame trap net", 
                                                                "Trap Net - Mini Fyke",
                                                                "1-in trap nets",
                                                                "Double-pot 3/4-in-mesh double frame trap nets") ~ "fyke_net",
                                         sampling_method %in% c("Standard gill net sets", 
                                                                "Special sampling with gill nets", 
                                                                "Gill net fine mesh",
                                                                "Small mesh gill nets, 3/8 and 1/2-in mesh, 200 x 6 ft",
                                                                "Standard gill nets, set deep in stratified assessment",
                                                                "Standard Vertical Gillnet",
                                                                "Standard gill nets, set shallow in stratified assessment",
                                                                "FCIN gill nets",
                                                                "Monofilament gill nets, short-term sets",
                                                                "Multifilament GN; 300 x 6; three 100 panels 1.5-2.0-2.5",
                                                                "Standard gill nets, suspended sets",
                                                                "Trammel Net; 100 X 6 multifilament",
                                                                "Standard North American gill net") ~ "gill_net",
                                         sampling_method %in% c("Fall electrofishing for walleye", 
                                                                "Standard electrofishing",
                                                                "Special sampling, electrofishing") ~ "boat_electrofishing",
                                         sampling_method %in% c("Electrofishing, Backpack") ~ "backpack_electrofishing",
                                         sampling_method %in% c("Standard shoreline seining", 
                                                                "Seining, 50 foot 1/8 in Beach Seine for IBI", 
                                                                "Seining, 15 foot 1/8 in Beach Seine for IBI",
                                                                "Special sampling, seining") ~ "seine",
                                         sampling_method %in% c("Standard trawling",
                                                                "Special sampling, trawling") ~ "trawl")) %>% 
  filter(sampling_method_agg %in% c("fyke_net", "gill_net")) %>% 
  filter(sampling_method %in% c("Standard gill net sets", 
                                "Standard 3/4-in mesh, double frame trap net sets")) %>% 
  filter(survey_type.1 %in% c("Population Assessment",
                              "Standard Survey",
                              "Large Lake Survey",
                              "HISTORICAL")) %>% 
  group_by(species.1, survey_type.1) %>% 
  summarise(n = n()) %>%
  collect() %>% 
  print(n = nrow(.))

##################Minnesota agency told filtering and table trial#################
#reading in the filter table
filter_table <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(State == "Minnesota")

#fish data
filtered.fish <- inner_join(filter_table, mn_data, by = c("survey_type", "sampling_method"))

#adding lake area to the data
area <- read_csv("Data_and_Scripts/Data/input/mn_lake_list.csv") %>% 
  select(DOW, LAKE_AREA_DOW_ACRES) %>% 
  mutate(DOW = as.integer(DOW))
#joins fish data with area data
mn_data <- left_join(mn_data, area, by = c("lake_id" = "DOW")) %>% 
  #hard codes lakes that do not have area in the area file (areas taken from lake finder)
  mutate(LAKE_AREA_DOW_ACRES = as.numeric(case_when(
        lake_id == "56038800" ~ "1288",
        lake_id == "55006400" ~ "20",
        lake_id == "76014601" ~ "467",
        lake_id == "76014602" ~ "218",
        TRUE ~ as.character(LAKE_AREA_DOW_ACRES)))) %>% 
  #creates binned area grouping used for minimum effort calculation
  mutate(area.group = case_when(LAKE_AREA_DOW_ACRES < 100 ~ "<100",
                                LAKE_AREA_DOW_ACRES >= 100 & LAKE_AREA_DOW_ACRES <= 300 ~ "100-300",
                                LAKE_AREA_DOW_ACRES >= 301 & LAKE_AREA_DOW_ACRES <= 600 ~ "301-600",
                                LAKE_AREA_DOW_ACRES >= 601 & LAKE_AREA_DOW_ACRES <= 1500 ~ "601-1500",
                                LAKE_AREA_DOW_ACRES >= 1501 ~ "1501+",
                                TRUE ~ "NA")) %>% 
  #orders groupings so they plot well
  mutate(area.group = factor(area.group, levels = c("<100", "100-300", "301-600", "601-1500", "1501+")))
```

#ramsey county lakes
```{r}
#only zeeb lakes
zm.ramsey <- mn_data %>% 
  filter(lake_id %in% c("62000200", 
                        "62006200", 
                        "62007800", 
                        "62006700",
                        "62005400",
                        "62005600", 
                        "62004600", 
                        "62002800",
                        "62003801",
                        "62003802",
                        "82016700")) %>% 
  collect() %>% 
  mutate(year_infested = case_when(lake_id == "62000200" ~ 2018,
                                   lake_id == "62006200" ~ 2007,
                                   lake_id == "62007800" ~ 2018,
                                   lake_id == "62006700" ~ 2019,
                                   lake_id == "62005400" ~ 2019,
                                   lake_id == "62005600" ~ 2021,
                                   lake_id == "62004600" ~ 2007,
                                   lake_id == "62002800" ~ 2007,
                                   lake_id == "62003801" ~ 2007,
                                   lake_id == "62003802" ~ 2007,
                                   lake_id == "82016700" ~ 2014,
                                   TRUE ~ NA)) %>% 
  mutate(invasion_status = case_when(year_infested <= year(date_clean) ~ "ZM",
                                     year_infested > year(date_clean) ~ "Uninvaded",
                                     TRUE ~ NA))

#checking mutates
zm.ramsey %>% 
  group_by(lake_name.1) %>% 
  summarise(n = n(), invasion = unique(invasion_status)) %>% 
  print(n = nrow(.))

#samples for each lake before and after invasion
zm.ramsey %>% 
  group_by(lake_name.1, invasion_status) %>% 
  summarise(n = n()) %>% 
  print(n = nrow(.))

#count of samples samples by year for every lake
zm.ramsey %>% 
  group_by(lake_name.1, year(date_clean)) %>% 
  summarise(n = n()) %>% 
  print(n = nrow(.))

#any NAs?
zm.ramsey %>% 
  filter(is.na(invasion_status)) %>% 
  group_by(lake_name.1) %>%
  summarise(n = n()) %>% 
  print(n = nrow(.))

#ramsey total
total.ramsey <- mn_data %>%
  mutate(lake_id = as.character(lake_id)) %>% 
  filter(str_detect(lake_id, "^62") | lake_id == "2000300" | lake_id == "82016700") %>%
  collect() %>% 
  mutate(year_infested = case_when(lake_id == "62000200" ~ 2018,
                                   lake_id == "62006200" ~ 2007,
                                   lake_id == "62007800" ~ 2018,
                                   lake_id == "62006700" ~ 2019,
                                   lake_id == "62005400" ~ 2019,
                                   lake_id == "62005600" ~ 2021,
                                   lake_id == "62004600" ~ 2007,
                                   lake_id == "62002800" ~ 2007,
                                   lake_id == "62003801" ~ 2007,
                                   lake_id == "62003802" ~ 2007,
                                   lake_id == "82016700" ~ 2014,
                                   TRUE ~ NA)) %>% 
  mutate(invasion_status = case_when(year_infested <= year(date_clean) ~ "ZM",
                                     year_infested > year(date_clean) ~ "Uninvaded",
                                     TRUE ~ NA))

#adding in Mccarron data from field class
mcn_extra <- read_csv("mccarrons.csv") %>% 
  select(-`...1`) %>% 
  mutate(species.1 = case_when(species.1 == "pumpkin_seed" ~ "pumpkinseed",
                               species.1 == "pumpkin_seed X bluegill" ~ "pumpkinseed x bluegill",
                               TRUE ~ species.1)) %>% 
  mutate(species.1 = str_replace(species.1, " ", "_")) %>% 
  mutate(length.1 = case_when(length_unit.1 %in% c("cm", "UNK") ~ length.1*10,
                              TRUE ~ length.1)) %>% 
  mutate(length_unit.1 = case_when(length_unit.1 %in% c("cm", "UNK") ~ "mm",
                                   TRUE ~ length_unit.1)) %>% 
  mutate(species_abbrev = case_when(species_abbrev == "PUS" ~ "PMK",
                                    species.1 == "bluegill_hybrid" ~ "BLG",
                                    TRUE ~ species_abbrev)) %>% 
  mutate(total_effort_1.1 = 5,
         state = "Minnesota",
         county = "Ramsey",
         lake_id = "62005400",
         lake_name.1 = "McCarron",
         nhdhr.id = "nhdhr_120018084",
         survey_type.1 = "UMN Field Class",
         sampling_method = "Standard 3/4-in mesh, double frame trap net sets",
         sampling_method_abbrev = "TN",
         effort_units.1 = "set",
         nothing_caught = "FALSE",
         target_species = NA,
         sample_id.1 = NA,
         age = NA,
         aging_structure = NA,
         young_of_year = NA,
         sex = NA,
         original_file_name.1_effort = "mccarrons.csv",
         original_file_name.1_indivfish = "mccarrons.csv",
         original_file_name.1_histcatch = NA,
         flag = NA,
         lake_area_dow_acres = 73,
         area_group = "<100") %>% 
  mutate(effort_ident = case_when(date_clean == "2023-09-15" ~ 100000,
                                  date_clean == "2020-09-04" ~ 100001,
                                  date_clean == "2023-05-17" ~ 100002)) %>% 
  mutate(year_infested = case_when(lake_id == "62000200" ~ 2018,
                                   lake_id == "62006200" ~ 2007,
                                   lake_id == "62007800" ~ 2018,
                                   lake_id == "62006700" ~ 2019,
                                   lake_id == "62005400" ~ 2019,
                                   lake_id == "62005600" ~ 2021,
                                   lake_id == "62004600" ~ 2007,
                                   lake_id == "62002800" ~ 2007,
                                   lake_id == "62003801" ~ 2007,
                                   lake_id == "62003802" ~ 2007,
                                   lake_id == "82016700" ~ 2014,
                                   TRUE ~ NA)) %>% 
  mutate(invasion_status = case_when(year_infested <= year(date_clean) ~ "ZM",
                                     year_infested > year(date_clean) ~ "Uninvaded",
                                     TRUE ~ NA)) %>% 
  mutate(nothing_caught = as.logical(nothing_caught))

#how does it look?
mcn_extra %>% 
  group_by(date_clean) %>% 
  count()

mcn_extra %>% 
  group_by(species.1) %>% 
  count()

mcn_extra %>% 
  group_by(species.1) %>% 
  summarise(mean = mean(length.1),
            min = min(length.1, na.rm = T),
            max = max(length.1, na.rm = T))

mcn_extra %>% 
  group_by(species.1) %>% 
  filter(!is.na(weight.1)) %>% 
  count()

mcn_extra %>% 
  group_by(species_abbrev) %>% 
  count()

write_csv(total.ramsey, "ramsey_county_fish.csv")

total.ramsey %>% 
  group_by(lake_name.1, nhdhr.id) %>% 
  summarise(n = n(), invasion = unique(invasion_status)) %>% 
  filter(!is.na(invasion)) %>% 
  print(n = nrow(.))

total.ramsey %>% 
  group_by(species.1) %>% 
  count() %>% 
  collect() %>% 
  print(n = nrow(.))

total.ramsey %>% 
  group_by(length_unit.1) %>% 
  count()

total.ramsey %>% 
  group_by(effort_units.1) %>% 
  count()

total.ramsey %>% 
  summarise(min = min(effort_ident), max = max(effort_ident))

#combining umn field class and ramsey total
total.ramsey.field <- bind_rows(mcn_extra, total.ramsey)

write_csv(total.ramsey.field, "ramsey_county_fish.csv")


#grabbing age/length
mn_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "Age-assigned Data", "mn_halk_aged_data"))
glimpse(mn_data)

total.ramsey <- mn_data %>%
  mutate(lake_id = as.character(lake.id)) %>% 
  filter(str_detect(lake_id, "^62") | lake_id == "2000300" | lake_id == "82016700") %>%
  collect() %>% 
  mutate(year_infested = case_when(lake_id == "62000200" ~ 2018,
                                   lake_id == "62006200" ~ 2007,
                                   lake_id == "62007800" ~ 2018,
                                   lake_id == "62006700" ~ 2019,
                                   lake_id == "62005400" ~ 2019,
                                   lake_id == "62005600" ~ 2021,
                                   lake_id == "62004600" ~ 2007,
                                   lake_id == "62002800" ~ 2007,
                                   lake_id == "62003801" ~ 2007,
                                   lake_id == "62003802" ~ 2007,
                                   lake_id == "82016700" ~ 2014,
                                   TRUE ~ NA)) %>% 
  mutate(invasion_status = case_when(year_infested <= year(date) ~ "ZM",
                                     year_infested > year(date) ~ "Uninvaded",
                                     TRUE ~ NA))

total.ramsey %>% 
  group_by(age) %>% 
  count()

total.ramsey %>% 
  group_by(est.age) %>% 
  count()

write_csv(total.ramsey, "ramsey_county_fish_growth.csv")
```

#MN surveys with different purposes relating to catches?
```{r}
#surveys that Chris Rounds found with the issue
example <- read_csv("multi_survey_ex.csv") 
  

#finding the records in the data
records <- mn_data %>% 
  filter(lake_id %in% example$lake_id, effort_ident %in% example$effort_ident, survey_type.1 %in% example$survey_type.1) %>% 
  collect() %>% 
  distinct(effort_ident, .keep_all = T)

#specific to one survey 
specific <- mn_data %>% 
  filter(effort_ident %in% c(25520, 44776)) %>% 
  collect()

#is this a problem in the larger database?
#getting cases where there are more than one survey per sampling method in one day
problems <- mn_data %>%
  distinct(effort_ident, date_clean, lake_id, lake_name.1, sampling_method, nothing_caught) %>%
  collect() %>%
  group_by(lake_id, lake_name.1, date_clean, sampling_method, nothing_caught) %>% 
  count() %>% 
  filter(n >1) %>% 
  print(n = nrow(.))

#filtering for these surveys in the original data set
problem_surveys <- mn_data %>% 
  filter(lake_id %in% problems$lake_id & date_clean %in% problems$date_clean & sampling_method %in% problems$sampling_method) %>% 
  collect() 

#generates a list of surveys with more than one survey per day
list_of_problems <- problem_surveys %>% 
  distinct(effort_ident, .keep_all = T)

#counting records for the these lakes, dates, and survey type
#problem seems to exist where there are two survey types where one reports nothing caught but the nothing reports catch
#not all of these appear to be problems - some are are def multi surveys in a day\
#historical catch typically has values while the other survey type doesn't
problem_surveys %>% 
  group_by(lake_id, lake_name.1, date_clean, survey_type.1, nothing_caught) %>% 
  count() %>% 
  print(n = nrow(.))
```

#prop of fish in gears
```{r}
lake <- mn_data %>% 
  filter(lake_id == 27003100) %>% 
  filter(species.1 == "northern_pike") %>% 
  filter(sampling_method %in% c("Standard gill net sets", "Standard 3/4-in mesh, double frame trap net sets")) %>% 
  collect()

prop <- lake %>% 
  group_by(year(date_clean), sampling_method) %>% 
  count() %>% 
  pivot_wider(names_from = "sampling_method", values_from = "n") %>% 
  rename(trap = `Standard 3/4-in mesh, double frame trap net sets`,
         gill = `Standard gill net sets`,
         year = `year(date_clean)`) %>% 
  filter(!(is.na(gill) | is.na(trap))) %>% 
  mutate(prop = gill/trap)

prop %>% 
  ggplot() +
  geom_point(aes(year, prop)) +
  geom_smooth(aes(year, prop))
```

#summary of gears for iowa
```{r}
ia_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "ia_file_arrow"))
glimpse(ia_data)

ia_data %>% 
  group_by(length_unit_1) %>% 
  count() %>% 
  collect()

ia_data %>% 
  group_by(length_bin_unit) %>% 
  count() %>% 
  collect()

ia_data %>% 
  group_by(length_bin) %>% 
  count() %>% 
  collect()

ia_data %>% 
  filter(species_1 %in% c("Walleye",
                          "Bluegill", 
                          "Black Crappie", 
                          "Largemouth Bass", 
                          "Smallmouth Bass", 
                          "Northern Pike",
                          "Yellow Perch")) %>% 
  filter(sampling_method %in% c("Electrofishing", "Fyke Netting", "Gill Netting")) %>%
  filter(!str_detect(sampling_method_2, c("Backpack | Barge"))) %>%
  group_by(species_1, sampling_method) %>% 
  count() %>% 
  collect() %>% 
  print(n = nrow(.))

ia_data %>% 
  mutate(length.update = case_when(!is.na(length_bin) ~ (as.numeric(sub(".*-(\\d+\\.\\d+).*", "\\1", length_bin)) +
                            as.numeric(sub(".*-(\\d+\\.\\d+)$", "\\1", length_bin))) / 2,
                            TRUE ~ length_1),
         length.update = (length.update + (length.update - 9.99))/2) %>% 
  group_by(length_bin) %>% 
  summarise(mean(length.update, na.rm = T)) %>% 
  collect()

ia_data %>% 
  group_by(species_1) %>% 
  count() %>% 
  collect()

ia_data %>% 
  filter(species_1 %in% c("Walleye",
                          "Bluegill", 
                          "Black Crappie", 
                          "Largemouth Bass", 
                          "Smallmouth Bass", 
                          "Northern Pike",
                          "Yellow Perch")) %>% 
  filter(sampling_method %in% c("Electrofishing", "Fyke Netting", "Gill Netting")) %>%
  mutate(length.update = case_when(!is.na(length_bin) ~ (as.numeric(sub(".*-(\\d+\\.\\d+).*", "\\1", length_bin)) +
                            as.numeric(sub(".*-(\\d+\\.\\d+)$", "\\1", length_bin))) / 2,
                            TRUE ~ length_1)) %>% 
  mutate(length.update = case_when(!is.na(length_bin) ~ ((length.update + (length.update - 9.99))/2),
                                   TRUE ~ length.update)) %>% 
  collect() %>% 
  filter(!str_detect(sampling_method_2, c("Backpack | Barge"))) %>%
  filter(length.update < 60) %>% 
  ggplot() +
  geom_density(aes(length.update, fill = sampling_method_2)) +
  facet_grid(sampling_method ~ species_1, scales = "free")

ia_data %>% 
  filter(species_1 %in% c("Walleye",
                          "Bluegill", 
                          "Black Crappie", 
                          "Largemouth Bass", 
                          "Smallmouth Bass", 
                          "Northern Pike",
                          "Yellow Perch")) %>% 
  filter(sampling_method %in% c("Electrofishing", "Fyke Netting", "Gill Netting")) %>%
  mutate(length.update = case_when(!is.na(length_bin) ~ (as.numeric(sub(".*-(\\d+\\.\\d+).*", "\\1", length_bin)) +
                            as.numeric(sub(".*-(\\d+\\.\\d+)$", "\\1", length_bin))) / 2,
                            TRUE ~ length_1)) %>% 
  mutate(length.update = case_when(!is.na(length_bin) ~ ((length.update + (length.update - 9.99))/2),
                                   TRUE ~ length.update)) %>% 
  collect() %>% 
  filter(!str_detect(sampling_method_2, c("Backpack | Barge"))) %>%
  filter(length.update < 60) %>% 
  ggplot() +
  geom_histogram(aes(length.update, fill = sampling_method_2)) +
  facet_grid(sampling_method ~ species_1, scales = "free")


ia_data %>% 
  filter(species_1 %in% c("Walleye",
                          "Bluegill", 
                          "Black Crappie", 
                          "Largemouth Bass", 
                          "Smallmouth Bass", 
                          "Northern Pike",
                          "Yellow Perch")) %>% 
  filter(sampling_method %in% c("Electrofishing", "Fyke Netting", "Gill Netting")) %>% 
  distinct(total_effort_ident, date, sampling_method) %>% 
  mutate(jul_day = yday(date)) %>% 
  collect() %>% 
  ggplot() +
  geom_density(aes(jul_day, fill = sampling_method), alpha = .5)

ia_data %>% 
  filter(species_1 %in% c("Walleye",
                          "Bluegill", 
                          "Black Crappie", 
                          "Largemouth Bass", 
                          "Smallmouth Bass", 
                          "Northern Pike",
                          "Yellow Perch")) %>% 
  filter(sampling_method %in% c("Electrofishing", "Fyke Netting", "Gill Netting")) %>% 
  distinct(total_effort_ident, date, sampling_method) %>% 
  mutate(jul_day = yday(date)) %>% 
  collect() %>% 
  ggplot() +
  geom_histogram(aes(jul_day, fill = sampling_method), alpha = .5)

check <- ia_data %>% 
  filter(species_1 %in% c("Walleye",
                          "Bluegill", 
                          "Black Crappie", 
                          "Largemouth Bass", 
                          "Smallmouth Bass", 
                          "Northern Pike",
                          "Yellow Perch")) %>% 
  filter(sampling_method %in% c("Electrofishing", "Fyke Netting", "Gill Netting")) %>% 
  filter(!str_detect(sampling_method_2, c("Backpack | Barge"))) %>%
  filter(!is.na(total_effort_1)) %>% 
  collect() %>% 
  group_by(total_effort_ident, species_1, sampling_method) %>% 
  summarise(total_effort_ident = unique(total_effort_ident), sampling_method = unique(sampling_method), total_effort_1 = unique(total_effort_1), n = n()) %>% 
  mutate(cpe = n/total_effort_1)

check %>% 
  ggplot() +
  geom_smooth(aes(total_effort_1, cpe, color = sampling_method)) + 
  facet_wrap(~species_1, scales = "free")

check %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(total_effort_1), mean = mean(total_effort_1), max = max(total_effort_1), n = n())

check %>% 
  filter(total_effort_1 < 50) %>% 
  ggplot() +
  geom_jitter(aes(total_effort_1, cpe, color = sampling_method)) + 
  geom_smooth(aes(total_effort_1, cpe, color = sampling_method), se = F) +
  facet_grid(species_1~ sampling_method, scales = "free")

ia_data %>% 
  group_by(total_effort_1_units) %>% 
  count() %>% 
  collect()
```

#looking at updated cross walk
```{r}
library(mwlaxeref)
library(LAGOSNE)
#what do we have in our database?
fish_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "hive"), partitioning = c("state")) 
  
fish_data %>% 
  distinct(state, county, lake_id, lake_name, nhdhr_id) %>% 
  group_by(state) %>% 
  count() %>% 
  collect() %>% 
  print(n = nrow(.))

sd <- fish_data %>%
  filter(state == "South_Dakota") %>% 
  distinct(lake_id, lake_name, nhdhr_id, county) %>% 
  collect()

#overall crosswalk
cross <- read_csv("MGLP_FISH_LAKES.csv") 
glimpse(cross)

cross %>% 
  group_by(STATE) %>% 
  count()

cross %>% 
  group_by(STATE, Verify) %>% 
  count() %>% 
  print(n = nrow(.))

cross %>% 
  filter(STATE == "SD") %>% 
  group_by(is.na(LAGOSLAKEID), is.na(NHDHR_ID)) %>% 
  count()

#michigan
mi <- cross %>% 
  filter(STATE == "MI")

mi_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "hive"), partitioning = c("state")) %>% 
  filter(state == "Michigan")
glimpse(mi_data)

#gathers lake info 
mi_lakes <- mi_data %>% 
  group_by(lake_id, nhdhr_id, lake_name, lat_unspec, lon_unspec, county) %>%
  count() %>% 
  collect() %>% 
  replace_na(list(nhdhr_id = "NULL")) %>% 
  distinct(lake_id, nhdhr_id, lake_name, lat_unspec, lon_unspec, county)

#gathers lakes missing nhdid
missing_mi_lakes <- mi_lakes %>% 
  filter(nhdhr_id == "NULL")

mi_crosswalk <- mi %>% 
  filter(STATE_ID %in% missing_mi_lakes$lake_id & LAKE_NAME %in% missing_mi_lakes$lake_name)

anti <- mi %>% 
  rename(lake_id = STATE_ID,
         lake_name = LAKE_NAME,
         nhdhr_id = NHDHR_ID) %>% 
 anti_join(mi_lakes, by = c("lake_id",
                            "lake_name",
                            "nhdhr_id"))
#checking why there is a difference for Beaver Lake
check <- data.frame(lake.id = c("45383", "4-1"))
mi_to_nhdhr(check, from_colname ="lake.id")
check.2 <- data.frame(nhdhr.id = "113471071")
nhdhr_to_mi(check.2)
#this shows that there are multiple local is for the nhdhrid but none match what msu gave us?



#checking crosswalk with lagos data
cross <- read_csv("MGLP_FISH_LAKES.csv") %>%  
  #make sure there is only one lagos id for each basin (lakes with multipule are listed with a :)
  #separate(LAGOSLAKEID, into = c("LAGOSLAKEID_clean", "extra_ids"), sep = ";", extra = "merge", fill = "right")
  #just removing them for now but see code above to sepearte
  filter(!(str_detect(LAGOSLAKEID, ";"))) %>% 
  lagos_to_nhdhr(from_colname = "LAGOSLAKEID") 

cross %>% 
  group_by(STATE, is.na(nhdhr.id)) %>% 
  count()

cross %>% 
  group_by(STATE, is.na(NHDHR_ID)) %>% 
  count()

match <- cross %>% 
  filter(!is.na(LAGOSLAKEID)) %>% 
  mutate(nhdhr_id_mwlaxref = paste0("nhdhr_", nhdhr.id),
         NHDHR_ID_msu = case_when(grepl("^nhdhr_", NHDHR_ID) ~ NHDHR_ID,
                              TRUE ~ paste0("nhdhr_", NHDHR_ID)),
         NHDHR_ID_msu = case_when(NHDHR_ID_msu == "nhdhr_NA" ~ NA,
                              TRUE ~ NHDHR_ID_msu),
         nhdhr_match = case_when(nhdhr_id_mwlaxref == NHDHR_ID_msu ~ T,
                              TRUE ~ F)) %>% 
  select(STATE, 
         STATE_ID,
         LAKE_NAME,
         COUNTY, 
         LAT, 
         LON, 
         WATERBODY_,
         LAGOSLAKEID, 
         NHDHR_ID_msu,
         nhdhr_id_mwlaxref, 
         nhdhr_match) %>% 
  filter(!(is.na(nhdhr_id_mwlaxref) | is.na(NHDHR_ID_msu)))

match %>% 
  filter(!(is.na(nhdhr_id_mwlaxref) | is.na(NHDHR_ID_msu))) %>% 
  group_by(nhdhr_match) %>% 
  count()

write_csv(match, "crosswalk_nhdhrid_exploring.csv")
```

# Exploring errors 
```{r}
#cam's error
mw_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "hive"), partitioning = c("state")) 
  

mw_data %>% 
  filter(state == "Minnesota") %>% 
  distinct(total_effort_ident, sampling_method, area_group, total_effort_1, flag) %>% 
  filter(sampling_method == "Standard Vertical Gillnet") %>% 
  group_by(flag) %>% 
  count() %>% 
  collect() %>% 
  print()

##na efforts
mw_data %>% 
  filter(is.na(total_effort_1)) %>% 
  group_by(state, flag) %>% 
  count() %>%  
  collect()

na.effort <- mw_data %>% 
  filter(is.na(total_effort_1)) %>% 
  collect()

na.effort %>% 
  group_by(state, flag) %>% 
  summarise(n_distinct(total_effort_ident))

na.effort %>% 
  filter(state == "Minnesota") %>% 
  filter(is.na(flag)) %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method, sampling_method_2, is.na(date_total_effort_ident)) %>% 
  count() %>% 
  arrange(sampling_method) %>% 
  print(n = nrow(.))

mw_data %>% 
  filter(is.na(total_effort_1)) %>% 
  filter(state == "Minnesota") %>% 
  group_by(original_file_names) %>% 
  count() %>% 
  collect()

mw_data  %>% 
  filter(state == "Minnesota") %>% 
  group_by(original_file_names) %>% 
  count() %>% 
  collect()

mn_specific_case <- mw_data %>% 
  filter(state == "Minnesota") %>% 
  filter(lake_id == "14004900") %>% 
  collect() %>% 
  filter(year == "2022")
rm(mn_specific_case)

#indy
indy_na <- mw_data %>% 
  filter(state == "Indiana") %>% 
  filter(is.na(total_effort_1)) %>% 
  collect() 

indy_na %>% 
  group_by(original_file_names) %>% 
  count()

indy_na %>% 
  group_by(flag, gear_data_notes, notes_1) %>% 
  count() %>% 
  print(n = nrow(.))

indy_na %>% 
  group_by(waterbody_type) %>% 
  count()

indy_na %>% 
  group_by(age, flag) %>% 
  count()
#all but 7 fish without effort have an age - leading me to think we could not connect the aged fished to effort
#5 of the other 7 have no sampling method 
#the other 2... idfk 

indy_na %>% 
  filter(survey_id == "480" | survey_id == "489") %>% 
  group_by(survey_id, age, flag) %>% 
  count()
#those other two fish look like they came from an aged survey just didn't get aged 
rm(indy_na)

#iowa
ia_na <- mw_data %>% 
  filter(state == "Iowa" & is.na(total_effort_1)) %>% 
  collect()

ia_na %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(flag) %>% 
  count()
#looks like most of these from Iowa are flagged from the state as not adequate 

ia_na %>% 
  filter(is.na(total_effort_1) & is.na(flag)) %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  print(n = nrow(.))

ia_na %>% 
  filter(is.na(total_effort_1) & is.na(flag)) %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  print(n = nrow(.))

#total effort ident 7728 is a good example how there is sub effort 1 but no total effort 1

ia_specific_case <- ia_na %>% 
  filter(total_effort_ident == "6732")

ia_na %>% 
  group_by(is.na(total_effort_1), is.na(total_effort_2), is.na(total_effort_3), flag) %>% 
  count() %>% 
  print(n = nrow(.))

ia_na %>% 
  filter(is.na(total_effort_1) & is.na(total_effort_2) & is.na(total_effort_3) & is.na(flag)) %>% 
  group_by(total_effort_ident) %>% 
  count() 

na_check <- ia_na %>% 
  group_by(total_effort_ident) %>% 
  filter(is.na(flag)) %>% 
  summarise(na_total_effort = sum(is.na(total_effort_1)),
            na_sub_effort = sum(is.na(sub_effort_1)),
            total_effort_1_all_na = all(is.na(total_effort_1)),
            total_effort_2_all_na = all(is.na(total_effort_2)),
            sub_effort_1_all_na = all(is.na(sub_effort_1)),
            sub_effort_2_all_na = all(is.na(sub_effort_2))) %>% 
  print(n = nrow(.))
#true values mean they are all na, a false values means at least one is not na

na_check %>% 
  mutate(na_total_effort1_but_effort_2 = case_when(total_effort_1_all_na == TRUE & 
                                                     total_effort_2_all_na == FALSE ~ "TRUE",
         TRUE ~ "FALSE")) %>% 
  group_by(na_total_effort1_but_effort_2) %>% 
  count()
#most without a flag have total effort in total effort 2 but not total effort 1
na_check %>% 
   mutate(na_total_effort1_but_effort_2 = case_when(total_effort_1_all_na == TRUE & 
                                                     total_effort_2_all_na == FALSE ~ "TRUE",
         TRUE ~ "FALSE")) %>%
  filter(na_total_effort1_but_effort_2 != "TRUE")

na_check %>% 
   mutate(na_total_effort1_but_effort_2 = case_when(total_effort_1_all_na == TRUE & 
                                                     total_effort_2_all_na == FALSE ~ "TRUE",
         TRUE ~ "FALSE")) %>%
  filter(na_total_effort1_but_effort_2 != "FALSE")

rm(ia_na, ia_specific_case, na_check)

#Michigan 
mi_na <- mw_data %>% 
  filter(state == "Michigan") %>% 
  filter(total_effort_ident %in% c("2169", "2170", "2171")) %>% 
  collect()

mi_na %>% 
  group_by(survey_id) %>% 
  count()
#wacky survey 4042 - I remember this being a thing in aggregation but worth a double check
rm(mi_na)

#gear separation
gears_by_state <- mw_data %>% 
  distinct(state, sampling_method, sampling_method_2) %>% 
  collect()

gears_simple <- read_csv("gears_by_state.csv")
gears_simple %>% 
  group_by(state) %>% 
  summarise(n_distinct(simple_gear, sampling_method, sampling_method_2))

unique_methods <- gears_simple %>% 
  mutate(sampling_method_state = paste0(sampling_method, "-", state)) %>% 
  group_by(simple_gear) %>% 
  summarise(unique_methods = list(unique(sampling_method_state))) %>% 
  mutate(unique_methods = sapply(unique_methods, paste, collapse = ";"))
write_csv(unique_methods, "unique_sampling_methods.csv")

unique_methods %>% 
  unnest() %>% 
  group_by(simple_gear) %>% 
  summarise(count = n_distinct(unique_methods)) %>% 
  ggplot( aes(x = reorder(simple_gear, -count), y = count)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = "Number of Unique Sampling Methods per Simple Gear",
       x = "Simple Gear",
       y = "Number of Unique Methods") +
  theme_minimal()

#what does nhdhr_id look like for each state?
mw_data %>%
  select(state, nhdhr_id) %>% 
  distinct(state, nhdhr_id) %>% 
  collect() %>% 
  group_by(state) %>%
  slice_sample(n = 1)

mw_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "hive"), partitioning = c("state")) 

sampling_method_list <- mw_data %>% 
  distinct(state, sampling_method, sampling_method_2) %>% 
  collect() 
write_csv(sampling_method_list, "stnd_gears_xwalk_9Sept24.csv")
```

# Lagos and state ids to nhdids?
```{r}
library(mwlaxeref)

cpe_data <- read_csv("all_state_cpue_6Feb24.csv") %>% 
  filter(state == "Minnesota") %>% 
  distinct(lake_id, lake_name, nhdhr_id) %>% 
  local_to_lagos(from_colname = "lake_id", states = "mn") %>% 
  lagos_to_nhdhr(from_colname = "lagos.id")

cpe_data %>% 
  mutate(nhd_match = case_when(nhdhr_id == nhdhr.id ~ TRUE,
                               TRUE ~ FALSE)) %>% 
  group_by(nhd_match) %>% 
  count()

no_match <- cpe_data %>% 
  mutate(nhd_match = case_when(nhdhr_id == nhdhr.id ~ TRUE,
                               TRUE ~ FALSE)) %>% 
  filter(nhd_match == F)
#all non matches are due to NAs at some level 

#updated crosswalk - looking at just Minnesota 
cross_update <- read_csv("MGLP_FISH_LAKES_update.csv") %>% 
  filter(STATE == "MN") %>% 
  mutate(NHDHR_ID = gsub("^nhdhr_", "", NHDHR_ID)) %>% 
  #msu lagos to nhdhr
  lagos_to_nhdhr(from_colname = "lagoslakeid") %>% 
  rename(nhdhr_from_msu_lagos = nhdhr.id) %>% 
  #msu nhdhr to lagos
  nhdhr_to_lagos(from_colname = "NHDHR_ID") %>% 
  rename(lagos_from_msu_nhdhr = lagos.id) %>% 
  #msu local id to lagos
  local_to_lagos(from_colname = "STATE_ID", states = "mn") %>% 
  rename(lagos_from_state_id = lagos.id) %>% 
  #msu local id to nhdhr
  local_to_nhdhr(from_colname = "STATE_ID", states = "mn") %>% 
  rename(nhdhr_from_state_id = nhdhr.id) %>% 
  #1. is the msu lagos the same as lagos generated by state id?
  #2. is the msu lagos the same as lagos generated by msu nhdhr id?
  #3. is the msu nhdhr the same as nhdhr generated by state id?
  #4. is the msu nhdhr the same as nhdhr generated by msu lagos id?
  mutate(lagos_msu_to_state_crosswalk = case_when(lagoslakeid == lagos_from_state_id ~ T,
                                 T ~ F),
         lagos_msu_to_nhdhr_crosswalk = case_when(lagoslakeid == lagos_from_msu_nhdhr ~ T,
                                 T ~ F),
         nhdhr_msu_to_state_crosswalk = case_when(NHDHR_ID == nhdhr_from_state_id ~ T,
                                           T ~ F),
         nhdhr_msu_to_lagos_crosswalk = case_when(NHDHR_ID == nhdhr_from_msu_lagos ~ T,
                                           T ~ F)) %>% 
  select(STATE_ID,
         LAKE_NAME,
         lagoslakeid,
         lagos_from_state_id,
         lagos_from_msu_nhdhr,
         lagos_msu_to_state_crosswalk,
         lagos_msu_to_nhdhr_crosswalk,
         NHDHR_ID,
         nhdhr_from_state_id,
         nhdhr_from_msu_lagos,
         nhdhr_msu_to_state_crosswalk,
         nhdhr_msu_to_lagos_crosswalk)

cross_update %>% 
  group_by(lagos_msu_to_state_crosswalk,
         lagos_msu_to_nhdhr_crosswalk) %>%
  count()

cross_update %>% 
  group_by(nhdhr_msu_to_state_crosswalk,
          nhdhr_msu_to_lagos_crosswalk) %>%
  count()


#msu cross all states
cross_update_all <- read_csv("MGLP_FISH_LAKES_update.csv") %>% 
  mutate(NHDHR_ID = gsub("^nhdhr_", "", NHDHR_ID)) %>% 
  #msu lagos to nhdhr
  lagos_to_nhdhr(from_colname = "lagoslakeid") %>% 
  rename(nhdhr_from_msu_lagos = nhdhr.id) %>% 
  #msu nhdhr to lagos
  nhdhr_to_lagos(from_colname = "NHDHR_ID") %>% 
  rename(lagos_from_msu_nhdhr = lagos.id) %>% 
  #msu local id to lagos
  #local_to_lagos(from_colname = "STATE_ID", states = c("mn", "ia", "wi", "sd", "il", "mi", "in")) %>% 
  #rename(lagos_from_state_id = lagos.id) %>% 
  #msu local id to nhdhr
  #local_to_nhdhr(from_colname = "STATE_ID", states = c("mn", "ia", "wi", "sd", "il", "mi", "in")) %>% 
  #rename(nhdhr_from_state_id = nhdhr.id) %>% 
  #1. is the msu lagos the same as lagos generated by state id?
  #2. is the msu lagos the same as lagos generated by msu nhdhr id?
  #3. is the msu nhdhr the same as nhdhr generated by state id?
  #4. is the msu nhdhr the same as nhdhr generated by msu lagos id?
  mutate(#lagos_msu_to_state_crosswalk = case_when(lagoslakeid == lagos_from_state_id ~ T,
           #                      T ~ F),
         lagos_msu_to_nhdhr_crosswalk = case_when(lagoslakeid == lagos_from_msu_nhdhr ~ T,
                                 T ~ F),
         #nhdhr_msu_to_state_crosswalk = case_when(NHDHR_ID == nhdhr_from_state_id ~ T,
          #                                 T ~ F),
         nhdhr_msu_to_lagos_crosswalk = case_when(NHDHR_ID == nhdhr_from_msu_lagos ~ T,
                                           T ~ F)) %>% 
  select(STATE_ID,
         LAKE_NAME,
         lagoslakeid,
         #lagos_from_state_id,
         lagos_from_msu_nhdhr,
         #lagos_msu_to_state_crosswalk,
         lagos_msu_to_nhdhr_crosswalk,
         NHDHR_ID,
         #nhdhr_from_state_id,
         nhdhr_from_msu_lagos,
         #nhdhr_msu_to_state_crosswalk,
         nhdhr_msu_to_lagos_crosswalk)

cross_update_all %>% 
  group_by(nhdhr_msu_to_lagos_crosswalk,
         lagos_msu_to_nhdhr_crosswalk) %>%
  count()

cross_update_all %>% 
  group_by(is.na(lagoslakeid), is.na(NHDHR_ID)) %>% 
  count()

#msu crosswalk
cross <- read_csv("MGLP_FISH_LAKES.csv") %>% 
  filter(STATE == "MN") %>% 
  lagos_to_nhdhr(from_colname = "LAGOSLAKEID") %>% 
  local_to_lagos(from_colname = "STATE_ID", states = "mn") %>% 
  rename(lagos.id.local = lagos.id) %>% 
  nhdhr_to_lagos(from_colname = "NHDHR_ID") %>% 
  rename(lagos.id.nhdhr = lagos.id) %>% 
  mutate(lagos_local_match = case_when(LAGOSLAKEID == lagos.id.local ~ T,
                                 T ~ F),
         lagos_nhdhr_match = case_when(LAGOSLAKEID == lagos.id.nhdhr ~ T,
                                 T ~ F),
         nhdhr.match.msu.lagos = case_when(NHDHR_ID == nhdhr.id ~ T,
                                           T ~ F)) %>% 
  select(LAGOSLAKEID,
         lagos.id.local,
         lagos.id.nhdhr,
         lagos_local_match,
         lagos_nhdhr_match,
         NHDHR_ID,
         nhdhr.id,
        nhdhr.match.msu.lagos,
        STATE_ID,
        LAKE_NAME
         )

cross %>% 
  group_by(lagos_local_match, lagos_nhdhr_match, nhdhr.match.msu.lagos) %>%
  count()

#nhdhr ids match when I go from local id to lagos id and then to nhdhr 
#nothing matches when I based my nhdhr off the lagos id given by the msu team
  #1. lagos to nhdhr - no match
  #2. local id to lagos - no match
  #3. nhdhr to lagos - no match 
#the best we get is 18 matches using the local state id to get lagos 
```

#new hive
```{r}
mw_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "hive_update"), partitioning = c("state")) 
glimpse(mw_data)

mw_data <- open_dataset(sources = file.path("G:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "hive_update"), partitioning = c("state")) %>% 
  filter(state %in% c("Illinois", "Michigan")) %>% 
  group_by(species_1, state) %>% 
  count() %>% 
  collect()

mw_data %>% 
  distinct(state, sampling_method_simple, sampling_method, sampling_method_2) %>% 
  collect() %>% 
  arrange(sampling_method_simple, sampling_method, state) %>% 
  print(n = nrow(.))

#note here that it was doing the NA thing where it thinks each one is a unique value. have to pull in lake data first 
mw_data %>% 
  mutate(latitude_lake_centroid = case_when(
    is.na(latitude_lake_centroid) ~ "null",  # Replace NA with "null"
    TRUE ~ as.character(latitude_lake_centroid)  # Ensure all values are strings
  )) %>% 
  distinct(state, lake_id, lake_name, nhdhr_id, latitude_lake_centroid) %>% 
  collect() %>% 
  mutate(latitude_lake_centroid = case_when(
    latitude_lake_centroid == "null" ~ NA_real_,  # Convert "null" back to NA (as numeric)
    TRUE ~ as.numeric(latitude_lake_centroid)  # Convert back to numeric after filtering
  )) %>% 
  distinct(state, lake_id, lake_name, nhdhr_id, latitude_lake_centroid) %>% 
  group_by(state, is.na(nhdhr_id), is.na(latitude_lake_centroid)) %>% 
  count() %>% 
  collect()

mw_data %>% 
  distinct(state, lake_id, lake_name, nhdhr_id) %>% 
  collect() %>% 
  group_by(state, is.na(nhdhr_id)) %>% 
  count() %>% 
  collect()

mw_data %>% 
  distinct(nhdhr_id, lake_id, latitude_lake_centroid, longitude_lake_centroid) %>% 
  group_by(is.na(nhdhr_id), is.na(latitude_lake_centroid)) %>% 
  count() %>% 
  collect()

mw_data %>% 
  filter(state == "Michigan" & is.na(nhdhr_id) & is.na(lat_unspec)) %>% 
  collect() %>% 
  glimpse()

mw_data %>% 
  distinct(total_effort_ident, sampling_method_simple, sampling_method, state) %>% 
  group_by(sampling_method_simple, sampling_method, state) %>% 
  count() %>% 
  collect() %>% 
  ggplot(aes(x = sampling_method, y = n, fill = state)) +
  geom_bar(stat = "identity") +
  facet_wrap(~sampling_method_simple, scales = "free") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

mw_data %>% 
  filter(state == "Wisconsin") %>% 
  group_by(species_1) %>% 
  count() %>% 
  collect() %>% 
  arrange(desc(n)) %>% 
  print(n = nrow(20))

mw_data %>% 
  filter(state == "Wisconsin") %>% 
  glimpse()

#do we have more than 100 species caught in a survey?
mw_data %>% 
  filter(state == "Wisconsin" | state == "Iowa") %>% 
  filter(!is.na(species_1)) %>% 
  group_by(state, total_effort_ident) %>% 
  summarise(n_species_survey = n_distinct(species_1)) %>% 
  group_by(state) %>% 
  summarise(max(n_species_survey)) %>% 
  collect()

#doesn't look like n>100 in a survey - what about all time in a lake?
mw_data %>% 
  filter(!is.na(species_1)) %>% 
  filter(!is.na(nhdhr_id)) %>%
  group_by(state, nhdhr_id) %>% 
  summarise(n_species_lake = n_distinct(species_1)) %>% 
  group_by(state) %>% 
  summarise(max(n_species_lake)) %>% 
  collect()

mw_data %>% 
  filter(!is.na(species_1)) %>% 
  filter(!is.na(nhdhr_id)) %>%
  group_by(state, nhdhr_id) %>% 
  summarise(n_species = n_distinct(species_1)) %>% 
  collect() %>%
  group_by(state) %>% 
  summarise(max(n_species))

#looks like this comes into play when nhdhr_ids are na
mw_data %>% 
  filter(!is.na(species_1)) %>%
  filter(!is.na(nhdhr_id)) %>%
  group_by(state, nhdhr_id) %>% 
  summarise(n_species = n_distinct(species_1)) %>% 
  collect() %>%
  group_by(state) %>% 
  summarise(max(n_species))

mw_data %>% 
  filter(state == "Wisconsin" | state == "Iowa") %>% 
  filter(!is.na(nhdhr_id)) %>% 
  filter(!is.na(species_1)) %>% 
  group_by(state, nhdhr_id) %>% 
  summarise(n_species_lake = n_distinct(species_1)) %>% 
  group_by(state) %>% 
  summarise(max(n_species_lake)) %>% 
  collect()

#pulling out the lakes that have the highest # of species caught in them of all states
mw_data %>% 
  filter(!is.na(nhdhr_id)) %>% 
  filter(!is.na(species_1)) %>% 
  group_by(state, nhdhr_id, lake_name, lake_id) %>% 
  summarise(n_species_lake = n_distinct(species_1)) %>% 
  collect() %>% 
  group_by(state) %>% 
  slice_max(n_species_lake, n = 1, with_ties = FALSE)

#looking at species within pepin
mw_data %>% 
  filter(!is.na(species_1)) %>% 
  filter(lake_id == "25000100") %>% 
  group_by(species_1) %>% 
  summarise(n = n()) %>%
  collect() %>% 
  arrange(species_1) %>% 
  print(n = nrow(.))

mw_data %>% 
  filter(state == "Michigan") %>% 
  filter(!is.na(nhdhr_id)) %>% 
  distinct(year, nhdhr_id) %>% 
  group_by(nhdhr_id) %>% 
  summarise(n_years = n_distinct(year)) %>% 
  collect() %>% 
  filter(n_years > 1) %>% 
  print( n = nrow(.))
#most lakes in MI only have 1 years of data - some have 2

mw_data %>% 
  filter(lake_id == "6000200") %>% 
  distinct(survey_type, year) %>% 
  collect() %>% 
  arrange(desc(year)) %>% 
  print(n = nrow(.))

mw_data %>% 
  filter(lake_id == "6000200") %>% 
  filter(year == 2021) %>% 
  group_by(total_effort_ident, survey_type, sampling_method_simple, sampling_method, sampling_method_2, flag) %>% 
  count() %>% 
  collect()

mw_data %>% 
  filter(lake_id == "6000200") %>% 
  filter(year == 2021) %>% 
  group_by(total_effort_ident, area_group, sampling_method, total_effort_1, month(date_total_effort_ident), flag) %>% 
  count() %>% 
  collect()
#gill net gets ruled out by month (total effort ident date is may)
#trap nets get ruled out by a flag (except there are only 2 with a flag - does distinct take the first?)
#other traps nets are not standard and do not show up

mw_data %>% 
  filter(lake_id == "6000200") %>% 
  filter(year == 2021) %>% 
  distinct(total_effort_ident, sampling_method, flag) %>% 
  collect()

glimpse(mw_data)

mw_data %>% 
  group_by(state) %>% 
  count() %>% 
  collect()

mw_data %>% 
  filter(state == "Illinois") %>% 
  group_by(is.na(species_1)) %>% 
  count() %>% 
  collect()

mw_data %>% 
  filter(state %in% c("Illinois", "Michigan")) %>% 
  group_by(flag) %>% 
  count() %>% 
  collect()

mw_data %>% 
  filter(state == "Michigan") %>% 
  filter(!is.na(date_total_effort_ident)) %>% 
  group_by(is.na(length_bin), year) %>% 
  count() %>% 
  collect() %>% 
  arrange(desc(year)) %>% 
  print(n = nrow(.))

mw_data %>% 
  group_by(state, is.na(age)) %>% 
  count() %>% 
  collect()

#do i retain both flags creations within IL?
mw_data %>%
  filter(state == "Illinois") %>% 
  filter(!is.na(species_1)) %>% 
  group_by(species_1, flag) %>% 
  summarise(max = max(length_1, na.rm = T)) %>% 
  arrange(desc(max)) %>% 
  collect() %>% 
  print(n = nrow(.))

#lake of the woods check 
mw_data %>% 
  filter(state == "Minnesota" & lake_id == "39000200") %>% 
  group_by(year) %>% 
  count() %>% 
  arrange(desc(year)) %>% 
  collect() %>% 
  print(n = nrow(.))

#what is going on with some missing LOW years?
mw_data %>% 
  filter(state == "Minnesota" & lake_id == "39000200") %>%
  filter(year %in% c("1996", "1997", "2013")) %>% 
  collect() %>% 
  group_by(total_effort_ident, flag, year, sampling_method_simple) %>%
  count() 

#gill netting data in 2013 gets thrown out because 58 records have gear issues (total effort ident 25580)
mw_data %>% 
  filter(state == "Minnesota" & lake_id == "39000200") %>%
  filter(year %in% c("1996", "1997", "2013")) %>%
  collect() %>% 
  group_by(total_effort_ident) %>% 
  filter(all(is.na(flag))) %>% 
  group_by(total_effort_ident, flag, year, sampling_method_simple) %>%
  count()

mw_data %>% 
  filter(state == "Minnesota" & lake_id == "39000200") %>%
  filter(year %in% c("1996", "1997", "2013")) %>%
  collect() %>% 
  group_by(total_effort_ident) %>% 
  filter(all(is.na(flag))) %>% 
  ungroup() %>% 
  group_by(total_effort_ident, month(date_total_effort_ident), year, sampling_method_simple) %>% 
  count() %>% 
  collect()
#na dates for total effort ident

mw_data %>% 
  filter(state == "Minnesota") %>% 
  filter(total_effort_ident == "44271") %>% 
  collect() %>% 
  distinct(total_effort_ident,
         date_total_effort_ident,
         month,
         year) %>% 
  print(n = nrow(.))
#one date with a may month but the rest of September?
#how is month and year generated?

mw_data %>% 
  filter(state == "Minnesota") %>% 
  filter(total_effort_ident == "44281") %>% 
  collect() %>% 
  distinct(total_effort_ident,
         date_total_effort_ident,
         survey_type,
         month,
         year) %>% 
  print(n = nrow(.))

mw_data %>% 
  filter(survey_type == "HISTORICAL") %>% 
  distinct(total_effort_ident, date_total_effort_ident) %>% 
  collect() %>% 
  distinct(total_effort_ident, date_total_effort_ident) %>% 
   group_by(is.na(date_total_effort_ident)) %>% 
   count()
#it appears that all historical surveys have na total effort idents?

mw_data %>% 
  filter(lake_id == "6000200") %>% 
  filter(year == 2021) %>% 
  filter(sampling_method_simple == "gill_net") %>% 
  collect() %>% 
  group_by(flag, month(date_total_effort_ident), total_effort_1, area_group) %>% 
  count() 

mw_data %>% 
  filter(state == "Indiana" & year == 2018 & sampling_method == "trap_net_michigan" & lake_name == "Brookville") %>% 
  group_by(total_effort_ident,total_effort_1) %>% 
  count() %>% 
  collect()

mw_data %>% 
  filter(state == "Indiana") %>% 
  select(total_effort_ident, total_effort_1) %>% 
  collect() %>% 
  group_by(total_effort_ident, total_effort_1) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n >1)

mw_data %>% 
  filter(state == "Iowa") %>% 
  collect() %>% 
  distinct(total_effort_ident, total_effort_1, .keep_all = T) %>% 
  group_by(is.na(total_effort_1), is.na(flag)) %>% 
  count()

mw_data %>% 
  filter(state == "Iowa") %>% 
  collect() %>% 
  distinct(total_effort_ident, total_effort_1, .keep_all = T) %>% 
  filter(is.na(total_effort_1) & is.na(flag)) %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  print(n = nrow(.))

  filter(state == "Michigan") %>% 
  collect() %>% 
  group_by(is.na(length_1), is.na(length_bin)) %>% 
  count()

#Iowa na total effort 
na_total <- mw_data %>% 
  filter(state == "Iowa") %>% 
  filter(is.na(total_effort_1)) %>%
  filter(is.na(flag)) %>% 
  collect() %>% 
  distinct(total_effort_ident) 

#do all of these have more than one sampling method within the same total effort ident?
mw_data %>% 
  filter(state == "Iowa") %>% 
  select(total_effort_ident,
         total_effort_1, 
         sub_effort_1, 
         sampling_method_simple,
         sampling_method, 
         sampling_method_2,
         lake_name,
         date_total_effort_ident,
         species_1, 
         length_1, 
         flag, 
         total_effort_nothing_caught) %>% 
  collect() %>% 
  filter(total_effort_ident %in% na_total$total_effort_ident) %>% 
  group_by(total_effort_ident, sampling_method_simple, sampling_method, sampling_method_2) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  print(n = nrow(.))


#looking at specific cases
iowa_check <-  mw_data %>% 
  filter(state == "Iowa" & total_effort_ident == 258) %>% 
  select(total_effort_ident,
         total_effort_1, 
         sub_effort_1, 
         sampling_method_simple,
         sampling_method, 
         lake_name,
         date_total_effort_ident,
         species_1, 
         length_1, 
         flag, 
         total_effort_nothing_caught,
         total_effort_2,
         total_effort_3) %>% 
  collect()
#different sampling method but the same date and lake: 258, 2850

#recruitment workshop
mw_data %>% 
  filter(state == "Minnesota" & species_1 == "rock_bass" & sampling_method == "gill_net_standard") %>% 
  summarise(min_year = min(year),
            max_year = max(year)) %>% 
  collect()

mw_data %>% 
  filter(state == "Minnesota" & species_1 == "rock_bass" & sampling_method == "gill_net_standard") %>% 
  collect() %>% 
  group_by(lake_id) %>% 
  slice_min(order_by = length_1, n = 100, with_ties = F) %>% 
  group_by(lake_id) %>% 
  summarise(average_smallest_10 = mean(length_1, na.rm = T)) %>% 
  filter(!is.na(average_smallest_10)) %>% 
  summarise(mean_smallest = mean(average_smallest_10))

mw_data %>% 
  filter(state == "Minnesota" & species_1 == "rock_bass" & sampling_method == "gill_net_standard") %>%
  group_by(year) %>% 
  count() %>% 
  collect() %>% 
  arrange(year) %>% 
  print(n = nrow(.))

mw_data %>% 
  filter(sampling_method_simple == "gill_net" & state == "Minnesota") %>% 
  group_by(sampling_method) %>% 
  count() %>% 
  collect()
```

#mn large lake summaries
```{r}
library(tidyverse)
library(arrow)
mw_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "hive_update"), partitioning = c("state")) 

mw_data %>% 
  filter(lake_name %in% c("Cass",
                          "Kabetogama", 
                          "Lake of the Woods", 
                          "Leech",
                          "Mille Lacs", 
                          "Pepin", 
                          "Rainy", 
                          "Upper Red", 
                          "Vermilion", 
                          "Winnibigoshish")) %>% 
  filter(!(lake_id %in% c("{D3003F72-D06F-4FE6-8FCE-E8B1A15DC4C9}", 
                          "11035600",
                          "40002800",
                          "77002500 "))) %>% 
  distinct(lake_name, lake_id) %>% 
  collect() %>% 
  arrange(lake_name)

mw_data %>% 
  filter(lake_name %in% c("Cass",
                          "Kabetogama", 
                          "Lake of the Woods", 
                          "Leech",
                          "Mille Lacs", 
                          "Pepin", 
                          "Rainy", 
                          "Upper Red", 
                          "Vermilion", 
                          "Winnibigoshish")) %>% 
  filter(!(lake_id %in% c("{D3003F72-D06F-4FE6-8FCE-E8B1A15DC4C9}", 
                          "11035600",
                          "40002800",
                          "77002500 "))) %>% 
  group_by(lake_name) %>% 
  summarise(max_year = max(year),
            min_year = min(year),
            n_years = n_distinct(year)) %>% 
  collect()

mw_data %>% 
  filter(lake_name == "Lake of the Woods" & state == "Minnesota") %>% 
  group_by(year, survey_type, sampling_method_simple, total_effort_nothing_caught) %>% 
  count() %>% 
  collect() %>% 
  print(n = nrow(.))

mw_data %>% 
  filter(lake_name == "Lake of the Woods" & state == "Minnesota" & sampling_method_simple == "gill_net") %>%
  distinct(year, survey_type) %>% 
  collect() %>% 
  arrange(year) %>% 
  print(n = nrow(.))

mw_data %>% 
  filter(lake_name == "Lake of the Woods" & 
           state == "Minnesota" & 
           sampling_method_simple == "gill_net" & 
           year == 1995) %>%
  collect() %>% 
  group_by(survey_type) %>% 
  summarise(count = n())

mw_data %>% 
  filter(lake_name == "Lake of the Woods" & 
           state == "Minnesota" & 
           sampling_method_simple == "gill_net" & 
           year == 1995) %>%
  collect() %>% 
  select(lake_name, survey_type, species_1, total_effort_nothing_caught)

mw_data %>% 
  filter(lake_name == "Winnibigoshish" & 
           state == "Minnesota" & 
           sampling_method_simple == "gill_net" & 
           year == 1996) %>%
  collect() %>% 
  select(lake_name, survey_type, species_1, total_effort_nothing_caught) %>% 
  group_by(species_1) %>% 
  count()

#writing data head for mn large lakes format
cpe_head <- read_csv(file.path("G:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "MN_Data", "mn_raw_disaggregated_data", "mn_cpue_21aug2023.csv")) %>% 
  head()

effort_head <- read_csv(file.path("G:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "MN_Data", "mn_raw_disaggregated_data", "mn_effort_18aug2023.csv")) %>% 
  head()

fish_head <- read_csv(file.path("G:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "MN_Data", "mn_raw_disaggregated_data", "mn_indiv_fish_23nov2023.csv")) %>% 
  head()

write_csv(cpe_head, "Data_and_Scripts/mn_cpe_example.csv")
write_csv(effort_head, "Data_and_Scripts/mn_effort_example.csv")
write_csv(fish_head, "Data_and_Scripts/mn_fish_example.csv")
```

# Minneosta large lakes update
```{r}
#effort data 
ll_effort <- read_csv("02tbl_GN_Effort.csv") %>% 
  rename(SURVEY_ID = ID)

glimpse(ll_effort)

ll_effort %>% 
  summarise(n_distinct_ID = n_distinct(SURVEY_ID))

ll_effort %>% 
  group_by(SAMP_STA_TYPE_NAME, GEAR_TP) %>% 
  count()

ll_effort %>% 
  group_by(Year, NAME, GEAR_TP) %>%
  summarise(n_nets = n_distinct(STATION_CODE),
            n_ID = n_distinct(SURVEY_ID)) %>% 
  filter(n_ID != n_nets)

ll_effort %>% 
  distinct(SURVEY_ID)

ll_effort %>% 
  distinct(Year, NAME, STATION_CODE)

#############################################################################
#fish data
ll_fish <- read_csv("MN_LL_FISH.csv") %>% 
  rename(STATION_CODE = STATION)

glimpse(ll_fish)

ll_fish %>% 
  distinct(SURVEY_ID)

ll_fish %>% 
  distinct(SURVEY_ID, STATION_CODE)

#############################################################################
#combined data
ll_fish_effort <- ll_fish %>% 
  left_join(ll_effort, by = c("SURVEY_ID", "STATION_CODE"))

glimpse(ll_fish_effort)

ll_fish_effort %>% 
  group_by(Year, NAME) %>% 
  summarise(n_survey_ids = n_distinct(SURVEY_ID),
            n_nets = )

ll_fish_effort %>% 
  distinct(Year, NAME, STATION_CODE)

ll_fish_effort %>% 
  distinct(SURVEY_ID)

ll_fish_effort %>% 
  group_by(is.na(SURVEY_ID)) %>% 
  count()

#I would expect that the survey ID Ns would match that of the Year, NAME, STATION_CODE, figure out what that isn't the case
#I get 14 more survey ids than the other grouping 
```

