---
title: "IL_Flat_File_Aggregation"
author: "Mike Verhoeven"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Preamble

#notes as of 2/26/24:
-all surveys/sub surveys were made their own survey. Each part has their own unique effort ident with either the target species listed or the "non-target species" listed
-no nhdids exist
-sub effort idents were created so that call sub efforts have a unique ident. net number was also retained to identify agency nets/runs within a survey
-the aging file did not contain a separate effort file - 0s might not be fully represented - a flag was created
-some surveys/runs contain 0 effort indicative of errors in the agency data themselves - a flag was created


-naming schema: -made net/run (agency provided) into site_id 
                -moved sub sampling designation to gear data notes 
                -target species lists species with either Y or N at the end


##Libraries
```{r}
library(arrow)
library(readr)
library(dplyr)
library(stringr)
library(data.table)
library(janitor)
library(tidyr)
library(lubridate)
library(bit64)
library(mwlaxeref)
library(tidyverse)
options(scipen = 999)
```


##Data
```{r}
#generate a file list to import
files_list <- list.files(path = "D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/IL_Data/il_raw_disaggregated_data", pattern = ".+\\.csv") #grabs only.csv files
files_list



#object for use in loop (simple length of file list)
n <- length(files_list)

for(i in 1:n) {
  #i = 1
  filei <- word(gsub(".csv","", files_list[i]), start = -1, sep = fixed("/"))
  #this does those two steps in one package
  assign(filei ,
          fread(paste0("D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/IL_Data/il_raw_disaggregated_data/",
                                          files_list[i])))
  
  # if the file is a crosswalk, do not rename anything, just loop to the confirm import line
  if(str_detect(filei, "crosswalk")) {  #confirm import of files:  
    print(paste(filei ,"added to workspace" ))  
    #confirm import of files:  
    print(paste(i ,"files added to workspace" )) ; next}
  
  #if the file is not in the data explainer, don't try to rename it:
  if(filei %in% cde$new_file_name) {
    print("renaming with data explainer")
  } else {next}
  
  
  
  
  
  # note we want to review a sorted list of column names to check misspelling etc.
  # we still need to use the columns with names like col_name_length_in, or known_units
  
  
  cde %>% # call data explainer file
    filter(`new_file_name`== filei)%>% #keep only the row relevant to this file
    select_if(~ !any(is.na(.))) %>% 
    data.table::transpose(keep.names = "newname") %>% 
    rename("oldname" = V1) %>% 
    assign("names", ., envir = .GlobalEnv)
  
  #see if any column names will not have a match! 
  # IF any pop FALSE, force stop and revist of data explainer ()
  # - e.g., named something "total catch" when actual column name was "total_catch"
  print(
    cbind(colnames(get(filei)),
          colnames(get(filei)) %in% names[ !str_detect(newname,"unique_row_key"), oldname, ]
    )
  )
  
  
  # break the loop if the current file has column names not in the data explainer
  # if (all(cbind(colnames(get(filei)),  colnames(get(filei)) %in% names[ !str_detect(newname,"unique_row_key"), oldname, ])[,2]) == FALSE ) break
  if (all(colnames(get(filei)) %in% names[ !str_detect(newname,"unique_row_key"), oldname, ]) == FALSE ) break
  
  
  # append old col names into new "notes" columns:
  get(filei)[ , (names[ str_detect(newname, "notes") , oldname   ,  ]) := Map(paste, colnames(.SD), .SD, sep = ':') , .SDcols =  names[ str_detect(newname, "notes") , oldname   ,  ] ]
  
  #now rename that file's colnames
  setnames(get(filei), colnames(get(filei)), names[!str_detect(newname,"unique_row_key")] [match(names(get(filei)),names[!str_detect(newname,"unique_row_key"),oldname]), newname] )
  
  #append all other data from data explainer
  unusedbits <- 
    data.table(
      matrix(
        rep(names[ !newname %in% colnames(get(filei)) , oldname , ],
            each = nrow(get(filei))
        ),
        nrow = nrow(get(filei)),
        dimnames = list(rep(NA,nrow(get(filei))),
                        names[ !newname %in% colnames(get(filei)) , newname , ])
        )
      )
  
  #add all not yet used columns from data explainer:
  get(filei)[ , (names[ !newname %in% colnames(get(filei)) , newname , ]) := unusedbits[] ]

  #confirm import of files:  
  print(paste(filei ,"added to workspace" ))  
  #confirm import of files:  
  print(paste(i ,"files added to workspace" )) 

  
} 
  #confirm import of files:  
  print(paste(i ,"files added to workspace" ))
  #confirm import of files:  
  print(paste(n-i ,"remaining to be added" )) 



```

#Data Review
#this code was used as exploration in several iterations of the ag process (not needed in ag)
```{r}
# review each dataset that we have, strategizing about how you'll use them to develop a obs-level file
# consider things like species scope (do I need to restrict all input data to just the 8ish game species?), file organization (is this file already in a obs-level format or is it a count of each species/size that I should uncount()?), linking keys (is there a fish obs ID in the age data that I can use to link to the fish observations data?), and what things (possibly whole datasets) are unneeded for our work, here. I have left the Michigan work in here to give you an idea of what I did:


#aged fish
glimpse(il_aged_fish_surveys_12Dec2023)

il_aged_fish_surveys_12Dec2023 %>% 
  group_by(lake_name.1) %>% 
  count() 


#do the catch and aged data match for the surveys?
il_aged_fish_surveys_12Dec2023 %>% 
  group_by(year, survey_id, lake_name.1) %>% 
  count() %>% 
  print(n = nrow(.))
#only clinton and rend lake from 1985 - 2003

il_catch_age_effort_30Nov23 %>% 
  filter(survey_id %in% il_aged_fish_surveys_12Dec2023$survey_id) %>% 
  group_by(survey_id, lake_name.1, year) %>% 
  count() %>% 
  print(n = nrow(.))
#they aren't going to jive

#catch age effort
glimpse(il_catch_age_effort_30Nov23)

il_catch_age_effort_30Nov23 %>% 
  filter(!is.na(age)) %>% 
  glimpse()

il_catch_age_effort_30Nov23 %>% 
  filter(total_count.1 < 1) %>% 
  group_by(survey_id) %>% 
  count()

il_catch_age_effort_30Nov23 %>% 
  group_by(survey_id) %>% 
  summarise(n = n(), unique(total_effort_2)) 
#variable for sub-survey level effort ID

il_catch_age_effort_30Nov23 %>% 
  group_by(survey_id) %>% 
  summarise(n = n(), unique(total_effort_1))
  
#effort
glimpse(il_effort_30Nov23)
#efforts associated with lake/survey/date
#two efforts
#survey id matches with the catch file but not the aged fish surveys 

il_effort_30Nov23 %>% 
  filter(survey_id == "Survey_15") %>% 
  glimpse()

multieffort.effort <- il_effort_30Nov23 %>% 
  group_by(survey_id) %>% 
  summarise(n = n(), unique(total_effort_2)) %>%  
  filter(n >1)
#total effort 2 is a sub-survey level id for effort

multieffort.effort <- il_effort_30Nov23 %>% 
  group_by(survey_id) %>% 
  summarise(n = n(), unique(total_effort_1)) %>%  
  filter(n >1)

#lake info 
glimpse(il_lake_info_17Jan22)
#only has lake info (location, size, id)

#do survey ids match?
#do survey IDs match effort?
# il_aged_fish_surveys_28Dec2022 %>% 
#   group_by(lake_name.1, survey_id) %>% 
#   summarise(n = n())

# il_effort_17Jan22 %>% 
#   group_by(lake_name.1, survey_id) %>% 
#   summarise() %>% 
#   print(n = 20)



#from this exploration, aged fish, lake info are of no use
#in order to use the effort from the catch file we must:
##1. find a survey level grouping that lumps all sub-survey levels (survey_id, year, sampling method)
##2.sum the sub-survey level effort (EF runs/number of nets)
##3. create a survey level identifier that lumps the sub-survey levels appropriately 

#exploring mismatching surveys that I found while merging fish level effort and survey level effort
effort.catch <- il_catch_age_effort_30Nov23 %>% 
  distinct(survey_id, 
            lake_id,
             year, 
               date.1, 
                sampling_method.1, 
                gear_data_notes.1,
                total_effort_2, 
                 total_effort_1)

effort.effort <- il_effort_30Nov23 %>% 
    distinct(survey_id, 
            lake_id,
             year, 
               date.1, 
                sampling_method.1, 
                gear_data_notes.1,
                total_effort_2, 
                 total_effort_1)

mismatched.catch <- anti_join(effort.catch, effort.effort) %>% 
  rename(total_effort_2.catch = total_effort_2, 
         total_effort_1.catch =  total_effort_1)
mismatched.effort <- anti_join(effort.effort, effort.catch) %>% 
  rename(total_effort_2.effort = total_effort_2, 
         total_effort_1.effort =  total_effort_1)

final_mismatched_surveys <- bind_rows(
  mismatched.catch %>% select(survey_id, lake_id, year, date.1, sampling_method.1, gear_data_notes.1, total_effort_2.catch, total_effort_1.catch),
  mismatched.effort %>% select(survey_id, lake_id, year, date.1, sampling_method.1, gear_data_notes.1, total_effort_2.effort, total_effort_1.effort)
)

final_combined_surveys <- final_mismatched_surveys %>%
  group_by(
    survey_id, lake_id, year, date.1, sampling_method.1, gear_data_notes.1
  ) %>%
  summarize(
    total_effort_2.catch = sum(total_effort_2.catch, na.rm = TRUE),
    total_effort_1.catch = sum(total_effort_1.catch, na.rm = TRUE),
    total_effort_2.effort = sum(total_effort_2.effort, na.rm = TRUE),
    total_effort_1.effort = sum(total_effort_1.effort, na.rm = TRUE)
  ) %>% 
  mutate(total_effort_1.catch = case_when(total_effort_1.catch == 0 & total_effort_2.catch == 0 ~ NA,
                                          TRUE ~ total_effort_1.catch),
         total_effort_2.catch = case_when(is.na(total_effort_1.catch) ~ NA,
                                          TRUE ~ total_effort_2.catch),
         total_effort_1.effort = case_when(total_effort_1.effort == 0 & total_effort_2.effort == 0 ~ NA,
                                          TRUE ~ total_effort_1.effort),
         total_effort_2.effort = case_when(is.na(total_effort_1.effort) ~ NA,
                                          TRUE ~ total_effort_2.effort))
mismatched <- final_combined_surveys %>% 
  filter(!is.na(total_effort_1.catch) & !is.na(total_effort_2.effort))
nomatch <- final_combined_surveys %>% 
  filter(is.na(total_effort_1.catch) | is.na(total_effort_2.effort))


sur.503.catch <- effort.catch %>% 
  filter(survey_id == "Survey_503")

sur.503.effort <- effort.effort %>% 
  filter(survey_id == "Survey_503")
#survey503 has different effort in the catch and effort files

lake40.catch <- effort.catch %>% 
  filter(lake_id == "40")

lake40.effort <- effort.effort %>% 
  filter(lake_id == "40")
#several surveys that are mismatched within the same lake here

#sub effort exploration
il_catch_age_effort_30Nov23 %>% 
  distinct(survey_id, 
            lake_id,
             year, 
               date.1, 
                sampling_method.1, 
                gear_data_notes.1,
                total_effort_2, 
                 total_effort_1,
           .keep_all = T) %>% 
  mutate(subsample.time = case_when(garbage_bin_notes.1 == "Subsample Time:0" ~ "N",
                                    TRUE ~ "Y")) %>% 
  group_by(subsample.time, sampling_method.1) %>% 
  count()%>% 
  print(n = nrow(.))
#only in efishing but 17% of them

il_catch_age_effort_30Nov23 %>% 
  distinct(survey_id, 
            lake_id,
             year, 
               date.1, 
                sampling_method.1, 
                gear_data_notes.1,
                total_effort_2, 
                 total_effort_1,
           .keep_all = T) %>% 
  mutate(subsample.time = case_when(garbage_bin_notes.1 == "Subsample Time:0" ~ "N",
                                    TRUE ~ "Y")) %>% 
  group_by(garbage_bin_notes.1, sampling_method.1) %>% 
  count()%>% 
  print(n = nrow(.))

il_catch_age_effort_30Nov23 %>% 
  distinct(survey_id, 
            lake_id,
             year, 
               date.1, 
                sampling_method.1, 
                gear_data_notes.1,
                total_effort_2, 
                 total_effort_1) %>% 
  count()

#effort
il_effort_30Nov23 %>% 
  mutate(subsample.time = case_when(garbage_bin_notes.3 == "Subsample Time:0" ~ "N",
                                    TRUE ~ "Y")) %>%
  group_by(subsample.time) %>% 
  count() %>% 
  print(n = nrow(.))

il_effort_30Nov23 %>% 
  mutate(subsample.time = case_when(garbage_bin_notes.3 == "Subsample Time:0" ~ "N",
                                    TRUE ~ "Y")) %>%
  group_by(subsample.time, sampling_method.1) %>% 
  count() %>% 
  print(n = nrow(.))

il_effort_30Nov23 %>% 
  mutate(subsample.time = case_when(garbage_bin_notes.3 == "Subsample Time:0" ~ "N",
                                    TRUE ~ "Y")) %>%
  filter(subsample.time == "Y") %>% 
  group_by(garbage_bin_notes.4) %>% 
  count() %>% 
  print(n = nrow(.))
#most of the sub are for bluegill

il_effort_30Nov23 %>% 
  group_by(garbage_bin_notes.2, sampling_method.1) %>% 
  count()

il_catch_age_effort_30Nov23 %>% 
  filter(garbage_bin_notes.4 == "Sample Type:Targeted Species") %>% 
  group_by(survey_id, species.1) %>% 
  count() %>% 
  pivot_wider(id_cols = survey_id,
    names_from = "species.1",
              values_from = "n") %>% 
  print(n = nrow(.))

#generating notes for workshop
glimpse(il_effort_30Nov23)
#garbage_bin_notes.1
#lake_type
#sampling_method_1
#gear_data_notes.1
#survey_type.1
#garbage_bin_notes.2

check <- il_effort_30Nov23 %>% 
  group_by(garbage_bin_notes.1) %>% 
  count()

check <- il_effort_30Nov23 %>% 
  group_by(lake_type) %>% 
  count()

check <- il_effort_30Nov23 %>% 
  group_by(sampling_method.1) %>% 
  count()

check <- il_effort_30Nov23 %>% 
  group_by(gear_data_notes.1) %>% 
  count()

check <- il_effort_30Nov23 %>% 
  group_by(survey_type.1) %>% 
  count()

check <- il_effort_30Nov23 %>% 
  group_by(garbage_bin_notes.2) %>% 
  count()

check <- il_effort_30Nov23 %>% 
  filter(garbage_bin_notes.2 == "Sample Type:Targeted Species") %>% 
  group_by(gear_data_notes.1) %>% 
  count()

check <- il_effort_30Nov23 %>% 
  filter(garbage_bin_notes.2 == "Sample Type:Targeted Species") %>% 
  group_by(garbage_bin_notes.4) %>% 
  count()

glimpse(il_catch_age_effort_30Nov23)
#reproductive_condition_notes

check <- il_catch_age_effort_30Nov23 %>% 
  group_by(reproductive_condition_notes) %>% 
  count()
#no data in maturity 

glimpse(il_aged_fish_surveys_12Dec2023)
#garbage_bin_notes.3
#survey_type.1
#sampling_method_1
#gear_data_notes.1
#garbage_bin_notes.2
#reproductive_condition_notes

check <- il_aged_fish_surveys_12Dec2023 %>% 
  distinct(lake_name.1, year, sampling_method.1, .keep_all = T) %>% 
  group_by(garbage_bin_notes.3) %>% 
  count()

check <- il_aged_fish_surveys_12Dec2023 %>% 
  distinct(lake_name.1, year, sampling_method.1, .keep_all = T) %>% 
  group_by(survey_type.1) %>% 
  count()

check <- il_aged_fish_surveys_12Dec2023 %>% 
  distinct(lake_name.1, year, sampling_method.1, .keep_all = T) %>% 
  group_by(sampling_method.1) %>% 
  count()

check <- il_aged_fish_surveys_12Dec2023 %>% 
  distinct(lake_name.1, year, sampling_method.1, .keep_all = T) %>% 
  group_by(gear_data_notes.1) %>% 
  count()

check <- il_aged_fish_surveys_12Dec2023 %>% 
  distinct(lake_name.1, year, sampling_method.1, .keep_all = T) %>% 
  group_by(garbage_bin_notes.2, sampling_method.1) %>% 
  count()

check <- il_aged_fish_surveys_12Dec2023 %>% 
  distinct(lake_name.1, year, sampling_method.1, .keep_all = T) %>% 
  group_by(reproductive_condition_notes) %>% 
  count()

rm(check, effort.catch, effort.effort, final_combined_surveys, final_mismatched_surveys, lake40.catch, lake40.effort, mismatched, mismatched.catch, mismatched.effort, sur.503.catch, sur.503.effort, multieffort.effort)
```

#Catch effort join to fish 
```{r}
#uncounting batch fish 
#makes fish per row from batch counted fish
il_catch_age_effort_30Nov23_uncount <- il_catch_age_effort_30Nov23 %>% 
  #creating length bin category for bin counted fish
  mutate(length_bin = case_when(total_count.1 >1 ~ length.1,
                                TRUE ~ NA),
         length_bin_unit = case_when(total_count.1 > 1 ~ "minimum value of 10mm bin",
                                     TRUE ~ NA),
         #making length.1 na for fish that have a bin length
         length.1 = case_when(!is.na(length_bin) ~ NA,
                              TRUE ~ length.1)) %>% 
  uncount(total_count.1) %>% 
  #grabbing subsamping time for garb notes
  rename(subsample_time = garbage_bin_notes.1) %>% 
  #creating better effort identifiers
  mutate(sampling_method_agg = case_when(gear_data_notes.1 %in% c("Gear Used:Boat electrofishing AC") ~ "Boat electrofishing AC (Day)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing AC (Night)") ~ "Boat electrofishing AC (Night)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing DC - Unspecified Manufacturer",
                                                                "Gear Used:Boat electrofishing DC -- Smith Root",
                                                                "Gear Used:Boat electrofishing DC -- Wisconsin",
                                                                "Gear Used:Boat electrofishing DC") ~ "Boat electrofishing DC (Day)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing DC -- Smith Root (Night)",
                                                                "Gear Used:Boat electrofishing DC -- Wisconsin (Night)") ~ "Boat electrofishing DC (Night)",
                                       TRUE ~ gear_data_notes.1))

#collapsing effort from the fish obs level file 
#this file is checked for conflicts between the effort file in a later step - keeping effort in this file makes joining cleaner and retain surveys that didn't catch fish 

#In this step, I make a targeted species columns the effort spent sub sampling for surveys that have sub sample associated with them
#this keeps the data in a format so each survey is one row with associated sub sampling tagged 
il_effort_30Nov23_fixed <- il_effort_30Nov23 %>% 
  #pivot sub sampled species wider for a one-to-many join to the fish data
  group_by(
    survey_id,
    lake_id,
    year,
    date.1,
    gear_data_notes.1,
    total_effort_2,
    total_effort_1,
    original_file_name.1) %>% 
  mutate(subspecies_order = row_number()) %>% 
  pivot_wider(names_from = subspecies_order,
              values_from = c(garbage_bin_notes.4, garbage_bin_notes.3)) %>% 
  #clean column naming and entries in the columsn for useage below
  rename_with(~str_replace(., 'garbage_bin_notes.4', 'target_species'), contains("garbage_bin_notes.4")) %>% 
  rename_with( ~str_replace(., 'garbage_bin_notes.3', 'subsample_time'), contains("garbage_bin_notes.3")) %>% 
  mutate(subsample_time_1 = gsub("Subsample Time:", "", subsample_time_1),
         subsample_time_2 = gsub("Subsample Time:", "", subsample_time_2),
         subsample_time_3 = gsub("Subsample Time:", "", subsample_time_3),
         target_species_1 = gsub("Subsample Species:", "", target_species_1),
         target_species_2 = gsub("Subsample Species:", "", target_species_2),
         target_species_3 = gsub("Subsample Species:", "", target_species_3),
         target_species_1 = case_when(target_species_1 %in% c("", "0") ~ NA,
                                      TRUE ~ target_species_1),
         target_species_2 = case_when(target_species_2 %in% c("") ~ NA,
                                      TRUE ~ target_species_2),
         subsample_time_1 = as.numeric(subsample_time_1),
         subsample_time_2 = as.numeric(subsample_time_2),
         subsample_time_3 = as.numeric(subsample_time_3)) %>%
  #making a column that designates surveys in which a species was not targeted (only matters in efishing surveys)
  #this column gets cleaned further down as well
  unite(no_target, starts_with("target_species"), sep = ", ", remove = FALSE, na.rm = TRUE) %>% 
  mutate(no_target = case_when(no_target == "Bluegill, Black Crappie" ~ "Black Crappie, Bluegill",
                               no_target == "" ~ NA,
                               TRUE ~ no_target))


survey.effort <- il_effort_30Nov23_fixed %>%
  #creating better effort identifiers
  mutate(sampling_method_agg = case_when(gear_data_notes.1 %in% c("Gear Used:Boat electrofishing AC") ~ "Boat electrofishing AC (Day)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing AC (Night)") ~ "Boat electrofishing AC (Night)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing DC - Unspecified Manufacturer",
                                                                "Gear Used:Boat electrofishing DC -- Smith Root",
                                                                "Gear Used:Boat electrofishing DC -- Wisconsin",
                                                                "Gear Used:Boat electrofishing DC") ~ "Boat electrofishing DC (Day)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing DC -- Smith Root (Night)",
                                                                "Gear Used:Boat electrofishing DC -- Wisconsin (Night)") ~ "Boat electrofishing DC (Night)",
                                       TRUE ~ gear_data_notes.1)) %>% 
  #make a column that designates if sub sampling happened within a survey (sub sampling only happens in some efishing)
  mutate(indiv_subsampling_survey = case_when(any(!is.na(target_species_1) | !is.na(target_species_2) | !is.na(target_species_3)) & sampling_method.1 == "Electro Fishing" ~ "Y",
                                              TRUE ~ "N")) %>%
  group_by(survey_id) %>% 
  mutate(subsampling_survey = case_when(any(!is.na(target_species_1) | !is.na(target_species_2) | !is.na(target_species_3)) & sampling_method.1 == "Electro Fishing" ~ "Y",
                                              TRUE ~ "N")) %>%
  ungroup() %>% 
  #groups all sub-survey level effort into the larger survey
  group_by(survey_id, 
           lake_id, 
           year, 
           date.1, 
           gear_data_notes.1, 
           total_effort_2, 
           total_effort_1, 
           target_species_1,
           target_species_2,
           target_species_3,
           subsample_time_1,
           subsample_time_2,
           subsample_time_3,
           original_file_name.1) %>% 
  mutate(sub_effort_ident = cur_group_id()) %>% 
  #making total effort ident and aggregating efforts within a survey
  #if sub sampling was present in a survey - all sub surveys effort are kept due to variable target/no target
  group_by(survey_id,
           lake_id, 
           year, 
           sampling_method_agg, 
           indiv_subsampling_survey,
           original_file_name.1) %>% 
  mutate(survey_effort_id = cur_group_id(),
         survey_effort = sum(total_effort_1),
         survey_effort = case_when(indiv_subsampling_survey == "N" ~ survey_effort,
                                   indiv_subsampling_survey == "Y" ~ total_effort_1)) %>%   #gives a unique ident for total effort 
  rename(original_file_name.1_effort = original_file_name.1) %>% 
  select(survey_id,
         lake_id,
         year,
         date.1,
         sampling_method_agg,
         no_target,
         target_species_1,
         target_species_2,
         target_species_3,
         subsample_time_1,
         subsample_time_2,
         subsample_time_3,
         total_effort_1,
         total_effort_2,
         sub_effort_ident,
         survey_effort,
         survey_effort_id,
         subsampling_survey,
         indiv_subsampling_survey,
         original_file_name.1_effort) %>% 
  mutate(survey_effort_id = as.character(survey_effort_id),
         sub_effort_ident = as.character(sub_effort_ident))

#quick gut check on survey-effort aggregation 
#are there any surveys that have more than one survey level effort?
#all surveys with more than one total effort ident are surveys with sub sampling 
survey.effort %>% 
  group_by(survey_effort_id, survey_effort, indiv_subsampling_survey) %>% 
  count() %>% 
  group_by(survey_effort_id, indiv_subsampling_survey) %>% 
  count() %>% 
  filter(n >1) %>% 
  print(n = nrow(.))

#joining the survey level effort with the individual fish obs
#this join adds the survey level effort and survey effort ident for each grouping
il_data_merged <- left_join(survey.effort, il_catch_age_effort_30Nov23_uncount, by = c("survey_id",
                                                                                       "lake_id",
                                                                                       "year",
                                                                                       "date.1",
                                                                                       "sampling_method_agg",
                                                                                       "total_effort_2",
                                                                                       "total_effort_1")) %>% 
  rename(original_file_name.1_indvifish = original_file_name.1)
#this works, but all of the surveys that did not catch fish are missing important survey information 
#we want to know the surveys that did not catch fish, extract all information from the original file, put the information back in

il_data_merged_trial <- il_data_merged %>% 
  #making unique surveys for sub-sampling and survey effort
  mutate(survey_effort = case_when(species.1 == target_species_1 & subsampling_survey == "Y" ~ subsample_time_1,
                                    species.1 == target_species_2 & subsampling_survey == "Y" ~ subsample_time_2,
                                    species.1 == target_species_3 & subsampling_survey == "Y" ~ subsample_time_3,
                                    TRUE ~ survey_effort),
         sub_effort_ident = case_when(species.1 == target_species_1 & subsampling_survey == "Y" ~ paste0(sub_effort_ident, "_1"),
                                    species.1 == target_species_2 & subsampling_survey == "Y" ~ paste0(sub_effort_ident, "_2"),
                                    species.1 == target_species_3 & subsampling_survey == "Y" ~ paste0(sub_effort_ident, "_3"),
                                    TRUE ~ sub_effort_ident),
         #makes no_target na when the species is caught is the species targeted 
         no_target = case_when(species.1 == target_species_1 ~ NA,
                               species.1 == target_species_2 ~ NA,
                               species.1 == target_species_3 ~ NA,
                               TRUE ~ no_target)) %>%
  mutate(survey_effort_id = case_when((!is.na(target_species_1) | !is.na(target_species_2) |!is.na(target_species_3)) & subsampling_survey == "Y" ~ paste(survey_effort_id, sub_effort_ident, sep = "_"),
                                    TRUE ~ survey_effort_id)) %>%
         mutate(flag = case_when((!is.na(target_species_1) | !is.na(target_species_2) | !is.na(target_species_3)) & subsampling_survey == "Y" ~ "effort associated with subsampling",
                          TRUE ~ NA)) %>% 
  mutate(#when no_target has values make targeted species na
         target_species_1 = case_when(!is.na(no_target) ~ NA,
                                      TRUE ~ target_species_1),
         target_species_2 = case_when(!is.na(no_target) ~ NA,
                                      TRUE ~ target_species_2),
         target_species_3 = case_when(!is.na(no_target) ~ NA,
                                      TRUE ~ target_species_3))


#finds surveys that are in the effort file but do not have associated fish
no_matches <- anti_join(survey.effort, il_catch_age_effort_30Nov23_uncount, by = c("survey_id",
                                                                                       "lake_id",
                                                                                       "year",
                                                                                       "date.1",
                                                                                       "sampling_method_agg",
                                                                                       "total_effort_2",
                                                                                       "total_effort_1"))
#this is an object that has all of the surveys that did not catch fish with all of the information
#I will bind this information to the the fish as rows object to ensure they are retained for cpe calculations
no_fish <- right_join(il_catch_age_effort_30Nov23_uncount, no_matches, by = c("survey_id",
                                                            "lake_id",
                                                            "year", 
                                                            "date.1", 
                                                            "sampling_method_agg",
                                                            "total_effort_2", 
                                                            "total_effort_1")) %>% 
  mutate(subsample_time_1 = as.numeric(subsample_time_1),
         subsample_time_2 = as.numeric(subsample_time_2),
         subsample_time_3 = as.numeric(subsample_time_3),
         survey_effort_id = as.character(survey_effort_id),
         sub_effort_ident = as.character(sub_effort_ident))
  

#returning no fish surveys back into the data
il_data_all <- il_data_merged_trial %>% 
  filter(!is.na(original_file_name.1_indvifish)) 
#this first step takes out surveys with no fish in the merged data so they can be returned with the object that returns all the survey information associated with surveys that did not catch fish

#this new object contains all fish data with associated effort and the surveys that did not catch fish 
il_data.catch <- bind_rows(il_data_all, no_fish) %>% 
  ungroup()  %>% 
  select(-survey_type.1) %>% 
  rename(survey_type.1 = garbage_bin_notes.4) %>% 
  #retaining lake area in acres - can be removed if desired
  rename(lake_area_acres = garbage_bin_notes.3) %>% 
  mutate(lake_area_acres = gsub("Acres:", "", lake_area_acres),
         lake_area_acres = as.numeric(lake_area_acres),
         flag = case_when(survey_effort == 0 ~ "subeffort or effort reported as 0",
                          TRUE ~ NA)) %>% 
  mutate(target_species = case_when(grepl("_1", sub_effort_ident) ~ target_species_1,
    grepl("_2", sub_effort_ident) ~ target_species_2,
    grepl("_3", sub_effort_ident) ~ target_species_3,
    TRUE ~ target_species_1))

#quick glance to see how net efforts are calculating to survey efforts
effort.check <- il_data.catch %>% 
  distinct(lake_id, year, date.1, sampling_method.1, total_effort_2, survey_effort_id, sub_effort_ident, total_effort_1, .keep_all = T) %>% 
  select(survey_id, lake_id, lake_name.1, year, date.1, sampling_method_agg, no_target, target_species, target_species_1, target_species_2, target_species_3, survey_effort_id, sub_effort_ident, total_effort_2, total_effort_1, survey_effort, subsampling_survey, flag)

il_data.catch %>% 
  group_by(survey_effort_id, survey_effort) %>% 
  count() %>% 
  group_by(survey_effort_id) %>% 
  count() %>% 
  filter(n >1) %>% 
  print(n = nrow(.))

#shows structure of a sub sampling survey 
il_data.catch %>% 
  filter(lake_id == "195" & year == "2012") %>% 
  distinct(survey_effort_id, sub_effort_ident)

#Are my original file names tracking?
il_data.catch %>% 
  group_by(original_file_name.1_indvifish) %>% 
  count() %>% 
  print(n = nrow(.))
#shows all fish records come from the original file for fish

na <- il_data.catch %>% 
  filter(is.na(original_file_name.1_indvifish))
#all nas here are surveys that did not catch fish

il_data.catch %>% 
  group_by(original_file_name.1_effort) %>% 
  count() %>% 
  print(n = nrow(.))
#all obs have effort associated with them from the effort file

#fish that are in the catch but are not in the effort?
excluded <- anti_join(il_catch_age_effort_30Nov23, il_data.catch, by = c("lake_id",
                                                                   "year", 
                                                                   "date.1",
                                                                   "gear_data_notes.1",
                                                                   "total_effort_2", 
                                                                   "total_effort_1"))

surveys.excluded <- excluded %>% 
  group_by(lake_id, lake_name.1, survey_id, year, gear_data_notes.1, total_effort_2, total_effort_1, species.1) %>% 
  count() 
#all joining columns combine correctly between the effort and catch file
``` 
          
#Age data - effort and catch
```{r}
il_aged_fish_surveys_12Dec2023 %>% 
  group_by(lake_id, lake_name.1) %>% 
  count()

il_data.catch %>% 
  filter(lake_id %in% il_aged_fish_surveys_12Dec2023$lake_id) %>% 
  group_by(lake_id, lake_name.1) %>% 
  count()
#lake names and survey ids are consistent between age and catch files
#survey ids are not the same across age and survey files

il_aged_fish_surveys_12Dec2023 %>% 
  filter(total_count.1 == 1) %>% 
  filter(is.na(age)) %>% 
  count()
#most of this data is unaged but we also have 20,000 records of age

il_aged_fish_surveys_12Dec2023 %>% 
  group_by(survey_id, lake_name.1) %>% 
  count() %>% 
  print(n = nrow(.))
#surveyid seems worthless here because there are multiple lakes within a given survey?

il_aged_fish_surveys_12Dec2023 %>% 
  group_by(garbage_bin_notes.1) %>% 
  count()
#thank goodness - no subsample times so we don't have to worry about that

il_aged_fish_surveys_12Dec2023 %>% 
  group_by(lake_id, 
           lake_name.1, 
           date.1, 
           sampling_method.1, 
           total_effort_1,
           total_effort_2,
           ) %>% 
  count() %>% 
  print(n = nrow(.))

il_aged_fish_surveys_12Dec2023 %>% 
  group_by(lake_name.1) %>% 
  count()
#data from 13 lakes
############starting the merge################

#uncounting aged fish surveys
#no surveys have sub-sampling associated with them - thus I am just making a subsample time 1 column where all values will be 0
#make a bin length for fish batch counted with bin lengths
il_aged_fish_surveys_12Dec2023_uncount <- il_aged_fish_surveys_12Dec2023 %>% 
  mutate(length_bin = case_when(total_count.1 >1 ~ length.1,
                                TRUE ~ NA),
         length_bin_unit = case_when(total_count.1 > 1 ~ "minimum value of 10mm bin",
                                     TRUE ~ NA),
         length.1 = case_when(!is.na(length_bin) ~ NA,
                              TRUE ~ length.1)) %>% 
  uncount(total_count.1) %>% 
  rename(subsample_time_1 = garbage_bin_notes.1) %>% 
  #creating better effort identifiers
  mutate(sampling_method_agg = case_when(gear_data_notes.1 %in% c("Gear Used:Boat electrofishing AC") ~ "Boat electrofishing AC (Day)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing AC (Night)") ~ "Boat electrofishing AC (Night)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing DC - Unspecified Manufacturer",
                                                                "Gear Used:Boat electrofishing DC -- Smith Root",
                                                                "Gear Used:Boat electrofishing DC -- Wisconsin",
                                                                "Gear Used:Boat electrofishing DC") ~ "Boat electrofishing DC (Day)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing DC -- Smith Root (Night)",
                                                                "Gear Used:Boat electrofishing DC -- Wisconsin (Night)") ~ "Boat electrofishing DC (Night)",
                                       TRUE ~ gear_data_notes.1))

#pulling out effort data
survey.effort.age <- il_aged_fish_surveys_12Dec2023_uncount %>% 
  #creating better effort identifiers
  mutate(sampling_method_agg = case_when(gear_data_notes.1 %in% c("Gear Used:Boat electrofishing AC") ~ "Boat electrofishing AC (Day)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing AC (Night)") ~ "Boat electrofishing AC (Night)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing DC - Unspecified Manufacturer",
                                                                "Gear Used:Boat electrofishing DC -- Smith Root",
                                                                "Gear Used:Boat electrofishing DC -- Wisconsin",
                                                                "Gear Used:Boat electrofishing DC") ~ "Boat electrofishing DC (Day)",
                                       gear_data_notes.1 %in% c("Gear Used:Boat electrofishing DC -- Smith Root (Night)",
                                                                "Gear Used:Boat electrofishing DC -- Wisconsin (Night)") ~ "Boat electrofishing DC (Night)",
                                       TRUE ~ gear_data_notes.1)) %>% 
  distinct(survey_id,
           lake_id,
           year,
           date.1,
           sampling_method_agg,
           total_effort_2,
           total_effort_1,
           original_file_name.1,
           .keep_all = T) %>% 
  #groups all sub-survey level and giving an id
  group_by(survey_id, 
           lake_id, 
           year, 
           date.1, 
           sampling_method_agg, 
           total_effort_2, 
           total_effort_1, 
           original_file_name.1) %>% 
  mutate(sub_effort_ident = cur_group_id()) %>% 
  ungroup() %>% 
  #grouping all survey level ids into a survey level ident and summing the effort
  group_by(survey_id,
           lake_id, 
           year,
           sampling_method_agg, 
           original_file_name.1) %>% 
  mutate(survey_effort = sum(total_effort_1),
         survey_effort_id = cur_group_id()) %>%  #gives a unique ident for total effort 
  rename(original_file_name.1_agedfish = original_file_name.1) %>% 
  ungroup() %>% 
  select(lake_id,
         year,
         date.1,
         sampling_method_agg,
         total_effort_2,
         total_effort_1,
         subsample_time_1,
         sub_effort_ident,
         survey_effort_id,
         survey_effort,
         original_file_name.1_agedfish)

#quick gut check on survey-effort aggregation 
#are there any surveys that have more than one survey level effort?
survey.effort.age %>% 
  group_by(survey_effort_id, survey_effort) %>% 
  count() %>% 
  group_by(survey_effort_id) %>% 
  count() %>% 
  filter(n >1)

#joining the survey level effort with the individual fish obs
#this join adds the survey level effort and survey effort ident for each grouping
il_data_merged_age <- left_join(survey.effort.age, il_aged_fish_surveys_12Dec2023_uncount, by = c("lake_id",
                                                                                       "year",
                                                                                       "date.1",
                                                                                       "sampling_method_agg",
                                                                                       "total_effort_2",
                                                                                       "total_effort_1",
                                                                                       "subsample_time_1")) %>% 
  select(-original_file_name.1) %>% 
  #cleaning up a few columns
  mutate(subsample_time_1 = gsub("Subsample Time:", "", subsample_time_1),
         subsample_time_1 = as.double(subsample_time_1),
         survey_effort_id = as.character(survey_effort_id),
         sub_effort_ident = as.character(sub_effort_ident))
#this works, but what about surveys that might not have caught fish?
#finds surveys that are in the effort file but do not have associated fish
no_matches <- anti_join(survey.effort.age, il_aged_fish_surveys_12Dec2023_uncount, by = c("lake_id",
                                                                                   "year",
                                                                                   "date.1",
                                                                                   "sampling_method_agg",
                                                                                   "total_effort_2",
                                                                                   "total_effort_1"))

effort.check <- survey.effort.age %>% 
  distinct(survey_effort_id, lake_id, year, date.1, sampling_method_agg, total_effort_2, total_effort_1, .keep_all = T) %>% 
  select(survey_effort_id, lake_id, year, date.1, sampling_method_agg, total_effort_2, total_effort_1, survey_effort)
#everything seems to be adding up alright, but a ton of sub surveys effort (and total effort) have 0

excluded <- anti_join(il_aged_fish_surveys_12Dec2023_uncount, il_data_merged_age, by = c("lake_id",
                                                                   "year", 
                                                                   "date.1",
                                                                   "sampling_method_agg",
                                                                   "total_effort_2", 
                                                                   "total_effort_1"))

il_data_merged_age <- il_data_merged_age %>% 
  mutate(flag = "no zero catches reported in aged data file") %>% #flagging surveys because we are not certain we have true 0s
  mutate(survey_type.1 = garbage_bin_notes.2) %>% #making survey type consistent with the first catch file
  mutate(flag = case_when(total_effort_1 == 0 ~ "effort reported as 0, typical sets are for 1440 min but cannot be certain",
                          TRUE ~ flag)) %>%  #flagging surveys without any effort reported 
  rename(lake_area_acres = c_lakesize)
#this could be merged with the other fish file now, however we likely do not have representative nothing caught surveys and there is an overlap of total effort idents and survey ids
```

#merging age fish and standard catch fish
```{r}
#row binding the two data frames together
#I am creating a source column so that I can retain unique total effort idents from the previous creation in separate chunks
il_data.prep <- bind_rows(il_data_merged_age %>% 
                            mutate(source = 1),
                          il_data.catch %>% 
                            mutate(source = 2)) %>% 
  #creating a new survey effort id so that all survey ids are unique to a survey
  #If i were to leave it as it is, there would be a survey effort 1 for both the catch and age fish
  mutate(survey_effort_id = paste0(survey_effort_id, ".", source)) %>% 
  mutate(sub_effort_ident = paste0(sub_effort_ident, ".", source)) 

il_data.prep %>% 
  group_by(sampling_method_agg) %>% 
  count()

il_data.prep %>% 
  group_by(flag) %>% 
  count()

#does the total effort id work?
il_data.prep %>% 
  group_by(survey_effort_id, original_file_name.1_agedfish, original_file_name.1_indvifish, original_file_name.1_effort) %>% 
  count()
#looks good - all surveys from the age file have an x.1 while all surveys from the catch file have an an x.2

#hows how many fish came from catch and aged fish surveys (with the caveat that some nas produced here are from surveys that did not catch fish)
il_data.prep %>% 
  group_by(original_file_name.1_indvifish) %>% 
  count()

il_data.prep %>% 
  group_by(original_file_name.1_agedfish) %>% 
  count()

il_data.prep %>% 
  group_by(survey_id, original_file_name.1_agedfish, lake_name.1) %>% 
  count() %>% 
  print(n = nrow(.))
#here we can see many files from the aged fish data share a survey id - survey id in the age file is meaningless

effort.check <- il_data.prep %>% 
  distinct(survey_effort_id, sub_effort_ident, lake_id, year, date.1, sampling_method_agg, total_effort_2, total_effort_1, .keep_all = T) %>% 
  select(survey_effort_id, sub_effort_ident, lake_id, year, date.1, sampling_method_agg, total_effort_2, total_effort_1, survey_effort)

#surveys with 0 effort
no_effort <- il_aged_fish_surveys_12Dec2023 %>% 
  distinct(survey_id, lake_id, date.1, gear_data_notes.1, total_effort_2, total_effort_1, .keep_all = T) %>% 
  filter(total_effort_1 == 0) %>%
  select(lake_name.1, lake_id, survey_id, date.1, gear_data_notes.1, total_effort_2, total_effort_1)
```

# Data viewing before tidy
```{r}
glimpse(il_data.prep)

#exploring dates in IL
dates <- il_data.prep %>% 
  group_by(survey_id, sampling_method_agg, survey_effort_id, sub_effort_ident, total_effort_2, date.1) %>% 
  count()

il_data.prep %>% 
  filter(survey_type.1 == "Sample Type:Targeted Species" | survey_type.1 == "Sample_Type:Targeted Species") %>% 
  distinct(survey_effort_id) %>% 
  glimpse()

il_data.prep %>% 
  group_by(no_target, target_species_1, target_species_2, target_species_3) %>% 
  count() %>% 
  print(n = nrow(.))

il_data.prep %>% 
  filter(no_target == "Black Crappie, Bluegill") %>% 
  group_by(species.1) %>% 
  count()

il_data.prep %>% 
  filter(no_target == "Bluegill") %>% 
  group_by(species.1) %>% 
  count()

il_data.prep %>% 
  filter(no_target == "Black Crappie") %>% 
  group_by(species.1) %>% 
  count()

il_data.prep %>% 
  group_by(state) %>% 
  count()

il_data.prep %>% 
  group_by(county) %>% 
  count() %>% 
  print(n = nrow(.))

il_data.prep %>% 
  group_by(lake_name.1, lake_id) %>% 
  count() %>% 
  print(n = nrow(.))

il_data.prep %>% 
  group_by(lake_name.1, lake_id) %>% 
  count() %>% 
  group_by(lake_id) %>% 
  count() %>% 
  filter(n >1)

il_data.prep %>% 
  filter(lake_name.1 == "Pistakee Lake") %>% 
  group_by(survey_effort_id, gear_data_notes.1, survey_id, year, total_effort_2, total_effort_1, survey_effort) %>% 
  count() %>% 
  print(n = nrow(.))
#It appears there are subtle differences in the survey method spelling which led to differences 

il_data.prep %>% 
  group_by(date.1) %>% 
  count() %>% 
  print(n = nrow(.))

il_data.prep %>% 
  group_by(survey_type.1) %>% 
  count() %>% 
  print(n = nrow(.))
#they are all impoundment surveys?

il_data.prep %>% 
  group_by(sampling_method.1) %>% 
  count() %>% 
  print(n = nrow(.))
#sampling method seems to be more sampling method agg

il_data.prep %>% 
  group_by(gear_data_notes.1) %>% 
  count() %>% 
  print(n = nrow(.))
#gear notes 1 is more of the sampling method

il_data.prep %>% 
  group_by(total_effort_2) %>% 
  count() %>% 
  print(n = nrow(.))
#this column needs to be renamed to sub-survey level effort id (net/shocking period)

il_data.prep %>% 
  group_by(subsample_time_1, subsample_time_2, subsample_time_3) %>% 
  count() %>% 
  print(n = nrow(.))
#gives subsample times 

il_data.prep %>% 
  group_by(target_species_1, subsample_time_1) %>%
  mutate(subsample_time_1 = gsub("Subsample Time:", "", subsample_time_1)) %>% 
  mutate(target_species_1 = gsub("Subsample Species:", "", target_species_1)) %>% 
  count() %>% 
  print(n = nrow(.))

il_data.prep %>% 
  group_by(target_species_2, subsample_time_2) %>% 
  mutate(subsample_time_2 = gsub("Subsample Time:", "", subsample_time_2)) %>% 
  mutate(target_species_2 = gsub("Subsample Species:", "", target_species_2)) %>%
  count() %>% 
  print(n = nrow(.))

il_data.prep %>% 
  group_by(target_species_3, subsample_time_3) %>% 
  count() %>% 
  print(n = nrow(.))

il_data.prep %>% 
  group_by(target_species_1, target_species_2, target_species_3) %>% 
  count() %>% 
  print(n = nrow(.))

il_data.prep %>% 
  mutate(species.1 = str_to_lower(species.1),
         species.1 = str_replace_all(species.1, " ", "_")) %>% 
  group_by(species.1) %>% 
  count() %>% 
  print(n = nrow(.))

il_data.prep %>% 
  group_by(species.1) %>% 
  filter(!is.na(length.1)) %>% 
  summarise(min = min(length.1), mean = mean(length.1), max = max(length.1))

il_data.prep %>% 
  group_by(species.1) %>% 
  filter(!is.na(weight.1)) %>% 
  summarise(min = min(weight.1), mean = mean(weight.1), max = max(weight.1))

il_data.prep %>% 
   mutate(weight_unit.1 = case_when(weight_unit.1 == "col_name_Wt(g)" ~ "g",
                                   TRUE ~ NA)) %>% 
  group_by(weight_unit.1) %>% 
  count() %>% 
  print(n = nrow(.))

il_data.prep %>% 
  group_by(sex) %>% 
  count() %>% 
  print(n = nrow(.))
#not much sex data

il_data.prep %>% 
  group_by(reproductive_condition_notes) %>% 
  count() %>% 
  print(n = nrow(.))
#no maturity - useless column

il_data.prep %>% 
  group_by(aging_structure.1) %>% 
  count() %>% 
  print(n = nrow(.))
#limited aging data

il_data.prep %>% 
  group_by(age) %>% 
  count() %>% 
  print(n = nrow(.))
#hardly any age data

il_data.prep %>% 
  group_by(subsampling_survey) %>% 
  count()

#look into merging no target and target species columns 
il_data.prep %>% 
  group_by(no_target) %>% 
  count()

il_data.prep %>% 
  mutate(no_target = tolower(gsub(",\\s+", ",", no_target))) %>%
  mutate(no_target = gsub("\\s+", "_", no_target)) %>%
  mutate(no_target = strsplit(no_target, ",")) %>%
  mutate(no_target = lapply(no_target, function(x) paste0(x, "N"))) %>%
  mutate(no_target = sapply(no_target, function(x) paste(x, collapse = ","))) %>% 
  mutate(no_target = case_when(no_target == "NAN" ~ NA,
                               TRUE ~ no_target)) %>% 
  group_by(no_target) %>% 
  count()


il_data.prep %>% 
  group_by(target_species) %>% 
  count()

il_data.prep %>% 
  #cleaning up no target species column
  mutate(no_target = tolower(gsub(",\\s+", ",", no_target))) %>%
  mutate(no_target = gsub("\\s+", "_", no_target)) %>%
  mutate(no_target = strsplit(no_target, ",")) %>%
  mutate(no_target = lapply(no_target, function(x) paste0(x, "N"))) %>%
  mutate(no_target = sapply(no_target, function(x) paste(x, collapse = ","))) %>% 
  mutate(no_target = case_when(no_target == "NAN" ~ NA,
                               TRUE ~ no_target)) %>% 
  
  #cleaning up target species column
  mutate(target_species = tolower(gsub(" ", "_", target_species)),
         target_species = case_when(!is.na(target_species) ~ paste0(target_species, "Y"))) %>% 
  #combining the columns
  mutate(combined_species = paste(target_species, no_target, sep = ",")) %>% 
  group_by(target_species, no_target, combined_species) %>% 
  count()

il_data.prep %>%
  #preparing no target column for combining
  mutate(no_target = tolower(gsub(",\\s+", ",", no_target))) %>%
  mutate(no_target = gsub("\\s+", "_", no_target)) %>%
  mutate(no_target = strsplit(no_target, ",")) %>%
  mutate(no_target = lapply(no_target, function(x) paste0(x, "N"))) %>%
  mutate(no_target = sapply(no_target, function(x) paste(x, collapse = ","))) %>%
  mutate(no_target = case_when(no_target == "NAN" ~ NA,
                               TRUE ~ no_target)) %>% 
  #parparing target_species for combining 
  mutate(target_species = tolower(gsub(" ", "_", target_species)),
         target_species = case_when(!is.na(target_species) ~ paste0(target_species, "Y"))) %>% 
  #combining columns and make sure NAs look nice
  mutate(combined_species = ifelse(is.na(target_species) & is.na(no_target), NA,
                                   ifelse(is.na(target_species), no_target,
                                          ifelse(is.na(no_target), target_species,
                                                 paste(target_species, no_target, sep = ","))))) %>%
  
  group_by(target_species, no_target, combined_species) %>% 
  count()

gear_types <- il_data.prep %>% 
  group_by(sampling_method.1,
           sampling_method_agg,
           gear_data_notes.1) %>% 
  count() %>% 
  print(n = nrow(.))
rm(gear_types)

il_data.prep %>% 
  #creating simple gear type across states
  mutate(sampling_method_simple = case_when(sampling_method.1 %in% c("Electro Fishing", "Electrofishing") ~ "boat_electrofishing",
                                            (is.na(sampling_method.1) & sampling_method_agg == "Boat electrofishing DC (Day)") ~ "boat_electrofishing",
                                            str_detect(sampling_method_agg, "Gill net") ~ "gill_net",
                                            str_detect(sampling_method_agg, "Trap net") ~ "frame_net",
                                            str_detect(sampling_method_agg, "seine") ~ "seine",
                                            TRUE ~ NA)) %>% 
  #creating sampling method with same level of detail within state
  mutate(sampling_method = gsub("Gear Used:", "", sampling_method_agg),
         sampling_method = case_when(str_detect(sampling_method, "Trap net") ~ "trap_net",
                                     str_detect(sampling_method, "Gill net") ~ "gill_net",
                                     str_detect(sampling_method, "seine") ~ "seine_minnow",
                                     TRUE ~ sampling_method)) %>% 
  mutate(sampling_method_2 = gsub("Gear Used:", "", gear_data_notes.1),
         sampling_method_2 = case_when(is.na(sampling_method_2) ~ sampling_method,
                                       TRUE ~ sampling_method_2)) %>% 
  group_by(sampling_method_simple, sampling_method, sampling_method_2) %>% 
  count() %>% 
  print(n = nrow(.))

#exploring the coverage of IL lakes 
lakes_missing_lat_long <- il_data.prep %>% 
  distinct(lake_name.1, lake_id, lat_unspec, lon_unspec) %>% 
  group_by(lake_id) %>% 
  summarise(n = n_distinct(lake_name.1)) %>% 
  filter(n > 1)
rm(lat_lon_check)
#this tells me that there are 31 lakes that have missing lake info due to missing fish observations but infomraiton is present in other surveys 
#lets pull that lake info and apply it to where it is missing

il_data.prep %>% 
  filter(!is.na(lat_unspec)) %>% 
  filter(lake_id %in% lakes_missing_lat_long$lake_id) %>% 
  distinct(lake_id, 
           lake_name.1, 
           garbage_bin_notes.3, 
           county, 
           lake_type, 
           lat_unspec, 
           lon_unspec)
```

#Data tidying                        
```{r}                       
###################cleaning up before final tidy#############################
#nhdids
crosswalks <- mwlaxeref::lake_id_xref %>%  
  group_by(state) %>% 
  count()
#no crosswalks exist for il in USGS 
rm(crosswalks)

#msu team developed crosswalks - we can go from IL state id to nhdhr id
msu_crosswalk <- read_csv("MGLP_FISH_LAKES_12Aug24.csv") %>% 
  filter(STATE == "IL") %>% 
  select(NHDHR_ID,
         STATE_ID) %>% 
  rename(nhdhr_id = NHDHR_ID,
         lake_id = STATE_ID)

il_data.prep <- il_data.prep %>% 
  mutate(lake_id = as.character(lake_id)) %>% 
  left_join(msu_crosswalk, by = "lake_id")
rm(msu_crosswalk)

#lats/lons
#this code cleans up lake level info when fish were not caught
il_data.prep <- il_data.prep %>% 
  group_by(lake_id) %>% 
  mutate(
    lat_unspec = case_when(is.na(lat_unspec) ~ first(na.omit(lat_unspec)),
                           TRUE ~ lat_unspec),
    lon_unspec = case_when(is.na(lon_unspec) ~ first(na.omit(lon_unspec)),
                           TRUE ~ lon_unspec),
    lake_name.1 = case_when(is.na(lake_name.1) ~ first(na.omit(lake_name.1)),
                            TRUE ~ lake_name.1),
    #garbage_bin_notes.3 = case_when(is.na(garbage_bin_notes.3) ~ first(na.omit(garbage_bin_notes.3))),
    county = case_when(is.na(county) ~ first(na.omit(county)),
                       TRUE ~ county),
    lake_type = case_when(is.na(lake_type) ~ first(na.omit(lake_type)),
                          TRUE ~ lake_type)) %>% 
  ungroup()

#now lets take the lat/lon from USGS data via nhdhr_id
lat_lon_usgs <- read_csv("lake_metadata.csv") %>% 
  filter(state == "IL") %>%
  select(site_id, 
         centroid_lat,
         centroid_lon) %>% 
  rename(nhdhr_id = site_id)

il_data.prep <- il_data.prep %>% 
  left_join(lat_lon_usgs, by = "nhdhr_id")
rm(lat_lon_usgs)

il_data.prep %>% 
  distinct(lake_id, nhdhr_id, centroid_lat) %>% 
  group_by(lake_id, nhdhr_id, is.na(nhdhr_id), is.na(centroid_lat)) %>% 
  count() %>% 
  filter(`is.na(nhdhr_id)` == F & `is.na(centroid_lat)` == T) %>% 
  print(n = nrow(.))
#21 lakes that have nhdhr id but do not pick up lat/lon from usgs

coord_compare <- il_data.prep %>% 
  distinct(lake_id, .keep_all = T) %>% 
  select(lake_id, lake_name.1, lat_unspec, centroid_lat, lon_unspec, centroid_lon) %>% 
  mutate(lat_diff = abs(lat_unspec - centroid_lat),
         lon_diff = abs(lon_unspec - centroid_lon))
rm(coord_compare)

#cleaning up a few coordinates
il_data.prep <- il_data.prep %>% 
#Charleston side channel lake and lake in the hills have problematic lat/lons provided by the agency
#take usgs lat/lon for lake in the hills and update lon to -88 for charelston
  mutate(lat_unspec = case_when(lat_unspec < 3 & lake_name.1 == "Lake In The Hills" ~ 42.18485,
                                TRUE ~ lat_unspec),
         lon_unspec = case_when(lon_unspec > -82 & lake_name.1 == "Charleston Side Channel Lake" ~ -88.14638,
                                TRUE ~ lon_unspec)) 

#sampling method hierarchy
#this comes from a file in the cross walk good drive 
gear_xwalk <- read_csv("gears_by_state.csv") %>% 
  filter(state == "Illinois") %>% 
  rename(sampling_method_agg = gear_1,
         gear_data_notes.1 = gear_2) %>% 
  select(sampling_method_agg,
         gear_data_notes.1,
         sampling_method_simple,
         sampling_method_1,
         sampling_method_2)

il_data.prep %>% 
  group_by(sampling_method_agg, gear_data_notes.1) %>% 
  count() %>% 
  print(n = nrow(.))
#looks like I want to use sampling method agg and gear data notes columns as a join for the gears crosswalk


il_data.prep <- il_data.prep %>% 
  mutate(sampling_method_agg = gsub("Gear Used:", "", sampling_method_agg)) %>% 
  mutate(gear_data_notes.1 = gsub("Gear Used:", "", gear_data_notes.1)) %>% 
  left_join(gear_xwalk) %>%
  rename(sampling_method = sampling_method_1)

il_data.prep %>% 
  group_by(sampling_method_agg, gear_data_notes.1, sampling_method_simple, sampling_method, sampling_method_2) %>% 
  count() %>% 
  arrange(sampling_method_simple) %>% 
  print(n = nrow(.))

rm(gear_xwalk)

#now I want to create some auto-flags
#I need to do this at the survey level. I will create a survey level flag and then add it back to those surveys

flag_xwalk <- il_data.prep %>% 
  distinct(survey_effort_id, .keep_all = TRUE) %>% 
  group_by(sampling_method_simple) %>% 
  mutate(mean_effort = mean(survey_effort, na.rm = TRUE),
         sd_effort = sd(survey_effort, na.rm = TRUE),
         z_score = (survey_effort - mean_effort) / sd_effort,
         flag = case_when(survey_effort < 0 ~ paste("invalid effort (negative)", coalesce(flag, "")),
                          z_score > 10 ~ paste("high effort", ";", coalesce(flag, "")),
                          TRUE ~ coalesce(flag, "")
         ),
         flag = na_if(flag, "")) %>% 
  select(survey_effort_id,
         sampling_method_simple,
         flag,
         survey_effort,
         mean_effort,
         sd_effort,
         z_score)


#cross walk the flags back to the il_data.prep - make sure we don't loose flags that were already created
il_data.prep <- il_data.prep %>% 
  select(-flag) %>% 
  left_join(flag_xwalk)

il_data.prep %>% 
  group_by(flag) %>% 
  count()

#weight and length auto flags
#we have some pretty big outliers, espcially in the weight column
#I will first create a that includes these really large values
#I will then do a second round of flagging when I exclude those values
length_weight_flag_1 <- il_data.prep %>% 
  #filter out surveys that have no catch
  filter(!is.na(species.1)) %>% 
  #group by species to create z score for weight and length
  #flag created for fish more or less than 10 sd 
  #add this flag to the flag column with coalesce
  group_by(species.1) %>% 
  mutate(mean_length = mean(length.1, na.rm = TRUE),
         mean_weight = mean(weight.1, na.rm = TRUE),
         sd_length = sd(length.1, na.rm = TRUE),
         sd_weight = sd(weight.1, na.rm = TRUE),
         z_score_length = (length.1 - mean_length) / sd_length,
         z_score_weight = (weight.1 - mean_weight) / sd_weight,
         flag = case_when(z_score_length >= 10 | z_score_length <= -10 ~ paste0("unlikely length", "; ", coalesce(flag, "")),
                          z_score_weight >= 10 | z_score_weight <= -10 ~ paste0("unlikely weight", "; ", coalesce(flag, "")),
                          TRUE ~ coalesce(flag, "")),
         flag = case_when(length.1 == 0 | weight.1 == 0 ~ paste("length or weight reported as 0", "; ", coalesce(flag, "")),
                          TRUE ~ coalesce(flag, "")),
         flag = na_if(flag, "")) %>% 
  ungroup()


length_weight_flag_2 <- length_weight_flag_1 %>% 
  filter((is.na(z_score_length) | (z_score_length > -10 & z_score_length < 10)) & 
           (is.na(z_score_weight) | (z_score_weight > -10 & z_score_weight < 10))) %>% 
  group_by(species.1) %>% 
  mutate(mean_length = mean(length.1, na.rm = TRUE),
         mean_weight = mean(weight.1, na.rm = TRUE),
         sd_length = sd(length.1, na.rm = TRUE),
         sd_weight = sd(weight.1, na.rm = TRUE),
         z_score_length = (length.1 - mean_length) / sd_length,
         z_score_weight = (weight.1 - mean_weight) / sd_weight,
         flag = case_when(z_score_length >= 10 | z_score_length <= -10 ~ paste0("unlikely length", "; ", coalesce(flag, "")),
                          z_score_weight >= 10 | z_score_weight <= -10 ~ paste0("unlikely weight", "; ", coalesce(flag, "")),
                          TRUE ~ coalesce(flag, "")),
         flag = na_if(flag, "")) %>% 
  ungroup()

#add back in flag1 rows that got removed
combined_flags <- length_weight_flag_1 %>% 
   filter(!((is.na(z_score_length) | (z_score_length > -10 & z_score_length < 10)) & 
           (is.na(z_score_weight) | (z_score_weight > -10 & z_score_weight < 10)))) %>% 
  bind_rows(length_weight_flag_2) %>% 
  select(survey_effort_id,
         sub_effort_ident,
         length.1,
         weight.1,
         flag) %>% 
  distinct()


length_weight_flag_1 %>% 
  filter(str_detect(flag, "unlikely")) %>% 
  select(flag)

length_weight_flag_2 %>% 
  filter(str_detect(flag, "unlikely")) %>% 
  select(flag)

combined_flags %>% 
  filter(str_detect(flag, "unlikely")) %>% 
  select(flag)
#you can see here that there are 20 length/weight based flags created in the first, 5 in the second, and 20 in the combined 
#flags are generating the way we would expect, lets add them back to the df
rm(length_weight_flag_1, length_weight_flag_2)

#length_weight_flag_2 contains all of the flags that were accumulated throughout the ag process
#we can left join these flags to the data 
il_data.prep <- il_data.prep %>% 
  select(-flag) %>% 
  left_join(combined_flags, relationship = "many-to-one") 

rm(combined_flags)

il_data.prep %>% 
  filter(str_detect(flag, "unlikely")) %>% 
  select(flag)

il_data.prep %>% 
  group_by(is.na(flag)) %>% 
  count()

############################final tidy################################
il_data <- il_data.prep %>% 
  #lower case with no spaces for species name
  mutate(species.1 = str_to_lower(species.1),
         species.1 = str_replace_all(species.1, " ", "_")) %>% 
  #shorten unit to just g
  mutate(weight_unit.1 = case_when(weight_unit.1 == "col_name_Wt(g)" ~ "g",
                                   TRUE ~ NA)) %>%
  #effort units
  mutate(total_effort_1_units = "minutes",
         sub_effort_1_units = "minutes") %>% 
  #survey type
  mutate(survey_type = gsub("Sample Type:", "", survey_type.1),
         survey_type = gsub("Sample_Type:", "", survey_type)) %>%  #cleans up column name
  #adding in length units
  #no units were specified within data but general assumption is mm
  mutate(length_unit.1 = "mm") %>% 
  #renaming effort hierarchy
  #this renames the survey level effort as total_effort_1 with the effort grouping noted by survey_effort_1_id
  #sub-survey level effort is named sub_effort_1 with sub-survey ids as sub_effort_1_id
  rename(net_id = total_effort_2) %>% 
  rename(total_effort_ident = survey_effort_id) %>% 
  rename(sub_effort_1 = total_effort_1) %>% 
  rename(total_effort_1 = survey_effort) %>% 
  #making a caught nothing column to flag when no fish species were caught in a net/survey
  #this is done at the survey and sub survey level
  mutate(sub_survey_nothing_caught = case_when(is.na(species.1) ~ TRUE,
                                    TRUE ~ FALSE),
         sub_survey_nothing_caught = as.logical(sub_survey_nothing_caught)) %>%
  group_by(total_effort_ident) %>% 
  mutate(total_survey_nothing_caught = all(sub_survey_nothing_caught)) %>% 
  ungroup() %>% 
  #cleaning up dates
  mutate(date_sample = mdy(date.1)) %>% 
  group_by(sub_effort_ident) %>% 
  mutate(date_sub_effort_ident = first(date_sample)) %>% 
  ungroup() %>% 
  group_by(total_effort_ident) %>% 
  mutate(date_total_effort_ident = first(date_sample)) %>% 
  ungroup() %>% 
  mutate(date_survey = date_total_effort_ident) %>% 
  #migrates the designation if a surveys is associated with subsampling to gear_data_notes
  mutate(subsampling_survey = case_when(is.na(subsampling_survey) ~ "subsampling_survey:N",
                                        subsampling_survey == "N" ~ "subsampling_survey:N",
                                        subsampling_survey == "Y" ~ "subsampling_survey:Y")) %>% 
  #the next three chunks of code are for navigating no target and target columns
  #preparing no target column for combining
  mutate(no_target = tolower(gsub(",\\s+", ",", no_target))) %>%
  mutate(no_target = gsub("\\s+", "_", no_target)) %>%
  mutate(no_target = strsplit(no_target, ",")) %>%
  mutate(no_target = lapply(no_target, function(x) paste0(x, "N"))) %>%
  mutate(no_target = sapply(no_target, function(x) paste(x, collapse = ","))) %>%
  mutate(no_target = case_when(no_target == "NAN" ~ NA,
                               TRUE ~ no_target)) %>% 
  #preparing target_species for combining 
  mutate(target_species = tolower(gsub(" ", "_", target_species)),
         target_species = case_when(!is.na(target_species) ~ paste0(target_species, "Y"))) %>% 
  #combining columns and make sure NAs look nice
  mutate(combined_species = ifelse(is.na(target_species) & is.na(no_target), NA,
                                   ifelse(is.na(target_species), no_target,
                                          ifelse(is.na(no_target), target_species,
                                                 paste(target_species, no_target, sep = ","))))) %>%
  ungroup() %>% 
  #added targeted species column to targeted surveys
  #adding lat/lon centroid - first taking agency provided and then taking usgs if needed
  mutate(latitude_lake_centroid = case_when(is.na(lat_unspec) ~ centroid_lat,
                                            TRUE ~ lat_unspec),
         longitude_lake_centroid = case_when(is.na(lon_unspec) ~ centroid_lon,
                                             TRUE ~ lon_unspec)) %>% 
  ungroup() %>% 
  #columns that still need to be added
  mutate(year = year(date_sample),
         month = month(date_sample),
         survey_type_2 = as.character(NA),
         survey_type_3 = as.character(NA),
         survey_type_4 = as.character(NA),
         gear_data_notes = subsampling_survey,
         target_species_2 = as.character(NA),
         total_effort_3 = as.numeric(NA),
         total_effort_3_units = as.character(NA),
         total_effort_2_units = as.character(NA),
         water_temp = as.numeric(NA),
         water_temp_units = as.character(NA),
         water_clarity = as.numeric(NA),
         Water_clarity_units = as.character(NA),
         lat_start = as.numeric(NA),
         lon_start = as.numeric(NA),
         lat_end = as.numeric(NA),
         lon_end = as.numeric(NA),
         aging_structure_2 = as.character(NA),
         obs_id = as.character(row_number()),
         total_effort_2 = as.numeric(NA),
         site_id = as.character(net_id),
         batch_weight = as.character(NA),
         batch_weight_unit = as.character(NA),
         age_class = as.character(NA),
         ind_fish_ident = as.character(NA),
         waterbody_type = as.character(NA),
         location_notes_1 = as.character(NA),
         notes_1 = as.character(NA),
         area_group = as.character(NA),
         lake_name = lake_name.1,
         date = date.1,
         sub_effort_2 = as.numeric(NA),
         sub_effort_2_units = as.character(NA),
         lakesize = lake_area_acres,
         lakesize_units = "acres",
         target_species = combined_species,
         lake_id = as.character(lake_id),
         length_bin = as.character(length_bin),
         length.1 = as.numeric(length.1),
         total_effort_nothing_caught = total_survey_nothing_caught,
         sub_effort_nothing_caught = sub_survey_nothing_caught
         ) %>% 
  #migrates all original file names to a single column
  unite("original_file_names", c(original_file_name.1_agedfish,
                                      original_file_name.1_indvifish,
                                      original_file_name.1_effort), 
                                      remove = T, 
                                      na.rm = T) %>% 
  #selecting columns to retain
  select(state, 
         county, 
         lake_name,
         lake_id,
         nhdhr_id,
         latitude_lake_centroid,
         longitude_lake_centroid,
         date_survey,
         date_total_effort_ident,
         date_sub_effort_ident,
         date_sample,
         year,
         month,
         survey_id,
         survey_type,
         survey_type_2,
         survey_type_3,
         survey_type_4,
         sampling_method_simple,
         sampling_method,
         sampling_method_2,
         gear_data_notes,
         target_species,
         target_species_2,
         total_effort_ident,
         total_effort_1, 
         total_effort_2,
         total_effort_3,
         total_effort_1_units,
         total_effort_2_units,
         total_effort_3_units,
         total_effort_nothing_caught,
         water_temp,
         water_temp_units,
         water_clarity,
         Water_clarity_units,
         lat_start,
         lon_start,
         lat_end,
         lon_end,
         site_id,
         sub_effort_ident,
         sub_effort_1,
         sub_effort_1_units,
         sub_effort_2,
         sub_effort_2_units,
         sub_effort_nothing_caught,
         species.1,
         length.1,
         length_unit.1,
         length_bin,
         length_bin_unit,
         age,
         aging_structure.1,
         aging_structure_2,
         weight.1,
         weight_unit.1,
         batch_weight,
         batch_weight_unit,
         sex,
         age_class,
         flag,
         original_file_names,
         ind_fish_ident,
         lakesize,
         lakesize_units,
         area_group,
         lat_unspec,
         lon_unspec,
         waterbody_type,
         location_notes_1,
         notes_1,
         obs_id
         )
#no crosswalk for lake id exists for nhdids

#all the columns appear to be present that we need
#clean up column naming (underscores for periods)
il_data <- il_data %>% 
  clean_names()
```                        
                        
# Review & QC datasets
```{r}
#here I do some very basic checks on what the data structure and general outputs look like (i.e., s this thing behaving like the obs-level file I think it is?). MI work left here as an idea of a previous state's work. In my opinion, it is not our job to QC the actual observations at this point (like, is a WAE really going to be 500mm at age zero), but instead to use this QC as a check on the operations performed in this script.  

glimpse(il_data)

#how does the caught nothing column look?
il_data %>% 
  filter(total_effort_nothing_caught == "TRUE") %>% 
  select(lake_id, sampling_method, year, total_effort_ident, sub_effort_ident, total_effort_nothing_caught, sub_effort_nothing_caught) %>% 
  print(n = nrow(.))
#the only columns with an na lake name do not have a catch - this tell us the merge was done correctly

il_data %>% 
  filter(total_effort_ident == "3.2") %>% 
  distinct(total_effort_ident, sub_effort_ident, total_effort_nothing_caught, sub_effort_nothing_caught) %>% 
  print()

il_data %>% 
  filter(total_effort_ident == "1771.2") %>% 
  distinct(total_effort_ident, sub_effort_ident, total_effort_nothing_caught, sub_effort_nothing_caught) %>% 
  print()

il_data %>% 
  distinct(total_effort_ident, sub_effort_ident, .keep_all = T) %>% 
  select(total_effort_ident, sub_effort_ident, total_effort_nothing_caught, sub_effort_nothing_caught) %>% 
  filter(total_effort_nothing_caught == "FALSE" & sub_effort_nothing_caught == "TRUE") %>% 
  print(n = nrow(.))

il_data %>% 
  select(total_effort_ident, sub_effort_ident, total_effort_1, sub_effort_1, total_effort_nothing_caught, sub_effort_nothing_caught, species_1) %>% 
  filter(total_effort_ident == "1606.2") %>% 
  print(n = nrow(.))
#this shows a survey where the total survey is false for total effort nothing caught but true in a few sub levels

il_data %>% 
  select(total_effort_ident, sub_effort_ident, total_effort_1, sub_effort_1, total_effort_nothing_caught, sub_effort_nothing_caught, species_1) %>% 
  filter(total_effort_ident == "316.2") %>% 
  print(n = nrow(.))
#this shows a survey where the total survey is false for total effort nothing caught but true in a few sub levels

il_data %>% 
  group_by(survey_type) %>% 
  count()

il_data %>% 
  group_by(flag) %>% 
  count()

#how do total effort and sub effort align?
#data were provided in the run or number id - we have created a sub effort column in which all values are unique 
check <- il_data %>% 
  distinct(total_effort_ident, sub_effort_ident, site_id, total_effort_1, sub_effort_1)
rm(check)


il_data %>% 
  filter(lake_name == "Baldwin Lake" & year == "2012") %>% 
  distinct(total_effort_ident, sub_effort_ident, site_id, total_effort_ident, sub_effort_1, total_effort_1, target_species) %>% 
  arrange(total_effort_ident)

#example for vic
example <- il_data %>% 
  filter(lake_name == "Baldwin Lake" & year == "2012") %>% 
  distinct(lake_name, date_total_effort_ident, total_effort_ident, sub_effort_ident, target_species, total_effort_1)
rm(example)

example.cpe <- il_data %>% 
  filter(lake_name == "Baldwin Lake" & year == "2012") %>% 
  group_by(total_effort_ident) %>% 
  mutate(count.blg = sum(species_1 == "bluegill"),
         count.cc = sum(species_1 == "channel_catfish"),
         count.lmb = sum(species_1 == "largemouth_bass"),
         cpe.blg = count.blg/total_effort_1,
         cpe.cc = count.cc/total_effort_1,
         cpe.lmb = count.lmb/total_effort_1) %>% 
  distinct(lake_name, date_total_effort_ident, total_effort_ident, sub_effort_ident, target_species, total_effort_1, .keep_all = T) %>% 
  select(lake_name, date_total_effort_ident, total_effort_ident, sub_effort_ident, target_species, total_effort_1, count.blg, count.cc, count.lmb, cpe.blg, cpe.cc, cpe.lmb)
rm(example.cpe)

baldwin_check <- il_catch_age_effort_30Nov23_uncount %>% 
  filter(lake_name.1 == "Baldwin Lake" & year == "2012") %>% 
  filter(species.1 == "Largemouth Bass") %>% 
  group_by(total_effort_2) %>% 
  count()
rm(baldwin_check)

baldwin_original <- il_effort_30Nov23_fixed %>% 
  ungroup() %>% 
  filter(lake_name.1 == "Baldwin Lake" & year == "2012") %>% 
  select(lake_name.1, date.1, survey_id, total_effort_2, total_effort_1, target_species_1, target_species_2, target_species_3, subsample_time_1, subsample_time_2, subsample_time_3) %>% 
  rename(`net/run` = total_effort_2)
rm(baldwin_original)

il_data %>% 
  distinct(total_effort_ident, survey_type) %>% 
  group_by(survey_type) %>% 
  count()

il_data %>% 
  filter(sub_effort_nothing_caught == T) %>% 
  distinct(total_effort_ident, sub_effort_ident, survey_type) %>% 
  group_by(survey_type) %>% 
  count()

il_data %>% 
  group_by(sampling_method_simple, sampling_method, sampling_method_2) %>% 
  count() %>% 
  print(n = nrow(.))

il_data %>% 
  group_by(sampling_method, total_effort_1_units) %>% 
  count()

il_data %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  ggplot() +
  geom_density(aes(total_effort_1)) +
  geom_vline(xintercept = c(30, 1440, 2880), color = "red") +
  facet_wrap(~sampling_method, scales = "free") 

il_data %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  ggplot() +
  geom_histogram(aes(total_effort_1)) +
  geom_vline(xintercept = c(30, 1440, 2880), color = "red") +
  facet_wrap(~sampling_method, scales = "free") 

il_data %>%
  group_by(sampling_method) %>% 
  summarise(mean = mean(total_effort_1))

il_data %>% 
  collect() %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method) %>% 
  summarise(below_30 = sum(total_effort_1 < 30),
         below_1day = sum(total_effort_1 <1440),
         below_2days = sum(total_effort_1 <2880),
         n = n(),
         max = max(total_effort_1))

il_data %>% 
  filter(lake_name == "Jacksonville, Lake" & year == "2012") %>% 
  distinct(lake_name, total_effort_ident, sampling_method, sub_effort_ident, total_effort_1, sub_effort_1) %>% 
  collect() %>% 
  print(n = nrow(.))

il_data %>% 
  group_by(original_file_names) %>% 
  count()

il_data %>% 
  group_by(target_species) %>% 
  count()

il_data %>% 
  group_by(nhdhr_id) %>% 
  count()

il_data %>% 
  distinct(lake_id, .keep_all = T) %>% 
  group_by(is.na(nhdhr_id)) %>% 
  count()

#how do my dates look?
dates <- il_data %>% 
  group_by(lake_name, sampling_method, total_effort_ident, sub_effort_ident, date_survey, date_total_effort_ident, date_sub_effort_ident, date_sample) %>% 
  count()
rm(dates)

il_data %>% 
  group_by(sampling_method_simple, sampling_method, sampling_method_2) %>% 
  count() %>% 
  arrange(sampling_method_simple) %>% 
  print(n = nrow(.))

il_data %>% 
  count(is.na(species_1))
``` 


# Import/Export files
```{r}
str(il_data)

il_data <- as_arrow_table(il_data)

write_dataset(dataset = il_data, path = "Data_and_Scripts/Data/output/il_file_arrow")

il_data <- open_dataset("Data_and_Scripts/Data/output/il_file_arrow")

glimpse(il_data)
```

