---
title: "IN_Flat_File_Aggregation"
author: "Mike Verhoeven"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Preamble



# Issues to deal with last updated 1/30/2024

- Get age data from Matthew Linn for the IN glacial lakes




##Libraries
```{r}
library(arrow)
library(readr)
library(dplyr)
library(stringr)
library(data.table)
library(janitor)
library(tidyr)
library(lubridate)
library(bit64)

options(scipen = 999)
```


##Data
This could readily be changed into a function that takes a file path and returns files into environment.
```{r}
#generate a file list to import
files_list <- list.files(path = "D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/IN_Data/in_raw_disaggregated_data", pattern = ".+\\.csv") #grabs only.csv files
files_list



#object for use in loop (simple length of file list)
n <- length(files_list)

for(i in 1:n) {
  #i = 1
  filei <- word(gsub(".csv","", files_list[i]), start = -1, sep = fixed("/"))
  #this does those two steps in one package
  assign(filei ,
          fread(paste0("D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/IN_Data/in_raw_disaggregated_data/",
                                          files_list[i])))
  
  # if the file is a crosswalk, do not rename anything, just loop to the confirm import line
  if(str_detect(filei, "crosswalk")) {  #confirm import of files:  
    print(paste(filei ,"added to workspace" ))  
    #confirm import of files:  
    print(paste(i ,"files added to workspace" )) ; next}
  
  #if the file is not in the data explainer, don't try to rename it:
  if(filei %in% cde$new_file_name) {
    print("renaming with data explainer")
  } else {next}
  
  
  
  
  
  # note we want to review a sorted list of column names to check misspelling etc.
  # we still need to use the columns with names like col_name_length_in, or known_units
  
  
  cde %>% # call data explainer file
    filter(`new_file_name`== filei)%>% #keep only the row relevant to this file
    select_if(~ !any(is.na(.))) %>% 
    data.table::transpose(keep.names = "newname") %>% 
    rename("oldname" = V1) %>% 
    assign("names", ., envir = .GlobalEnv)
  
  #see if any column names will not have a match! 
  # IF any pop FALSE, force stop and revisit of data explainer ()
  # - e.g., named something "total catch" when actual column name was "total_catch"
  print(
    cbind(colnames(get(filei)),
          colnames(get(filei)) %in% names[ !str_detect(newname,"unique_row_key"), oldname, ]
    )
  )
  
  
  # break the loop if the current file has column names not in the data explainer
  # if (all(cbind(colnames(get(filei)),  colnames(get(filei)) %in% names[ !str_detect(newname,"unique_row_key"), oldname, ])[,2]) == FALSE ) break
  if (all(colnames(get(filei)) %in% names[ !str_detect(newname,"unique_row_key"), oldname, ]) == FALSE ) break
  
  
  # append old col names into new "notes" columns:
  get(filei)[ , (names[ str_detect(newname, "notes") , oldname   ,  ]) := Map(paste, colnames(.SD), .SD, sep = ':') , .SDcols =  names[ str_detect(newname, "notes") , oldname   ,  ] ]
  
  #now rename that file's colnames
  setnames(get(filei), colnames(get(filei)), names[!str_detect(newname,"unique_row_key")] [match(names(get(filei)),names[!str_detect(newname,"unique_row_key"),oldname]), newname] )
  
  #append all other data from data explainer
  unusedbits <- 
    data.table(
      matrix(
        rep(names[ !newname %in% colnames(get(filei)) , oldname , ],
            each = nrow(get(filei))
        ),
        nrow = nrow(get(filei)),
        dimnames = list(rep(NA,nrow(get(filei))),
                        names[ !newname %in% colnames(get(filei)) , newname , ])
        )
      )
  
  #add all not yet used columns from data explainer:
  get(filei)[ , (names[ !newname %in% colnames(get(filei)) , newname , ]) := unusedbits[] ]

  #confirm import of files:  
  print(paste(filei ,"added to workspace" ))  
  #confirm import of files:  
  print(paste(i ,"files added to workspace" )) 

  
} 
  #confirm import of files:  
  print(paste(i ,"files added to workspace" ))
  #confirm import of files:  
  print(paste(n-i ,"remaining to be added" )) 



```


#Data Review
   
```{r}
# for IN, there are data from "glacial lakes" and there are data from "reservoirs" so will work with glacial lakes, then work with reservoirs, and then combine glacial lakes and reservoirs to make a single IN file

#re-check
in_glaciallakes_effort_6Oct2021[ , .N, .(lake_name.1, county)] #129 unique lakes as of looks like 132 because counties aren't spelled the same consistently


# lots of things need to be specified in order for this merge to work to get lake IDs... but there doesn't seem to be a cleaner option
```


Data review continued

IN Glacial Lakes

Notes from Matthew Linn:
- TN: standard trap net (1-in mesh 45-ft lead; two rectangular 6-ft x 10-ft wire frames and four 2.5-ft diameter circular wire frames spaced 4-ft apart at the cod-end of the trap nets)
GN: experimental gill net (250 x 6 ft; five 50-ft panel sections of 0.5-in, 1-in, 1.5-in, 2-in and 2.5-in mesh sizes)
EF: Boat mounted DC nighttime electrofishing
- all surveys were completed during the month of June
- could add this info in as "gear_data_notes_1"
      * should we add this to the data..?

```{r}
in_glaciallakes_effort_6Oct2021[ , .N, .(sampling_method.1)]
# Three gears: standard trap net, experimental gill net and nighttime electrofishing
  # each gear is used in every survey. 152 surveys times 3 = 456

```

From Matthew Linn IN Glacial lakes contact: "we do the same effort for each survey (2 overnight trap lifts, 2 overnight experiment gill net lifts, and 0.5 hours of nighttime electrofishing)" - this is for standard surveys

# IN GL (glacial lakes)
unify effort units into a single column
- effort units are "overnight lifts" (net nights) and "hours"
```{r}
in_glaciallakes_effort_6Oct2021_2 <- in_glaciallakes_effort_6Oct2021 %>%
  rename(sampling_method = sampling_method.1)%>%
  mutate(effort_units = case_when(sampling_method == "Standard Trap Net" ~ "net_nights",
                                  sampling_method == "Experimental Gill Net" ~ "net_nights",
                                  sampling_method == "Nighttime Electrofishing" ~ "hours")) %>%
  select(-effort_units.1, -effort_units.2, -effort_units.3)%>% #remove these columns now that the info exists in "effort_units"
  mutate(sampling_method = str_to_lower(sampling_method))%>% #make sampling method consistent for std and targeted
  mutate(county = str_to_lower(county))%>%
  rename(effort_units.1 = effort_units)%>%
  relocate(lake_name.1, county, year, sampling_method, total_effort_1, effort_units.1)%>%
  mutate(targeted_or_standard = "standard")%>%
  mutate(sampling_method = case_when(sampling_method == "nighttime electrofishing" ~ "boat_electrofishing_dc_night",
                                     sampling_method == "experimental gill net" ~ "gill_net_experimental",
                                     sampling_method == "standard trap net" ~ "trap_net",
                                     TRUE ~ NA))
```


# glacial lakes standard surveys

get lake ID from lake ID list - needed to get a complete join on names
```{r}
in_glaciallakes_effort_6Oct2021_ID <- in_glaciallakes_effort_6Oct2021_2 %>%
  mutate(county = str_to_title(county))%>%
  mutate(county = case_when(lake_name.1 == "Crooked" & county == "Noble/Whitley" ~ "Noble",
                            county == "Laporte" ~ "LaPorte",
                            county == "Dekalb" ~ "DeKalb",
                            .default = county)) %>% 
  left_join(in_lake_id_nhd_id_7Feb2024, by = c("lake_name.1" = "lake_name", "county"= "county"))%>%
  rename(lake_id = state_id)%>%
  relocate(lake_name.1, lake_id, county, year, sampling_method, total_effort_1, effort_units.1)

#now all glacial lakes have IN state lake ID (FINFO)
```

prep IN GL fish data
```{r}
#will need to clean up lake names and county names for merge (need Matthew Linn's help with this)
  # instead have worked out kinks with lake ID and will use that instead for merge, counties are still a mess 

in_glaciallakes_fish_6Oct2021_2 <- in_glaciallakes_fish_6Oct2021 %>%
  rename(sampling_method = sampling_method.1)%>%
  rename(sampling_method_abbrev = sampling_method)%>% #this is an abbreviated name, make column with full name
  mutate(sampling_method = case_when(sampling_method_abbrev == "TN"~ "trap_net",
                                  sampling_method_abbrev == "GN" ~ "gill_net_experimental",
                                  sampling_method_abbrev == "EF" ~ "boat_electrofishing_dc_night",
                                  sampling_method_abbrev == "X" ~ "unknown_sampling_method",
                                  .default = "unknown_sampling_method"))%>%
  mutate(county = str_to_lower(county))%>%
  mutate(sampling_method_abbrev = if_else(sampling_method == "unknown", NA, sampling_method_abbrev))%>% 
  relocate(lake_name.1, county, year, species.1, length.1, sampling_method, sampling_method_abbrev, targeted_or_standard)
```

  
```{r}
# get lake ID from FINFO lake ID list
in_glaciallakes_fish_6Oct2021_ID <- in_glaciallakes_fish_6Oct2021_2 %>%
  mutate(county = str_to_title(county))%>%
  mutate(county = case_when(county == "Laporte" ~ "LaPorte",
                            county == "Dekalb" ~ "DeKalb",
                            county == "Noble/Whitley" ~ "Noble",
                            .default = county))%>%
  mutate(lake_name.1 = if_else(lake_name.1 == "Crooked (Noble/Whitley)", "Crooked", lake_name.1)) %>% 
  left_join(in_lake_id_nhd_id_7Feb2024, by = c("lake_name.1" = "lake_name", "county"= "county"))%>%
  rename(lake_id = state_id)
```


Merge effort and catch data
- Standard surveys for Glacial Lakes

IN GL Standard merge
```{r}
in_glacial_lakes_standard_merge <- in_glaciallakes_fish_6Oct2021_ID %>%
  full_join(in_glaciallakes_effort_6Oct2021_ID, by = c("lake_id", "sampling_method", "year"), suffix = c(".effort", ".fish"))%>%
  relocate(lake_id,
           lake_name.1.fish,
           county.fish,
           year,
           species.1,
           length.1,
           sampling_method,
           sampling_method_abbrev,
           total_effort_1) #relocate just specifies which columns to put first


in_glacial_lakes_standard_merge %>%
  group_by(sampling_method)%>%
  summarise(total = n()) # five fish don't have a sampling method

in_glacial_lakes_standard_merge %>%
  group_by(is.na(species.1)) %>%
  count()
#three surveys that don't have fish

in_glacial_lakes_standard_merge %>% 
  filter(is.na(species.1)) %>% 
  glimpse()

in_glaciallakes_fish_6Oct2021_ID %>% 
  filter(lake_name.1 == "Flint") %>% 
  group_by(year, sampling_method) %>% 
  count()
#this shows only two fish were caught in flint in 2013 via EF

in_glaciallakes_fish_6Oct2021_ID %>% 
  filter(lake_name.1 == "North Chain") %>% 
  group_by(year, sampling_method) %>% 
  count()
#this shows there were no fish caught by gill net in North Chain in 2020
```

tidy and finish the glacial lakes standard surveys
```{r}
  # tidy so columns match other parquet names
in_glaciallakes_standard_tidy <- in_glacial_lakes_standard_merge%>%
  mutate(waterbody_type = "glacial_lake")%>%
  mutate(flag = case_when(length.1 == 0 ~ "length of zero",
                          county.fish != county.effort ~ "multiple counties listed",
                          sampling_method == "unknown_sampling_method" ~ "no sampling method provided",
                          .default = NA))%>%
  mutate(state = "Indiana")%>%
  mutate(county = if_else(is.na(county.effort), county.fish, county.effort))%>% #assign a single county
  mutate(lake_name_1 = if_else(is.na(lake_name.1.fish), lake_name.1.effort, lake_name.1.fish))%>%
  mutate(lat = if_else(is.na(lat.effort), lat.fish, lat.effort))%>%
  mutate(lon = if_else(is.na(lon.effort), lon.fish, lon.effort))%>%
  mutate(survey_type = if_else(is.na(targeted_or_standard.effort), targeted_or_standard.fish, targeted_or_standard.effort))%>%
  mutate(length_unit_1 = "inches")%>%
  mutate(length_1 = as.numeric(length.1))%>%
  mutate(month = 6)%>%
  mutate(target_species = NA)%>%
  mutate(species_1 = str_to_lower(species.1)) %>% 
  mutate(species_1 = str_replace(species_1, " ", "_")) %>% 
  rename(total_effort_1_units = effort_units.1,
         original_file_name_1_indivfish = original_file_name.1.fish,
         original_file_name_1_effort = original_file_name.1.effort,
         lat_unspec = lat,
         lon_unspec = lon)%>%
  mutate(original_file_names = paste(original_file_name_1_effort, original_file_name_1_indivfish, sep = ", "))%>%
  select(state,
         county,
         lake_name_1,
         lake_id,
         year,
         month,
         survey_type,
         sampling_method,
         total_effort_1,
         total_effort_1_units,
         species_1,
         target_species,
         length_1,
         length_unit_1,
         lat_unspec,
         lon_unspec,
         flag,
         original_file_names,
         waterbody_type)%>%
  rename(lake_name = lake_name_1)
#there is a warning about NAs being introduced when length is made a numeric, but they should be NAs
#were previously "_" (a blank) (11), "-" (25), "X" (1), or "FALSE" (2)


rm(in_glaciallakes_effort_6Oct2021_ID, in_glaciallakes_fish_6Oct2021_ID, in_glacial_lakes_standard_merge)
```


# IN Glacial Lakes (GL) targeted surveys
```{r}
# what are the sampling methods?
in_glaciallakes_targeted_effort_16Nov2023[ , .N, .(sampling_method.1)]
  # only two gears, nighttime Electrofishing and Experimental Gill Net
#prepare data for merge

in_glaciallakes_targeted_effort_16Nov2023_2 <- in_glaciallakes_targeted_effort_16Nov2023 %>%
  rename(sampling_method = sampling_method.1)%>%
  mutate(effort_units = case_when(sampling_method == "Experimental gill net" ~ "net_nights",
                                  sampling_method == "Nighttime electrofishing" ~ "hours"))%>%
  mutate(date.1 = mdy(date.1))%>%
  mutate(month = month(date.1))%>%
  mutate(year = year(date.1))%>% #make column for year to match non-targeted
  mutate(sampling_method = str_to_lower(sampling_method))%>%
  mutate(sampling_method = case_when(sampling_method == "nighttime electrofishing" ~ "boat_electrofishing_dc_night",
                                    sampling_method == "experimental gill net" ~ "gill_net_experimental",
                                    TRUE ~ sampling_method))%>%#make sampling method consistent for std and targeted
  rename(effort_units.1 = effort_units)%>%
  mutate(date.1 = as.character(if_else(lake_name.1 == "Golden" & year == "2017", "2017-05-03", paste(as.character(date.1)))))%>%# # has mismatched survey date and fish caught date
  mutate(date.1 = as.IDate(date.1))%>%
  relocate(lake_id, lake_name.1, county, year, sampling_method, total_effort_1, effort_units.1, date.1)

in_glaciallakes_targeted_fish_16Nov2023_2 <- in_glaciallakes_targeted_fish_16Nov2023 %>%
  mutate(date.1 = mdy(date.1))%>%
  mutate(year = year(date.1))%>%
  mutate(date.1 = as.IDate(date.1))

```


- check that lake ID >= lake_name.1 and county for key columns
```{r}
in_glaciallakes_targeted_effort_16Nov2023_2 %>%
  group_by(lake_name.1, county)%>%
  summarise(Total = n()) #46 lakes

in_glaciallakes_targeted_effort_16Nov2023_2 %>%
  group_by(lake_id)%>%
  summarise(Total = n()) #46 lakes, looks like we can use lake ID for these surveys!
```


merge IN GL targeted fish with effort
- 13,717 fish obs
- 51 survey/gear 

Check merge product for IN GL Targeted
# Merge of IN Glacial Lakes targeted surveys

- note, at one point, the dates were not matching, and we were losing 10,051 fish obs and 31 surveys. However, this seems to be resolved after making the dates IDates.

### IN GL Targeted Merge
```{r}
in_glaciallakes_targeted_full_join <- in_glaciallakes_targeted_fish_16Nov2023_2 %>%
  full_join(in_glaciallakes_targeted_effort_16Nov2023_2, by = c("lake_id", "date.1"),
             suffix = c("_catch", "_effort"))
```


Tidy GL targeted surveys 
```{r}
# clean up GL targeted surveys join
in_glaciallakes_targeted_full_join_tidy <- in_glaciallakes_targeted_full_join %>%
  mutate(lake_name_1 = if_else(lake_name.1_catch == lake_name.1_effort, lake_name.1_catch, lake_name.1_effort))%>%
  mutate(county = if_else(county_catch == county_effort, county_catch, county_effort))%>%
  mutate(length_1 = as.numeric(length.1))%>%
  rename(state = state_catch, #rename to match other parquet files
         date_1 = date.1,
         total_effort_1_units = effort_units.1,
         species_1 = species.1,
         length_unit_1 = length_unit.1,
         year = year_catch,
         original_file_name_1_effort = original_file_name.1_effort,
         original_file_name_1_indivfish = original_file_name.1_catch)%>%
  mutate(total_effort_1_units = if_else(total_effort_1_units == "overnight lifts", "net_nights", total_effort_1_units))%>%
  mutate(date_1 = as.IDate(date_1))%>% #make date an IDate
  mutate(species_1 = str_to_lower(species_1))%>% #make species name lowercase
  mutate(species_1 = str_replace(species_1, " ", "_"))%>% #remove spaces from species name and put underscores
  mutate(survey_type = if_else(!is.na(targeted_or_standard_catch), targeted_or_standard_catch, targeted_or_standard_effort))%>%
  mutate(waterbody_type = "glacial_lake")%>%
  mutate(target_species = species_1)%>%
  mutate(original_file_names = paste(original_file_name_1_effort, original_file_name_1_indivfish, sep = ", "))%>%
  select(state, 
         county, 
         lake_name_1, 
         lake_id,
         date_1,
         month,
         year,
         survey_type,
         sampling_method,
         total_effort_1,
         total_effort_1_units,
         species_1,
         target_species,
         length_1,
         length_unit_1,
         original_file_names,
         waterbody_type)%>%
  rename(date = date_1,
         lake_name = lake_name_1)



rm(in_glaciallakes_targeted_full_join)
```


#Glacial Lakes Standard and Targeted
```{r}
in_glaciallakes <- bind_rows(in_glaciallakes_standard_tidy, in_glaciallakes_targeted_full_join_tidy)
# good as of 2/8/2024

glimpse(in_glaciallakes)
```


#Reservoir
```{r}
################aged fish#################
#age fish
glimpse(in_reservoir_age_fish_16Aug2022)

#age effort
glimpse(in_reservoir_age_effort_16Aug2022)

###############fish community#############
#fish
glimpse(in_reservoir_fish_community_fishdata_16Aug2022)

#effort
glimpse(in_reservoir_fish_community_effort_16Aug2022)

##############targeted surveys#######################
#fish
glimpse(in_reservoir_targeted_fish_1Sep2022)

#effort
glimpse(in_reservoir_targeted_effort_1Sep2022)

#community data set has the most fish so i will start there

#collapse fish into survey level - doesn't look like I need to uncount

#effort file has lake specific info that could be useful in linking (lat/long, lake_id)

#potienal steps could be linking effort via survey id and sampling method and retaining info from the survey file

#how do lake names align?
fish.lakes <- in_reservoir_fish_community_fishdata_16Aug2022 %>% 
  group_by(survey_id, lake_name.1) %>% 
  count() %>% 
  print(n = nrow(.))

effort.lakes <- in_reservoir_fish_community_effort_16Aug2022 %>% 
  group_by(survey_id,lake_name.1) %>% 
  count() %>% 
  print(n = nrow(.))

rm(fish.lakes,
   effort.lakes)

in_reservoir_fish_community_effort_16Aug2022 %>% 
  group_by(survey_id, date.1) %>% 
  count() %>% 
  print(n=nrow(.))
#survey ids only contain one date


#lake names seem to slightly differ between the two files, but survey ids are consist
#no dates within the fish file, but if the survey ids are consist between the two files that should be okay

in_reservoir_fish_community_fishdata_16Aug2022 %>% 
  group_by(survey_id, sampling_method.1) %>% 
  count() %>% 
  print( n= nrow(.))
#multiple survey types per survey id


#how can i get sampling method within the effort file?
in_reservoir_fish_community_effort_16Aug2022 %>% 
  group_by(total_effort_1, total_effort_2, total_effort_3) %>% 
  count()
#data explainer says:
#1. total_effort_1 reports effort for electofishing
#2. total_effort_2 reports effort for gill netting
#3. total_effort_3 reports effort for trap netting 

#will joining on survey id work alright?
in_reservoir_fish_community_fishdata_16Aug2022 %>% 
  filter(is.na(survey_id))
in_reservoir_fish_community_effort_16Aug2022 %>% 
  filter(is.na(survey_id))
#921 surveys without an id - all NAs, reads in blank rows for some reason
#raw data only shows 79 rows/surveys - not sure why it reads in more 

in_reservoir_fish_community_effort_16Aug2022 %>% 
  filter(is.na(survey_id)) %>% 
  glimpse()
```

Notes about reservoir data:
-Lake names between effort and fish files were not consistent 
-The Lake ID and date are only found in the effort file
-Given the two points above, I merged effort and fish files together using survey id and sampling method
-total effort is stored in a wide format - conversion to long format was needed
-ages that do not have a corresponding fish in the community or targeted surveys were left in the file and can be easily filtered out

Questions about the data themselves:
- For standard fish community surveys cypress lake seems to have a miss match survey id (273 and 373)
- In targeted surveys, 512 Dogwood has effort for standard trap nets but no fish are in the fish file
- Only half of the ages found partners of fish using survey id, length, weight, species, sampling method 
    -surveys that do not have any records besides age data: 373, 467, 481, 482, 483, 484, 485, 486, 487, 488, 489, 490
    -survey that have matching community record but no corresponding fish: 379
    -surveys that have a matching survey id but mismatching survey info: 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 479, 480

# IN Reservoir standard effort merge
```{r}
#steps to get effort and fish together:
#1. generate sampling method for the effort file
#2. link the effort to the fish via survey id and sampling method
#3. retain or gather survey info from effort file or the lake id list

#generating sampling method for the effort file
in_reservoir_fish_community_effort_16Aug2022_gear <- in_reservoir_fish_community_effort_16Aug2022 %>%
  filter(!is.na(survey_id)) %>% 
  pivot_longer(cols = c(total_effort_1, total_effort_2, total_effort_3), names_to = "sampling_method", values_to = "total_effort" ) %>%  # make data longer, so that effort is in a single column
  #matching sampling method to those in the fish file - these will be cleaned up in a later step
  mutate(sampling_method = case_when(sampling_method == "total_effort_1" ~ "boat_electrofishing_dc_night",
                                     sampling_method == "total_effort_2" ~ "gill_net_experimental_res",
                                     sampling_method == "total_effort_3" ~ "trap_net"))%>% # write out sampling method
  mutate(effort_units = case_when(sampling_method == "boat_electrofishing_dc_night" ~ "hours",
                                  sampling_method == "gill_net_experimental" ~ "net_nights",
                                  sampling_method == "trap_net" ~ "net_nights"))%>% # write out effort units
  relocate(survey_id,
           lake_name.1,
           lake_id,
           date.1,
           end_date,
           survey_type.1,
           sampling_method,
           total_effort,
           effort_units)%>% #bring these columns to the front 
  select(-effort_units.1, -effort_units.2, -effort_units.3)%>%
  mutate(date.1 = as.Date(date.1, "%m/%d/%y"))%>%
  mutate(date.1 = as.IDate(date.1))%>%
  mutate(year = year(date.1))%>%
  mutate(survey_type.1 = if_else(survey_type.1 == "Reservoir S&T", "standard", NA))
```


```{r}
#mismatch in survey ids at cypress lake between the effort and fish data
#there was a difference in the sampling method spelling for a few records at Summit
#fish data must be fixed to insure they join together 

in_reservoir_fish_community_fishdata_16Aug2022 %>% 
  group_by(sampling_method.1) %>% 
  count()

#prepping fish data for merge - fixing erroneous sampling methods and survey ids
in_reservoir_fish_community_fishdata_16Aug2022_prep <- in_reservoir_fish_community_fishdata_16Aug2022 %>%
  mutate(sampling_method = case_when(sampling_method.1 == "Gill net STB exp" ~ "gill_net_experimental_res",
                                     sampling_method.1 == "Gill net std exp" ~ "gill_net_experimental_res",
                                     sampling_method.1 == "Night EF" ~ "boat_electrofishing_dc_night",
                                     sampling_method.1 == "Trap net std" ~ "trap_net",
                                     TRUE ~ NA))  %>% 
  mutate(survey_id = case_when((survey_id == 373 & lake_name.1 == "Cypress Lake") ~ 273,
                               TRUE ~ survey_id)) #difference in survey id at cypress lake
```

### IN Reservoir Community Merge
```{r}
in.community <- full_join(in_reservoir_fish_community_effort_16Aug2022_gear, 
                          in_reservoir_fish_community_fishdata_16Aug2022_prep, 
                          by = c("survey_id", "sampling_method"),
                          suffix = c("_effort", "_catch")) %>% 
  mutate(original_file_names = paste(original_file_name.1_effort, original_file_name.1_catch, sep = ", "),
         target_species = NA)%>%
  rename(state = state_catch,
         lake_name = lake_name.1_catch,
         date_1 = date.1,
         survey_type = survey_type.1) %>% 
  select(state,
         survey_id,
         lake_name,
         lake_id,
         date_1,
         year,
         end_date,
         survey_type,
         sampling_method,
         total_effort,
         effort_units,
         lat_unspec,
         lon_unspec,
         species.1,
         target_species,
         length.1,
         weight.1,
         length_unit.1,
         weight_unit.1,
         gear_data_notes.1,
         original_file_names)

rm(in_reservoir_fish_community_effort_16Aug2022_gear, in_reservoir_fish_community_fishdata_16Aug2022_prep)
```

#IN Reservoir targeted surveys
1. prep effort file
```{r}
in_reservoir_targeted_effort_1Sep2022_gear <- in_reservoir_targeted_effort_1Sep2022 %>% 
  filter(!is.na(survey_id)) %>% 
  pivot_longer(cols = c(total_effort_1, total_effort_2, total_effort_3, total_effort_4, total_effort_5), names_to = "sampling_method", values_to = "total_effort" ) %>% 
  mutate(sampling_method = case_when(sampling_method == "total_effort_1" ~ "Night EF",
                                     sampling_method == "total_effort_2" ~ "Gill net std exp",
                                     sampling_method == "total_effort_3" ~ "Trap net std",
                                     sampling_method == "total_effort_4" ~ "MITN",
                                     sampling_method == "total_effort_5" ~ "Large-mesh GN"))%>% # write out sampling method
  mutate(effort_units = case_when(sampling_method == "Night EF" ~ "hours",
                                  sampling_method == "Gill net std exp" ~ "net_nights",
                                  sampling_method == "Trap net std" ~ "net_nights",
                                  sampling_method == "MITN" ~ "net_nights",
                                  sampling_method == "Large-mesh GN" ~ "net_nights")) %>% 
  relocate(survey_id, 
           lake_name.1, 
           lake_id, 
           date.1, 
           end_date, 
           survey_type.1, 
           sampling_method, 
           total_effort, 
           effort_units)%>% #bring these columns to the front 
  select(-effort_units.1, -effort_units.2, -effort_units.3, -effort_units.4, -effort_units.5) %>% 
  filter(!is.na(total_effort))%>%
  mutate(date.1 = as.Date(date.1, "%m/%d/%y"))%>%
  mutate(date.1 = as.IDate(date.1))%>%
  mutate(year = year(date.1))%>%
  mutate(survey_type.1 = str_to_lower(survey_type.1))
```

```{r}
in_reservoir_targeted_fish_1Sep2022_2 <- in_reservoir_targeted_fish_1Sep2022 %>%
  rename(sampling_method = sampling_method.1) #rename so anti joins can work for checks

anti.effort <- anti_join(in_reservoir_targeted_effort_1Sep2022_gear, 
                         in_reservoir_targeted_fish_1Sep2022_2, 
                          by = c("survey_id", "sampling_method"))

anti.fish <- anti_join(in_reservoir_targeted_fish_1Sep2022_2,
                       in_reservoir_targeted_effort_1Sep2022_gear,
                       by = c("survey_id", "sampling_method"))

anti.fish %>% 
  group_by(survey_id, lake_name.1, sampling_method) %>% 
  count()

in_reservoir_targeted_fish_1Sep2022_2 %>% 
  filter(is.na(survey_id)) %>% 
  group_by(lake_name.1, species.1, length.1) %>% 
  count()
#no fish records in 512 for the standard trap effort - all fish are are a MITN... is it really nothing caught with 35 nets?
#200 records that have everything as just na - similar to what I have been seeing in the effort data

rm(in_reservoir_targeted_fish_1Sep2022_2, anti.effort, anti.fish)
```

2. prep fish file
```{r}
#prepping fish data for merge
in_reservoir_targeted_fish_1Sep2022_prep <- in_reservoir_targeted_fish_1Sep2022 %>% 
  filter(!is.na(survey_id))%>%
  rename(sampling_method = sampling_method.1)

in_reservoir_targeted_fish_1Sep2022_prep %>% 
  group_by(sampling_method) %>% 
  count()
```

3. IN reservoir targeted merge
```{r}
in.targeted <- inner_join(in_reservoir_targeted_effort_1Sep2022_gear, 
                          in_reservoir_targeted_fish_1Sep2022_prep, 
                          by = c("survey_id", "sampling_method"),
                          suffix = c("_effort", "_catch")) %>%
  mutate(original_file_names = paste(original_file_name.1_effort, original_file_name.1_catch, sep = ", "))%>%
  mutate(sampling_method = case_when(sampling_method == "Night EF" ~ "boat_electrofishing_dc_night",
                                     sampling_method == "Gill net std exp" ~ "gill_net_experimental_res",
                                     sampling_method == "Trap net std" ~ "trap_net",
                                     sampling_method == "MITN" ~ "trap_net_michigan",
                                     sampling_method == "Large-mesh GN" ~ "gill_net_large_mesh",
                                     TRUE ~ NA)) %>% 
  rename(state = state_effort,
         lake_name = lake_name.1_effort,
         date_1 = date.1,
         survey_type = survey_type.1) %>% 
  select(state,
         survey_id,
         lake_name,
         lake_id,
         date_1,
         year,
         end_date,
         survey_type,
         sampling_method,
         total_effort,
         effort_units,
         lat_unspec,
         lon_unspec,
         species.1,
         length.1,
         weight.1,
         length_unit.1,
         weight_unit.1,
         gear_data_notes.1,
         original_file_names) 
```

4. add target species column to IN Reservoirs targeted surveys
```{r}
in_targeted_species <- in.targeted %>%
  group_by(survey_id, sampling_method, species.1)%>%
  summarise(total = n())%>%
  mutate(target_species = str_flatten(species.1, collapse=", "))%>%
  select(survey_id, sampling_method, species.1, target_species) #list of what species each survey is targeting to join

in_res_targeted <- in.targeted %>%
  left_join(in_targeted_species, by = c("survey_id", "sampling_method", "species.1"))

rm(in_targeted_species)
```

### combining reservoir targeted and community surveys and cleaning
```{r}
in_reservoir_data_noage <- bind_rows(in.community, in_res_targeted) %>% 
  mutate(date_1 = as.IDate(date_1))%>%
  mutate(waterbody_type = "reservoir")%>%
  mutate(month = month(date_1)) %>% 
  select(state,
         survey_id,
         lake_name,
         lake_id,
         date_1,
         year,
         month,
         end_date,
         survey_type,
         sampling_method,
         total_effort,
         effort_units,
         lat_unspec,
         lon_unspec,
         species.1,
         target_species,
         length.1,
         weight.1,
         length_unit.1,
         weight_unit.1,
         gear_data_notes.1,
         original_file_names,
         waterbody_type) %>% 
  rename(total_effort_1 = total_effort,
         total_effort_1_units = effort_units,
         species_1 = species.1,
         date = date_1,
         length_1 = length.1,
         length_unit_1 = length_unit.1,
         weight_1 = weight.1,
         weight_unit_1 = weight_unit.1,
         gear_data_notes_1 = gear_data_notes.1)

rm(in.community, in.targeted, in_res_targeted)
```

#files created up to the point
1. Glacial lakes (in_glaciallakes)
   a.) standard (removed but called in_glacial_lakes_standard_tidy)
   b.) targeted (removed but called targeted_full_join_tidy)
2. Reservoir lakes - no aged data (in_reservoir_data_noage)
   a.) standard (removed but called in_community)
   b.) targeted (removed but called in_res_targeted)

# Adding res aged fish to the res data
1. survey information for aged fish data
```{r}
# get survey info for aged fish from the effort file
in_res_aged_effort_fish <- in_reservoir_age_effort_16Aug2022%>%
  pivot_longer(cols = c(total_effort_1, total_effort_2, total_effort_3, total_effort_4, total_effort_5), names_to = "sampling_method", values_to = "total_effort") %>% 
  mutate(sampling_method = case_when(sampling_method == "total_effort_1" ~ "boat_electrofishing_dc_night",
                                     sampling_method == "total_effort_2" ~ "gill_net_experimental_res",
                                     sampling_method == "total_effort_3" ~ "trap_net",
                                     sampling_method == "total_effort_4" ~ "trap_net_michigan",
                                     sampling_method == "total_effort_5" ~ "gill_net_large_mesh"))%>% # write out sampling method
  mutate(effort_units = case_when(sampling_method == "boat_electrofishing_dc_night" ~ "hours",
                                  sampling_method == "gill_net_experimental" ~ "net_nights",
                                  sampling_method == "trap_net" ~ "net_nights",
                                  sampling_method == "trap_net_michigan" ~ "net_nights",
                                  sampling_method == "gill_net_large_mesh" ~ "net_nights")) %>%
  mutate(survey_id = case_when((survey_id == 373 & lake_name.1 == "Cypress Lake") ~ 273,
                               TRUE ~ survey_id))%>%
  relocate(survey_id, lake_name.1, lake_id, date.1, survey_type.1, sampling_method, total_effort, effort_units)%>%
  #Not sure where Holly got this info?
  mutate(lake_name.1 = if_else(survey_id == 479, "Brookville", lake_name.1))%>%
  mutate(lake_id = if_else(survey_id == 479, "{733228C8-5F92-46FF-ADB1-58883B7609FB}", lake_id))%>%
  mutate(total_effort = as.character(total_effort)) %>%
  mutate(total_effort = case_when(survey_id == 469 & sampling_method == "trap_net_michigan"~ "unknown", 
                                  survey_id == 469 & sampling_method == "trap_net_michigan"~ "unknown",
                                  survey_id == 473 & sampling_method == "trap_net_michigan"~ "unknown",
                                  survey_id == 473 & sampling_method == "trap_net"~ "unknown",
                                  survey_id == 479 & sampling_method == "gill_net_large_mesh"~ "unknown",
                                  survey_id == 467 & sampling_method == "in standard net" ~ "unknown",
                                  survey_id == 468 & sampling_method == "in standard net" ~ "unknown",
                                  .default = total_effort))%>% #these surveys have no effort, but don't want them dropped because they have aged fish
  drop_na(total_effort)%>%
  mutate(total_effort = na_if(total_effort, "unknown"))%>%
  mutate(total_effort = as.numeric(total_effort))%>%
  mutate(survey_type.1 = case_when(survey_type.1 == "Reservoir S&T" ~ "standard",
                                   survey_type.1 == "Targeted Species" ~ "targeted",
                                   survey_type.1 == "Targeted" ~ "targeted",
                                   .default = NA))%>%
  rename(original_file_name_age_effort = original_file_name.1) %>% 
  select(survey_id,
         lake_name.1,
         lake_id,
         date.1,
         end_date,
         survey_type.1,
         lat_unspec,
         lon_unspec,
         original_file_name_age_effort,
         sampling_method,
         total_effort,
         effort_units)
```


2. Aggregate the aged fish data and its effort
```{r}
in_reservoir_age_fish_16Aug2022_merge  <- in_reservoir_age_fish_16Aug2022 %>% 
  #remove fish that do not have a survey id
  filter(!is.na(survey_id)) %>%
  rename(sampling_method = sampling_method.1)%>%
  mutate(survey_id = case_when((survey_id == 373 & lake_name.1 == "Cypress Lake") ~ 273,
                               TRUE ~ survey_id))%>%
  #arrange fish in survey in a row, assign a number to them to ensure they join nicely with fish data
  arrange(survey_id, species.1, sampling_method, length.1, weight.1) %>%
  group_by(survey_id,species.1, sampling_method, length.1, weight.1) %>%
  mutate(age_id = row_number()) %>% 
  ungroup() %>% 
  #the code chunk above insures that all fish are made distinct (even if they are the same length and weight from the same survey id)
  mutate(length.1 = as.double(length.1),
         weight.1 = as.double(weight.1)) %>%
 mutate(sampling_method = case_when(sampling_method == "Night EF" ~ "boat_electrofishing_dc_night",
                                     sampling_method == "Gill net" ~ "gill_net_experimental_res",
                                     sampling_method == "Trap net std" ~ "trap_net",
                                     sampling_method == "MITN" ~ "trap_net_michigan",
                                     sampling_method == "Large-mesh Gill Net" ~ "gill_net_large_mesh",
                                    sampling_method == "IN Standard Net" ~ "standard_net_in",
                                    .default = "unknown"))%>%
  mutate(species.1 = str_to_lower(species.1)) %>% 
  #adding effort and survey level information to the fish
  left_join(in_res_aged_effort_fish, by = c("survey_id", "sampling_method"))%>%
  rename(lake_name = lake_name.1.x,
         date_1 = date.1,
         total_effort_1 = total_effort,
         total_effort_1_units = effort_units,
         survey_type = survey_type.1) %>% 
  select(survey_id,
         lake_name,
         lake_id,
         date_1,
         end_date,
         survey_type,
         sampling_method,
         total_effort_1,
         total_effort_1_units,
         species.1,
         length.1,
         weight.1,
         age_id,
         age,
         aging_structure.1,
         gear_data_notes.1,
         original_file_name.1,
         original_file_name_age_effort,
         lat_unspec,
         lon_unspec) %>%
  rename(original_file_name.1_age = original_file_name.1,
         species_1 = species.1,
         length_1 = length.1,
         weight_1 = weight.1) %>% 
  mutate(waterbody_type = "reservoir") %>% 
  mutate(total_effort_1_units = case_when(is.na(total_effort_1) & !is.na(total_effort_1_units) ~ NA,
                                          TRUE ~ total_effort_1_units))
#the fish level aged data has been added to the effort data 
```

We now have all of the aged fish in fish-per-row with its effort. Our next task is to see if any of these came from already aggregated surveys... in short, can we just throw the age onto some of these fish or did they come from separate surveys? We will have to carefully consider fish that have the same survey, gear, weight, length, so they each get the observed age assigned to the correct fish (although unlikely they could have different ages)

3. Add reservoir age data the other survey data from the reservoirs
- here we create a duplicate reservoir data set that lines up fish records and assigns an "age_id" so that the same fish are connected with the correct age (there any be multiple fish with he same length-weight-survey)
- we do a full join so that we retain all aged fish surveys - not just those that were matched to fish in a res survey

```{r}
#here we use the already aggregated reservoir data to create an age id column
#this gives a unique id to each fish in a total effort ident if they are the same weight and length 
in_reservoir_data_age <- in_reservoir_data_noage %>%
   mutate(species_1 = str_to_lower(species_1))%>%#was in_reservoir_data_noage
  arrange(survey_id, species_1, sampling_method, length_1, weight_1) %>%
  group_by(survey_id, species_1, sampling_method, length_1, weight_1) %>%
  mutate(age_id = row_number())
#there are unmeasured shad - nas are treated at the same value within the specified grouping. Thus, there is an age_id that goes up to 700. Not to sweat because it is highly unlikely that any unmeasured fish did not get aged

#checking to see if we can just add the age to any fish that were in the community survey - if ages cannot simply be added, we will tag them along within the full join
in_reservoir_data <- full_join(in_reservoir_data_age,
                                  in_reservoir_age_fish_16Aug2022_merge,
                                    by = c("survey_id",
                                           "lake_id",
                                           "sampling_method",
                                           "species_1",
                                           "length_1",
                                           "weight_1",
                                           "age_id"),
                               suffix = c("_unaged", "age"))%>%
  mutate(length_unit_1 = replace_na(length_unit_1, "col_name_Length (in)"))%>% 
  mutate(weight_unit_1 = replace_na(weight_unit_1, "col_name_weight (lb)"))

in_age_check1 <- in_reservoir_data_age %>%
  select(survey_id, sampling_method, species_1, length_1, weight_1, age_id) #66297

in_age_check2 <- in_reservoir_age_fish_16Aug2022_merge %>%
  select(survey_id, sampling_method, species_1, length_1, weight_1, age_id, age)%>%
  filter(!is.na(age)) #6005 fish with ages - 2 fish in the aged data do not have ages

in_age_check3 <- left_join(in_reservoir_data_age,
                                  in_reservoir_age_fish_16Aug2022_merge,
                                    by = c("survey_id",
                                           "sampling_method",
                                           "lake_id",
                                           "species_1",
                                           "length_1",
                                           "weight_1",
                                           "age_id")) %>%
  filter(!is.na(age)) 
#the full join added 3016 fish obs to the res data - meaning that many aged fish do not many any records
#there are 2991 aged fish that matched records 
#we have 6005 fish records with ages - that means if our joins were done correctly we should have 3014 fish without ages 
#the difference between 3016 and 3014 are two fish in the aged fish file that were filtered out in the check step because they do not have ages

in_age_check4 <- in_reservoir_data %>% 
  filter(!is.na(age))

in_age_check4 %>% 
  group_by(original_file_names, original_file_name.1_age, original_file_name_age_effort) %>% 
  count()

rm(in_age_check1, in_age_check2, in_age_check3, in_age_check4)

anti.age <- anti_join(in_reservoir_age_fish_16Aug2022_merge,
                      in_reservoir_data,
                                    by = c("survey_id",
                                           "sampling_method",
                                           "lake_id",
                                           "species_1",
                                           "length_1",
                                           "weight_1",
                                           "age_id"))
#we have 6007 aged fish after the effort merge, 2991 matched with fish already in res surveys. Thus, we should get 3016 fish that do not match and are "extra fish". These will not be for abundance surveys, could be useful for ALKs

no_matches_surveys <- in_reservoir_age_fish_16Aug2022_merge %>% 
  filter(survey_id == "479")
#surveys that do not have any records besides age data:  481, 482, 483, 484, 485, 486, 487, 488, 489, 490
#survey that have matching community record but no corresponding fish: 379
#surveys that have a matching survey id but mismatching survey info: 467, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 479, 480

rm(anti.age, no_matches_surveys)
```


# Clean IN reservoir data 
```{r}
# prep data for row bind with glacial lakes
in_reservoir_tidy <- in_reservoir_data %>%
  #makes original file games - can track aged fish that have matched survey info here
  mutate(original_file_names= paste(original_file_names, 
                                    original_file_name_age_effort, 
                                    original_file_name.1_age, sep = ", ")) %>% 
  #make sure the date columns matched for res and age fish
  mutate(date_1 = as.Date(date_1, "%m/%d/%y"), 
         date_1 = as.IDate(date_1),
         date = case_when(is.na(date) ~ date_1,
                          TRUE ~ date)) %>% 
  mutate(date_1 = as.Date(date, "%m/%d/%y"))%>%
  mutate(date_1 = as.IDate(date)) %>% 
  #creating month column
  mutate(month = month(date_1),
         year = year(date_1))%>%
  rename(aging_structure_1 = aging_structure.1)%>%
  #the next steps are makings important columns are retained and filled if the info is present from the age fish join
  #this is important for aged fish that were not matched to a survey 
  mutate(lake_name = if_else(is.na(lake_name_unaged), lake_nameage, lake_name_unaged))%>%
  mutate(end_date = if_else(is.na(end_date_unaged), end_dateage, end_date_unaged))%>%
  mutate(lat_unspec = if_else(is.na(lat_unspec_unaged), lat_unspecage, lat_unspec_unaged))%>%
  mutate(lon_unspec = if_else(is.na(lon_unspec_unaged), lon_unspecage, lon_unspec_unaged))%>%
  mutate(gear_data_notes_1= paste(gear_data_notes_1, gear_data_notes.1, sep = ", "))%>%
  mutate(total_effort_1 = if_else(is.na(total_effort_1_unaged), total_effort_1age, total_effort_1_unaged),
         total_effort_1_units = if_else(is.na(total_effort_1_units_unaged), total_effort_1_unitsage, total_effort_1_units_unaged),
         survey_type = if_else(is.na(survey_type_unaged), survey_typeage, survey_type_unaged),
         waterbody_type = if_else(is.na(waterbody_type_unaged), waterbody_typeage, waterbody_type_unaged)) %>% 
  mutate(state = "Indiana") %>% 
  select(state,
         survey_id,
         lake_name,
         lake_id,
         lat_unspec, 
         lon_unspec,
         date,
         year,
         month,
         end_date,
         survey_type,
         sampling_method,
         total_effort_1,
         total_effort_1_units,
         species_1,
         target_species,
         length_1,
         weight_1,
         length_unit_1,
         weight_unit_1,
         gear_data_notes_1,
         original_file_names,
         waterbody_type,
         age,
         aging_structure_1)
```


# IN glacial lakes and reservoirs combination 
```{r}
glimpse(in_glaciallakes)
glimpse(in_reservoir_tidy)


in_data <- bind_rows(in_glaciallakes, in_reservoir_tidy)
glimpse(in_data)

in_data %>% 
  summarise(n_distinct(lake_id))
#240 distinct lakes 

in_data %>% 
  distinct(lake_id, lake_name, county) %>% 
  group_by(lake_id) %>% 
  count() %>% 
  filter(n > 1)
#there are some aged fish that have na lake level info - this info could be filled from other surveys in the data
agency_list <- in_lake_id_list_1Dec2023

difference_check <- agency_list %>%
  group_by(lake_id) %>%
  filter(n_distinct(county) > 1 | n_distinct(lake_name.1) > 1) %>%
  summarize(
    county_values = paste(unique(county), collapse = ", "),
    lake_name_values = paste(unique(lake_name.1), collapse = ", "),
    difference_source = case_when(
      n_distinct(county) > 1 & n_distinct(lake_name.1) > 1 ~ "county, lake_name",
      n_distinct(county) > 1 ~ "county",
      n_distinct(lake_name.1) > 1 ~ "lake_name",
      TRUE ~ "no_difference"
    )
  ) %>%
  ungroup()
#this shows where the differences arise in the values - some can easily be fix... others look more challenging
rm(difference_check)

#this code combines places where there were differences
agency_list <- agency_list %>%
  group_by(lake_id) %>%
  mutate(
    county = if(n() > 1) paste(unique(county), collapse = ", ") else county,
    lake_name.1 = if(n() > 1) paste(unique(lake_name.1), collapse = ", ") else lake_name.1
  ) %>%
  distinct(lake_id, .keep_all = TRUE) %>%
  ungroup()


#lets start with gathering some lake info from the agency provided data frame
#this gathers a list of distinct lake ids in the fish data and truncates the agency provided list to those lakes
#there are some lakes with NA lakes ids and there is a lake with a blank lake id - this stems from the aged fished data 
agency_list <- in_data %>% 
  distinct(lake_id) %>% 
  left_join(agency_list, relationship = "one-to-one") %>% 
  filter(!is.na(lake_name.1)) %>% 
  rename(lake_name = lake_name.1) %>% 
  select(lake_id,
         lake_name,
         lat_unspec,
         lon_unspec,
         c_lakesize,
         c_lakesize_units,
         county) 

in_data_prep <- in_data %>% 
  left_join(agency_list, by = "lake_id", relationship = "many-to-one", suffix = c("_fish", "_xwalk")) %>% 
  #I want to return the values from the agency crosswalk for all cases expect where it was na or the value was blank
  mutate(lake_name = case_when(!is.na(lake_name_fish) & !is.na(lake_name_xwalk) ~ lake_name_xwalk,
                               is.na(lake_name_fish) & !is.na(lake_name_xwalk) ~ lake_name_xwalk,
                               !is.na(lake_name_fish) & is.na(lake_name_xwalk) ~ lake_name_fish,
                               TRUE ~ lake_name_fish),
         #this takes the xwalk lat/lon when it is available, fish when that is the only one available, or returns NA
         lat_unspec = case_when(!is.na(lat_unspec_fish) & !is.na(lat_unspec_xwalk) ~ lat_unspec_xwalk,
                                is.na(lat_unspec_fish) & !is.na(lat_unspec_xwalk) ~ lat_unspec_xwalk,
                                !is.na(lat_unspec_fish) & is.na(lat_unspec_xwalk) ~ lat_unspec_fish,
                               TRUE ~ lat_unspec_fish),
         lon_unspec = case_when(!is.na(lon_unspec_fish) & !is.na(lon_unspec_xwalk) ~ lon_unspec_xwalk,
                                is.na(lon_unspec_fish) & !is.na(lon_unspec_xwalk) ~ lon_unspec_xwalk,
                                !is.na(lon_unspec_fish) & is.na(lon_unspec_xwalk) ~ lon_unspec_fish,
                               TRUE ~ lon_unspec_fish),
         county = case_when(!is.na(county_fish) & !is.na(county_xwalk) ~ county_xwalk,
                            is.na(county_fish) & !is.na(county_xwalk) ~ county_xwalk,
                            !is.na(county_fish) & is.na(county_xwalk) ~ county_fish,
                            TRUE ~ county_fish)) %>% 
  #fixing some lake_ids that are NA but exist in the data 
  #Otter Pit does not have a lake_id and does not have survey level info in the effort file or xwalk
  mutate(lake_id = case_when(is.na(lake_id) & lake_name == "Dogwood" ~ "{308B61DE-4327-42F6-A8BE-756095FBB6DC}",
                             is.na(lake_id) & lake_name == "Cagle's Mill" ~ "{F73E8404-5E7F-46BA-AF42-7D1A8CC3857F}",
                             is.na(lake_id) & lake_name == "Hardy" ~ "{848DF53F-3372-43B2-94E9-5757A525B3CD}",
                             TRUE ~ lake_id)) %>% 
  #based on lat and lon and resources from IN fish and wildlife I can provide mroe detail on Otter Pit
  mutate(county = case_when(lake_name == "Otter Pit" ~ "Warrick",
         TRUE ~ county),
         lake_id = case_when(lake_name == "Otter Pit" ~ NA,
                             TRUE ~ lake_id)) %>%  
  group_by(lake_id) %>% 
  fill(state, county, waterbody_type, lat_unspec, lon_unspec, c_lakesize, c_lakesize_units, .direction = "downup") %>% 
  ungroup()

in_data_prep %>% 
  group_by(lake_name, lake_name_fish, lake_name_xwalk) %>% 
  count() %>% 
  print(n = nrow(.))

in_data_prep %>% 
  group_by(county, county_fish, county_xwalk) %>% 
  count() %>% 
  print(n = nrow(.))

in_data_prep %>% 
  group_by(state) %>% 
  count()

in_data_prep %>% 
  filter(lake_name == "Otter Pit") %>% 
  glimpse()

in_data_prep %>% 
  distinct(lake_id, .keep_all = T) %>% 
  group_by(is.na(lat_unspec), is.na(lon_unspec)) %>% 
  count()

in_data_prep %>% 
  distinct(lake_id, .keep_all = T) %>% 
  filter(is.na(lat_unspec) & is.na(lon_unspec)) %>% 
  select(lake_id, lake_name, waterbody_type, survey_type) %>% 
  arrange(lake_id) %>% 
  print(n = nrow(.)) 


#sweet, we only have 26 lakes that currently don't have a lat and lon. We will probs be able to picks some more up with the msu xwalk too

#updated crosswalk from msu team
msu_crosswalk <- read_csv("MGLP_FISH_LAKES_12Aug24.csv") %>% 
  filter(STATE == "IN") %>% 
  rename(lake_id = STATE_ID) %>% 
  distinct(lake_id,
         LAT,
         LON,
         LAKE_NAME,
         NHDHR_ID,
         COUNTY)


msu_crosswalk %>% 
  group_by(lake_id) %>% 
  filter(n_distinct(LAT) > 1 | n_distinct(LON) > 1) %>% 
  mutate(LON = as.character(LON),
         LAT = as.character(LAT)) %>% 
  print(n = nrow(.))
#some lakes have more than one record in the xwalk due to rounding in a lat/lon
#since there is no big difference, I am just going to take the first record of each one

msu_crosswalk <- msu_crosswalk %>% 
  distinct(lake_id, .keep_all = T)


in_data_prep <- in_data_prep %>% 
  left_join(msu_crosswalk, by = c("lake_id"), relationship = "many-to-one") %>% 
  mutate(lat_unspec = case_when(is.na(lat_unspec) ~ LAT,
                                TRUE ~ lat_unspec),
         lon_unspec = case_when(is.na(lon_unspec) ~ LON,
                                TRUE ~ lon_unspec),
         county = case_when(is.na(county) ~ COUNTY,
                            TRUE ~ county),
         lake_name = case_when(is.na(lake_name) ~ LAKE_NAME,
                            TRUE ~ lake_name)) %>% 
  rename(nhdhr_id = NHDHR_ID)

in_data_prep %>% 
  distinct(lake_id, lat_unspec, lon_unspec, nhdhr_id) %>% 
  group_by(is.na(lat_unspec), is.na(lon_unspec), is.na(nhdhr_id)) %>% 
  count()
#pretty sweet, this shows that there is only one lake that we don't have coordinates for
#also shows that there are only 7 lakes without an nhdhr

in_data_prep %>% 
  filter(is.na(lat_unspec), is.na(lon_unspec), is.na(nhdhr_id)) %>% 
  glimpse()
#Ball lake in Steuben county - just going to leave it for now

#now pulling centroids from USGS
#lat and lon info coming from usgs data repo (https://www.sciencebase.gov/catalog/item/6206d3c2d34ec05caca53071) lake metadata file
lat_lon_usgs <- read_csv("lake_metadata.csv") %>% 
  filter(state == "IN") %>% 
  select(site_id,
         centroid_lon,
         centroid_lat) %>% 
  rename(nhdhr_id = site_id)

in_data_prep <- in_data_prep %>% 
  #adds lats/lons to data using nhdid
  left_join(lat_lon_usgs, "nhdhr_id") %>%
  #not all lakes have nhdids and/or there is no usgs lat/lon for them
  #here we take the usgs centroid where it exists and fill the lakes that do not have that data with survey level info from the agency 
  mutate(latitude_lake_centroid = lat_unspec,
         longitude_lake_centroid = lon_unspec,
         latitude_lake_centroid = case_when(is.na(latitude_lake_centroid) ~ centroid_lon,
                                            TRUE ~ latitude_lake_centroid),
         longitude_lake_centroid = case_when(is.na(longitude_lake_centroid) ~ centroid_lon,
                                             TRUE ~ longitude_lake_centroid))

coord_check <- in_data_prep %>% 
  distinct(lake_id, .keep_all = T) %>% 
  select(lake_id, lake_name, nhdhr_id, LAT, centroid_lat, LON, centroid_lon) %>% 
  mutate(diff_lat = abs(LAT - centroid_lat),
         diff_lon = abs(LON - centroid_lon))
rm(coord_check)
#looks like all msu nhdids match lats and lons with usgs meta data (expected but a good gut check)
```


# tidy both of the together
```{r}
glimpse(in_data_prep)

#gear xwalk
gear_xwalk <- read_csv("gears_by_state.csv") %>% 
  filter(state == "Indiana") %>% 
  rename(sampling_method_agency = gear_1) %>% 
  select(sampling_method_agency,
         sampling_method_simple,
         sampling_method_1,
         sampling_method_2)

in_data_prep <- in_data_prep %>% 
  rename(sampling_method_agency = sampling_method) %>% 
  left_join(gear_xwalk, by = "sampling_method_agency", relationship = "many-to-one")
#the gill nets from res and glacial lakes have slightly different dimensions (sampling method 2)


in_data <- in_data_prep %>%
  rename(sampling_method = sampling_method_1) %>% 
  #creates total effort identification 
  group_by(lake_id, year, survey_type, sampling_method, waterbody_type)%>%
  mutate(survey_effort = sum(total_effort_1),
         total_effort_ident = cur_group_id())%>%
  ungroup() %>% 
  #fixing species if it hasn't been already
  mutate(species_1 = str_to_lower(species_1))%>%
  mutate(species_1 = str_replace(species_1, " ", "_"))%>%
  #creating nothing caught column
  mutate(nothing_caught = if_else(is.na(species_1), T, F))%>%
  #this is probs already done, but makeing sure all records have a year and month
  mutate(month = case_when(!is.na(date) ~ month(date),
                           TRUE ~ month),
         year = case_when(!is.na(date) ~ year(date),
                          TRUE ~ year)) %>% 
  #units were applied to whole columns, lets make sure we only have units where there are values
  mutate(length_unit_1 = case_when(!is.na(length_1) ~ length_unit_1,
                                   TRUE ~ NA),
         weight_unit_1 = case_when(!is.na(weight_1) ~ weight_unit_1,
                                   TRUE ~ NA)) %>% 
  #adding in some basic flags 
  group_by(sampling_method) %>% 
  mutate(mean_effort = mean(total_effort_1, na.rm = TRUE),
         sd_effort = sd(total_effort_1, na.rm = TRUE),
         z_score = (total_effort_1 - mean_effort) / sd_effort,
    flag = case_when(total_effort_1 <= 0 ~ "invalid effort (zero or negative)",
                     z_score > 10 ~ "high effort",
                     TRUE ~ flag)) %>% 
  ungroup() %>% 
  #cleaning up lake size units
  mutate(lakesize_units = case_when(c_lakesize_units == "col_name_SurfaceAcres" ~ "surface_acres",
                                    TRUE ~ c_lakesize_units)) %>% 
  #making sure we have created all columns for the hive
  mutate(date_survey = as.IDate(date),
         date_total_effort_ident = as.IDate(date),
         date_sub_effort_ident = as.Date(NA),
         date_sample = as.Date(NA),
         survey_id = as.character(survey_id),
         survey_type_2 = as.character(NA),
         survey_type_3 = as.character(NA),
         survey_type_4 = as.character(NA),
         gear_data_notes = gear_data_notes_1,
         target_species_2 = as.character(NA),
         total_effort_ident = as.character(total_effort_ident),
         total_effort_2 = as.numeric(NA),
         total_effort_3 = as.numeric(NA),
         total_effort_2_units = as.character(NA),
         total_effort_3_units = as.character(NA),
         total_effort_nothing_caught = nothing_caught,
         water_temp = as.numeric(NA),
         water_temp_units = as.character(NA),
         water_clarity = as.numeric(NA),
         water_clarity_units = as.character(NA),
         lat_start = as.numeric(NA),
         lat_end = as.numeric(NA),
         lon_start = as.numeric(NA),
         lon_end = as.numeric(NA),
         site_id = as.character(NA),
         sub_effort_ident = as.character(NA),
         sub_effort_1 = as.numeric(NA),
         sub_effort_1_units = as.character(NA),
         sub_effort_2 = as.numeric(NA),
         sub_effort_2_units = as.character(NA),
         sub_effort_nothing_caught = as.logical(NA),
         length_bin = as.character(NA),
         length_bin_unit = as.character(NA),
         aging_structure_2 = as.character(NA),
         batch_weight = as.character(NA),
         batch_weight_unit = as.character(NA),
         age_class = as.character(NA),
         sex = as.character(NA),
         ind_fish_ident = as.character(NA),
         lakesize = c_lakesize,
         area_group = as.character(NA),
         location_notes_1 = as.character(NA),
         notes_1 = paste("end date of survey", end_date, sep = " "),
         obs_id = as.character(row_number())) %>%
  #there are two surveys that have the same sampling method survey within a lake in a year - need to fix the ident
  ## this really manifests by seeing there is more than one total effort within a total effort ident
  #for the sake of ease, I am going to assign different total effort idents for each of these
  #an argument could be made that Hardy dc night efishing in 2010 should be lumped together and have sub-effort idents
  mutate(total_effort_ident = case_when(lake_name == "Patoka" & year == "2018" & sampling_method_simple == "gill_net" ~ paste0(total_effort_ident, "-", month),
                                        lake_name == "Hardy" & year == "2010" & sampling_method_simple == "boat_electrofishing" ~ paste0(total_effort_ident, "-", month),
                                        TRUE ~ total_effort_ident)) %>% 
  select(state,
         county,
         lake_name,
         lake_id,
         nhdhr_id,
         latitude_lake_centroid,
         longitude_lake_centroid,
         date_survey,
         date_total_effort_ident,
         date_sub_effort_ident,
         date_sample,
         year,
         month,
         survey_id,
         survey_type,
         survey_type_2,
         survey_type_3,
         survey_type_4,
         sampling_method_simple,
         sampling_method,
         sampling_method_2,
         gear_data_notes,
         target_species,
         target_species_2,
         total_effort_ident,
         total_effort_1,
         total_effort_2,
         total_effort_3,
         total_effort_1_units,
         total_effort_2_units,
         total_effort_3_units,
         total_effort_nothing_caught,
         water_temp,
         water_temp_units,
         water_clarity,
         water_clarity_units,
         lat_start,
         lon_start,
         lat_end,
         lon_end,
         site_id,
         sub_effort_ident,
         sub_effort_1,
         sub_effort_1_units,
         sub_effort_2,
         sub_effort_2_units,
         sub_effort_nothing_caught,
         species_1,
         length_1,
         length_unit_1,
         length_bin,
         length_bin_unit,
         age,
         aging_structure_1,
         aging_structure_2,
         weight_1,
         weight_unit_1,
         batch_weight,
         batch_weight_unit,
         sex,
         age_class,
         flag,
         original_file_names,
         ind_fish_ident,
         lakesize,
         lakesize_units,
         area_group,
         lat_unspec,
         lon_unspec,
         waterbody_type,
         location_notes_1,
         notes_1,
         obs_id)
```


```{r}
glimpse(in_data)

#quick checks on the in file
in_data %>% 
  group_by(state) %>% 
  count()

in_data %>% 
  group_by(county) %>% 
  count() %>% 
  arrange(county) %>% 
  print(n = nrow(.))

in_data %>% 
  group_by(lake_name) %>% 
  count() %>% 
  arrange(lake_name) %>% 
  print(n = nrow(.))

in_data %>% 
  distinct(lake_id, nhdhr_id) %>% 
  group_by(is.na(nhdhr_id)) %>% 
  count()

in_data %>% 
  distinct(lake_name, lake_id) %>% 
  group_by(is.na(lake_id)) %>% 
  count()

in_data %>% 
  group_by(total_effort_ident, sampling_method) %>% 
  summarise(n_distinct(sampling_method)) %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n >1)

in_data %>% 
  group_by(total_effort_ident, total_effort_1) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n >1)

in_data %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  arrange(n) %>% 
  print(n = nrow(.))

in_data %>% 
  filter(total_effort_ident == "489") %>% 
  group_by(lake_name, sampling_method, survey_type, date_survey, species_1, total_effort_1) %>% 
  count()

in_data %>% 
  group_by(is.na(length_1), is.na(length_unit_1)) %>% 
  count()

in_data %>% 
  group_by(is.na(weight_1), is.na(weight_unit_1)) %>% 
  count()

in_data %>% 
  group_by(flag) %>% 
  count()

in_data %>% 
  group_by(aging_structure_1, is.na(age)) %>% 
  count()

in_data %>% 
  group_by(original_file_names) %>% 
  count()

in_data %>% 
  group_by(sampling_method_simple, sampling_method, sampling_method_2) %>% 
  count()

in_data %>% 
  group_by(sampling_method, total_effort_1_units) %>% 
  count()

in_data %>% 
  group_by(is.na(total_effort_1), is.na(total_effort_1_units)) %>% 
  count()

in_data %>% 
  group_by(sampling_method_simple, sampling_method, is.na(total_effort_1), total_effort_1_units) %>%
  count()
  

in_data %>% 
  filter(is.na(total_effort_1) & !is.na(total_effort_1_units)) %>% 
  group_by(waterbody_type, lake_name, survey_id, total_effort_ident) %>% 
  count()

in_data %>% 
  filter(!(!is.na(total_effort_1) & !is.na(total_effort_1_units))) %>% 
  group_by(total_effort_ident, total_effort_1, total_effort_1_units, waterbody_type, survey_type, total_effort_nothing_caught) %>% 
  count()

in_data %>% 
  filter(is.na(total_effort_1)) %>% 
  group_by(waterbody_type, survey_type, total_effort_ident, lake_name, sampling_method, date_survey, survey_id) %>% 
  count()

in_data %>% 
  filter(flag == "high effort") %>% 
  group_by(lake_name, survey_id, total_effort_1, sampling_method, survey_type, waterbody_type) %>% 
  count()

in_data %>% 
  group_by(sampling_method_simple, sampling_method, sampling_method_2) %>% 
  count()
```

Based on the exploratory code above, there are a few things to point out:
1. Based on the current total effort ident groupings, there are two lake-sampling methods that happen more than once in a year. Each sampling event has a different total effort
    -For ease, I made each sampling event its own total effort ident. There is one electrofishing survey that we could conciser making sub effort idents that populate total effort idents 
    
2. There are some records with NA effort
    -five glacial lake records that have unknown sampling methods that cannot be linked to an effort
    -some aged fish records that do not match with effort records 
       -this is caused by a few different things: no effort reported, no effort reported for the given sampling method
       -this leads to most survey level info disappearing - since there is a survey_id perhaps I can pull from that?
       
3. effort flag
    -it is currently based on fish obs level effort (surveys with more fish have more weight) need to fix but was struggling to figure out
    -one high effort survey was an aged fish survey with 26 net nights of effort (Otter Pit)

4. There were some differences in lakes names and counties between each aggregation file and the master agency id file
  -in short where there were multiple listing for a lake id in the agency xwalk, I pasted lake name and county values together
  -I prioritized using the values from the xwalk


Make IN Parquet
```{r}
in_hive <- as_arrow_table(in_data)
write_dataset(dataset = in_data, path = "Data_and_Scripts/Data/output/in_file_arrow")
```


# Old code for record
```{r}
in_lake_id_list_1Dec2023_fixed <- in_lake_id_list_1Dec2023 %>%
  mutate(county = str_to_title(county))%>%
  mutate(county_lower = str_to_lower(county))%>%
  mutate(lake_name.1 = str_remove(lake_name.1, county))%>%
  mutate(lake_name.1 = str_remove(lake_name.1, county_lower))%>%
  mutate(lake_name.1 = str_remove_all(lake_name.1, "-"))%>%
  mutate(lake_name.1 = str_replace(lake_name.1, " \\(\\)", ""))%>%
  mutate(county = str_to_lower(county))%>%
  select(lake_id, lake_name.1, county)%>%
  mutate(county = str_replace(county, " ", ""))%>%
  mutate(county = if_else(county == "st.joseph", "st. joseph", county))%>%
  mutate(lake_name.1 = case_when(lake_name.1 == "LakeoftheWoods" ~ "Lake of the Woods",
                                 lake_name.1 == "Little Long" & county == "noble" ~ "Little Long (Noble)",
                                 lake_name.1 == "Little Long" & county == "steuben" ~ "Little Long (Steuben)",
                                 lake_name.1 == "Pretty" & county == "marshall" ~ "Pretty (Marshall)",
                                 lake_name.1 == "TroyCedar" & county == "whitley" ~ "Troy-Cedar",
                                 lake_name.1 == "Round (Clear)" ~ "Round(Clear)",
                                 lake_name.1 == "Crooked (/Whitley)" ~ "Crooked (Noble/Whitley)",
                                 .default = lake_name.1))%>%
  distinct() #can probably remove this step and just use the one lake ID file

rm(in_lake_id_list_1Dec2023) #can remove as we don't need it any more



in_effort_prob_list <- in_glaciallakes_effort_6Oct2021_2 %>%
  left_join(in_lake_id_list_1Dec2023_fixed, by = c("lake_name.1", "county"))%>%
  select(lake_id, lake_name.1, county, year, sampling_method, date_recieved, original_file_name.1, targeted_or_standard)%>%
  distinct()%>%
  filter(is.na(lake_id)) # only two problems: Loon and Tamarack in Noble County #can probably remove


in_effort_prob_list2 <- in_glaciallakes_effort_6Oct2021_2 %>%
  mutate(county = str_to_title(county))%>%
  mutate(county = case_when(lake_name.1 == "Crooked" & county == "Noble/Whitley" ~ "Noble",
                            county == "Laporte" ~ "LaPorte",
                            county == "Dekalb" ~ "DeKalb",
                            .default = county))%>%
  left_join(in_lake_id_nhd_id_7Feb2024, by = c("lake_name.1" = "lake_name", "county"= "county"))%>%
  select(state_id, lake_name.1, county, year, sampling_method, date_recieved, original_file_name.1, targeted_or_standard)%>%
  distinct()%>%
  filter(is.na(state_id)) #this works!


in_fish_prob_list <- in_glaciallakes_fish_6Oct2021_2 %>%
  select(lake_name.1, county, year)%>%
  distinct()%>%
  left_join(in_lake_id_list_1Dec2023_fixed, by = c("lake_name.1", "county"))%>%
  filter(is.na(lake_id)) # only probs are loon and tamarack (just like in effort)

in_fish_prob_list2 <- in_glaciallakes_fish_6Oct2021_2 %>%
  select(lake_name.1, county, year)%>%
  mutate(county = str_to_title(county))%>%
  mutate(county = case_when(county == "Laporte" ~ "LaPorte",
                            county == "Dekalb" ~ "DeKalb",
                            .default = county))%>%
  mutate(lake_name.1 = if_else(lake_name.1 == "Crooked (Noble/Whitley)", "Crooked", lake_name.1))%>%
  distinct()%>%
  left_join(in_lake_id_nhd_id_7Feb2024, by = c("lake_name.1" = "lake_name", "county" = "county"))%>%
  filter(is.na(state_id)) # only probs are loon and tamarack (just like in effort)


# THIS ISSUE HAS BEEN RESOLVED
IN_GL_targeted_LMB <- in_glaciallakes_targeted_fish_16Nov2023 %>%
  filter(species.1 == "Largemouth Bass")%>%
  mutate(LMB = "Y")%>%
  select(1:5, 19) #13305 fish out of 13717

IN_GL_targeted_CIS <- in_glaciallakes_targeted_fish_16Nov2023 %>%
  filter(species.1 == "Cisco")%>%
  mutate(Cisco = "Y")%>%
  select(1:5, 19) #412

IN_GL_targeted_gear_check <- in_glaciallakes_targeted_fish_16Nov2023 %>%
  select(1:5)%>%
  group_by(lake_id, species.1)%>%
  summarise(Total_Catch = n())%>%
  pivot_wider(names_from = species.1, values_from = Total_Catch)

IN_GL_targeted_gear_check2 <- in_glaciallakes_targeted_effort_16Nov2023_2%>%
  select(1:8)%>%
  pivot_wider(names_from = sampling_method, values_from = year) #gill nets and EF not done in same survey. Different lakes sample with GN


IN_GL_targeted_GN <- in_glaciallakes_targeted_effort_16Nov2023_2 %>%
  filter(sampling_method == "experimental gill net")%>%
  select(1:8)

IN_GL_targeted_merge_check <- in_glaciallakes_targeted_fish_16Nov2023 %>%
  filter(species.1 == "Cisco")%>% 
  select(1:5)%>%
  left_join(IN_GL_targeted_GN, by = "lake_id")

IN_targeted_same_year <- in_glaciallakes_targeted_effort_16Nov2023_2 %>%
  group_by(year, lake_id)%>%
  summarise(total = n()) #no cases of more than one targeted survey happening on the same lake in the same year

in_GL_std_effort <- in_glaciallakes_effort_6Oct2021_ID %>%
  group_by(lake_name.1, county)%>%
  summarise(Total = n()) #129 lakes

in_GL_std_effort2 <- in_glaciallakes_effort_6Oct2021_ID %>%
  #group_by(lake_id)%>%
  summarise(Total = n()) #129

in_GL_std_fish <- in_glaciallakes_fish_6Oct2021_ID %>%
  group_by(lake_name.1, county)%>%
  summarise(Total = n()) #129, had to fix crooked lake in noble county now all is well

in_GL_std_fish2 <- in_glaciallakes_fish_6Oct2021_ID %>%
  #group_by(lake_id)%>%
  summarise(Total = n()) #129

rm(in_GL_std_effort, in_GL_std_effort2, in_GL_std_fish, in_GL_std_fish2)

##########Holly's parquet#############
parquet <- read_csv("D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/parquet_schema_13Mar2024.csv")

in_col_names <- as.data.frame(colnames(in_ALL_tidy))

# get names of parquet and current col names into vector format
parquet_v <- unlist(parquet)
in_col_names_v <- unlist(in_col_names)

#what is missing from in cols?
missing <- as.data.frame(setdiff(parquet_v, in_col_names_v))

#what exists in in that is NOT in the parquet schema and needs to be modified or removed
additional <- as.data.frame(setdiff(in_col_names_v, parquet_v))

#once additional cols are dealt with, re-check missing to determine NA columns
missing <- as.data.frame(setdiff(parquet_v, in_col_names_v))

in_hive_ready <- in_ALL_tidy %>% # CODE FROM DENVER MODIFY FOR IN
  mutate(date_survey = as.IDate(date),
         date_total_effort_ident = as.IDate(date),
         date_sub_effort_ident = as.Date(NA),
         date_sample = as.Date(NA),
         month = if_else(is.na(month), month(date), month),
         survey_type_2 = as.character(NA),
         survey_type_3 = as.character(NA),
         survey_type_4 = as.character(NA),
         gear_data_notes = gear_data_notes_1,
         target_species_2 = as.character(NA),
         total_effort_ident = as.character(total_effort_ident),
         total_effort_2 = as.numeric(NA),
         total_effort_3 = as.numeric(NA),
         total_effort_2_units = as.character(NA),
         total_effort_3_units = as.character(NA),
         total_effort_nothing_caught = nothing_caught,
         water_temp = as.numeric(NA),
         water_temp_units = as.character(NA),
         water_clarity = as.numeric(NA),
         water_clarity_units = as.character(NA),
         lat_start = as.numeric(NA),
         lat_end = as.numeric(NA),
         lon_start = as.numeric(NA),
         lon_end = as.numeric(NA),
         site_id = as.character(NA),
         sub_effort_ident = as.character(NA),
         sub_effort_1 = as.numeric(NA),
         sub_effort_1_units = as.character(NA),
         sub_effort_2 = as.numeric(NA),
         sub_effort_2_units = as.character(NA),
         sub_effort_nothing_caught = as.logical(NA),
         length_bin = as.character(NA),
         length_bin_unit = as.character(NA),
         aging_structure_2 = as.character(NA),
         batch_weight = as.character(NA),
         batch_weight_unit = as.character(NA),
         age_class = as.character(NA),
         sex = as.character(NA),
         ind_fish_ident = as.character(NA),
         lakesize = as.numeric(NA),
         lakesize_units = as.character(NA),
         area_group = as.character(NA),
         location_notes_1 = as.character(NA),
         notes_1 = paste("end date of survey", end_date, sep = " ")) %>% #is column 'age_id' important?
select(state,
         county,
         lake_name,
         lake_id,
         nhdhr.id,
         latitude_lake_centroid,
         longitude_lake_centroid,
         date_survey,
         date_total_effort_ident,
         date_sub_effort_ident,
         date_sample,
         year,
         month,
         survey_id,
         survey_type,
         survey_type_2,
         survey_type_3,
         survey_type_4,
         sampling_method_simple,
         sampling_method,
         sampling_method_2,
         gear_data_notes,
         target_species,
         target_species_2,
         total_effort_ident,
         total_effort_1,
         total_effort_2,
         total_effort_3,
         total_effort_1_units,
         total_effort_2_units,
         total_effort_3_units,
         total_effort_nothing_caught,
         water_temp,
         water_temp_units,
         water_clarity,
         water_clarity_units,
         lat_start,
         lon_start,
         lat_end,
         lon_end,
         site_id,
         sub_effort_ident,
         sub_effort_1,
         sub_effort_1_units,
         sub_effort_2,
         sub_effort_2_units,
         sub_effort_nothing_caught,
         species.1,
         length_1,
         length_unit_1,
         length_bin,
         length_bin_unit,
         age,
         aging_structure_1,
         aging_structure_2,
         weight_1,
         weight_unit_1,
         batch_weight,
         batch_weight_unit,
         sex,
         age_class,
         flag,
         original_file_names,
         ind_fish_ident,
         lakesize,
         lakesize_units,
         area_group,
         lat_unspec,
         lon_unspec,
         waterbody_type,
         location_notes_1,
         notes_1,
         obs_id)

# check before running select function

in_col_names2 <- as.data.frame(colnames(in_hive_ready))

# get names of parquet and current col names into vector format

in_col_names_v2 <- unlist(in_col_names2)

#what is missing from in cols?
missing2 <- as.data.frame(setdiff(parquet_v, in_col_names_v2))

#what exists in in that is NOT in the parquet schema and needs to be modified or removed
additional2 <- as.data.frame(setdiff(in_col_names_v2, parquet_v))
```

