---
title: "IN_Flat_File_Aggregation"
author: "Mike Verhoeven"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Preamble



# Issues to deal with last updated 1/30/2024

- Get age data from Matthew Linn for the IN glacial lakes




##Libraries
```{r}
library(arrow)
library(readr)
library(dplyr)
library(stringr)
library(data.table)
library(janitor)
library(tidyr)
library(lubridate)
library(bit64)

options(scipen = 999)
```


##Data
This could readily be changed into a function that takes a file path and returns files into environment.
```{r}
#generate a file list to import
files_list <- list.files(path = "D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/IN_Data/in_raw_disaggregated_data", pattern = ".+\\.csv") #grabs only.csv files
files_list



#object for use in loop (simple length of file list)
n <- length(files_list)

for(i in 1:n) {
  #i = 1
  filei <- word(gsub(".csv","", files_list[i]), start = -1, sep = fixed("/"))
  #this does those two steps in one package
  assign(filei ,
          fread(paste0("D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/IN_Data/in_raw_disaggregated_data/",
                                          files_list[i])))
  
  # if the file is a crosswalk, do not rename anything, just loop to the confirm import line
  if(str_detect(filei, "crosswalk")) {  #confirm import of files:  
    print(paste(filei ,"added to workspace" ))  
    #confirm import of files:  
    print(paste(i ,"files added to workspace" )) ; next}
  
  #if the file is not in the data explainer, don't try to rename it:
  if(filei %in% cde$new_file_name) {
    print("renaming with data explainer")
  } else {next}
  
  
  
  
  
  # note we want to review a sorted list of column names to check misspelling etc.
  # we still need to use the columns with names like col_name_length_in, or known_units
  
  
  cde %>% # call data explainer file
    filter(`new_file_name`== filei)%>% #keep only the row relevant to this file
    select_if(~ !any(is.na(.))) %>% 
    data.table::transpose(keep.names = "newname") %>% 
    rename("oldname" = V1) %>% 
    assign("names", ., envir = .GlobalEnv)
  
  #see if any column names will not have a match! 
  # IF any pop FALSE, force stop and revisit of data explainer ()
  # - e.g., named something "total catch" when actual column name was "total_catch"
  print(
    cbind(colnames(get(filei)),
          colnames(get(filei)) %in% names[ !str_detect(newname,"unique_row_key"), oldname, ]
    )
  )
  
  
  # break the loop if the current file has column names not in the data explainer
  # if (all(cbind(colnames(get(filei)),  colnames(get(filei)) %in% names[ !str_detect(newname,"unique_row_key"), oldname, ])[,2]) == FALSE ) break
  if (all(colnames(get(filei)) %in% names[ !str_detect(newname,"unique_row_key"), oldname, ]) == FALSE ) break
  
  
  # append old col names into new "notes" columns:
  get(filei)[ , (names[ str_detect(newname, "notes") , oldname   ,  ]) := Map(paste, colnames(.SD), .SD, sep = ':') , .SDcols =  names[ str_detect(newname, "notes") , oldname   ,  ] ]
  
  #now rename that file's colnames
  setnames(get(filei), colnames(get(filei)), names[!str_detect(newname,"unique_row_key")] [match(names(get(filei)),names[!str_detect(newname,"unique_row_key"),oldname]), newname] )
  
  #append all other data from data explainer
  unusedbits <- 
    data.table(
      matrix(
        rep(names[ !newname %in% colnames(get(filei)) , oldname , ],
            each = nrow(get(filei))
        ),
        nrow = nrow(get(filei)),
        dimnames = list(rep(NA,nrow(get(filei))),
                        names[ !newname %in% colnames(get(filei)) , newname , ])
        )
      )
  
  #add all not yet used columns from data explainer:
  get(filei)[ , (names[ !newname %in% colnames(get(filei)) , newname , ]) := unusedbits[] ]

  #confirm import of files:  
  print(paste(filei ,"added to workspace" ))  
  #confirm import of files:  
  print(paste(i ,"files added to workspace" )) 

  
} 
  #confirm import of files:  
  print(paste(i ,"files added to workspace" ))
  #confirm import of files:  
  print(paste(n-i ,"remaining to be added" )) 



```


#Data Review
   
```{r}
# for IN, there are data from "glacial lakes" and there are data from "reservoirs" so will work with glacial lakes, then work with reservoirs, and then combine glacial lakes and reservoirs to make a single IN file

#re-check
in_glaciallakes_effort_6Oct2021[ , .N, .(lake_name.1, county)] #129 unique lakes as of looks like 132 because counties aren't spelled the same consistently


# lots of things need to be specified in order for this merge to work to get lake IDs... but there doesn't seem to be a cleaner option
```

 NOt ready to delete but likely can be deleted
clean up the IN lake ID list (FINFO) so that it will work with the fish data nicely
NOTE CAN HOPEFULLY REMOVE THIS IF NEW LAKE LIST WORKS, but for now we are keeping and using new list to add nhd ids to all IN (glacial and reservoirs at the end)
in_lake_id_list_1Dec2023_fixed <- in_lake_id_list_1Dec2023 %>%
  mutate(county = str_to_title(county))%>%
  mutate(county_lower = str_to_lower(county))%>%
  mutate(lake_name.1 = str_remove(lake_name.1, county))%>%
  mutate(lake_name.1 = str_remove(lake_name.1, county_lower))%>%
  mutate(lake_name.1 = str_remove_all(lake_name.1, "-"))%>%
  mutate(lake_name.1 = str_replace(lake_name.1, " \\(\\)", ""))%>%
  mutate(county = str_to_lower(county))%>%
  select(lake_id, lake_name.1, county)%>%
  mutate(county = str_replace(county, " ", ""))%>%
  mutate(county = if_else(county == "st.joseph", "st. joseph", county))%>%
  mutate(lake_name.1 = case_when(lake_name.1 == "LakeoftheWoods" ~ "Lake of the Woods",
                                 lake_name.1 == "Little Long" & county == "noble" ~ "Little Long (Noble)",
                                 lake_name.1 == "Little Long" & county == "steuben" ~ "Little Long (Steuben)",
                                 lake_name.1 == "Pretty" & county == "marshall" ~ "Pretty (Marshall)",
                                 lake_name.1 == "TroyCedar" & county == "whitley" ~ "Troy-Cedar",
                                 lake_name.1 == "Round (Clear)" ~ "Round(Clear)",
                                 lake_name.1 == "Crooked (/Whitley)" ~ "Crooked (Noble/Whitley)",
                                 .default = lake_name.1))%>%
  distinct() #can probably remove this step and just use the one lake ID file

rm(in_lake_id_list_1Dec2023) #can remove as we don't need it any more



Data review continued

IN Glacial Lakes

Notes from Matthew Linn:
- TN: standard trap net (1-in mesh 45-ft lead; two rectangular 6-ft x 10-ft wire frames and four 2.5-ft diameter circular wire frames spaced 4-ft apart at the cod-end of the trap nets)
GN: experimental gill net (250 x 6 ft; five 50-ft panel sections of 0.5-in, 1-in, 1.5-in, 2-in and 2.5-in mesh sizes)
EF: Boat mounted DC nighttime electrofishing
- all surveys were completed during the month of June
- could add this info in as "gear_data_notes_1"
      * should we add this to the data..?

```{r}
in_glaciallakes_effort_6Oct2021[ , .N, .(sampling_method.1)]
# Three gears: standard trap net, experimental gill net and nighttime electrofishing
  # each gear is used in every survey. 152 surveys times 3 = 456

```

From Matthew Linn IN Glacial lakes contact: "we do the same effort for each survey (2 overnight trap lifts, 2 overnight experiment gill net lifts, and 0.5 hours of nighttime electrofishing)" - this is for standard surveys

# IN GL (glacial lakes)
unify effort units into a single column
- effort units are "overnight lifts" (net nights) and "hours"
```{r}
in_glaciallakes_effort_6Oct2021_2 <- in_glaciallakes_effort_6Oct2021 %>%
  rename(sampling_method = sampling_method.1)%>%
  mutate(effort_units = case_when(sampling_method == "Standard Trap Net" ~ "net nights",
                                  sampling_method == "Experimental Gill Net" ~ "net nights",
                                  sampling_method == "Nighttime Electrofishing" ~ "hours")) %>%
  select(-effort_units.1, -effort_units.2, -effort_units.3)%>% #remove these columns now that the info exists in "effort_units"
  mutate(sampling_method = str_to_lower(sampling_method))%>% #make sampling method consistent for std and targeted
  mutate(county = str_to_lower(county))%>%
  rename(effort_units.1 = effort_units)%>%
  relocate(lake_name.1, county, year, sampling_method, total_effort_1, effort_units.1)%>%
  mutate(targeted_or_standard = "standard")%>%
  mutate(sampling_method = if_else(sampling_method == "nighttime electrofishing", "dc nighttime electrofishing", sampling_method))
```


old checks that were done 

in_effort_prob_list <- in_glaciallakes_effort_6Oct2021_2 %>%
  left_join(in_lake_id_list_1Dec2023_fixed, by = c("lake_name.1", "county"))%>%
  select(lake_id, lake_name.1, county, year, sampling_method, date_recieved, original_file_name.1, targeted_or_standard)%>%
  distinct()%>%
  filter(is.na(lake_id)) # only two problems: Loon and Tamarack in Noble County #can probably remove


in_effort_prob_list2 <- in_glaciallakes_effort_6Oct2021_2 %>%
  mutate(county = str_to_title(county))%>%
  mutate(county = case_when(lake_name.1 == "Crooked" & county == "Noble/Whitley" ~ "Noble",
                            county == "Laporte" ~ "LaPorte",
                            county == "Dekalb" ~ "DeKalb",
                            .default = county))%>%
  left_join(in_lake_id_nhd_id_7Feb2024, by = c("lake_name.1" = "lake_name", "county"= "county"))%>%
  select(state_id, lake_name.1, county, year, sampling_method, date_recieved, original_file_name.1, targeted_or_standard)%>%
  distinct()%>%
  filter(is.na(state_id)) #this works!


# glacial lakes standard surveys

get lake ID from lake ID list
```{r}
in_glaciallakes_effort_6Oct2021_ID <- in_glaciallakes_effort_6Oct2021_2 %>%
  mutate(county = str_to_title(county))%>%
  mutate(county = case_when(lake_name.1 == "Crooked" & county == "Noble/Whitley" ~ "Noble",
                            county == "Laporte" ~ "LaPorte",
                            county == "Dekalb" ~ "DeKalb",
                            .default = county))%>%
  left_join(in_lake_id_nhd_id_7Feb2024, by = c("lake_name.1" = "lake_name", "county"= "county"))%>%
  rename(lake_id = state_id)%>%
  relocate(lake_name.1, lake_id, county, year, sampling_method, total_effort_1, effort_units.1)

#now all glacial lakes have IN state lake ID (FINFO), nhd ID and lat long if available
 
# remove data frames that we no longer need in the environment
#rm(in_glaciallakes_effort_6Oct2021)


```

prep IN GL fish data
- already one fish per row! yay!

```{r}
#will need to clean up lake names and county names for merge (need Matthew Linn's help with this)
  # instead have worked out kinks with lake ID and will use that instead for merge, counties are still a mess 

in_glaciallakes_fish_6Oct2021_2 <- in_glaciallakes_fish_6Oct2021 %>%
  rename(sampling_method = sampling_method.1)%>%
  rename(sampling_method_abbrev = sampling_method)%>% #this is an abbreviated name, make column with full name
  mutate(sampling_method = case_when(sampling_method_abbrev == "TN"~ "standard trap net",
                                  sampling_method_abbrev == "GN" ~ "experimental gill net",
                                  sampling_method_abbrev == "EF" ~ "dc nighttime electrofishing",
                                  sampling_method_abbrev == "X" ~ "unknown sampling method",
                                  .default = "unknown sampling method"))%>%
  mutate(county = str_to_lower(county))%>%
  mutate(sampling_method_abbrev = if_else(sampling_method == "unknown", NA, sampling_method_abbrev))%>% 
  relocate(lake_name.1, county, year, species.1, length.1, sampling_method, sampling_method_abbrev, targeted_or_standard)
```
old checks

in_fish_prob_list <- in_glaciallakes_fish_6Oct2021_2 %>%
  select(lake_name.1, county, year)%>%
  distinct()%>%
  left_join(in_lake_id_list_1Dec2023_fixed, by = c("lake_name.1", "county"))%>%
  filter(is.na(lake_id)) # only probs are loon and tamarack (just like in effort)

in_fish_prob_list2 <- in_glaciallakes_fish_6Oct2021_2 %>%
  select(lake_name.1, county, year)%>%
  mutate(county = str_to_title(county))%>%
  mutate(county = case_when(county == "Laporte" ~ "LaPorte",
                            county == "Dekalb" ~ "DeKalb",
                            .default = county))%>%
  mutate(lake_name.1 = if_else(lake_name.1 == "Crooked (Noble/Whitley)", "Crooked", lake_name.1))%>%
  distinct()%>%
  left_join(in_lake_id_nhd_id_7Feb2024, by = c("lake_name.1" = "lake_name", "county" = "county"))%>%
  filter(is.na(state_id)) # only probs are loon and tamarack (just like in effort)
  
```{r}
# get lake ID from FINFO lake ID list
in_glaciallakes_fish_6Oct2021_ID <- in_glaciallakes_fish_6Oct2021_2 %>%
  mutate(county = str_to_title(county))%>%
  mutate(county = case_when(county == "Laporte" ~ "LaPorte",
                            county == "Dekalb" ~ "DeKalb",
                            county == "Noble/Whitley" ~ "Noble",
                            .default = county))%>%
  mutate(lake_name.1 = if_else(lake_name.1 == "Crooked (Noble/Whitley)", "Crooked", lake_name.1))%>%
  left_join(in_lake_id_nhd_id_7Feb2024, by = c("lake_name.1" = "lake_name", "county"= "county"))%>%
  rename(lake_id = state_id)

# remove dataframes that aren't needed any more
rm(in_glaciallakes_fish_6Oct2021, in_glaciallakes_fish_6Oct2021_2)
```


```{r}
in_GL_std_effort <- in_glaciallakes_effort_6Oct2021_ID %>%
  group_by(lake_name.1, county)%>%
  summarise(Total = n()) #129 lakes

in_GL_std_effort2 <- in_glaciallakes_effort_6Oct2021_ID %>%
  group_by(lake_id)%>%
  summarise(Total = n()) #129

in_GL_std_fish <- in_glaciallakes_fish_6Oct2021_ID %>%
  group_by(lake_name.1, county)%>%
  summarise(Total = n()) #129, had to fix crooked lake in noble county now all is well

in_GL_std_fish2 <- in_glaciallakes_fish_6Oct2021_ID %>%
  group_by(lake_id)%>%
  summarise(Total = n()) #129
```


Merge effort and catch data
- Standard surveys for Glacial Lakes

### IN GL Standard merge

```{r}
in_glacial_lakes_standard_merge <- in_glaciallakes_fish_6Oct2021_ID %>%
  full_join(in_glaciallakes_effort_6Oct2021_ID, by = c("lake_id", "sampling_method", "year"), suffix = c(".effort", ".fish"))%>%
  relocate(lake_id,
           lake_name.1.fish,
           county.fish,
           year,
           species.1,
           length.1,
           sampling_method,
           sampling_method_abbrev,
           total_effort_1) #relocate just specifies which columns to put first


in_gl_fish_check <- in_glacial_lakes_standard_merge %>%
  group_by(sampling_method)%>%
  summarise(total = n()) # five fish don't have a sampling method

in_gl_st_effort_check <- in_glacial_lakes_standard_merge %>%
  filter(is.na(species.1)) #three surveys without any CATCH
```

tidy and finish the glacial lakes standard surveys
```{r}
  # tidy so columns match other parquet names
in_glaciallakes_standard_tidy <- in_glacial_lakes_standard_merge%>%
  mutate(waterbody_type = "Glacial Lake")%>%
  mutate(flag = case_when(length.1 == 0 ~ "length of zero",
                          county.fish != county.effort ~ "multiple counties listed",
                          sampling_method == "unknown sampling method" ~ "no sampling method provided",
                          is.na(species.1) ~ "nothing caught",
                          .default = NA))%>%
  mutate(sampling_method_2 = case_when(sampling_method == "experimental gill net" ~ "250 x 6 ft; five 50-ft panel sections of 0.5-in, 1-in, 1.5-in, 2-in and 2.5-in mesh sizes",
                                       sampling_method =="dc nighttime electrofishing" ~ "Boat mounted DC nighttime electrofishing",
                                       sampling_method == "standard trap net" ~ "1-in mesh 45-ft lead; two rectangular 6-ft x 10-ft wire frames and four 2.5-ft diameter circular wire frames spaced 4-ft apart at the cod-end of the trap nets",
                                       .default = NA))%>%
  mutate(state = "IN")%>%
  mutate(county = if_else(is.na(county.effort), county.fish, county.effort))%>% #assign a single county
  mutate(lake_name_1 = if_else(is.na(lake_name.1.fish), lake_name.1.effort, lake_name.1.fish))%>%
  mutate(nhdhr_id = if_else(is.na(nhdhr_id.effort), nhdhr_id.fish, nhdhr_id.effort))%>%
  mutate(lat = if_else(is.na(lat.effort), lat.fish, lat.effort))%>%
  mutate(lon = if_else(is.na(lon.effort), lon.fish, lon.effort))%>%
  mutate(survey_type = if_else(is.na(targeted_or_standard.effort), targeted_or_standard.fish, targeted_or_standard.effort))%>%
  mutate(length_unit_1 = "inches")%>%
  mutate(length_1 = as.numeric(length.1))%>%
  mutate(month = 6)%>%
  mutate(target_species = NA)%>%
  rename(total_effort_1_units = effort_units.1,
         species_1 = species.1,
         original_file_name_1_indivfish = original_file_name.1.fish,
         original_file_name_1_effort = original_file_name.1.effort,
         lat_unspec = lat,
         lon_unspec = lon)%>%
  mutate(original_file_names = paste(original_file_name_1_effort, original_file_name_1_indivfish, sep = ", "))%>%
  select(state,
         county,
         lake_name_1,
         lake_id,
         nhdhr_id,
         year,
         month,
         survey_type,
         sampling_method,
         sampling_method_2,
         total_effort_1,
         total_effort_1_units,
         species_1,
         target_species,
         length_1,
         length_unit_1,
         lat_unspec,
         lon_unspec,
         flag,
         original_file_names,
         waterbody_type)%>%
  rename(lake_name = lake_name_1)#there is a warning about NAs being introduced when length is made a numeric, but they should be NAs
                            #were previously "_" (a blank) (11), "-" (25), "X" (1), or "FALSE" (2)


# rm(in_glacial_lakes_effort_06Oct2021_ID, in_glaciallakes_fish_06Oct2021_ID, in_glacial_lakes_standard_merge)
```


# IN Glacial Lakes (GL) targeted surveys
```{r}
# what are the sampling methods?
in_glaciallakes_targeted_effort_16Nov2023[ , .N, .(sampling_method.1)]
  # only two gears, nighttime Electrofishing and Experimental Gill Net
#prepare data for merge

in_glaciallakes_targeted_effort_16Nov2023_2 <- in_glaciallakes_targeted_effort_16Nov2023 %>%
  rename(sampling_method = sampling_method.1)%>%
  mutate(effort_units = case_when(sampling_method == "Experimental gill net" ~ "net nights",
                                  sampling_method == "Nighttime electrofishing" ~ "hours"))%>%
  mutate(date.1 = mdy(date.1))%>%
  mutate(month = month(date.1))%>%
  mutate(year = year(date.1))%>% #make column for year to match non-targeted
  mutate(sampling_method = str_to_lower(sampling_method))%>%
  mutate(sampling_method = if_else(sampling_method == "nighttime electrofishing", "dc nighttime electrofishing", sampling_method))%>%#make sampling method consistent for std and targeted
  rename(effort_units.1 = effort_units)%>%
  mutate(date.1 = as.character(if_else(lake_name.1 == "Golden" & year == "2017", "2017-05-03", paste(as.character(date.1)))))%>%# # has mismatched survey date and fish caught date
  mutate(date.1 = as.IDate(date.1))%>%
  relocate(lake_id, lake_name.1, county, year, sampling_method, total_effort_1, effort_units.1, date.1)

in_glaciallakes_targeted_fish_16Nov2023_2 <- in_glaciallakes_targeted_fish_16Nov2023 %>%
  mutate(date.1 = mdy(date.1))%>%
  mutate(year = year(date.1))%>%
  mutate(date.1 = as.IDate(date.1))
```


- check that lake ID >= lake_name.1 and county for key columns
```{r}
in_GL_tar_effort <- in_glaciallakes_targeted_effort_16Nov2023_2 %>%
  group_by(lake_name.1, county)%>%
  summarise(Total = n()) #46 lakes

in_GL_tar_effort2 <- in_glaciallakes_targeted_effort_16Nov2023_2 %>%
  group_by(lake_id)%>%
  summarise(Total = n()) #46 lakes, looks like we can use lake ID for these surveys!
```

IN GL targeted fish data
- don't have gear listed... Matthew Linn says these are targeted surveys for LMB and cisco
- got gear added to fish length data thanks to new pull from Matthew Linn 11/16/2023
```{r}
# THIS ISSUE HAS BEEN RESOLVED
IN_GL_targeted_LMB <- in_glaciallakes_targeted_fish_16Nov2023 %>%
  filter(species.1 == "Largemouth Bass")%>%
  mutate(LMB = "Y")%>%
  select(1:5, 19) #13305 fish out of 13717

IN_GL_targeted_CIS <- in_glaciallakes_targeted_fish_16Nov2023 %>%
  filter(species.1 == "Cisco")%>%
  mutate(Cisco = "Y")%>%
  select(1:5, 19) #412

IN_GL_targeted_gear_check <- in_glaciallakes_targeted_fish_16Nov2023 %>%
  select(1:5)%>%
  group_by(lake_id, species.1)%>%
  summarise(Total_Catch = n())%>%
  pivot_wider(names_from = species.1, values_from = Total_Catch)

IN_GL_targeted_gear_check2 <- in_glaciallakes_targeted_effort_16Nov2023_2%>%
  select(1:8)%>%
  pivot_wider(names_from = sampling_method, values_from = year) #gill nets and EF not done in same survey. Different lakes sample with GN


IN_GL_targeted_GN <- in_glaciallakes_targeted_effort_16Nov2023_2 %>%
  filter(sampling_method == "experimental gill net")%>%
  select(1:8)

IN_GL_targeted_merge_check <- in_glaciallakes_targeted_fish_16Nov2023 %>%
  filter(species.1 == "Cisco")%>% 
  select(1:5)%>%
  left_join(IN_GL_targeted_GN, by = "lake_id")

IN_targeted_same_year <- in_glaciallakes_targeted_effort_16Nov2023_2 %>%
  group_by(year, lake_id)%>%
  summarise(total = n()) #no cases of more than one targeted survey happening on the same lake in the same year

```

merge IN GL targeted fish with effort
- 13,717 fish obs
- 51 survey/gear 

Check merge product for IN GL Targeted
# Merge of IN Glacial Lakes targeted surveys

- note, at one point, the dates were not matching, and we were losing 10,051 fish obs and 31 surveys. However, this seems to be resolved after making the dates IDates.

### IN GL Targeted Merge
```{r}
in_glaciallakes_targeted_full_join <- in_glaciallakes_targeted_fish_16Nov2023_2 %>%
  full_join(in_glaciallakes_targeted_effort_16Nov2023_2, by = c("lake_id", "date.1"),
             suffix = c("_catch", "_effort"))

```

quick merge checks
```{r}
#check for dates not matching
in_glaciallakes_targeted_inner_join_2 <- in_glaciallakes_targeted_fish_16Nov2023_2 %>%
  inner_join(in_glaciallakes_targeted_effort_16Nov2023_2, by = c("lake_id", "year"),
             suffix = c("_catch", "_effort"))%>%
  filter(date.1_catch != date.1_effort) #yep all the dates match now... this is good!

in_glaciallakes_targeted_inner_join_3 <- in_glaciallakes_targeted_fish_16Nov2023_2 %>%
  inner_join(in_glaciallakes_targeted_effort_16Nov2023_2, by = c("lake_id", "date.1"),
             suffix = c("_catch", "_effort")) #yes looks like everything matches now


# Okay this works now, thank goodness
in_gl_target_date_mismatch <- in_glaciallakes_targeted_fish_16Nov2023_2 %>%
  anti_join(in_glaciallakes_targeted_effort_16Nov2023_2, by = c("lake_id", "date.1")) #0
```

Tidy GL targeted surveys join and add NHD IDs
```{r}
IN_NHD_crosswalk <- in_lake_id_nhd_id_7Feb2024%>%
  select(nhdhr_id, state_id, lat, lon)%>%
  rename(lake_id = state_id,
         lat_unspec = lat,
         lon_unspec = lon)%>%
  distinct()

# clean up GL targeted surveys join
in_glaciallakes_targeted_full_join_tidy <- in_glaciallakes_targeted_full_join %>%
  mutate(flag = case_when(lake_name.1_catch != lake_name.1_effort ~ "mismatched lake names",
                           county_catch != county_effort ~ "mismatched county names",
                           lake_name.1_catch != lake_name.1_effort ~ "mismatched lake names",
                          .default = NA))%>%
  mutate(sampling_method_2 = case_when(sampling_method == "experimental gill net" ~ "250 x 6 ft; five 50-ft panel sections of 0.5-in, 1-in, 1.5-in, 2-in and 2.5-in mesh sizes",
                                       sampling_method =="dc nighttime electrofishing" ~ "Boat mounted DC nighttime electrofishing",
                                       sampling_method == "standard trap net" ~ "1-in mesh 45-ft lead; two rectangular 6-ft x 10-ft wire frames and four 2.5-ft diameter circular wire frames spaced 4-ft apart at the cod-end of the trap nets",
                                       .default = NA))%>%
  mutate(lake_name_1 = if_else(lake_name.1_catch == lake_name.1_effort, lake_name.1_catch, lake_name.1_effort))%>%
  mutate(county = if_else(county_catch == county_effort, county_catch, county_effort))%>%
  mutate(length_1 = as.numeric(length.1))%>%
  rename(state = state_catch, #rename to match other parquet files
         date_1 = date.1,
         total_effort_1_units = effort_units.1,
         species_1 = species.1,
         length_unit_1 = length_unit.1,
         year = year_catch,
         original_file_name_1_effort = original_file_name.1_effort,
         original_file_name_1_indivfish = original_file_name.1_catch)%>%
  mutate(total_effort_1_units = if_else(total_effort_1_units == "overnight lifts", "net-nights", total_effort_1_units))%>%
  mutate(date_1 = as.IDate(date_1))%>% #make date an IDate
  mutate(species_1 = str_to_lower(species_1))%>% #make species name lowercase
  mutate(species_1 = str_replace(species_1, " ", "_"))%>% #remove spaces from species name and put underscores
  mutate(survey_type = if_else(!is.na(targeted_or_standard_catch), targeted_or_standard_catch, targeted_or_standard_effort))%>%
  mutate(waterbody_type = "Glacial Lake")%>%
  mutate(target_species = species_1)%>%
  mutate(original_file_names = paste(original_file_name_1_effort, original_file_name_1_indivfish, sep = ", "))%>%
  left_join(IN_NHD_crosswalk, by = "lake_id")%>%
  select(state, 
         county, 
         lake_name_1, 
         lake_id,
         nhdhr_id,
         date_1,
         month,
         year,
         survey_type,
         sampling_method,
         sampling_method_2,
         total_effort_1,
         total_effort_1_units,
         species_1,
         target_species,
         length_1,
         length_unit_1,
         lat_unspec,
         lon_unspec,
         original_file_names,
         waterbody_type)%>%
  rename(date = date_1,
         lake_name = lake_name_1)

```


#Glacial Lakes Standard and Targeted
```{r}
in_glaciallakes <- bind_rows(in_glaciallakes_standard_tidy, in_glaciallakes_targeted_full_join_tidy)
# good as of 2/8/2024
```



#Reservoir
```{r}
################aged fish#################
#age fish
glimpse(in_reservoir_age_fish_16Aug2022)

#age effort
glimpse(in_reservoir_age_effort_16Aug2022)

###############fish community#############
#fish
glimpse(in_reservoir_fish_community_fishdata_16Aug2022)

#effort
glimpse(in_reservoir_fish_community_effort_16Aug2022)

##############targeted surveys#######################
#fish
glimpse(in_reservoir_targeted_fish_1Sep2022)

#effort
glimpse(in_reservoir_targeted_effort_1Sep2022)

#community data set has the most fish so i will start there

#collapse fish into survey level - doesn't look like I need to uncount

#effort file has lake specific info that could be useful in linking (lat/long, lake_id)

#potienal steps could be linking effort via survey id and sampling method and retaining info from the survey file

#how do lake names align?
fish.lakes <- in_reservoir_fish_community_fishdata_16Aug2022 %>% 
  group_by(survey_id, lake_name.1) %>% 
  count() %>% 
  print(n = nrow(.))

effort.lakes <- in_reservoir_fish_community_effort_16Aug2022 %>% 
  group_by(survey_id,lake_name.1) %>% 
  count() %>% 
  print(n = nrow(.))

in_reservoir_fish_community_effort_16Aug2022 %>% 
  group_by(survey_id, date.1) %>% 
  count() %>% 
  print(n=nrow(.))
#survey ids only contain one date


#lake names seem to slightly differ between the two files, but survey ids are consist
#no dates within the fish file, but if the survey ids are consist between the two files that should be okay

in_reservoir_fish_community_fishdata_16Aug2022 %>% 
  group_by(survey_id, sampling_method.1) %>% 
  count() %>% 
  print( n= nrow(.))
#multiple survey types per survey id


#how can i get sampling method within the effort file?
in_reservoir_fish_community_effort_16Aug2022 %>% 
  group_by(total_effort_1, total_effort_2, total_effort_3) %>% 
  count()
#data explainer says:
#1. total_effort_1 reports effort for electofishing
#2. total_effort_2 reports effort for gill netting
#3. total_effort_3 reports effort for trap netting 

#will joining on survey id work alright?
in_reservoir_fish_community_fishdata_16Aug2022 %>% 
  filter(is.na(survey_id))
in_reservoir_fish_community_effort_16Aug2022 %>% 
  filter(is.na(survey_id))
#921 surveys without an id - all NAs, reads in blank rows for some reason
#raw data only shows 79 rows/surveys - not sure why it reads in more 

in_reservoir_fish_community_effort_16Aug2022 %>% 
  filter(is.na(survey_id)) %>% 
  glimpse()
```

Notes about reservoir data:
-Lake names between effort and fish files were not consistent 
-The Lake ID and date are only found int the effort file
-Given the two points above, I merged effort and fish files together using survey id and sampling method
-total effort is stored in a wide format - conversion to long format was needed
-ages that do not have a corresponding fish in the community or targeted surveys were left in the file and can be easily filtered out

Questions about the data themselves:
- For standard fish community surveys cypress lake seems to have a miss match survey id (273 and 373)
- In targeted surveys, 512 Dogwood has effort for standard trap nets but no fish are in the fish file
- Only half of the ages found partners of fish using survey id, length, weight, species, sampling method 
    -surveys that do not have any records besides age data: 373, 467, 481, 482, 483, 484, 485, 486, 487, 488, 489, 490
    -survey that have matching community record but no corresponding fish: 379
    -surveys that have a matching survey id but mismatching survey info: 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 479, 480

# IN Reservoir community effort merge
```{r}
#steps to get effort and fish together:
#1. generate sampling method for the effort file
#2. link the effort to the fish via survey id and sampling method
#3. retain or gather survey info from effort file or the lake id list

in_reservoir_fish_community_fishdata_16Aug2022 <- in_reservoir_fish_community_fishdata_16Aug2022 %>% 
  rename(sampling_method = sampling_method.1)

#generating sampling method for the effort file
in_reservoir_fish_community_effort_16Aug2022_gear <- in_reservoir_fish_community_effort_16Aug2022 %>%
  filter(!is.na(survey_id)) %>% 
  pivot_longer(cols = c(total_effort_1, total_effort_2, total_effort_3), names_to = "sampling_method", values_to = "total_effort" ) %>%  # make data longer, so that effort is in a single column
  mutate(sampling_method = case_when(sampling_method == "total_effort_1" ~ "dc nighttime electrofishing",
                                     sampling_method == "total_effort_2" ~ "gill net std exp", #diff dimensions than GN used in GL
                                     sampling_method == "total_effort_3" ~ "standard trap net"))%>% # write out sampling method
  mutate(effort_units = case_when(sampling_method == "dc nighttime electrofishing" ~ "hours",
                                  sampling_method == "gill net std exp" ~ "net nights",
                                  sampling_method == "standard trap net" ~ "net nights"))%>% # write out effort units
  relocate(survey_id, lake_name.1, lake_id, date.1, end_date, survey_type.1, sampling_method, total_effort, effort_units)%>% #bring these columns to the front 
  select(-effort_units.1, -effort_units.2, -effort_units.3)%>%
  mutate(date.1 = as.Date(date.1, "%m/%d/%y"))%>%
  mutate(date.1 = as.IDate(date.1))%>%
  mutate(year = year(date.1))%>%
  mutate(survey_type.1 = if_else(survey_type.1 == "Reservoir S&T", "standard", NA))

```

```{r}
anti.effort <- anti_join(in_reservoir_fish_community_effort_16Aug2022_gear, 
                          in_reservoir_fish_community_fishdata_16Aug2022, 
                          by = c("survey_id", "sampling_method"))

anti.fish <- anti_join(in_reservoir_fish_community_fishdata_16Aug2022,
                       in_reservoir_fish_community_effort_16Aug2022_gear,
                       by = c("survey_id", "sampling_method"))
#this shows a mismatch in survey ids at cypress lake between the effort and fish data
#there was a difference in the sampling method spelling for a few records at Summit
#fish data must be fixed to insure they join together 
```

```{r}
#prepping fish data for merge
in_reservoir_fish_community_fishdata_16Aug2022_prep <- in_reservoir_fish_community_fishdata_16Aug2022 %>%
  mutate(sampling_method = case_when(sampling_method == "Gill net STB exp" ~ "gill net std exp",
                                     sampling_method == "Gill net std exp" ~ "gill net std exp",
                                     sampling_method == "Trap net std" ~ "standard trap net",
                                     sampling_method == "Night EF" ~ "dc nighttime electrofishing",
                                     TRUE ~ sampling_method))  %>% #sampling method difference for a few records of fish
  mutate(survey_id = case_when((survey_id == 373 & lake_name.1 == "Cypress Lake") ~ 273,
                               TRUE ~ survey_id)) #difference in survey id at cypress lake
```

### IN Reservoir Community Merge
```{r}
in.community <- inner_join(in_reservoir_fish_community_effort_16Aug2022_gear, 
                          in_reservoir_fish_community_fishdata_16Aug2022_prep, 
                          by = c("survey_id", "sampling_method")) %>%
  mutate(original_file_names = paste(original_file_name.1.x, original_file_name.1.y, sep = ", "))%>%
  mutate(sampling_method_2 = case_when(sampling_method == "gill net std exp" ~ "250-ft x 6-ft, with 5 successive 50-ft panels including one panel of each: ¾ in., 1 in., 1-1/4 in., 1-1/2in., and 2 in square mesh ",
                                       sampling_method =="dc nighttime electrofishing" ~ "Boat mounted DC nighttime electrofishing",
                                       sampling_method == "standard trap net" ~ "1-in mesh 45-ft lead; two rectangular 6-ft x 10-ft wire frames and four 2.5-ft diameter circular wire frames spaced 4-ft apart at the cod-end of the trap nets",
                                       .default = NA))%>%
  mutate(target_species = NA)%>%
  select(state.x,
         survey_id,
         lake_name.1.x,
         lake_id,
         date.1,
         year,
         end_date,
         survey_type.1,
         sampling_method,
         sampling_method_2,
         total_effort,
         effort_units,
         lat_unspec,
         lon_unspec,
         species.1,
         target_species,
         length.1,
         weight.1,
         length_unit.1,
         weight_unit.1,
         gear_data_notes.1,
         original_file_names) %>% 
  rename(state = state.x,
         lake_name.1 = lake_name.1.x,
         survey_type = survey_type.1)
```

#IN Reservoir targeted surveys

```{r}
in_reservoir_targeted_effort_1Sep2022_gear <- in_reservoir_targeted_effort_1Sep2022 %>% 
  filter(!is.na(survey_id)) %>% 
  pivot_longer(cols = c(total_effort_1, total_effort_2, total_effort_3, total_effort_4, total_effort_5), names_to = "sampling_method", values_to = "total_effort" ) %>% 
  mutate(sampling_method = case_when(sampling_method == "total_effort_1" ~ "dc nighttime electrofishing",
                                     sampling_method == "total_effort_2" ~ "gill net std exp",
                                     sampling_method == "total_effort_3" ~ "standard trap net",
                                     sampling_method == "total_effort_4" ~ "Michigan trap net",
                                     sampling_method == "total_effort_5" ~ "large-mesh GN"))%>% # write out sampling method
  mutate(effort_units = case_when(sampling_method == "dc nighttime electrofishing" ~ "hours",
                                  sampling_method == "gill net std exp" ~ "net nights",
                                  sampling_method == "standard trap net" ~ "net nights",
                                  sampling_method == "Michigan trap net" ~ "net nights",
                                  sampling_method == "large-mesh GN" ~ "net nights")) %>% 
  relocate(survey_id, lake_name.1, lake_id, date.1, end_date, survey_type.1, sampling_method, total_effort, effort_units)%>% #bring these columns to the front 
  select(-effort_units.1, -effort_units.2, -effort_units.3, -effort_units.4, -effort_units.5) %>% 
  filter(!is.na(total_effort))%>%
  mutate(date.1 = as.Date(date.1, "%m/%d/%y"))%>%
  mutate(date.1 = as.IDate(date.1))%>%
  mutate(year = year(date.1))%>%
  mutate(survey_type.1 = str_to_lower(survey_type.1))
```

```{r}
in_reservoir_targeted_fish_1Sep2022_2 <- in_reservoir_targeted_fish_1Sep2022 %>%
  rename(sampling_method = sampling_method.1) #rename so anti joins can work for checks

anti.effort <- anti_join(in_reservoir_targeted_effort_1Sep2022_gear, 
                         in_reservoir_targeted_fish_1Sep2022_2, 
                          by = c("survey_id", "sampling_method"))

anti.fish <- anti_join(in_reservoir_targeted_fish_1Sep2022_2,
                       in_reservoir_targeted_effort_1Sep2022_gear,
                       by = c("survey_id", "sampling_method"))

anti.fish %>% 
  group_by(survey_id, lake_name.1, sampling_method) %>% 
  count()

in_reservoir_targeted_fish_1Sep2022_2 %>% 
  filter(is.na(survey_id)) %>% 
  group_by(lake_name.1, species.1, length.1) %>% 
  count()
#no fish records in 512 for the standard trap effort - all fish are are a MITN... is it really nothing caught with 35 nets?
#200 records that have everything as just na - similar to what I have been seeing in the effort data
```

```{r}
#prepping fish data for merge
in_reservoir_targeted_fish_1Sep2022_prep <- in_reservoir_targeted_fish_1Sep2022 %>% 
  filter(!is.na(survey_id))%>%
  rename(sampling_method = sampling_method.1)%>%
  mutate(sampling_method = case_when(sampling_method == "Night EF" ~ "dc nighttime electrofishing",
                                     sampling_method == "Gill net std exp" ~ "gill net std exp",
                                     sampling_method == "Trap net std" ~ "standard trap net",
                                     sampling_method == "MITN" ~ "Michigan trap net",
                                     sampling_method == "Large-mesh GN" ~ "large-mesh GN"))
```

### IN reservoir targeted merge
```{r}
in.targeted <- inner_join(in_reservoir_targeted_effort_1Sep2022_gear, 
                          in_reservoir_targeted_fish_1Sep2022_prep, 
                          by = c("survey_id", "sampling_method")) %>%
  mutate(original_file_names = paste(original_file_name.1.x, original_file_name.1.y, sep = ", "))%>%
  mutate(sampling_method_2 = case_when(sampling_method == "dc nighttime electrofishing" ~ "Boat mounted DC nighttime electrofishing",
                                  sampling_method == "gill net std exp" ~ "250-ft x 6-ft, with 5 successive 50-ft panels including one panel of each: ¾ in., 1 in., 1-1/4 in., 1-1/2in., and 2 in square mesh ",
                                  sampling_method == "standard trap net" ~ "1-in mesh 45-ft lead; two rectangular 6-ft x 10-ft wire frames and four 2.5-ft diameter circular wire frames spaced 4-ft apart at the cod-end of the trap nets",
                                  sampling_method == "Michigan trap net" ~ "MIchigan trap net",
                                  sampling_method == "large-mesh GN" ~ "250-ft x 6-ft, with 2.25-in bar mesh"))%>%
  select(state.x,
         survey_id,
         lake_name.1.x,
         lake_id,
         date.1,
         year,
         end_date,
         survey_type.1,
         sampling_method,
         sampling_method_2,
         total_effort,
         effort_units,
         lat_unspec,
         lon_unspec,
         species.1,
         length.1,
         weight.1,
         length_unit.1,
         weight_unit.1,
         gear_data_notes.1,
         original_file_names) %>% 
    rename(state = state.x,
          lake_name.1 = lake_name.1.x,
          survey_type = survey_type.1)
```

What exactly are the targeted surveys using for gears and what species are they targeting?
```{r}
library(ggplot2)
in_targeted_res_plot <- ggplot(data = in.targeted, aes(x = species.1))+
  geom_bar()+
  facet_wrap(.~sampling_method)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

in_targeted_res_plot

in_targeted_res_sp <- in.targeted %>%
  group_by(sampling_method, species.1)%>%
  summarise(total = n()) # all gears are used in targeted surveys and several species are targeted

in_targeted_res_survey <- in.targeted %>%
  group_by(survey_id, sampling_method, species.1)%>%
  summarise(total = n()) #usually only one targeted gear per survey, but 520 has standard TN and MITN, and 521, 538

in_targeted_species <- in.targeted %>%
  group_by(survey_id, sampling_method, species.1)%>%
  summarise(total = n())%>%
  mutate(target_species = str_flatten(species.1, collapse=", "))%>%
  select(survey_id, sampling_method, species.1, target_species) #list of what species each survey is targeting to join
```

add target species column to IN Reservoirs targeted surveys
```{r}
in_res_targeted <- in.targeted %>%
  left_join(in_targeted_species, by = c("survey_id", "sampling_method", "species.1"))
```



### combining reservoir targeted and community surveys
```{r}
in_reservoir_data_noage <- bind_rows(in.community, in_res_targeted)
```

### clean in reservoir data (targeted and community), no age
#### get nhd IDs for reservoirs
```{r}
IN_NHD_crosswalk_2 <- in_lake_id_nhd_id_7Feb2024 %>%
  select(nhdhr_id, state_id, lat, lon, county)%>%
  rename(lake_id = state_id,
         lat_unspec = lat,
         lon_unspec = lon)%>%
  distinct()

in_reservoir_noage_nhd <- in_reservoir_data_noage %>%
  left_join(IN_NHD_crosswalk_2, by = c("lake_id"))%>%
  mutate(lat_unspec = if_else(is.na(lat_unspec.x), lat_unspec.y, lat_unspec.x))%>%
  mutate(lon_unspec = if_else(is.na(lon_unspec.x), lon_unspec.y, lon_unspec.x))%>%
  mutate(date_1 = as.IDate(date.1))%>%
  mutate(waterbody_type = "Reservoir")%>%
  mutate(month = month(date_1))%>%
  select(state,
         county,
         survey_id,
         lake_name.1,
         lake_id,
         nhdhr_id,
         date_1,
         year,
         month,
         end_date,
         survey_type,
         sampling_method,
         sampling_method_2,
         total_effort,
         effort_units,
         lat_unspec,
         lon_unspec,
         species.1,
         target_species,
         length.1,
         weight.1,
         length_unit.1,
         weight_unit.1,
         gear_data_notes.1,
         original_file_names,
         waterbody_type)%>%
  rename(lake_name = lake_name.1,
         total_effort_1 = total_effort,
         total_effort_1_units = effort_units,
         species_1 = species.1,
         date = date_1,
         length_1 = length.1,
         length_unit_1 = length_unit.1,
         weight_1 = weight.1,
         weight_unit_1 = weight_unit.1,
         gear_data_notes_1 = gear_data_notes.1)
  
```


# IN glacial lakes and reservoirs no ages 
```{r}
in_no_age <- bind_rows(in_glaciallakes, in_reservoir_noage_nhd)

```


### Tidy IN no ages
Tidy IN Data, no ages
```{r}
in_no_age_tidy <- in_no_age %>%
  relocate(state,
           county,
           lake_name,
           lake_id,
           nhdhr_id,
           date,
           year,
           survey_type,
           survey_id,
           sampling_method,
           sampling_method_2,
           total_effort_1,
           total_effort_1_units,
           species_1)%>%
  mutate(waterbody_type = if_else(is.na(waterbody_type), "Reservoir", waterbody_type))%>%
  group_by(lake_id, year, survey_type, sampling_method, waterbody_type)%>%
  mutate(survey_effort = sum(total_effort_1),
         total_effort_ident = cur_group_id())%>%
  mutate(species_1 = str_to_lower(species_1))%>%
  mutate(species_1 = str_replace(species_1, " ", "_"))%>%
  mutate(nothing_caught = if_else(is.na(species_1), T, F))%>%
  mutate(survey_id = as.character(survey_id))%>%
  mutate(date = as.IDate(date))%>%
  select(state,
         county,
         lake_name,
         lake_id,
         nhdhr_id,
         date,
         year,
         month,
         survey_id,
         survey_type,
         sampling_method,
         sampling_method_2,
         total_effort_ident,
         total_effort_1,
         total_effort_1_units,
         gear_data_notes_1,
         species_1,
         target_species,
         length_1,
         length_unit_1,
         weight_1,
         weight_unit_1,
         flag,
         original_file_names,
         nothing_caught,
         waterbody_type,
         lat_unspec,
         lon_unspec)%>%
  ungroup()%>%
  mutate(obs_id = row_number())
```

quick look at sampling methods for filtering workshop
```{r}
in_sampling_methods <- in_no_age_tidy %>%
  group_by(sampling_method, survey_type, waterbody_type)%>%
  summarise(total = n())

#write_csv(in_sampling_methods, "in_sampling_methods.csv")

in_sampling_methods_sp <- in_no_age_tidy %>%
  group_by(sampling_method, survey_type, waterbody_type, species_1)%>%
  summarise(total = n())

#write_csv(in_sampling_methods_sp, "in_sampling_methods_sp.csv")
```

# IN Age data (just reservoirs)

updated 2-9-2024
```{r}
in_reservoir_age_fish_16Aug2022 %>%
  rename(sampling_method = sampling_method.1)%>%
  group_by(sampling_method) %>%
  count()

in_reservoir_age_fish_16Aug2022 %>%
  group_by(species.1) %>%
  count()

in_reservoir_data_noage %>%
  group_by(species.1) %>%
  count() %>%
  print(n = nrow(.))

in_reservoir_age_fish_16Aug2022%>%
  group_by(sampling_method.1)%>%
  count()%>%
  print(n = nrow(.))
```
A tibble: 7 × 2
Groups:   sampling_method.1 [7]
  sampling_method.1         n
  <chr>                 <int>
1 ""                      200
2 "Gill net"              127
3 "IN Standard Net"       125
4 "Large-mesh Gill Net"   148
5 "MITN"                 1521
6 "Night EF"             3392
7 "Trap net std"          694


### prepping age data for merge

```{r}
# get survey info for aged fish
in_res_aged_effort_fish <- in_reservoir_age_effort_16Aug2022%>%
  pivot_longer(cols = c(total_effort_1, total_effort_2, total_effort_3, total_effort_4, total_effort_5), names_to = "sampling_method", values_to = "total_effort" ) %>% 
  mutate(sampling_method = case_when(sampling_method == "total_effort_1" ~ "dc nighttime electrofishing",
                                     sampling_method == "total_effort_2" ~ "gill net std exp",
                                     sampling_method == "total_effort_3" ~ "standard trap net",
                                     sampling_method == "total_effort_4" ~ "Michigan trap net",
                                     sampling_method == "total_effort_5" ~ "large-mesh GN"))%>% # write out sampling method
  mutate(effort_units = case_when(sampling_method == "dc nighttime electrofishing" ~ "hours",
                                  sampling_method == "gill net std exp" ~ "net nights",
                                  sampling_method == "standard trap net" ~ "net nights",
                                  sampling_method == "Michigan trap net" ~ "net nights",
                                  sampling_method == "large-mesh GN" ~ "net nights")) %>%
  mutate(sampling_method_2 = case_when(sampling_method == "dc nighttime electrofishing" ~ "Boat mounted DC nighttime electrofishing",
                                  sampling_method == "gill net std exp" ~ "250-ft x 6-ft, with 5 successive 50-ft panels including one panel of each: ¾ in., 1 in., 1-1/4 in., 1-1/2in., and 2 in square mesh ",
                                  sampling_method == "standard trap net" ~ "1-in mesh 45-ft lead; two rectangular 6-ft x 10-ft wire frames and four 2.5-ft diameter circular wire frames spaced 4-ft apart at the cod-end of the trap nets",
                                  sampling_method == "Michigan trap net" ~ "MIchigan trap net",
                                  sampling_method == "large-mesh GN" ~ "250-ft x 6-ft, with 2.25-in bar mesh"))%>%
  mutate(survey_id = case_when((survey_id == 373 & lake_name.1 == "Cypress Lake") ~ 273,
                               TRUE ~ survey_id))%>%
  relocate(survey_id, lake_name.1, lake_id, date.1, survey_type.1, sampling_method, total_effort, effort_units)%>%
  mutate(lake_name.1 = if_else(survey_id == 479, "Brookville", lake_name.1))%>%
  mutate(lake_id = if_else(survey_id == 479, "{733228C8-5F92-46FF-ADB1-58883B7609FB}", lake_id))%>%
  mutate(total_effort = as.character(total_effort))%>%
  mutate(total_effort = case_when(survey_id == 469 & sampling_method == "Michigan trap net"~ "unknown", 
                                  survey_id == 469 & sampling_method == "standard trap net"~ "unknown",
                                  survey_id == 473 & sampling_method == "Michigan trap net"~ "unknown",
                                  survey_id == 473 & sampling_method == "standard trap net"~ "unknown",
                                  survey_id == 479 & sampling_method == "large-mesh GN"~ "unknown",
                                  survey_id == 467 & sampling_method == "in standard net" ~ "unknown",
                                  survey_id == 468 & sampling_method == "in standard net" ~ "unknown",
                                  .default = total_effort))%>% #these surveys have no effort, but don't want them dropped because they have aged fish
  drop_na(total_effort)%>%
  mutate(total_effort = na_if(total_effort, "unknown"))%>%
  mutate(total_effort = as.numeric(total_effort))%>%
  mutate(survey_type.1 = case_when(survey_type.1 == "Reservoir S&T" ~ "standard",
                                   survey_type.1 == "Targeted Species" ~ "targeted",
                                   survey_type.1 == "Targeted" ~ "targeted",
                                   .default = NA))%>%
  rename(original_file_name_age_effort = original_file_name.1)%>%
  select(survey_id,
         lake_name.1,
         lake_id,
         date.1,
         end_date,
         survey_type.1,
         lat_unspec,
         lon_unspec,
         original_file_name_age_effort,
         sampling_method,
         sampling_method_2,
         total_effort,
         effort_units)
#%>%
 # full_join(in_reservoir_age_fish_16Aug2022, by = c("survey_id" = "survey_id", "sampling_method"= #"sampling_method.1"))
```

```{r}
in_reservoir_age_fish_16Aug2022_merge  <- in_reservoir_age_fish_16Aug2022 %>% # weird note saying it should be in_res_aged_effort_fish
  #remove fish that do not have a survey id
  filter(!is.na(survey_id)) %>%
  rename(sampling_method = sampling_method.1)%>%
  mutate(survey_id = case_when((survey_id == 373 & lake_name.1 == "Cypress Lake") ~ 273,
                               TRUE ~ survey_id))%>%
  #arrange fish in survey in a row, assign a number to them to ensure they join nicely with fish data
  arrange(survey_id, species.1, sampling_method, length.1, weight.1) %>%
  group_by(survey_id,species.1, sampling_method, length.1, weight.1) %>%
  mutate(age_id = row_number()) %>% #ask Denver about this
  ungroup() %>%
  mutate(length.1 = as.double(length.1),
         weight.1 = as.double(weight.1)) %>%
 mutate(sampling_method = case_when(sampling_method == "Night EF" ~ "dc nighttime electrofishing",
                                     sampling_method == "Gill net" ~ "gill net std exp",
                                     sampling_method == "Trap net std" ~ "standard trap net",
                                     sampling_method == "MITN" ~ "Michigan trap net",
                                     sampling_method == "Large-mesh Gill Net" ~ "large-mesh GN",
                                    sampling_method == "IN Standard Net" ~ "in standard net",
                                    .default = "unknown"))%>%
  mutate(sampling_method_2 = case_when(sampling_method == "dc nighttime electrofishing" ~ "Boat mounted DC nighttime electrofishing",
                                  sampling_method == "gill net std exp" ~ "250-ft x 6-ft, with 5 successive 50-ft panels including one panel of each: ¾ in., 1 in., 1-1/4 in., 1-1/2in., and 2 in square mesh ",
                                  sampling_method == "standard trap net" ~ "1-in mesh 45-ft lead; two rectangular 6-ft x 10-ft wire frames and four 2.5-ft diameter circular wire frames spaced 4-ft apart at the cod-end of the trap nets",
                                  sampling_method == "Michigan trap net" ~ "MIchigan trap net",
                                  sampling_method == "large-mesh GN" ~ "250-ft x 6-ft, with 2.25-in bar mesh",
                                  sampling_method == "in standard net" ~ "unknown specs",
                                  .default = NA))%>%
  mutate(species.1 = str_to_lower(species.1))%>%
  left_join(in_res_aged_effort_fish, by = c("survey_id", "sampling_method", "sampling_method_2"))%>%
  rename(lake_name = lake_name.1.x) %>%
  select(survey_id,
         lake_name,
         lake_id,
         date.1,
         end_date,
         sampling_method,
         sampling_method_2,
         species.1,
         length.1,
         weight.1,
         age_id,
         age,
         aging_structure.1,
         gear_data_notes.1,
         original_file_name.1,
         original_file_name_age_effort,
         lat_unspec,
         lon_unspec) %>%
  rename(original_file_name.1_age = original_file_name.1,
         species_1 = species.1,
         length_1 = length.1,
         weight_1 = weight.1)
#giving total data set a row number to join on

# pull in the rest of the fish data so we can have all the fish data not just aged fish
in_reservoir_data_age <- in_reservoir_noage_nhd %>%
   mutate(species_1 = str_to_lower(species_1))%>%#was in_reservoir_data_noage
  arrange(survey_id, species_1, sampling_method, length_1, weight_1) %>%
  group_by(survey_id, species_1, sampling_method, length_1, weight_1) %>%
  mutate(age_id = row_number())
#matching with community fish

# full join to keep aged fish that don't match
in_reservoir_data <- full_join(in_reservoir_data_age,
                                  in_reservoir_age_fish_16Aug2022_merge,
                                    by = c("survey_id",
                                           "sampling_method",
                                           "sampling_method_2",
                                           "species_1",
                                           "length_1",
                                           "weight_1",
                                           "age_id"))%>%
  mutate(length_unit_1 = replace_na(length_unit_1, "col_name_Length (in)"))%>% 
  mutate(weight_unit_1 = replace_na(weight_unit_1, "col_name_weight (lb)"))%>% #make sure all fish obs have units
  
  
  left_join(IN_NHD_crosswalk_2, by = c("lake_id"))
####

in_age_check1 <- in_reservoir_data_age %>%
  select(survey_id, sampling_method, species_1, length_1, weight_1, age_id) #66297

in_age_check2 <- in_reservoir_age_fish_16Aug2022_merge %>%
  select(survey_id, sampling_method, species_1, length_1, weight_1, age_id, age)%>%
  filter(!is.na(age)) #6005 fish with ages

in_age_check3 <- left_join(in_reservoir_data_age,
                                  in_reservoir_age_fish_16Aug2022_merge,
                                    by = c("survey_id",
                                           "sampling_method",
                                           "species_1",
                                           "length_1",
                                           "weight_1",
                                           "age_id")) %>%
  filter(!is.na(age)) #only #2951 fish get an age when left_join is used rest of fish don't match up
```

Clean IN reservoir data WITH AGES
```{r}
# prep data for row bind with glacial lakes
in_reservoir_tidy <- in_reservoir_data %>%
  mutate(original_file_names= paste(original_file_names, 
                                    original_file_name_age_effort, 
                                    original_file_name.1_age, sep = ", "))%>%
  mutate(date.1 = as.Date(date, "%m/%d/%y"))%>%
  mutate(date_1 = as.IDate(date))%>%
  mutate(month = month(date_1))%>%
  rename(aging_structure_1 = aging_structure.1)%>%
  mutate(lake_name = if_else(is.na(lake_name.x), lake_name.y, lake_name.x))%>%
  mutate(lake_id = if_else(is.na(lake_id.x), lake_id.y, lake_id.x))%>%
  mutate(end_date = if_else(is.na(end_date.x), end_date.y, end_date.x))%>%
  mutate(lat_unspec = if_else(is.na(lat_unspec.x), lat_unspec.y, lat_unspec.x))%>%
  mutate(lon_unspec = if_else(is.na(lon_unspec.x), lon_unspec.y, lon_unspec.x))%>%
  mutate(gear_data_notes_1= paste(gear_data_notes_1, gear_data_notes.1, sep = ", "))%>%
  select(state,
         county,
         survey_id,
         lake_name,
         lake_id,
         nhdhr_id,
         date,
         year,
         month,
         end_date,
         survey_type,
         sampling_method,
         sampling_method_2,
         total_effort_1,
         total_effort_1_units,
         species_1,
         target_species,
         length_1,
         weight_1,
         length_unit_1,
         weight_unit_1,
         gear_data_notes_1,
         original_file_names,
         waterbody_type,
         age,
         aging_structure_1,
         age_id)
```



# IN Glacial Lakes and IN Reservoirs together WITH AGES
```{r}
in_ALL <- bind_rows(in_glaciallakes, in_reservoir_tidy)

## add total effort ident and nothing caught

# make sure reservoirs are marked targeted and standard - DONE

# note, standard glacial lake surveys do not have a date, just a year

in_ALL_tidy <- in_ALL %>%
  group_by(lake_id, year, survey_type, sampling_method, waterbody_type)%>%
  mutate(survey_effort = sum(total_effort_1),
         total_effort_ident = cur_group_id())%>%
  mutate(species_1 = str_to_lower(species_1))%>%
  mutate(species_1 = str_replace(species_1, " ", "_"))%>%
  mutate(nothing_caught = if_else(is.na(species_1), T, F))%>%
  mutate(survey_id = as.character(survey_id))%>%
  select(state,
         county,
         lake_name,
         lake_id,
         nhdhr_id,
         year,
         month,
         survey_type,
         sampling_method,
         sampling_method_2,
         total_effort_1,
         total_effort_1_units,
         species_1,
         target_species,
         length_1,
         length_unit_1,
         lat_unspec,
         lon_unspec,
         flag,
         original_file_names,
         waterbody_type,
         date,
         survey_id,
         end_date,
         weight_1,
         weight_unit_1,
         gear_data_notes_1,
         age_id,
         age,
         aging_structure_1,
         total_effort_ident,
         survey_effort,
         nothing_caught)%>%
  ungroup()%>%
  mutate(obs_id = row_number())

```

Match column names in prep for hive 
```{r}
parquet <- read_csv("D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/parquet_schema_13Mar2024.csv")

in_col_names <- as.data.frame(colnames(in_ALL_tidy))

# get names of parquet and current col names into vector format
parquet_v <- unlist(parquet)
in_col_names_v <- unlist(in_col_names)

#what is missing from in cols?
missing <- as.data.frame(setdiff(parquet_v, in_col_names_v))

#what exists in in that is NOT in the parquet schema and needs to be modified or removed
additional <- as.data.frame(setdiff(in_col_names_v, parquet_v))

#once additional cols are dealt with, re-check missing to determine NA columns
missing <- as.data.frame(setdiff(parquet_v, in_col_names_v))

in_hive_ready <- in_ALL_tidy %>% # CODE FROM DENVER MODIFY FOR IN
  mutate(date_survey = as.IDate(date),
         date_total_effort_ident = as.IDate(date),
         date_sub_effort_ident = as.Date(NA),
         date_sample = as.Date(NA),
         month = if_else(is.na(month), month(date), month),
         survey_type_2 = as.character(NA),
         survey_type_3 = as.character(NA),
         survey_type_4 = as.character(NA),
         gear_data_notes = gear_data_notes_1,
         target_species_2 = as.character(NA),
         total_effort_ident = as.character(total_effort_ident),
         total_effort_2 = as.numeric(NA),
         total_effort_3 = as.numeric(NA),
         total_effort_2_units = as.character(NA),
         total_effort_3_units = as.character(NA),
         total_effort_nothing_caught = nothing_caught,
         water_temp = as.numeric(NA),
         water_temp_units = as.character(NA),
         water_clarity = as.numeric(NA),
         water_clarity_units = as.character(NA),
         lat_start = as.numeric(NA),
         lat_end = as.numeric(NA),
         lon_start = as.numeric(NA),
         lon_end = as.numeric(NA),
         site_id = as.character(NA),
         sub_effort_ident = as.character(NA),
         sub_effort_1 = as.numeric(NA),
         sub_effort_1_units = as.character(NA),
         sub_effort_2 = as.numeric(NA),
         sub_effort_2_units = as.character(NA),
         sub_effort_nothing_caught = as.logical(NA),
         length_bin = as.character(NA),
         length_bin_unit = as.character(NA),
         aging_structure_2 = as.character(NA),
         batch_weight = as.character(NA),
         batch_weight_unit = as.character(NA),
         age_class = as.character(NA),
         sex = as.character(NA),
         ind_fish_ident = as.character(NA),
         lakesize = as.numeric(NA),
         lakesize_units = as.character(NA),
         area_group = as.character(NA),
         location_notes_1 = as.character(NA),
         notes_1 = paste("end date of survey", end_date, sep = " ")) %>% #is column 'age_id' important?
  select(state,
         county,
         lake_name,
         lake_id,
         nhdhr_id,
         date_survey,
         date_total_effort_ident,
         date_sub_effort_ident,
         date_sample,
         year,
         month,
         survey_id,
         survey_type,
         survey_type_2,
         survey_type_3,
         survey_type_4,
         sampling_method,
         sampling_method_2,
         gear_data_notes,
         target_species,
         target_species_2,
         total_effort_ident,
         total_effort_1,
         total_effort_2,
         total_effort_3,
         total_effort_1_units,
         total_effort_2_units,
         total_effort_3_units,
         total_effort_nothing_caught,
         water_temp,
         water_temp_units,
         water_clarity,
         water_clarity_units,
         lat_start,
         lon_start,
         lat_end,
         lon_end,
         site_id,
         sub_effort_ident,
         sub_effort_1,
         sub_effort_1_units,
         sub_effort_2,
         sub_effort_2_units,
         sub_effort_nothing_caught,
         species_1,
         length_1,
         length_unit_1,
         length_bin,
         length_bin_unit,
         age,
         aging_structure_1,
         aging_structure_2,
         weight_1,
         weight_unit_1,
         batch_weight,
         batch_weight_unit,
         sex,
         age_class,
         flag,
         original_file_names,
         ind_fish_ident,
         lakesize,
         lakesize_units,
         area_group,
         lat_unspec,
         lon_unspec,
         waterbody_type,
         location_notes_1,
         notes_1,
         obs_id)

# check before running select function

in_col_names2 <- as.data.frame(colnames(in_hive_ready))

# get names of parquet and current col names into vector format

in_col_names_v2 <- unlist(in_col_names2)

#what is missing from in cols?
missing2 <- as.data.frame(setdiff(parquet_v, in_col_names_v2))

#what exists in in that is NOT in the parquet schema and needs to be modified or removed
additional2 <- as.data.frame(setdiff(in_col_names_v2, parquet_v))
```


Make IN Parquet
```{r}
in_no_age_tidy <- as_arrow_table(in_no_age_tidy)
write_dataset(dataset = in_no_age_tidy, path = "D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/Parquet files/in_no_age_file_arrow") #IN 

#in_ALL_tidy <- as_arrow_table(in_ALL_tidy)
#write_dataset(dataset = in_ALL_tidy, path = "D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/Parquet files/in_file_arrow")

in_hive <- as_arrow_table(in_hive_ready)
write_dataset(dataset = in_hive, path = "D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/Parquet files/in_file_arrow")
```

check and read in parquet
```{r}
library(arrow)
in_data <- open_dataset("D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/Parquet files/in_file_arrow")
glimpse(in_data)

in_data_age <- filter(!is.na(age))%>%
  collect()
```


# Making Figures with IN Data 1/29/2024
```{r}
library(ggplot2)

IN_TN <- in_no_age_tidy %>%
  filter(sampling_method %in% c("standard trap net","Michigan trap net"))%>%
  filter(species_1 %in% c("black_crappie",
                          "bluegill",
                          "cisco",
                          "largemouth_bass",
                          "northern_pike",
                          "smallmouth_bass",
                          "walleye",
                          "yellow_perch"))
  

IN_trap_nets <- ggplot(data = IN_TN, aes(x = length_1, fill = sampling_method))+
  geom_density(alpha = .5)+
  facet_wrap(.~species_1, scales = "free_x")+
  theme_classic()+
  labs(title = "Indiana Trap Nets")

IN_trap_nets
```
 sampling_method          total
  <chr>                    <int>
1 Michigan trap net         1815
2 experimental gill net     5948
3 gill net std exp         10618
4 large-mesh GN              220
5 nighttime electrofishing 95826
6 standard trap net        31512
7 unknown sampling method      5
```{r}
IN_GN <- in_no_age_tidy %>%
  filter(sampling_method %in% c("experimental gill net", "gill net std exp", "large-mesh GN"))%>%
  filter(species_1 %in% c("black_crappie",
                          "bluegill",
                          "cisco",
                          "largemouth_bass",
                          "northern_pike",
                          "smallmouth_bass",
                          "walleye",
                          "yellow_perch"))
  

IN_gill_nets <- ggplot(data = IN_GN, aes(x = length_1, fill = sampling_method))+
  geom_density(alpha = .5)+
  facet_wrap(.~species_1, scales = "free_x")+
  theme_classic()+
  labs(title = "Indiana Gill Nets")

IN_gill_nets
```

```{r}
IN_EF <- in_no_age_tidy %>%
  filter(sampling_method %in% c("nighttime electrofishing"))%>%
  filter(species_1 %in% c("black_crappie",
                          "bluegill",
                          "cisco",
                          "largemouth_bass",
                          "northern_pike",
                          "smallmouth_bass",
                          "walleye",
                          "yellow_perch"))
  

IN_electrofishing <- ggplot(data = IN_EF, aes(x = length_1))+
  geom_density(alpha = .5, fill = "gold")+
  facet_wrap(.~species_1, scales = "free_x")+
  theme_classic()+
  labs(title = "Indiana Electrofishing")

IN_electrofishing 
```

```{r}
IN_targeted <- in_no_age_tidy %>%
  filter(survey_type == "targeted")%>%
  mutate(julian_day = yday(date_1))%>%
  mutate(month = month(date_1))

IN_date <- ggplot(data = IN_targeted, aes(x = julian_day, fill = waterbody_type))+
  geom_density(alpha = .5)+
  theme_classic()+
  labs(title = "IN Targeted Surveys by Julian Day")

IN_date

IN_date2 <- ggplot(data = IN_targeted, aes(x = month, fill = waterbody_type))+
  geom_density(alpha = .5)+
  theme_classic()+
  labs(title = "IN Targeted Surveys by Month")+
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9,10,11,12))

IN_date2
```


 


# Review & QC datasets, Mike's code for MI
```{r}
#here I do some very basic checks on what the data structure and general outputs look like (i.e., s this thing behaving like the obs-level file I think it is?). MI work left here as an idea of a previous state's work. In my opinion, it is not our job to QC the actual observations at this point (like, is a WAE really going to be 500mm at age zero), but instead to use this QC as a check on the operations performed in this script.  



                        #effort per surveyXgear?
                        mi_catch_eff_merge[ , .(effort = first(total_effort_1.1_effort), units = first(effort_units.1)) ,   c("lake_name.1", "lake_id", "survey_id", "sampling_method_abbrev")]
                        
                        #effort per survey type?
                        mi_catch_eff_merge[!is.na(total_effort_1.1_effort) , .(effort = first(total_effort_1.1_effort), units = first(effort_units.1), number = .N) ,   c("lake_name.1", "lake_id", "survey_id", "sampling_method_abbrev")][ ,.(effort = sum(effort), counts = sum(number), grandCPUE = sum(number)/sum(effort)) , .(sampling_method_abbrev, units)]
                        
                        #effort per survey type (Walleye ONLY)?
                        mi_catch_eff_merge[!is.na(total_effort_1.1_effort) & species.1=="walleye" , .(effort = first(total_effort_1.1_effort), units = first(effort_units.1), number = .N) ,   c("lake_name.1", "lake_id", "survey_id", "sampling_method_abbrev")][ ,.(effort = sum(effort), counts = sum(number), grandCPUE = sum(number)/sum(effort)) , .(sampling_method_abbrev, units)]
                        
                        
                        
                        #how many Walleye in surveys where we had effort data?
                        mi_catch_eff_merge[ species.1== "walleye"  , .("n_fish" = .N) , .(sampling_method_abbrev) ][, sum(n_fish)]
                        mi_catch_eff_merge[ , .N , species.1]
                        
                        
                        #whats the effort look like?
                        mi_catch_eff_merge[ ,.N, total_effort_1.1_effort ]
                        
                        # data coverage
                        # how many surveys were we missing effort data for? One survey, 3 gears. Survey 4042 on Twin Lake
                        mi_catch_eff_merge[ is.na(total_effort_1.1_effort), .N , ]
                        mi_catch_eff_merge[ is.na(total_effort_1.1_effort), c("numberofspp" = length(unique(species.1))) , c("lake_name.1", "lake_id", "survey_id", "sampling_method_abbrev") ]
                        
                        
                        # how many surveys were we missing catch data from?
                        # how many surveys missing catchlength for?
                        mi_catch_eff_merge[ , .N, is.na(original_file_name.1_catch)]
                        mi_catch_eff_merge[ , .N, .(catchNA = is.na(original_file_name.1_catch),
                                                    catchlengthNA = is.na(original_file_name.1_catchlengths),
                                                    effortNA = is.na(original_file_name.1_effort))]
                        mi_catch_eff_merge[is.na(original_file_name.1_catch)]
                        
                        
                        
                        glimpse(mi_catch_eff_merge)
                        
                        
                        #Naming scheme updated to match overall approach:
                        
                      
                        

```


# Import/Export files

```{r}


#save to disk:

# saveRDS(mi_catch_eff_merge, file = "Data_and_Scripts\\Data\\output\\mi_flat_effort_indivfish_merge.rds")
# mi_catch_eff_merge <- readRDS(file = "Data_and_Scripts\\Data\\output\\mi_flat_effort_indivfish_merge.rds")


str(mi_catch_eff_merge)


mi_catch_eff_merge <- as_arrow_table(mi_catch_eff_merge)

write_dataset(dataset = mi_catch_eff_merge, path = "Data_and_Scripts/Data/output/mi_file_arrow")

mi_data <- open_dataset("Data_and_Scripts/Data/output/mi_file_arrow")

glimpse(mi_data)

```




