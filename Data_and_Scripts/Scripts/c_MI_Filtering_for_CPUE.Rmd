---
title: "c_MI_Filtering_for_CPUE"
author: "Denver Link"
date: "2023-10-29"
output: html_document
editor_options: 
  chunk_output_type: console
---

#Library
```{r}
library(tidyverse)
library(arrow)
```

#data
```{r}
mi_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "hive"), partitioning = c("state")) %>% 
  filter(state == "Michigan")
glimpse(mi_data)
```

Filtering steps within Michigan:
1. load in the filter table with parameters of interest
2. join the filter table based on sampling method and survey type for representative cpe
3. collect fish from the good surveys
4. count species of interest from the good surveys and calculate cpe
   -if specific individual fish level cpes (length bins) are desired they can be counted here
5. check filters and the cpe generated 

#walleye filtering 
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Michigan" & species_1 == "walleye") %>% 
  select(-metric,
         -species_1,
         -area_group,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max,
         -area_group) %>% 
  rename(sampling_method_2 = sampling_method)

good_surveys <- mi_data %>% 
  mutate(state = "Michigan") %>% 
  right_join(filter_table_effort, by = c("state",
                                         "survey_type",
                                         "sampling_method_2")) %>% 
  distinct(lake_id,
           lake_name,
           total_effort_ident,
           date_total_effort_ident,
           survey_id,
           year,
           survey_type,
           sampling_method_2,
           total_effort_1,
           effort_min,
           effort_max
#           month_min,
#           month_max
           ) %>% 
 filter(total_effort_1 >= effort_min,
        total_effort_1 <= effort_max) %>% 
#         month(date_clean) >= month_min,
#         month(date_clean) <= month_max) %>% 
  collect()

#gathering fish from good surveys
adult_walleye <- mi_data %>% 
  right_join(good_surveys) %>% 
  collect() 

#creating cpue for species of interest
adult_walleye_cpue <- adult_walleye %>% 
  #grouping by variables to get survey fish count 
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species_1 == 'walleye')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(is.na(species_1) ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/as.numeric(total_effort_1)) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(total_effort_ident,
           .keep_all = T) 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method_2) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), max.month = max(month(date_total_effort_ident)))

#sampling method
good_surveys %>% 
  group_by(sampling_method_2) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type) %>% 
  count()

#min effort
good_surveys %>% 
  group_by(sampling_method_2) %>% 
  summarise(min.effort = min(total_effort_1),
            max.effort = max(total_effort_1))


#checking filters after collecting fish
adult_walleye %>% 
  group_by(species_1) %>% 
  count()

#is the state label the same for all fish
adult_walleye %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_walleye %>% 
  group_by(sampling_method_2) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), max.month = max(month(date_total_effort_ident)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct(lake_id,
           lake_name,
           date_total_effort_ident,
           survey_id,
           year,
           survey_type,
           sampling_method,
           total_effort_1) %>% 
  glimpse()

adult_walleye %>% 
  distinct(total_effort_ident) %>% 
  glimpse()


#range of cpues?
adult_walleye_cpue %>% 
  group_by(sampling_method_2) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_walleye_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_walleye_cpue %>% 
  filter(total_effort_nothing_caught == "TRUE") %>% 
  group_by(cpue) %>% 
  count()

adult_walleye %>% 
  group_by(species_1, total_effort_nothing_caught) %>% 
  count()

#remove larger fish object to save memory
rm(adult_walleye)
```

#black crappie filtering 
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Michigan" & species_1 == "black_crappie") %>% 
  select(-metric,
         -species_1,
         -area_group,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max,
         -area_group) %>% 
  rename(survey_type.1_effort = survey_type)

good_surveys <- mi_data %>% 
  mutate(state = "Michigan") %>% 
  right_join(filter_table_effort, by = c("state",
                                         "survey_type.1_effort",
                                         "sampling_method")) %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           effort_min,
#           month_min,
#           month_max
           ) %>% 
  filter(total_effort_1.1_effort >= effort_min) %>% 
#         month(date_clean) >= month_min,
#         month(date_clean) <= month_max) %>% 
  collect()

#collecting fish from good surveys
adult_black_crappie <- mi_data %>% 
  #making the state variable the same for all rows
  mutate(state = "Michigan") %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#creating cpue for species of interest
adult_black_crappie_cpue <- adult_black_crappie %>% 
  #grouping by variables to get survey fish count 
  group_by(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species.1 == 'black_crappie')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(species.1 == "taxon_NA" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/as.numeric(total_effort_1.1_effort)) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(lake_id,
           lake_name.1,
           nhdhr.id,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           .keep_all = T) 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1_effort) %>% 
  count()

#min effort
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1.1_effort))


#checking filtering after collecting fish
adult_black_crappie %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_black_crappie %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_black_crappie %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_black_crappie %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  group_by(sampling_method) %>% 
  glimpse()


#range of cpues?
adult_black_crappie_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_black_crappie_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_black_crappie_cpue %>% 
  filter(nothing_caught == "TRUE") %>% 
  group_by(cpue) %>% 
  count()

adult_black_crappie %>% 
  group_by(nothing_caught, species.1) %>% 
  count()

#removing larger fish object to save memory
rm(adult_black_crappie)
```

#bluegill filtering 
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Michigan" & species_1 == "bluegill") %>% 
  select(-metric,
         -species_1,
         -area_group,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max,
         -area_group) %>% 
  rename(survey_type.1_effort = survey_type)

good_surveys <- mi_data %>% 
  mutate(state = "Michigan") %>% 
  right_join(filter_table_effort, by = c("state",
                                         "survey_type.1_effort",
                                         "sampling_method")) %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           effort_min,
#           month_min,
#           month_max
           ) %>% 
 filter(total_effort_1.1_effort >= effort_min) %>% 
#         month(date_clean) >= month_min,
#         month(date_clean) <= month_max) %>% 
  collect()

#collecting fish from good surveys
adult_bluegill <- mi_data %>% 
  #making the state variable the same for all rows
  mutate(state = "Michigan") %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#creating cpue for species of interest
adult_bluegill_cpue <- adult_bluegill %>% 
  #grouping by variables to get survey fish count 
  group_by(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species.1 == 'bluegill')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(species.1 == "taxon_NA" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/as.numeric(total_effort_1.1_effort)) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(lake_id,
           lake_name.1,
           nhdhr.id,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           .keep_all = T) 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1_effort) %>% 
  count()

#min effort
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1.1_effort))


#checking final filter
adult_bluegill %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_bluegill %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_bluegill %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_bluegill %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#range of cpues?
adult_bluegill_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_bluegill_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_bluegill_cpue %>% 
  filter(nothing_caught == "TRUE") %>% 
  group_by(sampling_method, cpue) %>% 
  count()

adult_bluegill %>% 
  group_by(species.1, nothing_caught) %>% 
  count()

#removing large object to save memory
rm(adult_bluegill)
```

#cisco filtering 
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Michigan" & species_1 == "cisco") %>% 
  select(-metric,
         -species_1,
         -area_group,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max,
         -area_group) %>% 
  rename(survey_type.1_effort = survey_type)

good_surveys <- mi_data %>% 
  mutate(state = "Michigan") %>% 
  right_join(filter_table_effort, by = c("state",
                                         "survey_type.1_effort",
                                         "sampling_method")) %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           effort_min
#           month_min,
#           month_max
           ) %>% 
  filter(total_effort_1.1_effort >= effort_min) %>% 
#         month(date_clean) >= month_min,
#         month(date_clean) <= month_max) %>% 
  collect()

adult_cisco <- mi_data %>% 
  #making the state varaible the same for all rows
  mutate(state = "Michigan") %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#creating cpue for species of interest
adult_cisco_cpue <- adult_cisco %>% 
  #grouping by variables to get survey fish count 
  group_by(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species.1 == 'cisco')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(species.1 == "taxon_NA" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/as.numeric(total_effort_1.1_effort)) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(lake_id,
           lake_name.1,
           nhdhr.id,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           .keep_all = T) 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1_effort) %>% 
  count()

#min effort
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1.1_effort))




#checking final filter
adult_cisco %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_cisco %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_cisco %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_cisco %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#range of cpues?
adult_cisco_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_cisco_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_cisco_cpue %>% 
  filter(nothing_caught == "TRUE") %>% 
  group_by(sampling_method, cpue) %>% 
  count()

adult_cisco %>% 
  group_by(nothing_caught, species.1) %>% 
  count()

#removing large fish object to save memory
rm(adult_cisco)
```

#largemouth filtering 
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Michigan" & species_1 == "largemouth_bass") %>% 
  select(-metric,
         -species_1,
         -area_group,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max,
         -area_group) %>% 
  rename(survey_type.1_effort = survey_type)

good_surveys <- mi_data %>% 
  mutate(state = "Michigan") %>% 
  right_join(filter_table_effort, by = c("state",
                                         "survey_type.1_effort",
                                         "sampling_method")) %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           effort_min
#           month_min,
#           month_max
           ) %>% 
  filter(total_effort_1.1_effort >= effort_min) %>% 
#         month(date_clean) >= month_min,
#         month(date_clean) <= month_max) %>% 
  collect()

adult_largemouth <- mi_data %>% 
  #making the state varaible the same for all rows
  mutate(state = "Michigan") %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect()

#creating cpue for species of interest
adult_largemouth_cpue <- adult_largemouth %>% 
  #grouping by variables to get survey fish count 
  group_by(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species.1 == 'largemouth_bass')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(species.1 == "taxon_NA" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/as.numeric(total_effort_1.1_effort)) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(lake_id,
           lake_name.1,
           nhdhr.id,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           .keep_all = T) 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1_effort) %>% 
  count()

#min effort
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1.1_effort))


#checking final filter
adult_largemouth %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_largemouth %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_largemouth %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_largemouth %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#range of cpues?
adult_largemouth_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_largemouth_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_largemouth_cpue %>% 
  filter(nothing_caught == "TRUE") %>% 
  group_by(sampling_method, cpue) %>% 
  count()

adult_largemouth %>% 
  group_by(species.1, nothing_caught) %>% 
  count()

#removes large fish object to save memory
rm(adult_largemouth)
```

#smallmouth filtering 
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Michigan" & species_1 == "smallmouth_bass") %>% 
  select(-metric,
         -species_1,
         -area_group,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max,
         -area_group) %>% 
  rename(survey_type.1_effort = survey_type)

good_surveys <- mi_data %>% 
  mutate(state = "Michigan") %>% 
  right_join(filter_table_effort, by = c("state",
                                         "survey_type.1_effort",
                                         "sampling_method")) %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           effort_min,
#           month_min,
#           month_max
           ) %>% 
  filter(total_effort_1.1_effort >= effort_min) %>% 
#         month(date_clean) >= month_min,
#         month(date_clean) <= month_max) %>% 
  collect()

adult_smallmouth <- mi_data %>% 
  #making the state variable the same for all rows
  mutate(state = "Michigan") %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect()

#creating cpue for species of interest
adult_smallmouth_cpue <- adult_smallmouth %>% 
  #grouping by variables to get survey fish count 
  group_by(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species.1 == 'smallmouth_bass')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(species.1 == "taxon_NA" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/as.numeric(total_effort_1.1_effort)) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(lake_id,
           lake_name.1,
           nhdhr.id,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           .keep_all = T) 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1_effort) %>% 
  count()

#min effort
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1.1_effort))


#checking final filter
adult_smallmouth %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_smallmouth %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_smallmouth%>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_smallmouth %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#range of cpues?
adult_smallmouth_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_smallmouth_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_smallmouth_cpue %>% 
  filter(nothing_caught == "TRUE") %>% 
  group_by(sampling_method, cpue) %>% 
  count()

adult_smallmouth %>% 
  group_by(nothing_caught, species.1) %>% 
  count()

#removes large fish object to save memory
rm(adult_smallmouth)
```

#northern pike filtering 
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Michigan" & species_1 == "northern_pike") %>% 
  select(-metric,
         -species_1,
         -area_group,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max,
         -area_group) %>% 
  rename(survey_type.1_effort = survey_type)

good_surveys <- mi_data %>% 
  mutate(state = "Michigan") %>% 
  right_join(filter_table_effort, by = c("state",
                                         "survey_type.1_effort",
                                         "sampling_method")) %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           effort_min
#           month_min,
#           month_max
           ) %>% 
  filter(total_effort_1.1_effort >= effort_min) %>% 
#         month(date_clean) >= month_min,
#         month(date_clean) <= month_max) %>% 
  collect()

adult_northern_pike <- mi_data %>% 
  #making the state variable the same for all rows
  mutate(state = "Michigan") %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#creating cpue for species of interest
adult_northern_pike_cpue <- adult_northern_pike %>% 
  #grouping by variables to get survey fish count 
  group_by(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species.1 == 'northern_pike')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(species.1 == "taxon_NA" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/as.numeric(total_effort_1.1_effort)) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(lake_id,
           lake_name.1,
           nhdhr.id,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           .keep_all = T) 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1_effort) %>% 
  count()

#min effort
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1.1_effort))


#checking final filter
adult_northern_pike %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_northern_pike %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_northern_pike %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_northern_pike %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  group_by(sampling_method) %>% 
  glimpse()



#range of cpues?
adult_northern_pike_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_northern_pike_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_northern_pike_cpue %>% 
  filter(nothing_caught == "TRUE") %>% 
  group_by(sampling_method, cpue) %>% 
  count()

adult_northern_pike %>% 
  group_by(species.1, nothing_caught) %>% 
  count()

#removes large fish object to save memory
rm(adult_northern_pike)
```

#yellow perch filtering 
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Michigan" & species_1 == "yellow_perch") %>% 
  select(-metric,
         -species_1,
         -area_group,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max,
         -area_group) %>% 
  rename(survey_type.1_effort = survey_type)

good_surveys <- mi_data %>% 
  mutate(state = "Michigan") %>% 
  right_join(filter_table_effort, by = c("state",
                                         "survey_type.1_effort",
                                         "sampling_method")) %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           effort_min
#           month_min,
#           month_max
           ) %>% 
  filter(total_effort_1.1_effort >= effort_min) %>% 
#         month(date_clean) >= month_min,
#         month(date_clean) <= month_max) %>% 
  collect()

adult_yellow_perch <- mi_data %>% 
  #making the state variable the same for all rows
  mutate(state = "Michigan") %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect()

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1_effort) %>% 
  count()

#min effort
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1.1_effort))


#checking final filter
adult_yellow_perch %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_yellow_perch %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_yellow_perch %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1)), max.month = max(month(date.1)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_yellow_perch %>% 
  distinct(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#creating cpue for species of interest
adult_yellow_perch_cpue <- adult_yellow_perch %>% 
  #grouping by variables to get survey fish count 
  group_by(lake_id,
           lake_name.1,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species.1 == 'yellow_perch')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(species.1 == "taxon_NA" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/as.numeric(total_effort_1.1_effort)) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(lake_id,
           lake_name.1,
           nhdhr.id,
           date.1,
           survey_id,
           year,
           survey_type.1_effort,
           sampling_method,
           total_effort_1.1_effort,
           effort_units.1,
           .keep_all = T) 

#range of cpues?
adult_yellow_perch_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_yellow_perch_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_yellow_perch_cpue %>% 
  filter(nothing_caught == "TRUE") %>% 
  group_by(sampling_method, cpue) %>% 
  count()

adult_yellow_perch %>% 
  group_by(species.1, nothing_caught) %>% 
  count()

#removes large fish object to save memory
rm(adult_yellow_perch)
```

#combining species
```{r}
mi_filtered_species <- bind_rows(adult_walleye_cpue %>% 
                                   mutate(species_1 = "walleye"), 
                                 adult_bluegill_cpue %>% 
                                   mutate(species_1 = "bluegill"), 
                                 adult_black_crappie_cpue %>% 
                                   mutate(species_1 = "black_crappie"),
                                 adult_largemouth_cpue %>% 
                                   mutate(species_1 = "largemouth_bass"), 
                                 adult_smallmouth_cpue %>% 
                                   mutate(species_1 = "smallmouth_bass"), 
                                 adult_cisco_cpue %>% 
                                   mutate(species_1 = "cisco"), 
                                 adult_northern_pike_cpue %>% 
                                   mutate(species_1 = "northern_pike"), 
                                 adult_yellow_perch_cpue %>% 
                                   mutate(species_1 = "yellow_perch"))
write_csv(mi_filtered_species, "MI_all_cpue_filtered.csv")
```

#data exploration
```{r}
#effort with sampling types
mi_data %>% 
  collect() %>% 
  distinct(lake_id, year, sampling_method, .keep_all = T) %>% 
  group_by(sampling_method, effort_units.1, month(date.1)) %>% 
  summarise(n = n()) %>% 
  print(n = nrow(.))

mi_filtered_species %>% 
  ggplot() +
  geom_histogram(aes(cpue)) +
  facet_grid(sampling_method~species_1, scales = "free")


mi_data %>% 
  collect() %>% 
  group_by(sampling_method) %>% 
  summarise(walleye = sum(species.1 == "walleye"))

mi_data %>% 
  filter(species.1 == "taxon_NA") %>% 
  glimpse()

mi_data %>% 
  collect() %>% 
  distinct(effort_ident, .keep_all = T) %>%
  ggplot() +
  geom_histogram(aes(total_effort_1.1_effort)) + 
  geom_vline(xintercept = c(2, 30)) +
  facet_wrap(~sampling_method, scales = "free")

mi_data %>% 
  collect() %>% 
  distinct(effort_ident, .keep_all = T) %>%
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date.1), na.rm = T),
            max.month = max(month(date.1), na.rm = T),
            avg.month = mean(month(date.1), na.rm = T),
            n = n())
```
