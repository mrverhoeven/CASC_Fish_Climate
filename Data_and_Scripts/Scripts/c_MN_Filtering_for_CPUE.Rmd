---
title: "c_MN_Filtering_for_CPUE"
author: "Denver Link"
date: "2023-10-28"
output: html_document
editor_options: 
  chunk_output_type: console
---

12/29 filter cleaning:
1. selecting columns to retain for filtering... is that necessary? 
2. order of operation in creation of good surveys
      -could call the distinct function first
      -then I could join by filter table by specific columns and values (even numeric)
      -collect
      -could minimize the number of things I call to make a survey distinct (only include total effort ident)
3. I have realized filtering by fish level parameters is not the best way to go
      -instead, if a fish level parameter is of interest - include that variable in counting for cpue
4. only use total effort ident in the grouping for cpue
5. change the call of na species to nothing caught
6. collect first before calling the distinct function
  -that way we can retain all columns with .keep_all = T



#Library
```{r}
library(tidyverse)
library(arrow)
```

#Data
```{r}
mn_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "hive"), partitioning = c("state")) %>% 
  filter(state == "Minnesota")
glimpse(mn_data)
```

General structure for each filtering chunks:
1. gather the filter tables (survey level and fish level)
2. filter for "good surveys"
3. gather fish data from the good surveys
4. calculate cpue - ensuring you are counting fish of the correct parameters
   -if fish level counting within certain parameters is desired (bin lengths) apply that here
5. check survey level filtering
6. check filtering post gathering fish
7. check cpue generation
8. remove large individual fish object to save memory 

#walleye filtering
```{r}
#filters for metric and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  select(-metric,
         -species_1,
         -water_temp_min,
         -water_temp_max,
         -survey_type)

#filters for surveys that are good measures of abundance for given fish species
#first, merge the filter table with the data - selects for non-numeric parameters important for abundance 
#second, collapse the data into survey level
#third, filter the surveys based on numeric values 
good_surveys <- mn_data %>%
  #filter for correct survey_type
  mutate(survey_type_filter = case_when(survey_type %in% c("HISTORICAL", 
                                                 "Large Lake Survey", 
                                                 "Population Assessment",
                                                 "Standard Survey",
                                                 "Initial Survey",
                                                 "Re-Survey") ~ "y", 
                              TRUE ~ "n")) %>% 
  right_join(filter_table_effort, by = c("state",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           date_total_effort_ident,
           sampling_method,
           total_effort_ident,
           total_effort_1,
           area_group,
           effort_min,
           effort_max,
           month_min,
           month_max,
           survey_type_filter,
           flag) %>% 
  filter(total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         month(date_total_effort_ident) >= month_min,
         month(date_total_effort_ident) <= month_max,
         survey_type_filter == "y") %>% 
  collect() %>% 
  #removing surveys that have a flag
  group_by(total_effort_ident) %>% 
  filter(all(is.na(flag))) %>% 
  ungroup()  %>% 
  select(-flag)

#gather fish from the surveys deemed good for abundance of the given species
adult_walleye <- mn_data %>% 
  #filter the data for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#create cpue for species of interest
adult_walleye_cpue <- adult_walleye %>% 
  #grouping by survey level parameters to get survey level counts
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species_1 == 'walleye')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(total_effort_ident,
           total_effort_1,
           .keep_all = T) %>% 
  filter(is.na(total_effort_nothing_caught)) %>% 
  group_by(total_effort_ident) %>% 
  filter(n_distinct(total_effort_1) == 1)


#checking filtering

#survey level checks
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

#min effort by grouping
good_surveys %>% 
  group_by(area_group, sampling_method) %>% 
  summarise(min_effort = min(total_effort_1),
            n = n())

#checks after collecting all fish data
#is each sampling method correct for the filter?
adult_walleye %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

adult_walleye %>% 
  group_by(survey_type, sampling_method, survey_type_filter) %>% 
  count()

adult_walleye %>% 
  group_by(flag) %>% 
  count()

#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct(lake_id,
           date_total_effort_ident,
           survey_type,
           sampling_method,
           total_effort_1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#there are a handful of surveys that have multiple efforts within a total effort ident
#this causes the good surveys to look bigger than the cpue total but ensure we get all fish records 
adult_walleye %>% 
  distinct(total_effort_ident,
           total_effort_1) %>% 
  glimpse()

adult_walleye %>% 
  filter(is.na(total_effort_ident)) %>% 
  distinct(total_effort_ident) %>% 
  glimpse()

adult_walleye %>% 
  group_by(total_effort_ident,
           total_effort_1) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n > 1)

adult_walleye %>% 
  distinct(total_effort_ident, total_effort_nothing_caught) %>% 
  group_by(is.na(total_effort_nothing_caught)) %>% 
  count()

adult_black_crappie %>% 
  distinct(lake_id,
           date_total_effort_ident,
           sampling_method,
           #total_effort_ident,
           total_effort_1,
           area_group,
           effort_min,
           effort_max,
           month_min,
           month_max,
           survey_type_filter) %>% 
  glimpse()

adult_black_crappie %>% 
  group_by(lake_id,
           date_total_effort_ident,
           sampling_method,
           #total_effort_ident,
           total_effort_1,
           area_group,
           effort_min,
           effort_max,
           month_min,
           month_max,
           survey_type_filter) %>% 
  summarise(n = n_distinct(total_effort_ident)) %>% 
  filter(n > 1) %>% 
  glimpse()
#this survey has multiple effort idents?
#more exploration leads to this survey having a record of nothing caught but also fish records with assoicated effort.

#the difference between good surveys and cpue surveys are:
#88 nothing caught is true - removed due to unlikely they caught nothing

no_catch <- adult_walleye %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  filter(!is.na(total_effort_nothing_caught)) 
rm(no_catch)

#checks after calculating cpue
#range of cpues?
adult_walleye_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_walleye_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_walleye_cpue %>% 
  filter(total_effort_nothing_caught == "TRUE") %>% 
  group_by(lake_name, survey_type, sampling_method, total_effort_1, date_total_effort_ident, total_effort_nothing_caught, cpue) %>% 
  count() %>% 
  print(n = nrow(.))

adult_walleye_cpue %>% 
  ggplot() +
  geom_histogram(aes(cpue)) +
  facet_wrap(~sampling_method, scales = "free")

#removes individual fish object to save memory
rm(adult_walleye)
```

#black crappie filtering
```{r}
#filters for metric and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "black_crappie") %>% 
  select(-metric,
         -species_1,
         -water_temp_min,
         -water_temp_max,
         -survey_type)

#filters for surveys that are good measures of abundance for given fish species
#first, merge the filter table with the data - selects for non-numeric parameters important for abundance 
#second, collapse the data into survey level
#third, filter the surveys based on numeric values 
good_surveys <- mn_data %>%
  #filter for correct survey_type
  mutate(survey_type_filter = case_when(survey_type %in% c("HISTORICAL", 
                                                 "Large Lake Survey", 
                                                 "Population Assessment",
                                                 "Standard Survey",
                                                 "Initial Survey",
                                                 "Re-Survey") ~ "y", 
                              TRUE ~ "n")) %>% 
  right_join(filter_table_effort, by = c("state",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           date_total_effort_ident,
           sampling_method,
           total_effort_ident,
           total_effort_1,
           area_group,
           effort_min,
           effort_max,
           month_min,
           month_max,
           survey_type_filter,
           flag) %>% 
  filter(total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         month(date_total_effort_ident) >= month_min,
         month(date_total_effort_ident) <= month_max,
         survey_type_filter == "y") %>% 
  collect() %>% 
  #removing surveys that have a flag
  group_by(total_effort_ident) %>% 
  filter(all(is.na(flag))) %>% 
  ungroup() %>% 
  select(-flag)

#gather fish from the surveys deemed good for abundance of the given species
adult_black_crappie <- mn_data %>% 
  #filter the data for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#create cpue for species of interest
adult_black_crappie_cpue <- adult_black_crappie %>% 
  #grouping by survey level parameters to get survey level counts
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species_1 == 'black_crappie')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(total_effort_ident,
           total_effort_1,
           .keep_all = T) %>% 
  filter(is.na(total_effort_nothing_caught)) %>% 
  group_by(total_effort_ident) %>% 
  filter(n_distinct(total_effort_1) == 1)


#checking filtering

#survey level checks
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

#min effort by grouping
good_surveys %>% 
  group_by(area_group, sampling_method) %>% 
  summarise(min_effort = min(total_effort_1),
            n = n())

#checks after collecting all fish data
#is each sampling method correct for the filter?
adult_black_crappie %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

adult_black_crappie %>% 
  group_by(survey_type, sampling_method, survey_type_filter) %>% 
  count()

adult_black_crappie %>% 
  group_by(flag) %>% 
  count()

#do I retain all of the good surveys? - rows here should match good surveys 
adult_black_crappie %>% 
  distinct(total_effort_ident) %>% 
  glimpse()

#there are a handful of surveys that have multiple efforts within a total effort ident
#this causes the good surveys to look bigger than the cpue total but ensure we get all fish records 
adult_black_crappie %>% 
  distinct(total_effort_ident) %>% 
  glimpse()

adult_black_crappie %>% 
  group_by(total_effort_ident,
           date_total_effort_ident) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n > 1)

#the difference between good surveys and cpue surveys are:
#88 nothing caught is true - removed 


#checks after calculating cpue
#range of cpues?
adult_black_crappie_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_black_crappie_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_black_crappie_cpue %>% 
  filter(total_effort_nothing_caught == "TRUE") %>% 
  group_by(lake_name, survey_type, sampling_method, total_effort_1, date_total_effort_ident, total_effort_nothing_caught, cpue) %>% 
  count() %>% 
  print(n = nrow(.))

adult_black_crappie_cpue %>% 
  ggplot() +
  geom_histogram(aes(cpue)) +
  facet_wrap(~sampling_method, scales = "free")

#removes individual fish object to save memory
rm(adult_black_crappie)
```

#bluegill filtering
```{r}
#filters for metric and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "bluegill") %>% 
  select(-metric,
         -species_1,
         -water_temp_min,
         -water_temp_max,
         -survey_type)

#filters for surveys that are good measures of abundance for given fish species
#first, merge the filter table with the data - selects for non-numeric parameters important for abundance 
#second, collapse the data into survey level
#third, filter the surveys based on numeric values 
good_surveys <- mn_data %>%
  #filter for correct survey_type
  mutate(survey_type_filter = case_when(survey_type %in% c("HISTORICAL", 
                                                 "Large Lake Survey", 
                                                 "Population Assessment",
                                                 "Standard Survey",
                                                 "Initial Survey",
                                                 "Re-Survey") ~ "y", 
                              TRUE ~ "n")) %>% 
  right_join(filter_table_effort, by = c("state",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           date_total_effort_ident,
           sampling_method,
           total_effort_ident,
           total_effort_1,
           area_group,
           effort_min,
           effort_max,
           month_min,
           month_max,
           survey_type_filter,
           flag) %>% 
  filter(total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         month(date_total_effort_ident) >= month_min,
         month(date_total_effort_ident) <= month_max,
         survey_type_filter == "y") %>% 
  collect() %>% 
  #removing surveys that have a flag
  group_by(total_effort_ident) %>% 
  filter(all(is.na(flag))) %>% 
  ungroup()  %>% 
  select(-flag)

#gather fish from the surveys deemed good for abundance of the given species
adult_bluegill <- mn_data %>% 
  #filter the data for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#create cpue for species of interest
adult_bluegill_cpue <- adult_bluegill %>% 
  #grouping by survey level parameters to get survey level counts
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species_1 == 'bluegill')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(total_effort_ident,
           total_effort_1,
           .keep_all = T) %>% 
  filter(is.na(total_effort_nothing_caught)) %>% 
  group_by(total_effort_ident) %>% 
  filter(n_distinct(total_effort_1) == 1)


#checking filtering

#survey level checks
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

#min effort by grouping
good_surveys %>% 
  group_by(area_group, sampling_method) %>% 
  summarise(min_effort = min(total_effort_1),
            n = n())

#checks after collecting all fish data
#is each sampling method correct for the filter?
adult_bluegill %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

adult_bluegill %>% 
  group_by(survey_type, sampling_method, survey_type_filter) %>% 
  count()

adult_bluegill %>% 
  group_by(flag) %>% 
  count()

#do I retain all of the good surveys? - rows here should match good surveys 
adult_bluegill %>% 
  distinct(lake_id,
           date_total_effort_ident,
           survey_type,
           sampling_method,
           total_effort_1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#there are a handful of surveys that have multiple efforts within a total effort ident
#this causes the good surveys to look bigger than the cpue total but ensure we get all fish records 
adult_bluegill %>% 
  distinct(total_effort_ident,
           total_effort_1) %>% 
  glimpse()

adult_bluegill %>% 
  distinct(total_effort_ident) %>% 
  glimpse()


adult_bluegill %>% 
  group_by(total_effort_ident,
           total_effort_1) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n > 1)

#the difference between good surveys and cpue surveys are:
#88 nothing caught is true - remove


#checks after calculating cpue
#range of cpues?
adult_bluegill_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_bluegill_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_bluegill_cpue %>% 
  filter(total_effort_nothing_caught == "TRUE") %>% 
  group_by(lake_name, survey_type, sampling_method, total_effort_1, date_total_effort_ident, total_effort_nothing_caught, cpue) %>% 
  count() %>% 
  print(n = nrow(.))

adult_bluegill_cpue %>% 
  ggplot() +
  geom_histogram(aes(cpue)) +
  facet_wrap(~sampling_method, scales = "free")

#removes individual fish object to save memory
rm(adult_bluegill)
```

#largemouth filtering
```{r}
#filters for metric and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "largemouth_bass") %>% 
  select(-metric,
         -species_1,
         -water_temp_min,
         -water_temp_max,
         -survey_type)

#filters for surveys that are good measures of abundance for given fish species
#first, merge the filter table with the data - selects for non-numeric parameters important for abundance 
#second, collapse the data into survey level
#third, filter the surveys based on numeric values 
good_surveys <- mn_data %>%
  #filter for correct survey_type
  mutate(survey_type_filter = case_when(survey_type %in% c("HISTORICAL", 
                                                 "Large Lake Survey", 
                                                 "Population Assessment",
                                                 "Standard Survey",
                                                 "Initial Survey",
                                                 "Re-Survey") ~ "y", 
                              TRUE ~ "n")) %>% 
  right_join(filter_table_effort, by = c("state",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           date_total_effort_ident,
           sampling_method,
           total_effort_ident,
           total_effort_1,
           area_group,
           effort_min,
           effort_max,
           month_min,
           month_max,
           survey_type_filter,
           flag) %>% 
  filter(total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         month(date_total_effort_ident) >= month_min,
         month(date_total_effort_ident) <= month_max,
         survey_type_filter == "y") %>% 
  collect() %>% 
  #removing surveys that have a flag
  group_by(total_effort_ident) %>% 
  filter(all(is.na(flag))) %>% 
  ungroup()  %>% 
  select(-flag)

#gather fish from the surveys deemed good for abundance of the given species
adult_largemouth_bass <- mn_data %>% 
  #filter the data for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#create cpue for species of interest
adult_largemouth_bass_cpue <- adult_largemouth_bass %>% 
  #grouping by survey level parameters to get survey level counts
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species_1 == 'largemouth_bass')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(total_effort_ident,
           total_effort_1,
           .keep_all = T) %>% 
  filter(is.na(total_effort_nothing_caught)) %>% 
  group_by(total_effort_ident) %>% 
  filter(n_distinct(total_effort_1) == 1)


#checking filtering

#survey level checks
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

#min effort by grouping
good_surveys %>% 
  group_by(area_group, sampling_method) %>% 
  summarise(min_effort = min(total_effort_1),
            n = n())

#checks after collecting all fish data
#is each sampling method correct for the filter?
adult_largemouth_bass %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

adult_largemouth_bass %>% 
  group_by(survey_type, sampling_method, survey_type_filter) %>% 
  count()

adult_largemouth_bass %>% 
  group_by(flag) %>% 
  count()

#do I retain all of the good surveys? - rows here should match good surveys 
adult_largemouth_bass %>% 
  distinct(lake_id,
           date_total_effort_ident,
           survey_type,
           sampling_method,
           total_effort_1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#there are a handful of surveys that have multiple efforts within a total effort ident
#this causes the good surveys to look bigger than the cpue total but ensure we get all fish records 
adult_largemouth_bass %>% 
  distinct(total_effort_ident,
           total_effort_1) %>% 
  glimpse()

adult_largemouth_bass %>% 
  distinct(total_effort_ident) %>% 
  glimpse()


adult_largemouth_bass %>% 
  group_by(total_effort_ident,
           total_effort_1) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n > 1)

#the difference between good surveys and cpue surveys are:
#88 nothing caught is true - remove


#checks after calculating cpue
#range of cpues?
adult_largemouth_bass_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_largemouth_bass_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_largemouth_bass_cpue %>% 
  filter(total_effort_nothing_caught == "TRUE") %>% 
  group_by(lake_name, survey_type, sampling_method, total_effort_1, date_total_effort_ident, total_effort_nothing_caught, cpue) %>% 
  count() %>% 
  print(n = nrow(.))

adult_largemouth_bass_cpue %>% 
  ggplot() +
  geom_histogram(aes(cpue)) +
  facet_wrap(~sampling_method, scales = "free")

#removes individual fish object to save memory
rm(adult_largemouth_bass)
```

#smallmouth filtering
```{r}
#filters for metric and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "smallmouth_bass") %>% 
  select(-metric,
         -species_1,
         -water_temp_min,
         -water_temp_max,
         -survey_type)

#filters for surveys that are good measures of abundance for given fish species
#first, merge the filter table with the data - selects for non-numeric parameters important for abundance 
#second, collapse the data into survey level
#third, filter the surveys based on numeric values 
good_surveys <- mn_data %>%
  #filter for correct survey_type
  mutate(survey_type_filter = case_when(survey_type %in% c("HISTORICAL", 
                                                 "Large Lake Survey", 
                                                 "Population Assessment",
                                                 "Standard Survey",
                                                 "Initial Survey",
                                                 "Re-Survey") ~ "y", 
                              TRUE ~ "n")) %>% 
  right_join(filter_table_effort, by = c("state",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           date_total_effort_ident,
           sampling_method,
           total_effort_ident,
           total_effort_1,
           area_group,
           effort_min,
           effort_max,
           month_min,
           month_max,
           survey_type_filter,
           flag) %>% 
  filter(total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         month(date_total_effort_ident) >= month_min,
         month(date_total_effort_ident) <= month_max,
         survey_type_filter == "y") %>% 
  collect() %>% 
  #removing surveys that have a flag
  group_by(total_effort_ident) %>% 
  filter(all(is.na(flag))) %>% 
  ungroup()  %>% 
  select(-flag)

#gather fish from the surveys deemed good for abundance of the given species
adult_smallmouth_bass <- mn_data %>% 
  #filter the data for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#create cpue for species of interest
adult_smallmouth_bass_cpue <- adult_smallmouth_bass %>% 
  #grouping by survey level parameters to get survey level counts
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species_1 == 'smallmouth_bass')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(total_effort_ident,
           total_effort_1,
           .keep_all = T) %>% 
  filter(is.na(total_effort_nothing_caught)) %>% 
  group_by(total_effort_ident) %>% 
  filter(n_distinct(total_effort_1) == 1)


#checking filtering

#survey level checks
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

#min effort by grouping
good_surveys %>% 
  group_by(area_group, sampling_method) %>% 
  summarise(min_effort = min(total_effort_1),
            n = n())

#checks after collecting all fish data
#is each sampling method correct for the filter?
adult_smallmouth_bass %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

adult_smallmouth_bass %>% 
  group_by(survey_type, sampling_method, survey_type_filter) %>% 
  count()

adult_smallmouth_bass %>% 
  group_by(flag) %>% 
  count()

#do I retain all of the good surveys? - rows here should match good surveys 
adult_smallmouth_bass %>% 
  distinct(lake_id,
           date_total_effort_ident,
           survey_type,
           sampling_method,
           total_effort_1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#there are a handful of surveys that have multiple efforts within a total effort ident
#this causes the good surveys to look bigger than the cpue total but ensure we get all fish records 
adult_smallmouth_bass %>% 
  distinct(total_effort_ident,
           total_effort_1) %>% 
  glimpse()

adult_smallmouth_bass %>% 
  distinct(total_effort_ident) %>% 
  glimpse()


adult_smallmouth_bass %>% 
  group_by(total_effort_ident,
           total_effort_1) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n > 1)

#the difference between good surveys and cpue surveys are:
#88 nothing caught is true - remove


#checks after calculating cpue
#range of cpues?
adult_smallmouth_bass_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_smallmouth_bass_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_smallmouth_bass_cpue %>% 
  filter(total_effort_nothing_caught == "TRUE") %>% 
  group_by(lake_name, survey_type, sampling_method, total_effort_1, date_total_effort_ident, total_effort_nothing_caught, cpue) %>% 
  count() %>% 
  print(n = nrow(.))

adult_smallmouth_bass_cpue %>% 
  ggplot() +
  geom_histogram(aes(cpue)) +
  facet_wrap(~sampling_method, scales = "free")

#removes individual fish object to save memory
rm(adult_smallmouth_bass)
```

#cisco filtering
```{r}
#filters for metric and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "cisco") %>% 
  select(-metric,
         -species_1,
         -water_temp_min,
         -water_temp_max,
         -survey_type)


#filters for surveys that are good measures of abundance for given fish species
#first, merge the filter table with the data - selects for non-numeric parameters important for abundance 
#second, collapse the data into survey level
#third, filter the surveys based on numeric values 
good_surveys <- mn_data %>%
  #filter for correct survey_type
  mutate(survey_type_filter = case_when((survey_type %in% c("HISTORICAL", 
                                                 "Large Lake Survey", 
                                                 "Population Assessment",
                                                 "Standard Survey",
                                                 "Initial Survey",
                                                 "Re-Survey") & 
                                          sampling_method %in% c("Standard 3/4-in mesh, double frame trap net sets",
                                                                 "Standard gill net sets")) |
                                          (sampling_method == "Standard Vertical Gillnet" &
                                          survey_type %in% c("Research Survey",
                                                             "Standard Survey",
                                                             "Targeted Survey")) ~ "y", 
                              TRUE ~ "n")) %>% 
  right_join(filter_table_effort, by = c("state",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           date_total_effort_ident,
           sampling_method,
           total_effort_ident,
           total_effort_1,
           area_group,
           effort_min,
           effort_max,
           month_min,
           month_max,
           survey_type_filter,
           flag) %>% 
  filter(total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         month(date_total_effort_ident) >= month_min,
         month(date_total_effort_ident) <= month_max,
         survey_type_filter == "y") %>% 
  collect() %>% 
  #removing surveys that have a flag
  group_by(total_effort_ident) %>% 
  filter(all(is.na(flag))) %>% 
  ungroup()  %>% 
  select(-flag)


#gather fish from the surveys deemed good for abundance of the given species
adult_cisco <- mn_data %>% 
  #filter the data for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#create cpue for species of interest
adult_cisco_cpue <- adult_cisco %>% 
  #grouping by survey level parameters to get survey level counts
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species_1 == 'cisco')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(total_effort_ident,
           total_effort_1,
           .keep_all = T) %>% 
  filter(is.na(total_effort_nothing_caught)) %>% 
  group_by(total_effort_ident) %>% 
  filter(n_distinct(total_effort_1) == 1)


#checking filtering

#survey level checks
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

#min effort by grouping
good_surveys %>% 
  group_by(area_group, sampling_method) %>% 
  summarise(min_effort = min(total_effort_1),
            n = n())

#checks after collecting all fish data
#is each sampling method correct for the filter?
adult_cisco %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

adult_cisco %>% 
  group_by(survey_type, sampling_method, survey_type_filter) %>% 
  count()

adult_cisco %>% 
  group_by(flag) %>% 
  count()

#do I retain all of the good surveys? - rows here should match good surveys 
adult_cisco %>% 
  distinct(lake_id,
           date_total_effort_ident,
           survey_type,
           sampling_method,
           total_effort_1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#there are a handful of surveys that have multiple efforts within a total effort ident
#this causes the good surveys to look bigger than the cpue total but ensure we get all fish records 
adult_cisco %>% 
  distinct(total_effort_ident,
           total_effort_1) %>% 
  glimpse()

adult_cisco %>% 
  distinct(total_effort_ident) %>% 
  glimpse()


adult_cisco %>% 
  group_by(total_effort_ident,
           total_effort_1) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n > 1)

#the difference between good surveys and cpue surveys are:
#88 nothing caught is true - remove


#checks after calculating cpue
#range of cpues?
adult_cisco_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_cisco_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_cisco_cpue %>% 
  filter(total_effort_nothing_caught == "TRUE") %>% 
  group_by(lake_name, survey_type, sampling_method, total_effort_1, date_total_effort_ident, total_effort_nothing_caught, cpue) %>% 
  count() %>% 
  print(n = nrow(.))

adult_cisco_cpue %>% 
  ggplot() +
  geom_histogram(aes(cpue)) +
  facet_wrap(~sampling_method, scales = "free")

#removes individual fish object to save memory
rm(adult_cisco)
```

#northern pike filtering
```{r}
#filters for metric and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "northern_pike") %>% 
  select(-metric,
         -species_1,
         -water_temp_min,
         -water_temp_max,
         -survey_type)

#filters for surveys that are good measures of abundance for given fish species
#first, merge the filter table with the data - selects for non-numeric parameters important for abundance 
#second, collapse the data into survey level
#third, filter the surveys based on numeric values 
good_surveys <- mn_data %>%
  #filter for correct survey_type
  mutate(survey_type_filter = case_when(survey_type %in% c("HISTORICAL", 
                                                 "Large Lake Survey", 
                                                 "Population Assessment",
                                                 "Standard Survey",
                                                 "Initial Survey",
                                                 "Re-Survey") ~ "y", 
                              TRUE ~ "n")) %>% 
  right_join(filter_table_effort, by = c("state",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           date_total_effort_ident,
           sampling_method,
           total_effort_ident,
           total_effort_1,
           area_group,
           effort_min,
           effort_max,
           month_min,
           month_max,
           survey_type_filter,
           flag) %>% 
  filter(total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         month(date_total_effort_ident) >= month_min,
         month(date_total_effort_ident) <= month_max,
         survey_type_filter == "y") %>% 
  collect() %>% 
  #removing surveys that have a flag
  group_by(total_effort_ident) %>% 
  filter(all(is.na(flag))) %>% 
  ungroup()  %>% 
  select(-flag)

#gather fish from the surveys deemed good for abundance of the given species
adult_northern_pike <- mn_data %>% 
  #filter the data for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#create cpue for species of interest
adult_northern_pike_cpue <- adult_northern_pike %>% 
  #grouping by survey level parameters to get survey level counts
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species_1 == 'northern_pike')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(total_effort_ident,
           total_effort_1,
           .keep_all = T) %>% 
  filter(is.na(total_effort_nothing_caught)) %>% 
  group_by(total_effort_ident) %>% 
  filter(n_distinct(total_effort_1) == 1)


#checking filtering

#survey level checks
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

#min effort by grouping
good_surveys %>% 
  group_by(area_group, sampling_method) %>% 
  summarise(min_effort = min(total_effort_1),
            n = n())

#checks after collecting all fish data
#is each sampling method correct for the filter?
adult_northern_pike %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

adult_northern_pike %>% 
  group_by(survey_type, sampling_method, survey_type_filter) %>% 
  count()

adult_northern_pike %>% 
  group_by(flag) %>% 
  count()

#do I retain all of the good surveys? - rows here should match good surveys 
adult_northern_pike %>% 
  distinct(lake_id,
           date_total_effort_ident,
           survey_type,
           sampling_method,
           total_effort_1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#there are a handful of surveys that have multiple efforts within a total effort ident
#this causes the good surveys to look bigger than the cpue total but ensure we get all fish records 
adult_northern_pike %>% 
  distinct(total_effort_ident,
           total_effort_1) %>% 
  glimpse()

adult_northern_pike %>% 
  distinct(total_effort_ident) %>% 
  glimpse()


adult_northern_pike %>% 
  group_by(total_effort_ident,
           total_effort_1) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n > 1)

#the difference between good surveys and cpue surveys are:
#88 nothing caught is true - remove


#checks after calculating cpue
#range of cpues?
adult_northern_pike_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_northern_pike_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_northern_pike_cpue %>% 
  filter(total_effort_nothing_caught == "TRUE") %>% 
  group_by(lake_name, survey_type, sampling_method, total_effort_1, date_total_effort_ident, total_effort_nothing_caught, cpue) %>% 
  count() %>% 
  print(n = nrow(.))

adult_northern_pike_cpue %>% 
  ggplot() +
  geom_histogram(aes(cpue)) +
  facet_wrap(~sampling_method, scales = "free")

#removes individual fish object to save memory
rm(adult_northern_pike)
```

#yellow perch filtering
```{r}
#filters for metric and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "yellow_perch") %>% 
  select(-metric,
         -species_1,
         -water_temp_min,
         -water_temp_max,
         -survey_type)

#filters for surveys that are good measures of abundance for given fish species
#first, merge the filter table with the data - selects for non-numeric parameters important for abundance 
#second, collapse the data into survey level
#third, filter the surveys based on numeric values 
good_surveys <- mn_data %>%
  #filter for correct survey_type
  mutate(survey_type_filter = case_when(survey_type %in% c("HISTORICAL", 
                                                 "Large Lake Survey", 
                                                 "Population Assessment",
                                                 "Standard Survey",
                                                 "Initial Survey",
                                                 "Re-Survey") ~ "y", 
                              TRUE ~ "n")) %>% 
  right_join(filter_table_effort, by = c("state",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           date_total_effort_ident,
           sampling_method,
           total_effort_ident,
           total_effort_1,
           area_group,
           effort_min,
           effort_max,
           month_min,
           month_max,
           survey_type_filter,
           flag) %>% 
  filter(total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         month(date_total_effort_ident) >= month_min,
         month(date_total_effort_ident) <= month_max,
         survey_type_filter == "y") %>% 
  collect() %>% 
  #removing surveys that have a flag
  group_by(total_effort_ident) %>% 
  filter(all(is.na(flag))) %>% 
  ungroup()  %>% 
  select(-flag)

#gather fish from the surveys deemed good for abundance of the given species
adult_yellow_perch <- mn_data %>% 
  #filter the data for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#create cpue for species of interest
adult_yellow_perch_cpue <- adult_yellow_perch %>% 
  #grouping by survey level parameters to get survey level counts
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species_1 == 'yellow_perch')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(total_effort_ident,
           total_effort_1,
           .keep_all = T) %>% 
  filter(is.na(total_effort_nothing_caught)) %>% 
  group_by(total_effort_ident) %>% 
  filter(n_distinct(total_effort_1) == 1)


#checking filtering

#survey level checks
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

#min effort by grouping
good_surveys %>% 
  group_by(area_group, sampling_method) %>% 
  summarise(min_effort = min(total_effort_1),
            n = n())

#checks after collecting all fish data
#is each sampling method correct for the filter?
adult_yellow_perch %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_total_effort_ident)), 
            max.month = max(month(date_total_effort_ident)),
            n = n())

adult_yellow_perch %>% 
  group_by(survey_type, sampling_method, survey_type_filter) %>% 
  count()

adult_yellow_perch %>% 
  group_by(flag) %>% 
  count()

#do I retain all of the good surveys? - rows here should match good surveys 
adult_yellow_perch %>% 
  distinct(lake_id,
           date_total_effort_ident,
           survey_type,
           sampling_method,
           total_effort_1) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#there are a handful of surveys that have multiple efforts within a total effort ident
#this causes the good surveys to look bigger than the cpue total but ensure we get all fish records 
adult_yellow_perch %>% 
  distinct(total_effort_ident,
           total_effort_1) %>% 
  glimpse()

adult_yellow_perch %>% 
  distinct(total_effort_ident) %>% 
  glimpse()


adult_yellow_perch %>% 
  group_by(total_effort_ident,
           total_effort_1) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n > 1)

#the difference between good surveys and cpue surveys are:
#88 nothing caught is true - remove


#checks after calculating cpue
#range of cpues?
adult_yellow_perch_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_yellow_perch_cpue %>% 
  filter(is.na(cpue))

#surveys that have nothing caught?
adult_yellow_perch_cpue %>% 
  filter(total_effort_nothing_caught == "TRUE") %>% 
  group_by(lake_name, survey_type, sampling_method, total_effort_1, date_total_effort_ident, total_effort_nothing_caught, cpue) %>% 
  count() %>% 
  print(n = nrow(.))

adult_yellow_perch_cpue %>% 
  ggplot() +
  geom_histogram(aes(cpue)) +
  facet_wrap(~sampling_method, scales = "free")

#removes individual fish object to save memory
rm(adult_yellow_perch)
```

#combining species
```{r}
mn_filtered_species <- bind_rows(adult_walleye_cpue %>% 
                                   mutate(species_1 = "walleye"), 
                                 adult_bluegill_cpue %>% 
                                   mutate(species_1 = "bluegill"), 
                                 adult_black_crappie_cpue %>% 
                                   mutate(species_1 = "black_crappie"),
                                 adult_largemouth_bass_cpue %>% 
                                   mutate(species_1 = "largemouth_bass"), 
                                 adult_smallmouth_bass_cpue %>% 
                                   mutate(species_1 = "smallmouth_bass"), 
                                 adult_cisco_cpue %>% 
                                   mutate(species_1 = "cisco"), 
                                 adult_northern_pike_cpue %>% 
                                   mutate(species_1 = "northern_pike"), 
                                 adult_yellow_perch_cpue %>% 
                                   mutate(species_1 = "yellow_perch"))
write_csv(mn_filtered_species, "MN_all_cpue_filtered.csv")
```

#bottom feeders
```{r}
all_data <- open_dataset("Data_and_Scripts/Data/output/midwest_data", partitioning = c("state"))

#filters for metric and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "bottom_feeders") %>% 
  select(-metric,
         -species_1,
         -water_temp_min,
         -water_temp_max,
         -survey_type,
         -area_group,
         -month_min,
         -month_max)

#filters for surveys that are good measures of abundance for given fish species
#first, merge the filter table with the data - selects for non-numeric parameters important for abundance 
#second, collapse the data into survey level
#third, filter the surveys based on numeric values 
good_surveys <- all_data %>%
  #filter for correct survey_type
  mutate(survey_type_filter = case_when(survey_type %in% c("HISTORICAL", 
                                                 "Large Lake Survey", 
                                                 "Population Assessment",
                                                 "Standard Survey",
                                                 "Initial Survey",
                                                 "Re-Survey") ~ "y", 
                              TRUE ~ "n")) %>% 
  right_join(filter_table_effort, by = c("state",
                                        "sampling_method")) %>% 
  distinct(lake_id,
           date_survey,
           sampling_method,
           total_effort_ident,
           total_effort_1,
           effort_min,
           effort_max,
           survey_type_filter,
           flag) %>% 
  filter(total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         survey_type_filter == "y") %>% 
  collect() %>% 
  #removing surveys that have a flag
  group_by(total_effort_ident) %>% 
  filter(all(is.na(flag))) %>% 
  ungroup()  %>% 
  select(-flag)

#gather fish from the surveys deemed good for abundance of the given species
bottom_feeders <- all_data %>%
  filter(state == "Minnesota") %>% 
  #filter the data for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  collect() 

#create cpue for species of interest
bottom_feeders_cpue <- bottom_feeders %>% 
  #grouping by survey level parameters to get survey level counts
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count_white_sucker = sum(species_1 == 'white_sucker'),
         count_black_bullhead = sum(species_1 == 'black_bullhead'),
         count_brown_bullhead = sum(species_1 == 'brown_bullhead'),
         count_yellow_bullhead = sum(species_1 == 'yellow_bullhead'),
         count_bigmouth_buffalo = sum(species_1 == 'bigmouth_buffalo'),
         count_channel_catfish = sum(species_1 == 'channel_catfish'),
         count_common_carp = sum(species_1 == 'common_carp')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count_white_sucker = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count_white_sucker),
         count_black_bullhead = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count_black_bullhead),
         count_brown_bullhead = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count_brown_bullhead),
         count_yellow_bullhead = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count_yellow_bullhead),
         count_bigmouth_buffalo = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count_bigmouth_buffalo),
         count_channel_catfish = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count_channel_catfish),
         count_common_carp = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count_common_carp)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue_white_sucker = count_white_sucker/total_effort_1,
         cpue_black_bullhead = count_black_bullhead/total_effort_1,
         cpue_brown_bullhead = count_brown_bullhead/total_effort_1,
         cpue_yellow_bullhead = count_yellow_bullhead/total_effort_1,
         cpue_bigmouth_buffalo = count_bigmouth_buffalo/total_effort_1,
         cpue_channel_catfish = count_channel_catfish/total_effort_1,
         cpue_common_carp = count_common_carp/total_effort_1) %>%
  #collapse data into survey level cpue (also works as a select function)
  distinct(total_effort_ident,
           total_effort_1,
           .keep_all = T)  %>% 
  filter(is.na(total_effort_nothing_caught)) %>% 
  group_by(total_effort_ident) %>% 
  filter(n_distinct(total_effort_1) == 1)

#checking filtering

#survey level checks
#min effort by grouping
good_surveys %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method) %>% 
  summarise(min_effort = min(total_effort_1),
            n = n())

#checks after collecting all fish data
#is each sampling method correct for the filter?
bottom_feeders %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  group_by(sampling_method) %>% 
  summarise(min_effort = min(total_effort_1),
            n = n())

bottom_feeders %>% 
  group_by(survey_type, sampling_method, survey_type_filter) %>% 
  count()

bottom_feeders %>% 
  group_by(flag) %>% 
  count()

#do I retain all of the good surveys? - rows here should match good surveys 
bottom_feeders %>% 
  distinct(lake_id,
           date_survey,
           survey_type,
           sampling_method,
           total_effort_1) %>% 
  group_by(sampling_method) %>% 
  glimpse()
#this is good it matches good survey total

#this shows there are 61 total effort nothing caught is true

#there are a handful of surveys that have multiple efforts within a total effort ident
#this causes the good surveys to look bigger than the cpue total but ensure we get all fish records 
bottom_feeders %>% 
  distinct(total_effort_ident,
           total_effort_1) %>% 
  glimpse()
#shows this matches good surveys

bottom_feeders %>% 
  filter(is.na(species_1)) %>% 
  distinct(total_effort_ident) %>% 
  glimpse()

bottom_feeders %>% 
  group_by(total_effort_ident,
           total_effort_1) %>% 
  count() %>% 
  group_by(total_effort_ident) %>% 
  count() %>% 
  filter(n > 1)

#the difference between good surveys and cpue surveys are:
#61 nothing caught is true - remove
#14 surveys that have more than one total effort (removes 28 records)
#thus, there should be 89 more records in the good surveys than cpue
#33134-33045 checks out


#checks after calculating cpue
#range of cpues?
bottom_feeders_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue_common_carp), max = max(cpue_common_carp))

#any na cpue?
bottom_feeders_cpue %>% 
  filter(is.na(cpue_common_carp))

#surveys that have nothing caught?
bottom_feeders_cpue %>% 
  filter(total_effort_nothing_caught == "TRUE") %>% 
  group_by(lake_name, survey_type, sampling_method, total_effort_1, date_total_effort_ident, total_effort_nothing_caught, cpue_common_carp) %>% 
  count() %>% 
  print(n = nrow(.))

#selecting relevant rows 
bottom_feeder_final <- bottom_feeders_cpue %>% 
  select(state,
         county,
         lake_name,
         lake_id,
         nhdhr_id,
         date_survey,
         survey_type,
         sampling_method,
         total_effort_ident,
         total_effort_1,
         total_effort_1_units,
         lakesize,
         lakesize_units,
         count_bigmouth_buffalo,
         count_white_sucker,
         count_black_bullhead,
         count_brown_bullhead,
         count_yellow_bullhead,
         count_channel_catfish,
         count_common_carp,
         cpue_white_sucker,
         cpue_black_bullhead,
         cpue_brown_bullhead,
         cpue_yellow_bullhead,
         cpue_bigmouth_buffalo,
         cpue_channel_catfish,
         cpue_common_carp)
write_csv(bottom_feeder_final, "MN_bottom_feeders_cpue.csv")
```

# old code 
```{r}
#from the data chunk 


#creating columns for filtering by lake area

#creating y/n column for if survey type is good for abundance
mn_data %>% 
  mutate(rep.type = case_when(survey_type %in% c("HISTORICAL", 
                                           "Large Lake Survey", 
                                           "Population Assessment",
                                           "Standard Survey",
                                           "Initial Survey",
                                           "Re-Survey") ~ "y",
                        TRUE ~ "n")) %>% 
  distinct(total_effort_ident, survey_type, rep.type) %>% 
  group_by(survey_type, rep.type) %>%
  count() %>% 
  collect()

#max effort filter
mn_data %>% 
  filter(survey_type %in% c("HISTORICAL", 
                            "Large Lake Survey",
                            "Population Assessment",
                            "Standard Survey",
                            "Initial Survey",
                            "Re-Survey")) %>% 
  filter(sampling_method %in% c("Standard 3/4-in mesh, double frame trap net sets",
                                "Standard gill net sets",
                                "Standard gill nets, set shallow in stratified assessment")) %>% 
  distinct(total_effort_ident, sampling_method, total_effort_1) %>% 
  collect() %>% 
  ggplot() +
  geom_histogram(aes(total_effort_1)) + 
  facet_wrap(~sampling_method, scales = "free")

mn_data %>% 
  filter(survey_type %in% c("HISTORICAL", 
                            "Large Lake Survey",
                            "Population Assessment",
                            "Standard Survey",
                            "Initial Survey",
                            "Re-Survey")) %>% 
  filter(sampling_method %in% c("Standard 3/4-in mesh, double frame trap net sets",
                                "Standard gill net sets",
                                "Standard gill nets, set shallow in stratified assessment")) %>% 
  distinct(total_effort_ident, sampling_method, total_effort_1, survey_type) %>% 
  collect() %>% 
  ggplot() +
  geom_histogram(aes(total_effort_1)) + 
  facet_grid(survey_type~sampling_method, scales = "free")

#cisco gears?
mn_data %>% 
  group_by(sampling_method, survey_type) %>% 
  count() %>% 
  arrange(sampling_method) %>% 
  collect() %>% 
  print(n = nrow(.))

mn_data %>% 
  filter(sampling_method == "Standard Vertical Gillnet") %>% 
  filter(!is.na(total_effort_1)) %>% 
  summarise(min(total_effort_1), max(total_effort_1)) %>% 
  collect()

mn_data %>% 
  filter(sampling_method == "Standard Vertical Gillnet") %>% 
  filter(!is.na(total_effort_1)) %>% 
  collect() %>% 
  distinct(total_effort_ident, .keep_all = T) %>% 
  summarise(less.1 = sum(total_effort_1 <= 1),
            min.month = min(month(date_total_effort_ident)),
            max.month = max(month(date_total_effort_ident)),
            before.june = sum(month(date_total_effort_ident) < 6),
            before2020 = sum(year(date_total_effort_ident) < 2020),
            n = n()) %>% 
  select(less.1, before2020, min.month, max.month, before.june, n) %>% 
  print()

mn_data %>% 
  distinct(total_effort_ident, sampling_method, area_group, total_effort_1, flag) %>% 
  filter(sampling_method == "Standard Vertical Gillnet") %>% 
  group_by(flag) %>% 
  count() %>% 
  collect()

mn_data %>% 
  filter(sampling_method == "Standard Vertical Gillnet") %>% 
  distinct(total_effort_ident, total_effort_1) %>% 
  mutate(na = is.na(total_effort_1)) %>% 
  group_by(na) %>% 
  count() %>% 
  collect()

mn_data %>% 
  str_detect("cisco", species_1) %>% 
  group_by(species_1) %>% 
  count() %>% 
  collect() %>% 
  print(n= nrow(.))

mn_data %>% 
  filter(sampling_method == "Standard Vertical Gillnet") %>% 
  filter(!is.na(total_effort_1)) %>% 
  distinct(total_effort_ident, survey_type, sampling_method, total_effort_1, date) %>% 
  collect() %>% 
  group_by(survey_type) %>% 
  count()

check <- mn_data %>% 
  filter(sampling_method == "Standard Vertical Gillnet") %>%
  collect() %>% 
  distinct(total_effort_ident, .keep_all = T)

mn_data %>% 
  distinct(total_effort_ident, total_effort_1) %>% 
  summarise(max(total_effort_1)) %>% 
  collect()

mn_data %>% 
  distinct(total_effort_ident, flag) %>% 
  group_by(flag) %>% 
  count() %>% 
  collect()

mn_data %>% 
  group_by(sampling_method, sampling_method_2) %>% 
  count() %>% 
  collect()

#multipule effort idents for one survey?
multi_ident <- mn_data %>% 
  filter(lake_id == "28003200" &
           date_total_effort_ident == "1996-07-16" &
           sampling_method == "Standard 3/4-in mesh, double frame trap net sets") %>% 
  collect()
#looks like one is nothing caught and the other has fish
```

